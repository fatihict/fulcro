<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="author" content="Tony Kay">
<title>Fulcro: The Definitive Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book">
<div id="header">
<h1>Fulcro: The Definitive Guide</h1>
<div class="details">
<span id="author" class="author">Tony Kay</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">July 28, 2017</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_prologue">1. Prologue</a>
<ul class="sectlevel2">
<li><a href="#_about_this_book">1.1. About This Book</a>
<ul class="sectlevel3">
<li><a href="#_common_prefixes_and_namespaces">1.1.1. Common Prefixes and Namespaces</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_getting_started">2. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#_project_setup">2.1. Project setup</a>
<ul class="sectlevel3">
<li><a href="#_figwheel_startup_script">2.1.1. Figwheel Startup Script</a></li>
</ul>
</li>
<li><a href="#_the_code_client_files">2.2. The Code Client Files</a>
<ul class="sectlevel3">
<li><a href="#_html">2.2.1. HTML</a></li>
<li><a href="#_running_figwheel">2.2.2. Running Figwheel</a></li>
<li><a href="#_fixing_things">2.2.3. Fixing Things</a>
<ul class="sectlevel4">
<li><a href="#_fixing_stubborn_things">Fixing Stubborn Things</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_basic_ui_components">2.3. Basic UI Components</a>
<ul class="sectlevel3">
<li><a href="#_the_code_defsc_code_macro">2.3.1. The <code>defsc</code> Macro</a></li>
<li><a href="#_the_code_render_code_method">2.3.2. The <code>render</code> method.</a></li>
<li><a href="#_props">2.3.3. Props</a></li>
<li><a href="#_hot_code_reload">2.3.4. Hot Code Reload</a></li>
<li><a href="#_composing">2.3.5. Composing</a></li>
</ul>
</li>
<li><a href="#_feeding_the_data_tree">2.4. Feeding the Data Tree</a>
<ul class="sectlevel3">
<li><a href="#_why_not_have_components_just_grab_their_data_sideband">2.4.1. Why not have components just "grab" their data (sideband)?</a></li>
<li><a href="#_step_1_the_initial_state">2.4.2. Step 1&#8201;&#8212;&#8201;The Initial State</a></li>
<li><a href="#_step_2_establishing_a_query">2.4.3. Step 2&#8201;&#8212;&#8201;Establishing a Query</a>
<ul class="sectlevel4">
<li><a href="#_adding_queries_our_example">Adding Queries Our Example</a></li>
</ul>
</li>
<li><a href="#_step_3_receive_the_data_feed_as_props_in_root">2.4.4. Step 3&#8201;&#8212;&#8201;Receive the Data Feed as Props in Root</a></li>
</ul>
</li>
<li><a href="#_passing_callbacks_and_other_parent_computed_data">2.5. Passing Callbacks and Other Parent-computed Data</a>
<ul class="sectlevel3">
<li><a href="#_the_incorrect_way">2.5.1. The Incorrect Way:</a></li>
<li><a href="#_the_correct_way">2.5.2. The Correct Way:</a></li>
</ul>
</li>
<li><a href="#_updating_the_data_tree">2.6. Updating the Data Tree</a>
<ul class="sectlevel3">
<li><a href="#_transactions">2.6.1. Transactions</a></li>
<li><a href="#_handling_mutations">2.6.2. Handling Mutations</a></li>
<li><a href="#_hold_on_this_sucks">2.6.3. Hold on – This Sucks!</a></li>
</ul>
</li>
<li><a href="#_the_secret_sauce_normalizing_the_database">2.7. The Secret Sauce – Normalizing the Database</a>
<ul class="sectlevel3">
<li><a href="#_automatic_normalization">2.7.1. Automatic Normalization</a></li>
<li><a href="#_mutations_on_a_normalized_database">2.7.2. Mutations on a Normalized Database</a></li>
<li><a href="#_how_automatic_normalization_works_optional">2.7.3. How Automatic Normalization Works (optional)</a></li>
</ul>
</li>
<li><a href="#_review_so_far">2.8. Review So Far</a></li>
<li><a href="#_using_better_tools">2.9. Using Better Tools</a>
<ul class="sectlevel3">
<li><a href="#_fulcro_inspect">2.9.1. Fulcro Inspect</a></li>
<li><a href="#_devcards">2.9.2. Devcards</a></li>
</ul>
</li>
<li><a href="#_going_remote">2.10. Going Remote!</a>
<ul class="sectlevel3">
<li><a href="#_setting_up_a_server">2.10.1. Setting up a Server</a>
<ul class="sectlevel4">
<li><a href="#_using_the_easy_server">Using the Easy Server</a>
<ul class="sectlevel5">
<li><a href="#_starting_the_server">Starting the Server</a></li>
<li><a href="#_server_refresh">Server Refresh</a></li>
<li><a href="#_serving_your_app">Serving your App</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_setup_for_playing_with_loads">2.10.2. Setup for Playing with Loads</a></li>
<li><a href="#_loading_data">2.10.3. Loading Data</a>
<ul class="sectlevel4">
<li><a href="#_normalization">Normalization</a></li>
<li><a href="#_loading_something_into_the_db_root">Loading something into the DB root</a>
<ul class="sectlevel5">
<li><a href="#_triggering_the_load">Triggering the Load</a></li>
<li><a href="#_implementing_the_server_handler">Implementing the Server Handler</a></li>
<li><a href="#_using_data_from_root">Using Data from Root</a></li>
</ul>
</li>
<li><a href="#_loading_something_that_gets_added_in_to_an_existing_entity">Loading something that gets "added in" to an existing entity</a>
<ul class="sectlevel5">
<li><a href="#_targeting_the_load">Targeting the Load</a></li>
<li><a href="#_handling_the_load_request_on_the_server">Handling the Load Request on the Server</a></li>
</ul>
</li>
<li><a href="#_morphing_the_loaded_data">Morphing the Loaded Data</a></li>
<li><a href="#_loading_a_specific_entity_and_it_s_subgraph_by_ident">Loading a specific entity and it&#8217;s subgraph (by ident)</a>
<ul class="sectlevel5">
<li><a href="#_trigger_the_load_via_a_user_event">Trigger the Load via a User Event</a></li>
<li><a href="#_handling_an_entity_query_on_the_server">Handling an Entity Query on the Server</a></li>
<li><a href="#_refreshing_this">Refreshing "This"</a></li>
</ul>
</li>
<li><a href="#_additional_permutations">Additional Permutations</a></li>
</ul>
</li>
<li><a href="#_handling_mutations_on_the_server">2.10.4. Handling Mutations on The Server</a>
<ul class="sectlevel4">
<li><a href="#_triggering_the_remote_mutation_from_the_client">Triggering the Remote Mutation from the Client</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_using_a_legacy_rest_api">2.11. Using a legacy REST API</a>
<ul class="sectlevel3">
<li><a href="#_writing_the_networking_code">2.11.1. Writing the Networking Code</a></li>
<li><a href="#_the_ui_and_queries">2.11.2. The UI and Queries</a></li>
<li><a href="#_installing_our_networking_code">2.11.3. Installing our Networking Code</a></li>
<li><a href="#_requesting_data_from_the_alternate_remote">2.11.4. Requesting Data from the Alternate Remote</a></li>
<li><a href="#_mutations_over_rest">2.11.5. Mutations over REST</a></li>
</ul>
</li>
<li><a href="#_the_complete_source">2.12. The Complete Source</a></li>
</ul>
</li>
<li><a href="#_core_concepts">3. Core Concepts</a>
<ul class="sectlevel2">
<li><a href="#_immutable_data_structures">3.1. Immutable Data Structures</a></li>
<li><a href="#_pure_rendering">3.2. Pure Rendering</a></li>
<li><a href="#_data_driven">3.3. Data-Driven</a></li>
<li><a href="#GraphDB">3.4. Graph Database</a>
<ul class="sectlevel3">
<li><a href="#_idents">3.4.1. Idents</a></li>
<li><a href="#_a_complete_database">3.4.2. A Complete Database</a></li>
<li><a href="#_a_special_note_about_the_client_side_database">3.4.3. A Special Note about The Client-Side Database</a></li>
<li><a href="#_client_database_naming_conventions">3.4.4. Client Database Naming Conventions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_component_rendering">4. Component Rendering</a>
<ul class="sectlevel2">
<li><a href="#_html5_element_factories">4.1. HTML5 Element Factories</a>
<ul class="sectlevel3">
<li><a href="#_fulcro_and_react_dom_notes">4.1.1. Fulcro and React DOM – Notes</a></li>
</ul>
</li>
<li><a href="#_the_code_defsc_code_macro_2">4.2. The <code>defsc</code> Macro</a>
<ul class="sectlevel3">
<li><a href="#_the_argument_list">4.2.1. The Argument List</a>
<ul class="sectlevel4">
<li><a href="#_argument_destructuring">Argument Destructuring</a></li>
</ul>
</li>
<li><a href="#_options_lambda_vs_template">4.2.2. Options – Lambda vs. Template</a></li>
<li><a href="#_ident_generation">4.2.3. Ident Generation</a>
<ul class="sectlevel4">
<li><a href="#_template_idents">Template Idents</a></li>
<li><a href="#_lambda_idents">Lambda Idents</a></li>
</ul>
</li>
<li><a href="#_query">4.2.4. Query</a>
<ul class="sectlevel4">
<li><a href="#_template_query">Template Query</a></li>
<li><a href="#_lambda_query">Lambda Query</a></li>
</ul>
</li>
<li><a href="#_initial_state">4.2.5. Initial State</a>
<ul class="sectlevel4">
<li><a href="#_lambda_mode">Lambda mode</a></li>
<li><a href="#_template_mode">Template Mode</a></li>
</ul>
</li>
<li><a href="#_css_support">4.2.6. CSS Support</a></li>
<li><a href="#_react_lifecycle_methods">4.2.7. React Lifecycle Methods</a>
<ul class="sectlevel4">
<li><a href="#_additional_protocol_support">Additional Protocol Support</a></li>
</ul>
</li>
<li><a href="#_sanity_checking">4.2.8. Sanity Checking</a></li>
</ul>
</li>
<li><a href="#_factories">4.3. Factories</a></li>
<li><a href="#_render_and_props">4.4. Render and Props</a>
<ul class="sectlevel3">
<li><a href="#_derived_values">4.4.1. Derived Values</a></li>
<li><a href="#_computed_props_and_callbacks">4.4.2. Computed Props and Callbacks</a></li>
<li><a href="#_children">4.4.3. Children</a>
<ul class="sectlevel4">
<li><a href="#_working_with_children">Working with Children</a></li>
<li><a href="#_mixing_data_driven_children_with_ui_only_concerns">Mixing Data-Driven Children with UI-Only Concerns</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_controlled_inputs">4.5. Controlled Inputs</a></li>
<li><a href="#ReactLifecycle">4.6. React Lifecycle Examples</a>
<ul class="sectlevel3">
<li><a href="#_focusing_an_input">4.6.1. Focusing an input</a></li>
<li><a href="#_taking_control_of_the_sub_dom_d3_etc">4.6.2. Taking control of the sub-DOM (D3, etc)</a></li>
<li><a href="#_dynamically_rendering_into_a_canvas">4.6.3. Dynamically rendering into a canvas</a></li>
</ul>
</li>
<li><a href="#_using_javascript_react_components">4.7. Using Javascript React Components</a>
<ul class="sectlevel3">
<li><a href="#_factory_functions_for_js_react_components">4.7.1. Factory Functions for JS React Components</a></li>
</ul>
</li>
<li><a href="#_demo_an_image_clip_tool">4.8. Demo: An Image Clip Tool</a></li>
<li><a href="#_the_code_defui_code_macro_fulcro_1_x_legacy_support_in_2_x">4.9. The <code>defui</code> Macro (Fulcro 1.x. Legacy support in 2.x)</a>
<ul class="sectlevel3">
<li><a href="#_react_object_methods">4.9.1. React (Object) methods</a></li>
<li><a href="#_the_code_static_code_protocol_qualifier">4.9.2. The <code>static</code> Protocol Qualifier</a></li>
<li><a href="#_iquery_and_ident">4.9.3. IQuery and Ident</a>
<ul class="sectlevel4">
<li><a href="#_notes_on_the_iquery_protocol">Notes on the IQuery Protocol</a></li>
<li><a href="#_notes_on_the_ident_protocol">Notes on the Ident Protocol</a></li>
</ul>
</li>
<li><a href="#_om_next_compatibility">4.9.4. Om Next Compatibility</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_the_query_and_mutation_language">5. The Query and Mutation Language</a>
<ul class="sectlevel2">
<li><a href="#_properties">5.1. Properties</a></li>
<li><a href="#_joins">5.2. Joins</a></li>
<li><a href="#Unions">5.3. Unions</a>
<ul class="sectlevel3">
<li><a href="#_demo_using_unions_as_a_ui_type_selector">5.3.1. Demo – Using Unions as a UI Type Selector</a></li>
<li><a href="#_demo_using_unions_to_switch_out_ui_elements">5.3.2. Demo – Using Unions to Switch out UI Elements</a></li>
</ul>
</li>
<li><a href="#Mutations">5.4. Mutations</a></li>
<li><a href="#_parameters">5.5. Parameters</a></li>
<li><a href="#_queries_on_idents">5.6. Queries on Idents</a></li>
<li><a href="#_link_queries">5.7. Link Queries</a></li>
<li><a href="#_the_ast">5.8. The AST</a>
<ul class="sectlevel3">
<li><a href="#_morphing_mutations">5.8.1. Morphing Mutations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_initial_application_state">6. Initial Application State</a>
<ul class="sectlevel2">
<li><a href="#_adding_initial_state_to_components">6.1. Adding Initial State to Components</a>
<ul class="sectlevel3">
<li><a href="#_initial_state_and_alternate_branches_of_unions">6.1.1. Initial State and Alternate Branches of Unions</a></li>
</ul>
</li>
<li><a href="#_initial_state_and_state_progressions">6.2. Initial State and State Progressions</a></li>
</ul>
</li>
<li><a href="#_normalization_2">7. Normalization</a>
<ul class="sectlevel2">
<li><a href="#_internals">7.1. Internals</a></li>
<li><a href="#Normalization">7.2. Normalization: Initial State, Server Interations, and Mutations</a></li>
</ul>
</li>
<li><a href="#MutationsChapter">8. Handling Mutations</a>
<ul class="sectlevel2">
<li><a href="#_stages_of_mutation">8.1. Stages of Mutation</a></li>
<li><a href="#_using_the_multimethod_directly">8.2. Using the Multimethod Directly</a></li>
<li><a href="#_using_code_defmutation_code">8.3. Using <code>defmutation</code></a></li>
<li><a href="#_recommendations_about_writing_mutations">8.4. Recommendations About Writing Mutations</a>
<ul class="sectlevel3">
<li><a href="#_node_specific_mutation">8.4.1. Node-Specific Mutation</a></li>
<li><a href="#_composition_in_mutations">8.4.2. Composition in Mutations</a></li>
<li><a href="#_mutation_helpers">8.4.3. Mutation Helpers</a></li>
</ul>
</li>
<li><a href="#_remote_mutations">8.5. Remote Mutations</a>
<ul class="sectlevel3">
<li><a href="#_altering_the_mutation">8.5.1. Altering the Mutation</a></li>
<li><a href="#_mutations_that_trigger_one_or_more_loads">8.5.2. Mutations that Trigger one or more Loads</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_full_stack_operation">9. Full Stack Operation</a>
<ul class="sectlevel2">
<li><a href="#_server_interaction_general_operation">9.1. Server interaction - General Operation</a></li>
<li><a href="#_general_theory_of_operation">9.2. General Theory of Operation</a>
<ul class="sectlevel3">
<li><a href="#_integration_of_strong_all_strong_new_external_data_is_just_a_query_based_merge">9.2.1. Integration of <strong>ALL</strong> new external data is just a Query-Based Merge</a></li>
</ul>
</li>
<li><a href="#_the_central_functions_code_transact_code_and_code_merge_code">9.3. The Central Functions : <code>transact!</code> and <code>merge!</code></a></li>
<li><a href="#_augmenting_the_ring_response">9.4. Augmenting the Ring Response</a></li>
<li><a href="#_easy_server">9.5. Easy Server</a>
<ul class="sectlevel3">
<li><a href="#_constructing_a_base_server">9.5.1. Constructing a base server</a></li>
<li><a href="#_configuring_the_server">9.5.2. Configuring the server</a></li>
<li><a href="#_reloading_server_code">9.5.3. Reloading Server Code</a></li>
</ul>
</li>
<li><a href="#_the_data_fetch_api_code_load_code">9.6. The Data Fetch API: <code>load</code></a>
<ul class="sectlevel3">
<li><a href="#_handling_a_root_query">9.6.1. Handling a Root Query</a></li>
<li><a href="#_entity_queries">9.6.2. Entity Queries</a></li>
<li><a href="#_targeting_loads">9.6.3. Targeting Loads</a>
<ul class="sectlevel4">
<li><a href="#_simple_targeting">Simple Targeting</a></li>
<li><a href="#_advanced_targets">Advanced Targets</a></li>
</ul>
</li>
<li><a href="#_refreshing_the_ui_after_load">9.6.4. Refreshing the UI After Load</a></li>
<li><a href="#_other_load_options">9.6.5. Other Load Options</a></li>
<li><a href="#_initializing_loaded_items">9.6.6. Initializing Loaded Items</a></li>
<li><a href="#_post_mutations_morphing_loaded_data">9.6.7. Post Mutations – Morphing Loaded Data</a>
<ul class="sectlevel4">
<li><a href="#_post_mutations">Post Mutations</a></li>
<li><a href="#_using_code_defsc_code_for_server_queries">Using <code>defsc</code> For Server Queries</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_full_stack_mutations">9.7. Full-Stack Mutations</a>
<ul class="sectlevel3">
<li><a href="#_mutations_revisited">9.7.1. Mutations Revisited</a></li>
<li><a href="#_writing_the_server_mutations">9.7.2. Writing The Server Mutations</a></li>
<li><a href="#_new_item_creation_temporary_ids">9.7.3. New item creation – Temporary IDs</a></li>
<li><a href="#_remote_reads_after_a_mutation">9.7.4. Remote Reads After a Mutation</a></li>
<li><a href="#PTransact">9.7.5. Pessimistic Transactions</a>
<ul class="sectlevel4">
<li><a href="#_pessimistic_transaction_fallbacks">Pessimistic Transaction Fallbacks</a></li>
</ul>
</li>
<li><a href="#_using_loads_as_mutations">9.7.6. Using Loads as Mutations</a></li>
<li><a href="#_running_mutations_in_the_context_of_an_entity">9.7.7. Running Mutations in the Context of an Entity</a></li>
</ul>
</li>
<li><a href="#_network_activity_indicators">9.8. Network Activity Indicators</a>
<ul class="sectlevel3">
<li><a href="#_global_network_activity_marker">9.8.1. Global network activity marker</a></li>
<li><a href="#_mutation_activity">9.8.2. Mutation Activity</a></li>
<li><a href="#_tracking_specific_loads">9.8.3. Tracking Specific Loads</a>
<ul class="sectlevel4">
<li><a href="#_working_with_load_markers">Working with Load Markers</a>
<ul class="sectlevel5">
<li><a href="#_marker_ids_for_items_that_have_many_instances">Marker IDs for Items That Have Many Instances</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#ReturnValues">9.9. Server Mutation Return Values</a>
<ul class="sectlevel3">
<li><a href="#_using_mutation_joins">9.9.1. Using Mutation Joins</a></li>
<li><a href="#ASTMutationJoins">9.9.2. Mutation Joins: Simpler Notation</a></li>
<li><a href="#_targeting_return_values_from_mutation_joins">9.9.3. Targeting Return Values From Mutation Joins</a></li>
<li><a href="#_augmenting_the_merge">9.9.4. Augmenting the Merge</a>
<ul class="sectlevel4">
<li><a href="#_accessing_server_components_old">Accessing Server Components (OLD)</a></li>
<li><a href="#_library_modules_composition_old">Library Modules (composition) (OLD)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#_full_stack_operations_needs_combined_with_earlier_chapter">10. Full-Stack Operations (NEEDS COMBINED WITH EARLIER CHAPTER)</a>
<ul class="sectlevel2">
<li><a href="#_theory_of_operation">10.1. Theory of Operation</a>
<ul class="sectlevel3">
<li><a href="#_think_in_graphs">10.1.1. Think In Graphs</a></li>
<li><a href="#_targeting_the_root_of_your_graph">10.1.2. Targeting the Root of Your Graph</a></li>
<li><a href="#_targeting_an_alternate_node">10.1.3. Targeting an Alternate Node</a></li>
<li><a href="#_ui_only_query_elements">10.1.4. UI-Only Query Elements</a></li>
<li><a href="#_server_interaction_order">10.1.5. Server Interaction Order</a></li>
<li><a href="#_server_result_query_merging">10.1.6. Server Result Query Merging</a></li>
<li><a href="#_react_lifecycle_and_load">10.1.7. React Lifecycle and Load</a></li>
<li><a href="#_incremental_loading">10.1.8. Incremental Loading</a></li>
</ul>
</li>
<li><a href="#_processing_remote_queries">10.2. Processing Remote Queries</a>
<ul class="sectlevel3">
<li><a href="#_using_code_defquery_root_code_and_code_defquery_entity_code">10.2.1. Using <code>defquery-root</code> and <code>defquery-entity</code></a></li>
<li><a href="#_datomic_tips">10.2.2. Datomic Tips</a></li>
<li><a href="#_sql_tips">10.2.3. SQL Tips</a></li>
</ul>
</li>
<li><a href="#_remote_mutations_2">10.3. Remote Mutations</a>
<ul class="sectlevel3">
<li><a href="#_creating_things_tempid_remapping">10.3.1. Creating Things: Tempid Remapping</a></li>
<li><a href="#_dealing_with_errors">10.3.2. Dealing with Errors</a></li>
<li><a href="#_returning_a_value">10.3.3. Returning a Value</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_advanced_parsing">11. Advanced Parsing</a>
<ul class="sectlevel2">
<li><a href="#_using_advanced_parsing_on_the_client">11.1. Using Advanced Parsing on the Client</a></li>
</ul>
</li>
<li><a href="#_ui_routing">12. UI Routing</a>
<ul class="sectlevel2">
<li><a href="#_see_the_developer_s_guide">12.1. See the Developer&#8217;s Guide.</a></li>
</ul>
</li>
<li><a href="#_forms">13. Forms</a>
<ul class="sectlevel2">
<li><a href="#_see_the_developer_s_guide_2">13.1. See the Developer&#8217;s Guide.</a></li>
</ul>
</li>
<li><a href="#_server_side_rendering">14. Server-side Rendering</a>
<ul class="sectlevel2">
<li><a href="#_generating_initial_state">14.1. Generating Initial State</a>
<ul class="sectlevel3">
<li><a href="#_alternate_union_branches">14.1.1. Alternate Union Branches</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Networking">15. Networking</a>
<ul class="sectlevel2">
<li><a href="#_adding_additional_remotes">15.1. Adding Additional Remotes</a></li>
<li><a href="#_creating_custom_remote_handlers">15.2. Creating Custom Remote Handlers</a>
<ul class="sectlevel3">
<li><a href="#_optional_sequential_operation">15.2.1. Optional Sequential Operation</a></li>
<li><a href="#_implementing_send">15.2.2. Implementing Send</a></li>
<li><a href="#_merging_state">15.2.3. Merging State</a></li>
<li><a href="#_error_handling">15.2.4. Error Handling</a></li>
<li><a href="#_supporting_progress_updates">15.2.5. Supporting Progress Updates</a>
<ul class="sectlevel4">
<li><a href="#_alternative_busy_indicator">Alternative Busy Indicator</a></li>
</ul>
</li>
<li><a href="#_interfacing_with_rest_servers">15.2.6. Interfacing with REST Servers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_websockets">16. Websockets</a>
<ul class="sectlevel2">
<li><a href="#_client_side_setup">16.1. Client-side Setup</a></li>
<li><a href="#_server_side_setup">16.2. Server-side Setup</a></li>
<li><a href="#_server_push">16.3. Server Push</a></li>
</ul>
</li>
<li><a href="#_internationalization">17. Internationalization</a>
<ul class="sectlevel2">
<li><a href="#_basic_strings">17.1. Basic Strings</a></li>
<li><a href="#_formatted_strings">17.2. Formatted Strings</a></li>
<li><a href="#_strings_in_variables">17.3. Strings in Variables</a></li>
<li><a href="#_extracting_strings">17.4. Extracting Strings</a></li>
<li><a href="#_generating_translations">17.5. Generating Translations</a></li>
<li><a href="#_modular_locale_loading">17.6. Modular Locale Loading</a></li>
<li><a href="#_polyfills">17.7. Polyfills</a></li>
</ul>
</li>
<li><a href="#_devcards_2">18. Devcards</a>
<ul class="sectlevel2">
<li><a href="#_developing_component_ui">18.1. Developing Component UI</a></li>
<li><a href="#_developing_active_screens">18.2. Developing Active Screens</a></li>
</ul>
</li>
<li><a href="#_support_viewer">19. Support Viewer</a>
<ul class="sectlevel2">
<li><a href="#_submitting_support_requests">19.1. Submitting Support Requests</a></li>
<li><a href="#_supplying_state_to_the_support_viewer">19.2. Supplying State to the Support Viewer</a></li>
</ul>
</li>
<li><a href="#_code_splitting_modules">20. Code Splitting (modules)</a>
<ul class="sectlevel2">
<li><a href="#_the_source_structure">20.1. The Source Structure</a></li>
<li><a href="#_the_compiler_config">20.2. The Compiler Config</a></li>
<li><a href="#_the_extension_point">20.3. The Extension Point</a></li>
<li><a href="#_server_side_rendering_2">20.4. Server-Side Rendering</a></li>
</ul>
</li>
<li><a href="#_dynamic_queries">21. Dynamic Queries</a>
<ul class="sectlevel2">
<li><a href="#_query_ids">21.1. Query IDs</a></li>
<li><a href="#_query_parameters">21.2. Query Parameters</a></li>
</ul>
</li>
<li><a href="#_hacking_the_client_query_engine">22. Hacking the Client Query Engine</a>
<ul class="sectlevel2">
<li><a href="#_adding_to_code_read_local_code">22.1. Adding to <code>read-local</code></a></li>
<li><a href="#_demo_writing_a_pagination_and_sort_routine">22.2. Demo – Writing a Pagination and Sort Routine</a></li>
</ul>
</li>
<li><a href="#_performance">23. Performance</a>
<ul class="sectlevel2">
<li><a href="#_poor_query_performance">23.1. Poor Query Performance</a></li>
<li><a href="#_poor_react_performance">23.2. Poor React Performance</a></li>
</ul>
</li>
<li><a href="#_testing">24. Testing</a>
<ul class="sectlevel2">
<li><a href="#_specifications">24.1. Specifications</a></li>
<li><a href="#_behaviors_components_and_assertions">24.2. Behaviors, Components, and Assertions</a></li>
<li><a href="#_exceptions">24.3. Exceptions</a></li>
<li><a href="#_functional_assertions">24.4. Functional Assertions</a></li>
<li><a href="#_mocking_and_spies">24.5. Mocking and Spies</a>
<ul class="sectlevel3">
<li><a href="#_specifying_call_count">24.5.1. Specifying Call Count</a></li>
<li><a href="#_checking_order">24.5.2. Checking Order</a></li>
<li><a href="#_limitations">24.5.3. Limitations</a></li>
</ul>
</li>
<li><a href="#VisualRegression">24.6. Visual Regression Testing</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_prologue"><a class="anchor" href="#_prologue"></a><a class="link" href="#_prologue">1. Prologue</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_about_this_book"><a class="anchor" href="#_about_this_book"></a><a class="link" href="#_about_this_book">1.1. About This Book</a></h3>
<div class="paragraph">
<p>This book is meant to be a stand-alone book for Fulcro developers. Fulcro has a
pretty extensive set of resources on the web, tailored to fit your learning style.
There are YouTube videos, an interactive tutorial, and full-blown sample applications.</p>
</div>
<div class="paragraph">
<p>This book includes quite a bit of live code. Live code demos with their source
look like this:</p>
</div>
<div id="server-controls"> </div>
<div class="example" id="example-1"> </div>
<a class="source-toggle" href="javascript:void(0)" onClick="$('.example-1').toggle()">Show/Hide Source</a>
<div class="listingblock example-1 source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.example-1</span>
  (<span class="symbol">:require</span> [fulcro.client.primitives <span class="symbol">:as</span> fp <span class="symbol">:refer</span> [defsc]]
            [fulcro.client.mutations <span class="symbol">:refer</span> [defmutation]]
            [fulcro.client.dom <span class="symbol">:as</span> dom]))

(defmutation bump-number [ignored]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state update <span class="symbol">:ui/number</span> <span class="keyword">inc</span>)))

(defsc Root [this {<span class="symbol">:keys</span> [ui/number]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/number</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:ui/number</span> <span class="integer">0</span>}}
  (dom/div <span class="predefined-constant">nil</span>
    (dom/h4 <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">This is an example.</span><span class="delimiter">&quot;</span></span>)
    (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(fp/transact! this `[(bump-number {})])}
      <span class="string"><span class="delimiter">&quot;</span><span class="content">You've clicked this button </span><span class="delimiter">&quot;</span></span> number <span class="string"><span class="delimiter">&quot;</span><span class="content"> times.</span><span class="delimiter">&quot;</span></span>)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>All of the Full Stack examples actually use a mock server embedded in the browser to
simulate the interaction, but the source that you&#8217;ll read for the application is
identical to what you&#8217;d write for a real server. This mock server has a built-in latency to
simulate a moderately slow network so you can observe behaviors over time. You can
control the length of this latency in ms using the "Server Controls" in the upper-right
corner of this document (if you&#8217;re reading the HTML version with live examples).</p>
</div>
<div class="sect3">
<h4 id="_common_prefixes_and_namespaces"><a class="anchor" href="#_common_prefixes_and_namespaces"></a><a class="link" href="#_common_prefixes_and_namespaces">1.1.1. Common Prefixes and Namespaces</a></h4>
<div class="paragraph">
<p>Many of the code examples assume you&#8217;ve required the proper namespaces in your
code. This book adopts the following general set of requires and aliases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">your-ns</span>
  (<span class="symbol">:require</span> [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defsc defui]]
            [fulcro.client.dom <span class="symbol">:as</span> dom]
            [fulcro.util <span class="symbol">:as</span> util]
            [fulcro.client.util <span class="symbol">:as</span> cutil]
            [fulcro.client.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
            [fulcro.server <span class="symbol">:as</span> server <span class="symbol">:refer</span> [defquery-root defquery-entity]]
            [fulcro.client <span class="symbol">:as</span> fc]])</code></pre>
</div>
</div>
<div class="paragraph">
<p>others will be identified as they are used.</p>
</div>
<div class="paragraph">
<p>The next chapter, "Getting Started", is an exception. The code you see in that chapter is meant to be added to
a template that you create and run on your own machine. A complete running version of it is available on GitHub
as described at the end of the chapter.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started"><a class="anchor" href="#_getting_started"></a><a class="link" href="#_getting_started">2. Getting Started</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter is meant to be a whirlwind introduction. It takes you through a step-by-step guide of how to go
from nothing to a full-stack basic application using the Fulcro leiningen template. Concepts are introduced as we
go, and given a very cursory definition in the interest of concision. Once you&#8217;ve got the general idea you
can use other materials to refine your understanding.</p>
</div>
<div class="paragraph">
<p>The Leiningen template is the very quickest way to get started. It gives you a number of useful
things like devcards, production builds, CI integration and more while also giving you the minimal
amount of actual code. This can save you hours of setup.</p>
</div>
<div class="sect2">
<h3 id="_project_setup"><a class="anchor" href="#_project_setup"></a><a class="link" href="#_project_setup">2.1. Project setup</a></h3>
<div class="paragraph">
<p>You can get a basic app with no prewritten demo code using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ lein new fulcro app nodemo</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>nodemo</code> option tells the template not to include demonstration full-stack code. It gives you a
shell of a project that still contains everything you&#8217;d want to set up (cards, testing, a development
web server, figwheel, etc.) without much actual code to understand or delete.</p>
</div>
<div class="paragraph">
<p>You should stop here for a moment and read the README in your generated project to see how that
is laid out.</p>
</div>
<div class="sect3">
<h4 id="_figwheel_startup_script"><a class="anchor" href="#_figwheel_startup_script"></a><a class="link" href="#_figwheel_startup_script">2.1.1. Figwheel Startup Script</a></h4>
<div class="paragraph">
<p>Figwheel is a hot-reload development tool. We recommend using figwheel sidecar so
you can easily start the project from the command line or use it from the REPL
support built into IntelliJ. The template already has the code for doing this. Part of
it is in <code>user.clj</code>, and the other part is a simple script <code>script/figwheel.clj</code> to invoke it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">require</span> '[user <span class="symbol">:refer</span> [start-figwheel]])

(start-figwheel)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>README</code> of your project describes how to start the various builds of your cljs code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_code_client_files"><a class="anchor" href="#_the_code_client_files"></a><a class="link" href="#_the_code_client_files">2.2. The Code Client Files</a></h3>
<div class="paragraph">
<p>A complete Fulcro front-end client can be created in about two lines of code. Hot-load
concerns require just a few more lines.</p>
</div>
<div class="paragraph">
<p>Your project should have a <code>src/main/app/client.cljs</code> file that looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.client</span>
  (<span class="symbol">:require</span> [fulcro.client <span class="symbol">:as</span> fc]))

(<span class="keyword">defonce</span> <span class="function">app</span> (<span class="keyword">atom</span> (fc/new-fulcro-client)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a client and stores it in an atom. The client isn&#8217;t active until you mount it. In
order to do <strong>that</strong>, you need a UI. The file <code>src/main/ui/root.cljc</code> contains something like
this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.ui.root</span>
  (<span class="symbol">:require</span>
    translations.es
    [fulcro.client.dom <span class="symbol">:as</span> dom]
    [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defsc]]))

(defsc Root [this {<span class="symbol">:keys</span> [ui/react-key]}]
  (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> react-key} <span class="string"><span class="delimiter">&quot;</span><span class="content">TODO</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actual mount is done by code that figwheel is configured to load/run in
<code>src/dev/user.cljs</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">cljs.user</span>
  (<span class="symbol">:require</span>
    [fulcro.client <span class="symbol">:as</span> fc]
    [app.client <span class="symbol">:as</span> core]
    [app.ui.root <span class="symbol">:as</span> root]
    [cljs.pprint <span class="symbol">:refer</span> [pprint]]
    [fulcro.client.logging <span class="symbol">:as</span> log]))

(enable-console-print!)

(log/set-level <span class="symbol">:all</span>)

(<span class="keyword">defn</span> <span class="function">mount</span> []
  (<span class="keyword">reset!</span> core/app (fc/mount @core/app root/Root <span class="string"><span class="delimiter">&quot;</span><span class="content">app</span><span class="delimiter">&quot;</span></span>)))

(mount)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you look at your <code>project.clj</code> file you&#8217;ll see it is configured to re-call <code>mount</code> on every hot load.
Mounting an already mounted app is the same as asking for a forced UI refresh.</p>
</div>
<div class="paragraph">
<p>This is all the real code you need to get started with a hot-code reload capable application! However, the
browser needs instructions to load this stuff up, and the target <code>div</code> of the mount needs to exist.</p>
</div>
<div class="sect3">
<h4 id="_html"><a class="anchor" href="#_html"></a><a class="link" href="#_html">2.2.1. HTML</a></h4>
<div class="paragraph">
<p>The most basic HTML file you can start with (and it won&#8217;t get much bigger) is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html&gt;</span>
    <span class="tag">&lt;body&gt;</span>
        <span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">app-1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/div&gt;</span>
        <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">js/app.js</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/javascript</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_figwheel"><a class="anchor" href="#_running_figwheel"></a><a class="link" href="#_running_figwheel">2.2.2. Running Figwheel</a></h4>
<div class="paragraph">
<p>You can now run this project in various ways.</p>
</div>
<div class="paragraph">
<p>From the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ lein run -m clojure.main script/figwheel.clj</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within IntelliJ:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Run &#8594; Edit Configurations&#8230;&#8203;</p>
</li>
<li>
<p>Press the <em>+</em> button, and choose Clojure REPL &#8594; Local</p>
<div class="ulist">
<ul>
<li>
<p>Give it a name (like <code>dev</code>)</p>
</li>
<li>
<p>Choose "Use clojure.main in normal JVM process" (important: it defaults to nREPL which won&#8217;t work right)</p>
</li>
<li>
<p>In <code>JVM Args</code> specify <code>-Ddev</code>. This is a trick of the template&#8217;s figwheel script that lets you pick
one or more build from your build config easily. This selects just the <code>dev</code> build.</p>
</li>
<li>
<p>In <code>Parameters</code> add <code>script/figwheel.clj</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now you should be able to start it from the Run menu.</p>
</div>
<div class="paragraph">
<p>For Emacs + Cider:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure a piggieback dev-time dependency and repl-option are in <code>project.clj</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">  <span class="symbol">:profiles</span> {<span class="symbol">:dev</span> {<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/dev</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>]
                   <span class="symbol">:repl-options</span> {<span class="symbol">:nrepl-middleware</span> [cemerick.piggieback/wrap-cljs-repl]}
                   <span class="symbol">:dependencies</span> [[binaryage/devtools <span class="string"><span class="delimiter">&quot;</span><span class="content">0.9.4</span><span class="delimiter">&quot;</span></span>]
                                  [com.cemerick/piggieback <span class="string"><span class="delimiter">&quot;</span><span class="content">0.2.1</span><span class="delimiter">&quot;</span></span>]
                                  [org.clojure/tools.namespace <span class="string"><span class="delimiter">&quot;</span><span class="content">0.3.0-alpha4</span><span class="delimiter">&quot;</span></span>]
                                  [figwheel-sidecar <span class="string"><span class="delimiter">&quot;</span><span class="content">0.5.13</span><span class="delimiter">&quot;</span></span>]
                                  [org.clojure/tools.nrepl <span class="string"><span class="delimiter">&quot;</span><span class="content">0.2.13</span><span class="delimiter">&quot;</span></span>]]}})</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>With <code>src/dev/user.clj</code> open in a buffer, choose <code>M-x cider-jack-in</code>. In the clojure repl, run <code>(start-figwheel)</code>, which will launch a cljs repl.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You should see the application printing "Hello World" at: <a href="http://localhost:3449" class="bare">http://localhost:3449</a></p>
</div>
<div class="paragraph">
<p>Now that you have a basic project working, let&#8217;s understand how to add some
content!</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When developing it is a good idea to: Use Chrome (the devtools only work there),
have the developer&#8217;s console open, and in the developer console settings: "Network, Disable cache (while
DevTools is open)", and "Console, Enable custom formatters".
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Cached files can, as everywhere else, cause you lots of headaches. Fortunately they only really affect you poorly
on the initial load in Fulcro. Hot reloads typically work very well.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fixing_things"><a class="anchor" href="#_fixing_things"></a><a class="link" href="#_fixing_things">2.2.3. Fixing Things</a></h4>
<div class="paragraph">
<p>One of the most maddening things that can happen during development is mystery around build errors. Nothing is
more frustrating than not understanding what is wrong.</p>
</div>
<div class="paragraph">
<p>As you work on your code your compiler errors and warnings will show in the browser. DO NOT RELOAD THE PAGE! If
you reload the page you&#8217;ll lose the warning or error, and that makes it harder to figure out what is wrong!</p>
</div>
<div class="paragraph">
<p>Instead, edit your code and re-save.</p>
</div>
<div class="paragraph">
<p>If you are having problems and you&#8217;ve lost your way, it is sometimes useful to ask figwheel to clean and recompile
everything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cljs.user=&gt; (reset-autobuild)</pre>
</div>
</div>
<div class="paragraph">
<p>will typically get you back on track.</p>
</div>
<div class="sect4">
<h5 id="_fixing_stubborn_things"><a class="anchor" href="#_fixing_stubborn_things"></a><a class="link" href="#_fixing_stubborn_things">Fixing Stubborn Things</a></h5>
<div class="paragraph">
<p>Sometimes stuff just fails for reasons we fail to understand. There are times when
you may want to completely kill your REPL, clean the project with <code>lein clean</code>, and start again. Make sure all
of the generated Javascript is removed when you clean, or things might not clear up.</p>
</div>
<div class="paragraph">
<p>It is also true that problems in your project configuration may cause problems that are very difficult to
understand. If this happens to you (especially if you&#8217;ve never run a project with the current project setup) then
it is good to look at things like dependency problems with <code>lein deps :tree</code> and fix those.</p>
</div>
<div class="paragraph">
<p>In general, if you see a conflict on versions it will work to place the newest version of the conflicted dependency into
your own dependency list. This can cause problems as well, but is less likely to fail than using an older version
of a library that doesn&#8217;t have some needed feature of bug fix.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_basic_ui_components"><a class="anchor" href="#_basic_ui_components"></a><a class="link" href="#_basic_ui_components">2.3. Basic UI Components</a></h3>
<div class="paragraph">
<p>Fulcro supplies <code>defsc</code> to build React components. This macro emits React components that work as 100% raw React
components (i.e. once you compile them to Javascript they could be used from other native React code).</p>
</div>
<div class="paragraph">
<p>There are also factory functions for generating all standard HTML5 DOM elements in React in the <code>fulcro.client.dom</code> namespace.</p>
</div>
<div class="sect3">
<h4 id="_the_code_defsc_code_macro"><a class="anchor" href="#_the_code_defsc_code_macro"></a><a class="link" href="#_the_code_defsc_code_macro">2.3.1. The <code>defsc</code> Macro</a></h4>
<div class="paragraph">
<p>The basic code to build a simple component has the following form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc ComponentName
  <span class="comment">; optional: &quot;docstring&quot;</span>
  [this props] <span class="comment">; parameters. Availble in body, and in *some* of the options</span>
  <span class="comment">; optional:  { ...options... }</span>
  (dom/div <span class="error">#</span>js {<span class="symbol">:className</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>}
    (dom/p <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello</span><span class="delimiter">&quot;</span></span>)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>for our purposes we won&#8217;t be saying much about the React lifecycle methods, though they can be added. The basic
intention of this macro&#8217;s syntax is to declare a component that can render UI and participate in our
data-driven story.</p>
</div>
<div class="paragraph">
<p>This macro emits the equivalent of a React component with a <code>render</code> method.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_code_render_code_method"><a class="anchor" href="#_the_code_render_code_method"></a><a class="link" href="#_the_code_render_code_method">2.3.2. The <code>render</code> method.</a></h4>
<div class="paragraph">
<p>The body of <code>defsc</code> is the render for the component and can do whatever work you need, but it should return
a react element (see <a href="https://facebook.github.io/react/blog/2015/12/18/react-components-elements-and-instances.html">React Components, Elements, and Instances</a>).</p>
</div>
<div class="paragraph">
<p>Luckily, there are factory methods for all of HTML5 in <code>fulcro.client.dom</code>. These functions generally take a Javascript map
as their first argument (for things like classname and event handlers) and any children. There are two ways to
generate the Javascript map: with the reader tag <code>#js</code> or with <code>clj-&gt;js</code>. Thus the following two are functionally
equivalent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(dom/div <span class="error">#</span>js {<span class="symbol">:className</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>} <span class="string"><span class="delimiter">&quot;</span><span class="content">Hi</span><span class="delimiter">&quot;</span></span>)
(dom/div (clj-&gt;js {<span class="symbol">:className</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>}) <span class="string"><span class="delimiter">&quot;</span><span class="content">Hi</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, the former happens in the reader (before compile) and generates more efficient runtime code, but the
latter is useful when you&#8217;ve computed attributes in regular clj data structures and need to convert it at runtime.</p>
</div>
</div>
<div class="sect3">
<h4 id="_props"><a class="anchor" href="#_props"></a><a class="link" href="#_props">2.3.3. Props</a></h4>
<div class="paragraph">
<p>React components receive their data through props and state (which is local mutable state on the component).
In Fulcro we highly recommend using props for most things. This
ensures that various other features work well. The data passed to a component can be accessed (as a cljs map) by
calling <code>prim/props</code> on <code>this</code>, or by destructuring in the second argument of <code>defsc</code>.</p>
</div>
<div class="paragraph">
<p>So, let&#8217;s define a <code>Person</code> component to display details about
a person. We&#8217;ll assume that we&#8217;re going to pass in name and age as properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Person [this {<span class="symbol">:keys</span> [person/name person/age]}]
  (dom/div <span class="predefined-constant">nil</span>
    (dom/p <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Name: </span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>)
    (dom/p <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Age: </span><span class="delimiter">&quot;</span></span> age)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, in order to use this component we need an element factory. An element factory lets
us use the component within our React UI tree. Name confusion can become an
issue (Person the component vs. person the factory?) we recommend prefixing the factory with <code>ui-</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">ui-person</span> (prim/factory Person))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can compose people into our root:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Root [this {<span class="symbol">:keys</span> [ui/react-key]}]
  (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> react-key }
    (ui-person {<span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/age</span> <span class="integer">22</span>})))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hot_code_reload"><a class="anchor" href="#_hot_code_reload"></a><a class="link" href="#_hot_code_reload">2.3.4. Hot Code Reload</a></h4>
<div class="paragraph">
<p>Part of our quick development story is getting hot code reload to update the UI whenever we change the source.
If you were to omit the outer <code>div</code> in the above example it would look broken. Actually, hot code
reload is working, but the UI refresh isn&#8217;t.</p>
</div>
<div class="paragraph">
<p>You can force React to re-render the entire UI (Fulcro optimizes away refresh when the app state hasn&#8217;t changed).
The trick here is to change the React key on the root element (which forces React to throw away the prior tree
and generate a whole new one). Fulcro helps by sending your root component a property named <code>:ui/react-key</code> that
only changes on (re)mount and forced refresh.</p>
</div>
<div class="paragraph">
<p>Try editing the UI of <code>Person</code> and save. You should see the UI update even though the person&#8217;s data didn&#8217;t change.</p>
</div>
</div>
<div class="sect3">
<h4 id="_composing"><a class="anchor" href="#_composing"></a><a class="link" href="#_composing">2.3.5. Composing</a></h4>
<div class="paragraph">
<p>You should already be getting the picture that your UI is going to be a tree composed from a root element. The
method of data passing (via props) should also be giving you the picture that supplying data to your UI (through root)
means you need to supply an equivalently structured tree of data. This is true of basic React.
However, just to drive the point home let&#8217;s make a slightly more complex UI and see it in detail:</p>
</div>
<div class="paragraph">
<p>Replace your content with this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Person [this {<span class="symbol">:keys</span> [person/name person/age]}]
  (dom/li <span class="predefined-constant">nil</span>
    (dom/h5 <span class="predefined-constant">nil</span> <span class="keyword">name</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">(age: </span><span class="delimiter">&quot;</span></span> age <span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span>))))

(<span class="keyword">def</span> <span class="function">ui-person</span> (prim/factory Person {<span class="symbol">:keyfn</span> <span class="symbol">:person/name</span>}))

(defsc PersonList [this {<span class="symbol">:keys</span> [person-list/label person-list/people]}]
  (dom/div <span class="predefined-constant">nil</span>
    (dom/h4 <span class="predefined-constant">nil</span> label)
    (dom/ul <span class="predefined-constant">nil</span>
      (<span class="keyword">map</span> ui-person people))))

(<span class="keyword">def</span> <span class="function">ui-person-list</span> (prim/factory PersonList))

(defsc Root [this {<span class="symbol">:keys</span> [ui/react-key]}]
  (<span class="keyword">let</span> [ui-data {<span class="symbol">:friends</span> {<span class="symbol">:person-list/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person-list/people</span>
                                              [{<span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/age</span> <span class="integer">32</span>}
                                               {<span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/age</span> <span class="integer">22</span>}]}
                 <span class="symbol">:enemies</span> {<span class="symbol">:person-list/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Enemies</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person-list/people</span>
                                              [{<span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/age</span> <span class="integer">11</span>}
                                               {<span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Bobby</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/age</span> <span class="integer">55</span>}]}}]
    (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> react-key}
      (ui-person-list (<span class="symbol">:friends</span> ui-data))
      (ui-person-list (<span class="symbol">:enemies</span> ui-data)))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>So that the UI graph looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/ui-graph.png" alt="ui graph" width="260" height="238">
</div>
</div>
<div class="paragraph">
<p>and the data graph matches the same structure, with map keys acting as the graph "edges":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:friends</span>           { <span class="symbol">:person-list/people</span> [PERSON <span class="keyword">..</span><span class="keyword">.</span>]
<span class="comment">;  ==to-one list=&gt;      ==to-many people==&gt;</span>
  <span class="symbol">:enemies</span>           { <span class="symbol">:person-list/people</span> [PERSON <span class="keyword">..</span><span class="keyword">.</span>] }</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/data-tree.png" alt="data tree" width="280" height="238">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_feeding_the_data_tree"><a class="anchor" href="#_feeding_the_data_tree"></a><a class="link" href="#_feeding_the_data_tree">2.4. Feeding the Data Tree</a></h3>
<div class="paragraph">
<p>Obviously it isn&#8217;t going to be desirable to hand-manage this very well for anything
but the most trivial application (which is the crux of the problems with most UI libraries).</p>
</div>
<div class="paragraph">
<p>At best it does give us a persistent data structure that represents the
current "view" of the application (which has many benefits), but at worst it requires us to "think globally"
about our application. We want local reasoning. We also want to be able to easily re-compose our UI as needed,
and a static data graph like this would have to be updated every time we made a change! Almost equally as bad: if
two different parts of our UI want to show the same data then we&#8217;d have to find and update a bunch of copies
spread all over the data tree.</p>
</div>
<div class="paragraph">
<p>So, how do we solve this?</p>
</div>
<div class="sect3">
<h4 id="_why_not_have_components_just_grab_their_data_sideband"><a class="anchor" href="#_why_not_have_components_just_grab_their_data_sideband"></a><a class="link" href="#_why_not_have_components_just_grab_their_data_sideband">2.4.1. Why not have components just "grab" their data (sideband)?</a></h4>
<div class="paragraph">
<p>This is certainly a possibility; however, it leads to other complications. What is the data model? How do you
interact with remotes to fill your data needs? Fulcro has a very nice cohesive story for these questions,
while other systems end up with complications like event handler middleware, coeffect accretion,
and signal graphs&#8230;&#8203;not to mention that the sideband solution says nothing definitive about how you actually
<strong>accomplish</strong> the server interactions with said data model.</p>
</div>
<div class="paragraph">
<p>Fulcro has a model for all of this, and it is surprising how simple it makes your application once you
put your appliation together.  Let&#8217;s look at the steps and parts:</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_1_the_initial_state"><a class="anchor" href="#_step_1_the_initial_state"></a><a class="link" href="#_step_1_the_initial_state">2.4.2. Step 1&#8201;&#8212;&#8201;The Initial State</a></h4>
<div class="paragraph">
<p>All applications have some starting initial state. Since our UI is a tree, our starting state needs to
somehow establish what goes to the initial nodes.</p>
</div>
<div class="paragraph">
<p>In Fulcro, there is a way to construct the initial tree of data in a way that allows for local reasoning and
easy refactoring: co-locate the initial desired part of the tree with the component that uses it. This allows
you to compose the state tree in exactly the same way as the UI tree.</p>
</div>
<div class="paragraph">
<p>Fulcro defines a protocol <code>InitialAppState</code> with a single method named <code>initial-state</code>. The defui macro
will allow us to add that implementation to the generated component class by adding <code>static</code> in front of
the protocol name we want to implement.</p>
</div>
<div class="paragraph">
<p>The <code>defsc</code> macro makes this much shorter: use a simple lambda that gets parameters (optionally from
the parent) and returns a map representing the state of the component.</p>
</div>
<div class="paragraph">
<p>It looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.ui.root</span>
  (<span class="symbol">:require</span>
    translations.es
    [fulcro.client.dom <span class="symbol">:as</span> dom]
    [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defsc]]))

(defsc Person [this {<span class="symbol">:keys</span> [person/name person/age]}]
  { <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [<span class="keyword">name</span> age] <span class="symbol">:as</span> params}] {<span class="symbol">:person/name</span> <span class="keyword">name</span> <span class="symbol">:person/age</span> age}) }
  (dom/li <span class="predefined-constant">nil</span>
    (dom/h5 <span class="predefined-constant">nil</span> <span class="keyword">name</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">(age: </span><span class="delimiter">&quot;</span></span> age <span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span>))))

(<span class="keyword">def</span> <span class="function">ui-person</span> (prim/factory Person {<span class="symbol">:keyfn</span> <span class="symbol">:person/name</span>}))

(defsc PersonList [this {<span class="symbol">:keys</span> [person-list/label person-list/people]}]
  {<span class="symbol">:initial-state</span>
   (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [label]}]
     {<span class="symbol">:person-list/label</span>  label
      <span class="symbol">:person-list/people</span> (<span class="keyword">if</span> (<span class="keyword">=</span> label <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>)
                            [(prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">32</span>})
                             (prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">22</span>})]
                            [(prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">11</span>})
                             (prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Bobby</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">55</span>})])})}
   (dom/div <span class="predefined-constant">nil</span>
     (dom/h4 <span class="predefined-constant">nil</span> label)
     (dom/ul <span class="predefined-constant">nil</span>
       (<span class="keyword">map</span> ui-person people))))

(<span class="keyword">def</span> <span class="function">ui-person-list</span> (prim/factory PersonList))

<span class="comment">; Root's initial state becomes the entire app's initial state!</span>
(defsc Root [this {<span class="symbol">:keys</span> [ui/react-key friends enemies]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:friends</span> (prim/get-initial-state PersonList {<span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>})
                                <span class="symbol">:enemies</span> (prim/get-initial-state PersonList {<span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Enemies</span><span class="delimiter">&quot;</span></span>})}) }
  (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> react-key}
    (ui-person-list friends)
    (ui-person-list enemies)))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You <strong>must</strong> reload your browser for this to show up. Fulcro pulls this data into the database when the
application <strong>first mounts</strong>, not on hot code reload (because that would change your app state, and hot
code reload is more useful without state changes).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now a lot of the specific data here is just for demonstration purposes. Data like this (people) would almost
certainly come from a server, but it serves to illustrate that we can localize the initial data needs of a
component to the component, and then compose that into the parent in an abstract way
(by calling <code>get-initial-state</code> against that child).</p>
</div>
<div class="paragraph">
<p>There are several benefits of this so far:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It generates the exact tree of data needed to feed the initial UI.</p>
</li>
<li>
<p>That initial state becomes your initial application database.</p>
</li>
<li>
<p>It restores local reasoning (and easy refactoring). Moving a component just means local reasoning about the
component being moved and the component it is being moved from/to: You remove the the <code>get-initial-state</code> from one
parent and add it to a different one.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can see that there is no magic if you just pull the initial tree at the REPL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dev:cljs.user=&gt; (fulcro.client.primitives/get-initial-state app.ui.root/Root {})
{:friends
 {:person-list/label "Friends",
  :person-list/people
  [{:person/name "Sally", :person/age 32}
   {:person/name "Joe", :person/age 22}]},
 :enemies
 {:person-list/label "Enemies",
  :person-list/people
  [{:person/name "Fred", :person/age 11}
   {:person/name "Bobby", :person/age 55}]}}</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s nothing more than function composition. The initial state option on <code>defsc</code> encodes your initial state
into a function that can be accessed via <code>get-initial-state</code> on a class.</p>
</div>
<div class="paragraph">
<p>So behind the scenes Fulcro detects the initial state on the first mount and automatically uses it to initialize your
application state.</p>
</div>
<div class="paragraph">
<p>By default, the entire initial state database is passed into your root node on render, so it is
available for destructuring in Root&#8217;s props.</p>
</div>
<div class="paragraph">
<p>If you even want to see your current application state, you can do so through the atom that is holding
your mounted application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">dev<span class="symbol">:cljs.user</span>=&gt; @(fulcro.client.primitives/app-state (<span class="keyword">get</span> @app.client/app <span class="symbol">:reconciler</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see how we program our UI to access the data in the application state!</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_2_establishing_a_query"><a class="anchor" href="#_step_2_establishing_a_query"></a><a class="link" href="#_step_2_establishing_a_query">2.4.3. Step 2&#8201;&#8212;&#8201;Establishing a Query</a></h4>
<div class="paragraph">
<p>Fulcro unifies the data access story using a co-located query on each component. This sets up data access
for both the client and server, and also continues our story of local reasoning and composition.</p>
</div>
<div class="paragraph">
<p>Queries go on a component in the same way as initial state: as <code>static</code> implementations of a protocol.</p>
</div>
<div class="paragraph">
<p>The query notation is relatively light, and we&#8217;ll just concentrate on two bits of query syntax: props and joins.</p>
</div>
<div class="paragraph">
<p>Queries form a tree just like the UI and data. Obtaining a value at the current node in the tree traversal is done
using the keyword for that value. Walking down the graph (a join) is represented as a map with a single entry whose
key is the keyword for that nested bit of state.</p>
</div>
<div class="paragraph">
<p>So, a data tree like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:friends</span>
 {<span class="symbol">:person-list/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>,
  <span class="symbol">:person-list/people</span>
  [{<span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:person/age</span> <span class="integer">32</span>}
   {<span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:person/age</span> <span class="integer">22</span>}]},
 <span class="symbol">:enemies</span>
 {<span class="symbol">:person-list/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Enemies</span><span class="delimiter">&quot;</span></span>,
  <span class="symbol">:person-list/people</span>
  [{<span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:person/age</span> <span class="integer">11</span>}
   {<span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Bobby</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:person/age</span> <span class="integer">55</span>}]}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>would have a query that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[{<span class="symbol">:friends</span>  <span class="comment">; JOIN</span>
    [ <span class="symbol">:person-list/label</span>
      {<span class="symbol">:person-list/people</span> <span class="comment">; JOIN</span>
         [<span class="symbol">:person/name</span> <span class="symbol">:person/age</span>]}]}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query reads "At the root you&#8217;ll find <code>:friends</code>, which joins to a nested entity that has a label and people,
which in turn has nested properties name and age.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A vector always means "get this stuff at the current node"</p>
</li>
<li>
<p><code>:friends</code> is a key in a map, so at the root of the application state the query engine would expect to find that
key, and would expect the value to be nested state (because maps mean joins on the tree)</p>
</li>
<li>
<p>The value in the <code>:friends</code> join must be a vector, because we have to indicate what we want out of the nested data.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Joins are automatically <code>to-one</code> if the data found in the state is a map, and <code>to-many</code> if the data found is a
vector.</p>
</div>
<div class="paragraph">
<p>The namespacing of keywords in your data (and therefore your query) is highly encouraged, as it makes it clear to the
reader what kind of entity you&#8217;re working against (it also ensures that over-rendering doesn&#8217;t happen on
refreshes later).</p>
</div>
<div class="paragraph">
<p>You can try this query stuff out in your REPL. Let&#8217;s say you just want the friends list label. The function
<code>db-&gt;tree</code> can take an application database (which we can generate from initial state) and run a query
against it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">dev<span class="symbol">:cljs.user</span>=&gt; (fulcro.client.primitives/db-&gt;tree [{<span class="symbol">:friends</span> [<span class="symbol">:person-list/label</span>]}] (fulcro.client.primitives/get-initial-state app.ui.root/Root {}) {})
{<span class="symbol">:friends</span> {<span class="symbol">:person-list/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>HINT: The mirror of initial state with query is a great way to error-check your work (and <code>defsc</code> does some of that
for you): For each scalar property in
initial state, there should be an identical simple property in your query. For each join of initial state to a child via
<code>get-initial-state</code> there should be a query join via <code>get-query</code> to that same child.</p>
</div>
<div class="sect4">
<h5 id="_adding_queries_our_example"><a class="anchor" href="#_adding_queries_our_example"></a><a class="link" href="#_adding_queries_our_example">Adding Queries Our Example</a></h5>
<div class="paragraph">
<p>We want our queries to have the same nice local-reasoning as our initial data tree. The <code>get-query</code> function
works just like the <code>get-initial-state</code> function, and can pull the query from a component. In this case, you
should <strong>not</strong> ever call <code>query</code> directly. The <code>get-query</code> function augments the subqueries with metadata that is
important at a later stage.</p>
</div>
<div class="paragraph">
<p>So, the <code>Person</code> component queries for just the properties it needs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Person [this {<span class="symbol">:keys</span> [person/name person/age]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:person/name</span> <span class="symbol">:person/age</span>]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [<span class="keyword">name</span> age] <span class="symbol">:as</span> params}] {<span class="symbol">:person/name</span> <span class="keyword">name</span> <span class="symbol">:person/age</span> age})}
  (dom/li <span class="predefined-constant">nil</span>
    (dom/h5 <span class="predefined-constant">nil</span> <span class="keyword">name</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">(age: </span><span class="delimiter">&quot;</span></span> age <span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span>))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the entire rest of the component <strong>did not</strong> change.</p>
</div>
<div class="paragraph">
<p>Next up the chain, we compose the <code>Person</code> query into <code>PersonList</code> (notice how the composition of state and query
are mirrored):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc PersonList [this {<span class="symbol">:keys</span> [person-list/label person-list/people]}]
  {<span class="symbol">:query</span> [<span class="symbol">:person-list/label</span> {<span class="symbol">:person-list/people</span> (prim/get-query Person)}]
   <span class="symbol">:initial-state</span>
          (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [label]}]
            {<span class="symbol">:person-list/label</span>  label
             <span class="symbol">:person-list/people</span> (<span class="keyword">if</span> (<span class="keyword">=</span> label <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>)
                                   [(prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">32</span>})
                                    (prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">22</span>})]
                                   [(prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">11</span>})
                                    (prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Bobby</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">55</span>})])})}
  (dom/div <span class="predefined-constant">nil</span>
    (dom/h4 <span class="predefined-constant">nil</span> label)
    (dom/ul <span class="predefined-constant">nil</span>
      (<span class="keyword">map</span> ui-person people))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>again, nothing else changes.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_step_3_receive_the_data_feed_as_props_in_root"><a class="anchor" href="#_step_3_receive_the_data_feed_as_props_in_root"></a><a class="link" href="#_step_3_receive_the_data_feed_as_props_in_root">2.4.4. Step 3&#8201;&#8212;&#8201;Receive the Data Feed as Props in Root</a></h4>
<div class="paragraph">
<p>Finally, we compose to <code>Root</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Root [this {<span class="symbol">:keys</span> [ui/react-key friends enemies]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/react-key</span> {<span class="symbol">:friends</span> (prim/get-query PersonList)}
                   {<span class="symbol">:enemies</span> (prim/get-query PersonList)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:friends</span> (prim/get-initial-state PersonList {<span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>})
                                <span class="symbol">:enemies</span> (prim/get-initial-state PersonList {<span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Enemies</span><span class="delimiter">&quot;</span></span>})})}
  (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> react-key}
    (ui-person-list friends)
    (ui-person-list enemies)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This all looks like a minor (and useless) change. The operation is the same; however, we&#8217;re getting close to
the magic, so stick with us. The major difference in this code is that even though the database <strong>starts
out</strong> with the initial state, there is nothing to say we have to query for everything that is in there,
or that the state has to start out with everything we might query for in the future. We&#8217;re getting
close to having a dynamic data-driven application.</p>
</div>
<div class="paragraph">
<p>Notice that everything we&#8217;ve done so far has <strong>global client database</strong> implications, but that each component
codes only the portion it is concerned with. Local reasoning is maintained. All software evolution in
this model preserves this critical aspect.</p>
</div>
<div class="paragraph">
<p>Also, you now have application state that can evolve (the query is running against the active application
database stored in an atom)!</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You should always think of the query as "running from root". You&#8217;ll
notice that <code>Root</code> still expects to receive the <strong>entire</strong> data tree for the UI (even though it doesn&#8217;t have to
know much about what is in it, other than the names of direct children), and it still picks out those sub-trees
of data and passes them on. In this way an arbitrary component in the UI tree is not querying
for it&#8217;s data directly in a side-band sort of way, but is instead being composed in from parent to parent all the
way to the root. Later, we&#8217;ll learn how Fulcro can optimize this and pull the data from the database for
a specific component, but the reasoning will remain the same.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_passing_callbacks_and_other_parent_computed_data"><a class="anchor" href="#_passing_callbacks_and_other_parent_computed_data"></a><a class="link" href="#_passing_callbacks_and_other_parent_computed_data">2.5. Passing Callbacks and Other Parent-computed Data</a></h3>
<div class="paragraph">
<p>The queries on component describe what data the component wants from the database; however, you&#8217;re not allowed
to put code in the database, and sometimes a parent might compute something it needs to pass to a child like
a callback function.</p>
</div>
<div class="paragraph">
<p>It turns out that we <strong>can</strong> optimize away the refresh of components (if their data has not changed). This
means that we can use a component&#8217;s query to directly re-supply data for refresh; however, since doing so
skips the rendering of the parent, if we are not careful this can lead to "losing" these extra bits of
computationally generated data passed <strong>from</strong> the parent, like callbacks.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say we want to render a delete button on our individual people in our UI. This button will mean
"remove the person from this list"&#8230;&#8203;but the person itself has no idea which list it is in. Thus,
the parent will need to pass in a function that the child can call to affect the delete properly:</p>
</div>
<div class="sect3">
<h4 id="_the_incorrect_way"><a class="anchor" href="#_the_incorrect_way"></a><a class="link" href="#_the_incorrect_way">2.5.1. The Incorrect Way:</a></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Person [this {<span class="symbol">:keys</span> [person/name person/age onDelete]}] <span class="comment">; </span><b class="conum">(3)</b>
  {<span class="symbol">:query</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:person/name</span> <span class="symbol">:person/age</span>])
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [<span class="keyword">name</span> age] <span class="symbol">:as</span> params}] {<span class="symbol">:person/name</span> <span class="keyword">name</span> <span class="symbol">:person/age</span> age})}
  (dom/li <span class="predefined-constant">nil</span>
    (dom/h5 <span class="predefined-constant">nil</span> <span class="keyword">name</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">(age: </span><span class="delimiter">&quot;</span></span> age <span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span>) (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(onDelete <span class="keyword">name</span>)} <span class="string"><span class="delimiter">&quot;</span><span class="content">X</span><span class="delimiter">&quot;</span></span>)))) <span class="comment">; </span><b class="conum">(4)</b>

(<span class="keyword">def</span> <span class="function">ui-person</span> (prim/factory Person {<span class="symbol">:keyfn</span> <span class="symbol">:person/name</span>}))

(defsc PersonList [this {<span class="symbol">:keys</span> [person-list/label person-list/people]}]
  {<span class="symbol">:query</span> [<span class="symbol">:person-list/label</span> {<span class="symbol">:person-list/people</span> (prim/get-query Person)}]
   <span class="symbol">:initial-state</span>
          (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [label]}]
            {<span class="symbol">:person-list/label</span>  label
             <span class="symbol">:person-list/people</span> (<span class="keyword">if</span> (<span class="keyword">=</span> label <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>)
                                   [(prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">32</span>})
                                    (prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">22</span>})]
                                   [(prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">11</span>})
                                    (prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Bobby</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">55</span>})])})}
  (<span class="keyword">let</span> [delete-person (<span class="keyword">fn</span> [<span class="keyword">name</span>] (<span class="keyword">println</span> label <span class="string"><span class="delimiter">&quot;</span><span class="content">asked to delete</span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>))]  <span class="comment">; </span><b class="conum">(1)</b>
    (dom/div <span class="predefined-constant">nil</span>
      (dom/h4 <span class="predefined-constant">nil</span> label)
      (dom/ul <span class="predefined-constant">nil</span>
        (<span class="keyword">map</span> (<span class="keyword">fn</span> [p] (ui-person (<span class="keyword">assoc</span> p <span class="symbol">:onDelete</span> delete-person))) people))))) <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A function acting in as a stand-in for our real delete</p>
</li>
<li>
<p>Adding the callback into the props (WRONG)</p>
</li>
<li>
<p>Pulling the onDelete from the passed props (WRONG). The query has to be changed to a lambda to turn off error checking to even try this method.</p>
</li>
<li>
<p>Invoking the callback when delete is pressed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This method of passing a callback will work initially, but not consistently. The problem is that we can optimize away a
re-render of a parent when it can figure out how to pull just the data of the child on a refresh, and in that case the
callback will get lost because only the database data will get supplied to the child! Your delete button will work
on the initial render (from root), but may stop working at a later time after a UI refresh.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_correct_way"><a class="anchor" href="#_the_correct_way"></a><a class="link" href="#_the_correct_way">2.5.2. The Correct Way:</a></h4>
<div class="paragraph">
<p>There is a special helper function that can record the computed data like callbacks onto the child that receives them
such that an optimized refresh will still know them. There is also an additional (optional) component parameter to <code>defsc</code>
that you can use to deconstruct them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Person [this {<span class="symbol">:keys</span> [person/name person/age]} {<span class="symbol">:keys</span> [onDelete]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:person/name</span> <span class="symbol">:person/age</span>]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [<span class="keyword">name</span> age] <span class="symbol">:as</span> params}] {<span class="symbol">:person/name</span> <span class="keyword">name</span> <span class="symbol">:person/age</span> age})}
  (dom/li <span class="predefined-constant">nil</span>
    (dom/h5 <span class="predefined-constant">nil</span> <span class="keyword">name</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">(age: </span><span class="delimiter">&quot;</span></span> age <span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span>) (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(onDelete <span class="keyword">name</span>)} <span class="string"><span class="delimiter">&quot;</span><span class="content">X</span><span class="delimiter">&quot;</span></span>)))) <span class="comment">; </span><b class="conum">(4)</b>

(<span class="keyword">def</span> <span class="function">ui-person</span> (prim/factory Person {<span class="symbol">:keyfn</span> <span class="symbol">:person/name</span>}))

(defsc PersonList [this {<span class="symbol">:keys</span> [person-list/label person-list/people]}] <span class="comment">; </span><b class="conum">(2)</b>
  {<span class="symbol">:query</span> [<span class="symbol">:person-list/label</span> {<span class="symbol">:person-list/people</span> (prim/get-query Person)}]
   <span class="symbol">:initial-state</span>
          (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [label]}]
            {<span class="symbol">:person-list/label</span>  label
             <span class="symbol">:person-list/people</span> (<span class="keyword">if</span> (<span class="keyword">=</span> label <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>)
                                   [(prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">32</span>})
                                    (prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">22</span>})]
                                   [(prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">11</span>})
                                    (prim/get-initial-state Person {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Bobby</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">55</span>})])})}
  (<span class="keyword">let</span> [delete-person (<span class="keyword">fn</span> [<span class="keyword">name</span>] (<span class="keyword">println</span> label <span class="string"><span class="delimiter">&quot;</span><span class="content">asked to delete</span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>))] <span class="comment">; </span><b class="conum">(1)</b>
    (dom/div <span class="predefined-constant">nil</span>
      (dom/h4 <span class="predefined-constant">nil</span> label)
      (dom/ul <span class="predefined-constant">nil</span>
        (<span class="keyword">map</span> (<span class="keyword">fn</span> [p] (ui-person (prim/computed p {<span class="symbol">:onDelete</span> delete-person}))) people))))) <span class="comment">; </span><b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>prim/computed</code> function is used to add the computed data to the props being passed.</p>
</li>
<li>
<p>The child adds an additional parameter, and pulls the computed data from there. You can also
use <code>(prim/get-computed this)</code> to pull all of the computed props in the body.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now you can be sure that your callbacks (or other parent-computed data) won&#8217;t be lost to render optimizations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_the_data_tree"><a class="anchor" href="#_updating_the_data_tree"></a><a class="link" href="#_updating_the_data_tree">2.6. Updating the Data Tree</a></h3>
<div class="paragraph">
<p>Now the real fun begins: Making things dynamic.</p>
</div>
<div class="paragraph">
<p>In general you don&#8217;t have to think about how the UI updates, because most changes are run within the
context that needs refreshed. But for general knowledge UI Refresh is triggered in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Running a data modification transaction on a component (which will re-render the subtree of that component), and
refresh only the DOM for those bits that had actual changes.</p>
</li>
<li>
<p>Telling Fulcro that some specific data changed (e.g. :person/name).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The former is most common, but the latter is often needed when a change executed in one part of the application
modifies data that some UI component elsewhere in the tree needs to respond to.</p>
</div>
<div class="paragraph">
<p>So, if we run the code that affects changes from the component that will need to refresh (a very common case) we&#8217;re
covered. If a child needs to make a change that will affect a parent (as in our earlier example), then the
modification should run from the parent via a callback so that refresh will not require further interaction. Later we&#8217;ll
show you how to deal with refreshes that could be in far-flung parts of the UI. First, let&#8217;s get some data
changing.</p>
</div>
<div class="sect3">
<h4 id="_transactions"><a class="anchor" href="#_transactions"></a><a class="link" href="#_transactions">2.6.1. Transactions</a></h4>
<div class="paragraph">
<p>Every change to the application database must go through a transaction processing system. This has two
goals:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Abstract the operation (like a function)</p>
</li>
<li>
<p>Treat the operation like data (which allows us to generalize it to remote interactions)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The operations are written as quoted data structures. Specifically as a vector of mutation
invocations. The entire transaction is just data. It is <strong>not</strong> something run in the UI, but instead
passed into the underlying system for processing.</p>
</div>
<div class="paragraph">
<p>You essentially just "make up" names for the operations you&#8217;d like to do to your database, just like
function names. Namespacing is encouraged, and of course syntax quoting honors namespace aliases.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(prim/transact! this `[(ops/delete-person {<span class="symbol">:list-name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>})])</code></pre>
</div>
</div>
<div class="paragraph">
<p>is asking the underlying system to run the mutation <code>ops/delete-person</code> (where ops can be an alias established
in the <code>ns</code>). Of course, you&#8217;ll typically use unquote to embed data from local variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(prim/transact! this `[(ops/delete-person {<span class="symbol">:list-name</span> ~<span class="keyword">name</span> <span class="symbol">:person</span> ~person})])</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_handling_mutations"><a class="anchor" href="#_handling_mutations"></a><a class="link" href="#_handling_mutations">2.6.2. Handling Mutations</a></h4>
<div class="paragraph">
<p>When a transaction runs in Fulcro, it passes things off to a multimethod. This multi-method is described in more
detail in the Fulcro Developer&#8217;s Guide, but Fulcro provides a macro that makes
building (and using) them easier: <code>defmutation</code>.</p>
</div>
<div class="paragraph">
<p>The template application comes with a pre-built namespace for these <code>src/main/app/api/mutations.cljs</code>, but you can put them anywhere as long
as the namespace in question is required by your application at runtime. Note there is also a <code>mutations.clj</code>, which is
for the server-side handling of these same mutations.</p>
</div>
<div class="paragraph">
<p>A mutation looks a bit like a method. It can have a docstring, and the argument list will always receive a
single argument (params) that will be a map (which then allows destructuring).</p>
</div>
<div class="paragraph">
<p>The body looks a bit like a <code>letfn</code>, but the names we use for these methods are pre-established. The one
we&#8217;re interested in at the moment is <code>action</code>, which is what to do <strong>locally</strong>. The <code>action</code> method will be
passed the application database&#8217;s app-state atom, and it should change the data in that atom to reflect
the new "state of the world" indicated by the mutation.</p>
</div>
<div class="paragraph">
<p>For example, <code>delete-person</code> must find the list of people on the list in question, and filter out the one
that we&#8217;re deleting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.api.mutations</span>
  (<span class="symbol">:require</span> [fulcro.client.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]))

(defmutation delete-person
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Mutation: Delete the person with name from the list with list-name</span><span class="delimiter">&quot;</span></span>
  [{<span class="symbol">:keys</span> [list-name <span class="keyword">name</span>]}] <span class="comment">; </span><b class="conum">(1)</b>
  (action [{<span class="symbol">:keys</span> [state]}] <span class="comment">; </span><b class="conum">(2)</b>
    (<span class="keyword">let</span> [path     (<span class="keyword">if</span> (<span class="keyword">=</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span> list-name)
                     [<span class="symbol">:friends</span> <span class="symbol">:person-list/people</span>]
                     [<span class="symbol">:enemies</span> <span class="symbol">:person-list/people</span>])
          old-list (<span class="keyword">get-in</span> @state path)
          new-list (<span class="keyword">vec</span> (<span class="keyword">filter</span> #(<span class="keyword">not</span><span class="keyword">=</span> (<span class="symbol">:person/name</span> %) <span class="keyword">name</span>) old-list))]
      (<span class="keyword">swap!</span> state <span class="keyword">assoc-in</span> path new-list))))</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The argument list for the mutation itself</p>
</li>
<li>
<p>The thing to do, which receives the app-state atom as an argument.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Then all that remains is to change <code>basic-ui</code> in the following ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a require and alias for app.operations to the ns</p>
</li>
<li>
<p>Change the callback to run the transaction</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.basic-ui</span>
  (<span class="symbol">:require</span> [fulcro.client <span class="symbol">:as</span> fc]
            [fulcro.client.dom <span class="symbol">:as</span> dom]
            <span class="comment">; ADD THIS:</span>
            [app.api.mutations <span class="symbol">:as</span> api] <span class="comment">; </span><b class="conum">(1)</b>
            [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defui defsc]]))

<span class="keyword">..</span><span class="keyword">.</span>

(defsc PersonList [this {<span class="symbol">:keys</span> [person-list/label person-list/people]}]
  <span class="keyword">..</span><span class="keyword">.</span>
  (<span class="keyword">let</span> [delete-person (<span class="keyword">fn</span> [<span class="keyword">name</span>] (prim/transact! this `[(api/delete-person {<span class="symbol">:list-name</span> ~label <span class="symbol">:name</span> ~<span class="keyword">name</span>})]))] <span class="comment">; </span><b class="conum">(2)</b>
  <span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The require ensures that the mutations are loaded, and also gives us an alias to the namespace of the mutation&#8217;s symbol.</p>
</li>
<li>
<p>Running the transaction in the callback.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that our mutation&#8217;s symbol is actually <code>app.api.mutations/delete-person</code>, but the syntax quoting will fix it.
Also realize that the mutation is <strong>not</strong> running in the UI, it is instead being handled "behind the scenes". This
allows a snapshot of the state history to be kept, and also a more seamless integration to full-stack operation
over a network to a server (in fact, the UI code here is <strong>already</strong> full-stack capable <strong>without any changes</strong>!).</p>
</div>
<div class="paragraph">
<p>This is where the power starts to show: all of the minutiae above is leading us to some grand unifications when
it comes to writing full-stack applications.</p>
</div>
</div>
<div class="sect3">
<h4 id="_hold_on_this_sucks"><a class="anchor" href="#_hold_on_this_sucks"></a><a class="link" href="#_hold_on_this_sucks">2.6.3. Hold on – This Sucks!</a></h4>
<div class="paragraph">
<p>But first, we should address a problem that many of you may have already noticed: The mutation code is tied to
the shape of the UI tree!!!</p>
</div>
<div class="paragraph">
<p>This breaks our lovely model in several ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We can&#8217;t refactor our UI without also rewriting the mutations (since the data tree would change shape)</p>
</li>
<li>
<p>We can&#8217;t locally reason about any data. Our mutations have to understand things globally!</p>
</li>
<li>
<p>Our mutations could get rather large and ugly as our UI gets big</p>
</li>
<li>
<p>If a fact appears in more than one place in the UI and data tree, then we&#8217;ll have to update <strong>all</strong> of them
in order for things to be correct. Data duplication is never your friend.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_secret_sauce_normalizing_the_database"><a class="anchor" href="#_the_secret_sauce_normalizing_the_database"></a><a class="link" href="#_the_secret_sauce_normalizing_the_database">2.7. The Secret Sauce – Normalizing the Database</a></h3>
<div class="paragraph">
<p>Fortunately, we have a very good solution to the mutation problem above, and it is one that has been around for decades:
database normalization!</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what we&#8217;re going to do:</p>
</div>
<div class="paragraph">
<p>Each UI component represents some conceptual entity with data (assuming it has state and a query). In a fully
normalized database, each such concept would have its own table, and related things would refer to it
through some kind of foreign key. In SQL land this looks like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/sql-norm.png" alt="sql norm" width="760" height="196">
</div>
</div>
<div class="paragraph">
<p>In a graph database (like Datomic) a reference can have a to-many arity, so the direction can be more natural:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/datomic-norm.png" alt="datomic norm" width="630" height="168">
</div>
</div>
<div class="paragraph">
<p>Since we&#8217;re storing things in a map, we can represent "tables" as an entry in the map where the key is the
table name, and the value is a map from ID to entity value. So, the last diagram could be represented as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:PersonList</span> { <span class="integer">1</span>  { <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>
                     <span class="symbol">:people</span> #{<span class="integer">1</span>, <span class="integer">2</span>} }}
  <span class="symbol">:Person</span> { <span class="integer">1</span> {<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> }
            <span class="integer">2</span> {<span class="symbol">:id</span> <span class="integer">2</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is close, but not quite good enough. The set in <code>:person-list/people</code> is a problem. There is no schema, so there is no
way to know what kind of thing "1" and "2" are!</p>
</div>
<div class="paragraph">
<p>The solution is rather easy: code the foreign reference to <strong>include</strong> the name of the table (is a single such
"pointer", and to-many relations
store many such "pointers" in a vector (so you end up with a doubly-nested vector)):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:PersonList</span> { <span class="integer">1</span>  { <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>
                     <span class="symbol">:people</span> [ [<span class="symbol">:Person</span> <span class="integer">1</span>] [<span class="symbol">:Person</span> <span class="integer">2</span>] ] }}
  <span class="symbol">:Person</span> { <span class="integer">1</span> {<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> }
            <span class="integer">2</span> {<span class="symbol">:id</span> <span class="integer">2</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A foreign key as a vector pair of <code>[TABLE ID]</code> is known as an <code>Ident</code>.</p>
</div>
<div class="paragraph">
<p>So, now that we have the concept and implementation, let&#8217;s talk about conventions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Properties are usually namespaced (as shown in earlier examples)</p>
</li>
<li>
<p>Table names are usually namespaced with the entity type, and given a name that indicates how it is indexed.
For example: <code>:person/by-id</code>, <code>:person-list/by-name</code>, etc. If you use Clojure spec, you may choose to
alter this a bit for convenience in namespace-aliasing keywords (e.g. <code>::my-db-schema/person-by-id</code>).</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_automatic_normalization"><a class="anchor" href="#_automatic_normalization"></a><a class="link" href="#_automatic_normalization">2.7.1. Automatic Normalization</a></h4>
<div class="paragraph">
<p>Fortunately, you don&#8217;t have to hand-normalize your data. The components have almost everything they need to
do it for you, other than the actual value of the <code>Ident</code>. So, we&#8217;ll add one more option to your components
(and we&#8217;ll add IDs to the data at this point, for easier implementation):</p>
</div>
<div class="paragraph">
<p>The program will now look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.ui.root</span>
  (<span class="symbol">:require</span>
    translations.es
    [fulcro.client.dom <span class="symbol">:as</span> dom]
    [app.api.mutations <span class="symbol">:as</span> api]
    [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defsc]]))

(defsc Person [this {<span class="symbol">:keys</span> [db/id person/name person/age]} {<span class="symbol">:keys</span> [onDelete]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:db/id</span> <span class="symbol">:person/name</span> <span class="symbol">:person/age</span>] <span class="comment">; </span><b class="conum">(2)</b>
   <span class="symbol">:ident</span>         [<span class="symbol">:person/by-id</span> <span class="symbol">:db/id</span>] <span class="comment">; </span><b class="conum">(1)</b>
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [id <span class="keyword">name</span> age]}] {<span class="symbol">:db/id</span> id <span class="symbol">:person/name</span> <span class="keyword">name</span> <span class="symbol">:person/age</span> age})} <span class="comment">; </span><b class="conum">(3)</b>
  (dom/li <span class="predefined-constant">nil</span>
    (dom/h5 <span class="predefined-constant">nil</span> <span class="keyword">name</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">(age: </span><span class="delimiter">&quot;</span></span> age <span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span>) (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(onDelete id)} <span class="string"><span class="delimiter">&quot;</span><span class="content">X</span><span class="delimiter">&quot;</span></span>)))) <span class="comment">; </span><b class="conum">(4)</b>

(<span class="keyword">def</span> <span class="function">ui-person</span> (prim/factory Person {<span class="symbol">:keyfn</span> <span class="symbol">:person/name</span>}))

(defsc PersonList [this {<span class="symbol">:keys</span> [db/id person-list/label person-list/people]}]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:person-list/label</span> {<span class="symbol">:person-list/people</span> (prim/get-query Person)}]
   <span class="symbol">:ident</span> [<span class="symbol">:person-list/by-id</span> <span class="symbol">:db/id</span>] <span class="comment">; </span><b class="conum">(5)</b>
   <span class="symbol">:initial-state</span>
          (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [id label]}]
            {<span class="symbol">:db/id</span>              id
             <span class="symbol">:person-list/label</span>  label
             <span class="symbol">:person-list/people</span> (<span class="keyword">if</span> (<span class="keyword">=</span> label <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>)
                                   [(prim/get-initial-state Person {<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">32</span>})
                                    (prim/get-initial-state Person {<span class="symbol">:id</span> <span class="integer">2</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">22</span>})]
                                   [(prim/get-initial-state Person {<span class="symbol">:id</span> <span class="integer">3</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">11</span>})
                                    (prim/get-initial-state Person {<span class="symbol">:id</span> <span class="integer">4</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Bobby</span><span class="delimiter">&quot;</span></span> <span class="symbol">:age</span> <span class="integer">55</span>})])})}
  (<span class="keyword">let</span> [delete-person (<span class="keyword">fn</span> [person-id] (prim/transact! this `[(api/delete-person {<span class="symbol">:list-id</span> ~id <span class="symbol">:person-id</span> ~person-id})]))] <span class="comment">; </span><b class="conum">(4)</b>
    (dom/div <span class="predefined-constant">nil</span>
      (dom/h4 <span class="predefined-constant">nil</span> label)
      (dom/ul <span class="predefined-constant">nil</span>
        (<span class="keyword">map</span> (<span class="keyword">fn</span> [p] (ui-person (prim/computed p {<span class="symbol">:onDelete</span> delete-person}))) people)))))

(<span class="keyword">def</span> <span class="function">ui-person-list</span> (prim/factory PersonList))

(defsc Root [this {<span class="symbol">:keys</span> [ui/react-key friends enemies]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/react-key</span> {<span class="symbol">:friends</span> (prim/get-query PersonList)}
                   {<span class="symbol">:enemies</span> (prim/get-query PersonList)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:friends</span> (prim/get-initial-state PersonList {<span class="symbol">:id</span> <span class="symbol">:friends</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>})
                                <span class="symbol">:enemies</span> (prim/get-initial-state PersonList {<span class="symbol">:id</span> <span class="symbol">:enemies</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Enemies</span><span class="delimiter">&quot;</span></span>})})}
  (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> react-key}
    (ui-person-list friends)
    (ui-person-list enemies)))</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Adding an ident allows Fulcro to know how to build a FK reference to a person (given its props). The first element is the table name, the second is the name of the property that
contains the ID of the entity.</p>
</li>
<li>
<p>We will be using IDs now, so we need to add <code>:db/id</code> to the query (and props destructuring). This is just a convention for the ID attribute</p>
</li>
<li>
<p>The state of the entity will also need the ID</p>
</li>
<li>
<p>The callback can now delete people by their ID, which is more reliable.</p>
</li>
<li>
<p>The list will have an ID, and an Ident as well</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you reload the web page (needed to reinitialize the database state), then you can look at the newly normalized
database at the REPL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dev:cljs.user=&gt; @(fulcro.client.primitives/app-state (-&gt; app.client/app deref :reconciler))
{:friends [:person-list/by-id :friends],
 :enemies [:person-list/by-id :enemies],
 :person/by-id
 {1 {:db/id 1, :person/name "Sally", :person/age 32},
  2 {:db/id 2, :person/name "Joe", :person/age 22},
  3 {:db/id 3, :person/name "Fred", :person/age 11},
  4 {:db/id 4, :person/name "Bobby", :person/age 55}},
 :person-list/by-id
 {:friends
  {:db/id :friends,
   :person-list/label "Friends",
   :person-list/people [[:person/by-id 1] [:person/by-id 2]]},
  :enemies
  {:db/id :enemies,
   :person-list/label "Enemies",
   :person-list/people [[:person/by-id 3] [:person/by-id 4]]}}}</pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>db-&gt;tree</code> understands (prefers) this normalized form, and can still convert it (via a query)
to the proper data tree (note the repetition of the app state is necessary now). At the REPL, try this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">dev<span class="symbol">:cljs.user</span>=&gt; (<span class="keyword">def</span> <span class="function">current-db</span> @(fulcro.client.primitives/app-state (<span class="keyword">-&gt;</span> app.client/app <span class="keyword">deref</span> <span class="symbol">:reconciler</span>)))
<span class="error">#</span>'cljs.user/current-db
dev<span class="symbol">:cljs.user</span>=&gt; (fulcro.client.primitives/db-&gt;tree (fulcro.client.primitives/get-query app.ui.root/Root) current-db current-db)
{<span class="symbol">:friends</span>
 {<span class="symbol">:db/id</span> <span class="symbol">:friends</span>,
  <span class="symbol">:person-list/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>,
  <span class="symbol">:person-list/people</span>
  [{<span class="symbol">:db/id</span> <span class="integer">1</span>, <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:person/age</span> <span class="integer">32</span>}
   {<span class="symbol">:db/id</span> <span class="integer">2</span>, <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:person/age</span> <span class="integer">22</span>}]},
 <span class="symbol">:enemies</span>
 {<span class="symbol">:db/id</span> <span class="symbol">:enemies</span>,
  <span class="symbol">:person-list/label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Enemies</span><span class="delimiter">&quot;</span></span>,
  <span class="symbol">:person-list/people</span>
  [{<span class="symbol">:db/id</span> <span class="integer">3</span>, <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:person/age</span> <span class="integer">11</span>}
   {<span class="symbol">:db/id</span> <span class="integer">4</span>, <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Bobby</span><span class="delimiter">&quot;</span></span>, <span class="symbol">:person/age</span> <span class="integer">55</span>}]}}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mutations_on_a_normalized_database"><a class="anchor" href="#_mutations_on_a_normalized_database"></a><a class="link" href="#_mutations_on_a_normalized_database">2.7.2. Mutations on a Normalized Database</a></h4>
<div class="paragraph">
<p>We have now made it possible to fix the problems with our mutation. Now, instead of removing
a person from a tree, we can remove a FK from a TABLE entry!</p>
</div>
<div class="paragraph">
<p>This is not only much easier to code, but it is complete independent of the shape of the UI tree:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.api.mutations</span>
  (<span class="symbol">:require</span> [fulcro.client.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]))

(defmutation delete-person
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Mutation: Delete the person with name from the list with list-name</span><span class="delimiter">&quot;</span></span>
  [{<span class="symbol">:keys</span> [list-id person-id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">let</span> [ident-to-remove [<span class="symbol">:person/by-id</span> person-id] <span class="comment">; </span><b class="conum">(1)</b>
          strip-fk (<span class="keyword">fn</span> [old-fks]
                     (<span class="keyword">vec</span> (<span class="keyword">filter</span> #(<span class="keyword">not</span><span class="keyword">=</span> ident-to-remove %) old-fks)))] <span class="comment">; </span><b class="conum">(2)</b>
      (<span class="keyword">swap!</span> state <span class="keyword">update-in</span> [<span class="symbol">:person-list/by-id</span> list-id <span class="symbol">:person-list/people</span>] strip-fk)))) <span class="comment">; </span><b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>References are always idents, meaning we know the value to remove from the FK list</p>
</li>
<li>
<p>By defining a function that can filter the ident from (1), we can use update-in on the person list table&#8217;s people.</p>
</li>
<li>
<p>This is a very typical operation in a mutation: swap on the application state, and update a particular thing
in a table (in this case the people to-many ref in a specific person list).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If we were to now wrap the person list in any amount of additional UI (e.g. a nav bar, sub-pane, modal dialog, etc) this
mutation will still work perfectly, since the list itself will only have one place it ever lives in the
database.</p>
</div>
</div>
<div class="sect3">
<h4 id="_how_automatic_normalization_works_optional"><a class="anchor" href="#_how_automatic_normalization_works_optional"></a><a class="link" href="#_how_automatic_normalization_works_optional">2.7.3. How Automatic Normalization Works (optional)</a></h4>
<div class="paragraph">
<p>It is good to know how an arbitrary tree of data (the one in InitialAppState) can be converted to the normalized form.
Understanding how this is accomplished can help you avoid some mistakes later.</p>
</div>
<div class="paragraph">
<p>When you compose your query (via <code>prim/get-query</code>), the <code>get-query</code> function adds metadata to the query fragment that
names which component that query fragment came from.</p>
</div>
<div class="paragraph">
<p>For example, try this at the REPL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dev:cljs.user=&gt; (meta (fulcro.client.primitives/get-query app.basic-ui/PersonList))
{:component app.basic-ui/PersonList}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>get-query</code> function adds the component itself to the metadata for that query fragment. We already know that
we can call the static methods on a component (in this case we&#8217;re interested in <code>ident</code>).</p>
</div>
<div class="paragraph">
<p>So, Fulcro includes a function called <code>tree-&gt;db</code> that can simultaneously walk a data tree (in this case initial-state) and a
component-annotated query. When it reaches a data node whose query metadata names a component with an <code>Ident</code>, it
places that data into the approprite table (by calling your <code>ident</code> function on it to obtain the table/id), and
replaces the data in the tree with its FK ident.</p>
</div>
<div class="paragraph">
<p>Once you realize that the query <strong>and</strong> the ident work together to do normalization, you can more easily
figure out what mistakes you might make that could cause auto-normalization to fail (e.g. stealing a query from
one component and placing it on another, writing the query of a sub-component by-hand instead of pulling it
with <code>get-query</code>, etc.).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_review_so_far"><a class="anchor" href="#_review_so_far"></a><a class="link" href="#_review_so_far">2.8. Review So Far</a></h3>
<div class="ulist">
<ul>
<li>
<p>An Initial app state sets up a tree of data for startup to match the UI tree</p>
</li>
<li>
<p>Component query and ident are used to normalize this initial data into the database</p>
</li>
<li>
<p>The query is used to pull data from the normalized db into the props of the active Root UI</p>
</li>
<li>
<p>Transactions invoke abstract mutations</p>
<div class="ulist">
<ul>
<li>
<p>Mutations modify the (normalized) db</p>
</li>
<li>
<p>The transaction&#8217;s subtree of components re-renders</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_using_better_tools"><a class="anchor" href="#_using_better_tools"></a><a class="link" href="#_using_better_tools">2.9. Using Better Tools</a></h3>
<div class="paragraph">
<p>So far we&#8217;ve been hacking things in place and using the REPL to watch what we&#8217;re doing. There are better ways to work
on Fulcro applications, and now that we&#8217;ve got one basically working, let&#8217;s take a look at them both.</p>
</div>
<div class="sect3">
<h4 id="_fulcro_inspect"><a class="anchor" href="#_fulcro_inspect"></a><a class="link" href="#_fulcro_inspect">2.9.1. Fulcro Inspect</a></h4>
<div class="paragraph">
<p>A relatively recent (late 2017) addition to the ecosystem is Fucro Inspect. A set of tools you can load into your
environment during development. In fact, the template already has them (for the <code>dev</code> build)! On OSX or Linux, simply hit
<code>CTRL-F</code>.  See Fulcro Inspect&#8217;s documentation for how to set the keyboard shortcut in Windows.</p>
</div>
<div class="paragraph">
<p>The DB tab of this tool shows you your application&#8217;s database <strong>and</strong> has a time slider to see the history of states! It also
has tabs for showing you transactions that have run, and network interactions. See the tool&#8217;s documentation for more
information. In fact, by the time you read this it will probably have even more exciting features!</p>
</div>
</div>
<div class="sect3">
<h4 id="_devcards"><a class="anchor" href="#_devcards"></a><a class="link" href="#_devcards">2.9.2. Devcards</a></h4>
<div class="paragraph">
<p>There is a build in the template project called <code>cards</code>. This starts up a development environment where you can
code entire applications (or portions of them) in an environment that can show you live state and is quite handy, particularly
for working with small parts of your program (remember, we can actually split off chunks of the application because they
are all relative to their parent).</p>
</div>
<div class="paragraph">
<p>You can start this build just as we did near the start of this guide, and load it via <code>http://localhost:3449/cards.html</code>.</p>
</div>
<div class="paragraph">
<p>In fact, you don&#8217;t even have to start a new REPL! You can run <code>switch-to-build</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">dev<span class="symbol">:cljs.user</span>=&gt; (switch-to-build <span class="string"><span class="delimiter">&quot;</span><span class="content">cards</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">dev</span><span class="delimiter">&quot;</span></span>)
Figwheel<span class="error">:</span> Watching build <span class="keyword">-</span> cards
Figwheel<span class="error">:</span> Cleaning build <span class="keyword">-</span> cards
Compiling <span class="string"><span class="delimiter">&quot;</span><span class="content">resources/public/js/cards.js</span><span class="delimiter">&quot;</span></span> from [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">src/cards</span><span class="delimiter">&quot;</span></span>]<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can embed a full-funcional Fulcro application into a card environment with very little code. Replace the
content of <code>src/cards/app/intro.cljs</code> with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.intro</span>
  (<span class="symbol">:require</span> [fulcro.client.cards <span class="symbol">:refer</span> [defcard-fulcro]]
            [app.ui.root <span class="symbol">:as</span> root]))

(defcard-fulcro sample-app
  root/Root
  {}
  {<span class="symbol">:inspect-data</span> <span class="predefined-constant">true</span>})</code></pre>
</div>
</div>
<div class="paragraph">
<p>save and go to <a href="http://localhost:3449/cards.html#!/app.intro" class="bare">http://localhost:3449/cards.html#!/app.intro</a>. You should see your app running in a card, and
you should be able to see the live database (which will change as you interact)!.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_going_remote"><a class="anchor" href="#_going_remote"></a><a class="link" href="#_going_remote">2.10. Going Remote!</a></h3>
<div class="paragraph">
<p>OK, back to the main story!</p>
</div>
<div class="paragraph">
<p>Believe it or not, there&#8217;s not much to add/change on the client to get it talking
to a server, and there is also a relatively painless way to get a server up and
running.</p>
</div>
<div class="paragraph">
<p>Your template already has one :)</p>
</div>
<div class="sect3">
<h4 id="_setting_up_a_server"><a class="anchor" href="#_setting_up_a_server"></a><a class="link" href="#_setting_up_a_server">2.10.1. Setting up a Server</a></h4>
<div class="paragraph">
<p>There are two server namespaces in Fulcro: <code>fulcro.server</code> and
<code>fulcro.easy-server</code>. The former has composable bits for making a server that
has a lot of your own extensions, while the latter is a pre-baked server that covers
many of the common bases and is less work to get started with. You can always get started with the easy one, and upgrade
to a more enhanced one later.</p>
</div>
<div class="paragraph">
<p>The template generates the easy one for you in <code>src/main/app/server.clj</code>.</p>
</div>
<div class="sect4">
<h5 id="_using_the_easy_server"><a class="anchor" href="#_using_the_easy_server"></a><a class="link" href="#_using_the_easy_server">Using the Easy Server</a></h5>
<div class="paragraph">
<p>The easy server is based upon the component system. It is set up so that it can be stopped, code refreshed,
and restarted very quickly. The management functions are already written in <code>src/dev/user.clj</code> underneath
the Figwheel startup code.</p>
</div>
<div class="paragraph">
<p>The server code itself is very light:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.server</span>
  (<span class="symbol">:require</span>
    [fulcro.easy-server <span class="symbol">:refer</span> [make-fulcro-server]]
    <span class="comment">; MUST require these, or you won't get them installed.</span>
    [app.api.read]
    [app.api.mutations]))

(<span class="keyword">defn</span> <span class="function">build-server</span>
  [{<span class="symbol">:keys</span> [config] <span class="symbol">:or</span> {config <span class="string"><span class="delimiter">&quot;</span><span class="content">config/dev.edn</span><span class="delimiter">&quot;</span></span>}}]
  (make-fulcro-server
    <span class="symbol">:parser-injections</span> #{<span class="symbol">:config</span>}
    <span class="symbol">:config-path</span> config))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>make-fulcro-server</code> function needs to know where to find the server config file. You can tell it a number
of other things, including which components you&#8217;d like to be available when parsing the incoming
client requests. In the template, the only component available is the one that reads the application
config (which contains the port on which to run the web server).</p>
</div>
<div class="paragraph">
<p>The configuration is meant for production environments, and requires a default file that spells out
defaults in case the main config does not have values for them, and a primary config file that can
override any defaults.</p>
</div>
<div class="paragraph">
<p>Your template already has these in <code>src/main/config</code> (the config component looks for <code>defaults.edn</code> on the
CLASSPATH at relative location <code>config/</code>):</p>
</div>
<div class="paragraph">
<p><code>defaults.edn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:port</span> <span class="integer">3000</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>dev.edn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first file is always looked for by the server, and should contain all of the default settings you think you
want independent of where the server is started.</p>
</div>
<div class="paragraph">
<p>The server (for safety reasons in production) will not start if there isn&#8217;t a user-specified file containing potential
overrides.</p>
</div>
<div class="paragraph">
<p>Basically, it will deep-merge the two and have the latter override things in the former. This makes mistakes in
production harder to make. If you read the source of the <code>go</code> function in the <code>user.clj</code> file you&#8217;ll see that
we supply this development config file as an argument. In production systems you&#8217;ll typically want this file to be
on the filesystem when an admin can tweak it.</p>
</div>
<div class="sect5">
<h6 id="_starting_the_server"><a class="anchor" href="#_starting_the_server"></a><a class="link" href="#_starting_the_server">Starting the Server</a></h6>
<div class="paragraph">
<p>If you now start a local Clojure REPL (with <strong>no special options</strong>), it should start in the <code>user</code> namespace.
You can kick off your own application&#8217;s easy web server with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">user=&gt; (go)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The console should tell you the URL, and if you browse there you should see your <code>index.html</code> file.</p>
</div>
</div>
<div class="sect5">
<h6 id="_server_refresh"><a class="anchor" href="#_server_refresh"></a><a class="link" href="#_server_refresh">Server Refresh</a></h6>
<div class="paragraph">
<p>When you add/change code on the server you will want to see those changes in the live server without having to restart
your REPL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">user=&gt; (restart)</code></pre>
</div>
</div>
<div class="paragraph">
<p>will do this.</p>
</div>
<div class="paragraph">
<p>If there are compiler errors, then the <code>user</code> namespace might not reload properly. In that case, you should be able
to recover using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">user=&gt; (tools-ns/refresh)
user=&gt; (go)</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Don&#8217;t call refresh while the server is running. It will refresh the code, <strong>but it will lose</strong> the reference to
the running server, meaning you won&#8217;t be able to stop it and free up the network port. If you do this, you&#8217;ll have to
restart your REPL.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_serving_your_app"><a class="anchor" href="#_serving_your_app"></a><a class="link" href="#_serving_your_app">Serving your App</a></h6>
<div class="paragraph">
<p>Figwheel comes with a server that we&#8217;ve been using to serve our client. When you want to build a full-stack app
<strong>you must</strong> serve your client from your own server. Thus, if you load your page with the figwheel server (which is still
available on an alternate port) you&#8217;ll see your app, but the server interactions won&#8217;t succeed.</p>
</div>
<div class="paragraph">
<p>One might ask: "If I don&#8217;t use figwheel&#8217;s server, do I lose hot code reload on the client?"</p>
</div>
<div class="paragraph">
<p>The answer is no. When figwheel compiles your application it embeds it&#8217;s own websocket code in your application for
hot code reload. When you load that compiled code (in any way) it will try to connect to the figwheel websocket.</p>
</div>
<div class="paragraph">
<p>So your network topology was:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/client-network-topo.png" alt="client network topo" width="550" height="196">
</div>
</div>
<div class="paragraph">
<p>where both the HTML/CSS/JS resources and the hot code were coming from different connections to the same server.</p>
</div>
<div class="paragraph">
<p>The networking picture during full-stack development just splits these like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/network-topo.png" alt="network topo" width="520" height="252">
</div>
</div>
<div class="paragraph">
<p>Fulcro&#8217;s client will automatically route requests to the <code>/api</code> URI of the source URL that was used to load the page,
and Fulcro&#8217;s server is built to watch for communications at this endpoint.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_setup_for_playing_with_loads"><a class="anchor" href="#_setup_for_playing_with_loads"></a><a class="link" href="#_setup_for_playing_with_loads">2.10.2. Setup for Playing with Loads</a></h4>
<div class="paragraph">
<p>It is very handy to be able to look at your application&#8217;s state to see what might be wrong. We&#8217;ve been manually
dumping application state at the REPL using a rather long expression. So, at this point make sure
you are either running your application in a devcard, or you know how to look at things with Fulcro
Inspect. The output in the devcards is typically easier for beginners to read.</p>
</div>
</div>
<div class="sect3">
<h4 id="_loading_data"><a class="anchor" href="#_loading_data"></a><a class="link" href="#_loading_data">2.10.3. Loading Data</a></h4>
<div class="paragraph">
<p>Now we will start to see more of the payoff of our UI co-located queries and auto-normalization. Our application
so far is quite unrealistic: the people we&#8217;re showing should be coming from a server-side database, they
should not be embedded in the code of the client. Let&#8217;s remedy that.</p>
</div>
<div class="paragraph">
<p>Fulcro provides a few mechanisms for loading data, but every possible load scenario can be done using
the <code>fulcro.client.data-fetch/load</code> function.</p>
</div>
<div class="paragraph">
<p>It is very important to remember that our application database is completely normalized, so anything we&#8217;d want to put
in that application state will be <strong>at most</strong> 3 levels deep (the table name, the ID of the thing in the table, and the
field within that thing). We&#8217;ve also seen that Fulcro can also auto-normalize complete trees of data,
and has graph queries that can be used to ask for those trees.</p>
</div>
<div class="paragraph">
<p>Thus, there really are not very many scenarios!</p>
</div>
<div class="paragraph">
<p>The three basic scenarios are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Load something into the root of the application state</p>
</li>
<li>
<p>Load something into a particular field of an existing thing</p>
</li>
<li>
<p>Load some pile of data, and shape it into the database (e.g. load all of the people, and then separate them into
a list of friends and enemies).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s try out these different scenarios with our application.</p>
</div>
<div class="paragraph">
<p>First, let&#8217;s correct our application&#8217;s initial state so that no people are there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc PersonList [this {<span class="symbol">:keys</span> [db/id person-list/label person-list/people]}]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:person-list/label</span> {<span class="symbol">:person-list/people</span> (prim/get-query Person)}]
   <span class="symbol">:ident</span> [<span class="symbol">:person-list/by-id</span> <span class="symbol">:db/id</span>]
   <span class="symbol">:initial-state</span>
          (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [id label]}]
            {<span class="symbol">:db/id</span>              id
             <span class="symbol">:person-list/label</span>  label
             <span class="symbol">:person-list/people</span> []})} <span class="comment">; REMOVE THE INITIAL PEOPLE</span>
  <span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you now reload your page you should see two empty lists.</p>
</div>
<div class="sect4">
<h5 id="_normalization"><a class="anchor" href="#_normalization"></a><a class="link" href="#_normalization">Normalization</a></h5>
<div class="paragraph">
<p>When you load something you will use a query from something on your UI (it is rare to load something you don&#8217;t want to
show). Since those components (should) have a query and ident, the result of a load can be sent from the server as a
tree, and the client can auto-normalize that tree just like it did for our initial state!</p>
</div>
</div>
<div class="sect4">
<h5 id="_loading_something_into_the_db_root"><a class="anchor" href="#_loading_something_into_the_db_root"></a><a class="link" href="#_loading_something_into_the_db_root">Loading something into the DB root</a></h5>
<div class="paragraph">
<p>This case is less common, but it is a simple starting point. It is typically used to obtain something that you&#8217;d want
to access globally (e.g. the user info about the current session). Let&#8217;s assume that our Person component represents
the same kind of data as the "logged in" user. Let&#8217;s write a load that can ask the server for the "current user" and
store that in the root of our database under the key <code>:current-user</code>.</p>
</div>
<div class="paragraph">
<p>Loads, of course, can be triggered at any time (startup, event, timeout). Loading is just a function call.</p>
</div>
<div class="paragraph">
<p>For this example, let&#8217;s trigger the load just after the application has started.</p>
</div>
<div class="sect5">
<h6 id="_triggering_the_load"><a class="anchor" href="#_triggering_the_load"></a><a class="link" href="#_triggering_the_load">Triggering the Load</a></h6>
<div class="paragraph">
<p>To do this, we can add an option to our client. In <code>app.client</code> change <code>app</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.client</span>
  (<span class="symbol">:require</span> [fulcro.client <span class="symbol">:as</span> fc]
            [fulcro.client.data-fetch <span class="symbol">:as</span> df] <span class="comment">; </span><b class="conum">(1)</b>
            [app.ui.root <span class="symbol">:as</span> root]))

(<span class="keyword">defonce</span> <span class="function">app</span> (<span class="keyword">atom</span> (fc/new-fulcro-client
                     <span class="symbol">:started-callback</span>
                     (<span class="keyword">fn</span> [app]  <span class="comment">; </span><b class="conum">(2)</b>
                       (df/load app <span class="symbol">:current-user</span> root/Person)))))</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Require the <code>data-fetch</code> namespace</p>
</li>
<li>
<p>Issue the load in the application&#8217;s <code>started-callback</code></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<strong>If you are using devcards</strong> you will need to place the option for the application in the devcard&#8217;s options
under the <code>:fulcro</code> key:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.intro</span>
  (<span class="symbol">:require</span> [fulcro.client.cards <span class="symbol">:refer</span> [defcard-fulcro]]
            [app.ui.root <span class="symbol">:as</span> root]
            [fulcro.client.data-fetch <span class="symbol">:as</span> df]))

(defcard-fulcro sample-app
  root/Root
  {}
  {<span class="symbol">:inspect-data</span> <span class="predefined-constant">true</span>
   <span class="symbol">:fulcro</span>       {<span class="symbol">:started-callback</span>
                  (<span class="keyword">fn</span> [app] (df/load app <span class="symbol">:current-user</span> root/Person))}})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course hot code reload does not restart the app (if just hot patches the code), so to see this load trigger we must
reload the browser page.</p>
</div>
<div class="paragraph">
<p>If you do that at the moment, you should see an error in the various consoles related to the failure of the load.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Make sure your application (or dev cadr) is running from <strong>your</strong> server (port 3000) and not the figwheel one!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Technically, <code>load</code> is just writing a query for you (in this case <code>[{:current-user (prim/get-query Person)}]</code>) and sending it to the
server. The server will receive <strong>exactly</strong> that query as a CLJ data structure.</p>
</div>
</div>
<div class="sect5">
<h6 id="_implementing_the_server_handler"><a class="anchor" href="#_implementing_the_server_handler"></a><a class="link" href="#_implementing_the_server_handler">Implementing the Server Handler</a></h6>
<div class="paragraph">
<p>You now need to converting the raw CLJ query into a response. You can read more
about the gory details of that in the developer&#8217;s guide; however, Fulcro&#8217;s has some
helpers that make our job much easier.</p>
</div>
<div class="paragraph">
<p>The template has a spot to put your query handlers in <code>src/main/app/api/read.clj</code>.
Since we&#8217;re on the server and we&#8217;re going to be supplying and manipulating people, we&#8217;ll just make a single atom-based
in-memory database. This could easily be stored in a database of any kind.
To handle the incoming "current user" request, we can use a macro to write the handler for us.
Change the file to look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.api.read</span>
  (<span class="symbol">:require</span>
    [fulcro.server <span class="symbol">:refer</span> [defquery-root defquery-entity defmutation]]))

(<span class="keyword">def</span> <span class="function">people-db</span> (<span class="keyword">atom</span> {<span class="integer">1</span>  {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Bert</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/age</span> <span class="integer">55</span> <span class="symbol">:person/relation</span> <span class="symbol">:friend</span>}
                      <span class="integer">2</span>  {<span class="symbol">:db/id</span> <span class="integer">2</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/age</span> <span class="integer">22</span> <span class="symbol">:person/relation</span> <span class="symbol">:friend</span>}
                      <span class="integer">3</span>  {<span class="symbol">:db/id</span> <span class="integer">3</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Allie</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/age</span> <span class="integer">76</span> <span class="symbol">:person/relation</span> <span class="symbol">:enemy</span>}
                      <span class="integer">4</span>  {<span class="symbol">:db/id</span> <span class="integer">4</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Zoe</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/age</span> <span class="integer">32</span> <span class="symbol">:person/relation</span> <span class="symbol">:friend</span>}
                      <span class="integer">99</span> {<span class="symbol">:db/id</span> <span class="integer">99</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Me</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/role</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>}}))

(defquery-root <span class="symbol">:current-user</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Queries for the current user and returns it to the client</span><span class="delimiter">&quot;</span></span>
  (value [env params]
    (<span class="keyword">get</span> @people-db <span class="integer">99</span>)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This actually augments a multimethod, which means we need to make sure this namespace is loaded by our server. The
<code>user</code> namespace already does this. So, you should be able to simply restart/refresh the server at the SERVER REPL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>user=&gt; (restart)</pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;ve done everything correctly, then reloading your application should successfully load your current user. You
can verify this by examining the network data, but it will be even more convincing if you look at your client database
via the dev card visualization on Fulcro Inspect. It should look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:current-user</span>         [<span class="symbol">:person/by-id</span> <span class="integer">99</span>]
 <span class="symbol">:person/by-id</span>         {<span class="integer">99</span> {<span class="symbol">:db/id</span> <span class="integer">99</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Me</span><span class="delimiter">&quot;</span></span> <span class="symbol">:person/role</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>}}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the top-level key is a normalized FK reference to the person, which has been placed into the correct database
table.</p>
</div>
</div>
<div class="sect5">
<h6 id="_using_data_from_root"><a class="anchor" href="#_using_data_from_root"></a><a class="link" href="#_using_data_from_root">Using Data from Root</a></h6>
<div class="paragraph">
<p>Of course, the question is now "how do I use that in some arbitrary component?" We won&#8217;t completely
explore that right now, but the answer is easy: The query syntax has a notation for "query something at the root". It looks like this:
<code>[ {[:current-user '_] (prim/get-query Person)} ]</code>. You should recognize this as a query join, but on something that
looks like an ident without an ID (implying there is only one, at root).</p>
</div>
<div class="paragraph">
<p>We&#8217;ll just use it on the Root UI node, where we don&#8217;t need to "jump to the top":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Root [this {<span class="symbol">:keys</span> [ui/react-key friends enemies current-user]}] <span class="comment">; </span><b class="conum">(2)</b>
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/react-key</span>
                   {<span class="symbol">:current-user</span> (prim/get-query Person)} <span class="comment">; </span><b class="conum">(1)</b>
                   {<span class="symbol">:friends</span> (prim/get-query PersonList)}
                   {<span class="symbol">:enemies</span> (prim/get-query PersonList)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:friends</span> (prim/get-initial-state PersonList {<span class="symbol">:id</span> <span class="symbol">:friends</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>})
                                <span class="symbol">:enemies</span> (prim/get-initial-state PersonList {<span class="symbol">:id</span> <span class="symbol">:enemies</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Enemies</span><span class="delimiter">&quot;</span></span>})})}
  (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> react-key}
    (dom/h4 <span class="predefined-constant">nil</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Current User: </span><span class="delimiter">&quot;</span></span> (<span class="symbol">:person/name</span> current-user))) <span class="comment">; </span><b class="conum">(3)</b>
    (ui-person-list friends)
    (ui-person-list enemies)))</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Add the current user to the query</p>
</li>
<li>
<p>Pull of from the props</p>
</li>
<li>
<p>Show something about it in the UI</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_loading_something_that_gets_added_in_to_an_existing_entity"><a class="anchor" href="#_loading_something_that_gets_added_in_to_an_existing_entity"></a><a class="link" href="#_loading_something_that_gets_added_in_to_an_existing_entity">Loading something that gets "added in" to an existing entity</a></h5>
<div class="paragraph">
<p>The next common scenario is loading something into some other existing entity in your database. Remember that since
the database is normalized this will cover all of the other loading cases (except for the one where you want to convert
what the server tells you into a different shape (e.g. paginate, sort, etc.)).</p>
</div>
<div class="paragraph">
<p>Fulcro&#8217;s load method accomplishes this by loading the data into the root of the database, normalizing it, then
(optionally) allowing you to re-target the top-level FK to different location(s) in the database.</p>
</div>
<div class="sect5">
<h6 id="_targeting_the_load"><a class="anchor" href="#_targeting_the_load"></a><a class="link" href="#_targeting_the_load">Targeting the Load</a></h6>
<div class="paragraph">
<p>The load looks very much like what we just did, but with one addition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(df/load app <span class="symbol">:my-friends</span> Person {<span class="symbol">:target</span> [<span class="symbol">:person-list/by-id</span> <span class="symbol">:friends</span> <span class="symbol">:person-list/people</span>]})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:target</code> option indicates that once the data is loaded and normalized (which will leave the FK reference
at the root as we saw in the last section) this top-level reference (or vector of references) will be moved into the key-path provided.
Since our database is normalized, this means a 3-tuple (table, id, target field).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
It is important to choose a keyword for this load that won&#8217;t stomp on real data in your database&#8217;s root.
We already have the top-level keys <code>:friends</code> and <code>:enemies</code> as part of our UI graph from root. So, we&#8217;re making up
<code>:my-friends</code>  as the load key. One could also namespace the keyword with something like <code>:server/friends</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since friend and enemies are the same kind of query, let&#8217;s add both into the startup code (in the card/client):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="keyword">..</span><span class="keyword">.</span>
     <span class="symbol">:started-callback</span>
     (<span class="keyword">fn</span> [app]
       (df/load app <span class="symbol">:current-user</span> root/Person)
       (df/load app <span class="symbol">:my-enemies</span> root/Person {<span class="symbol">:target</span> [<span class="symbol">:person-list/by-id</span> <span class="symbol">:enemies</span> <span class="symbol">:person-list/people</span>]})
       (df/load app <span class="symbol">:my-friends</span> root/Person {<span class="symbol">:target</span> [<span class="symbol">:person-list/by-id</span> <span class="symbol">:friends</span> <span class="symbol">:person-list/people</span>]}))
<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_handling_the_load_request_on_the_server"><a class="anchor" href="#_handling_the_load_request_on_the_server"></a><a class="link" href="#_handling_the_load_request_on_the_server">Handling the Load Request on the Server</a></h6>
<div class="paragraph">
<p>The server query processing is what you would expect from the last example (in <code>read.clj</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">people-db</span> <span class="keyword">..</span><span class="keyword">.</span>) <span class="comment">; as before</span>

(<span class="keyword">defn</span> <span class="function">get-people</span> [kind <span class="keyword">keys</span>]
  (<span class="keyword">-&gt;&gt;</span> @people-db
    <span class="keyword">vals</span>
    (<span class="keyword">filter</span> #(<span class="keyword">=</span> kind (<span class="symbol">:person/relation</span> %)))
    <span class="keyword">vec</span>))

(defquery-root <span class="symbol">:my-friends</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Queries for friends and returns them to the client</span><span class="delimiter">&quot;</span></span>
  (value [{<span class="symbol">:keys</span> [query]} params]
    (get-people <span class="symbol">:friend</span> query)))

(defquery-root <span class="symbol">:my-enemies</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Queries for enemies and returns them to the client</span><span class="delimiter">&quot;</span></span>
  (value [{<span class="symbol">:keys</span> [query]} params]
    (get-people <span class="symbol">:enemy</span> query)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>A refresh of the server and reload of the page should now populate your lists from the server!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>user=&gt; (restart)</pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_morphing_the_loaded_data"><a class="anchor" href="#_morphing_the_loaded_data"></a><a class="link" href="#_morphing_the_loaded_data">Morphing the Loaded Data</a></h5>
<div class="paragraph">
<p>It is somewhat common for a server to return data that isn&#8217;t quite what we want in our UI. So far we&#8217;ve just been placing
the data returned from the server directly in our UI. Fulcro&#8217;s load mechanism allows a post mutation of the loaded
data once it arrives, allowing you to re-shape it into whatever form you might desire.</p>
</div>
<div class="paragraph">
<p>For example, you may want the people in your lists to be sorted by name. You&#8217;ve already seen how to write client
mutations that modify the database, and that is really all you need. The client mutation for sorting the people
in the friends list could be (in <code>mutations.cljs</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">sort-friends-by*</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Sort the idents in the friends person list by the indicated field. Returns the new app-state.</span><span class="delimiter">&quot;</span></span>
  [state-map field]
  (<span class="keyword">let</span> [friend-idents  (<span class="keyword">get-in</span> state-map [<span class="symbol">:person-list/by-id</span> <span class="symbol">:friends</span> <span class="symbol">:person-list/people</span>] [])
        friends        (<span class="keyword">map</span> (<span class="keyword">fn</span> [friend-ident] (<span class="keyword">get-in</span> state-map friend-ident)) friend-idents)
        sorted-friends (<span class="keyword">sort-by</span> field friends)
        new-idents     (mapv (<span class="keyword">fn</span> [friend] [<span class="symbol">:person/by-id</span> (<span class="symbol">:db/id</span> friend)]) sorted-friends)]
    (<span class="keyword">assoc-in</span> state-map [<span class="symbol">:person-list/by-id</span> <span class="symbol">:friends</span> <span class="symbol">:person-list/people</span>] new-idents)))

(defmutation sort-friends [no-params]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state sort-friends-by* <span class="symbol">:person/name</span>)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course this mutation could be triggered anywhere you could run a <code>transact!</code>, but since we&#8217;re interested in morphing
just-loaded data, we&#8217;ll add it there. Our dev card would now look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.intro</span>
  (<span class="symbol">:require</span> [fulcro.client.cards <span class="symbol">:refer</span> [defcard-fulcro]]
            [app.ui.root <span class="symbol">:as</span> root]
            [fulcro.client.data-fetch <span class="symbol">:as</span> df]
            [app.api.mutations <span class="symbol">:as</span> api]))

(defcard-fulcro sample-app
  root/Root
  {}
  {<span class="symbol">:inspect-data</span> <span class="predefined-constant">true</span>
   <span class="symbol">:fulcro</span>       {<span class="symbol">:started-callback</span>
                  (<span class="keyword">fn</span> [app] (df/load app <span class="symbol">:current-user</span> root/Person)
                    (df/load app <span class="symbol">:my-friends</span> root/Person {<span class="symbol">:target</span>        [<span class="symbol">:person-list/by-id</span> <span class="symbol">:friends</span> <span class="symbol">:person-list/people</span>]
                                                          <span class="symbol">:post-mutation</span> `api/sort-friends})
                    (df/load app <span class="symbol">:my-enemies</span> root/Person {<span class="symbol">:target</span> [<span class="symbol">:person-list/by-id</span> <span class="symbol">:enemies</span> <span class="symbol">:person-list/people</span>]}))}})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the syntax quoting. The post mutation has to be the <strong>symbol</strong> of the mutation. Remember that
our require has <code>app.api.mutations</code> aliased to <code>api</code>, and syntax quoting will expand that for us.</p>
</div>
<div class="paragraph">
<p>If you reload your UI you should now see the people sorted by name. Hopefully you can see how easy it is to change
this sort order to something like "by age". Try it!</p>
</div>
</div>
<div class="sect4">
<h5 id="_loading_a_specific_entity_and_it_s_subgraph_by_ident"><a class="anchor" href="#_loading_a_specific_entity_and_it_s_subgraph_by_ident"></a><a class="link" href="#_loading_a_specific_entity_and_it_s_subgraph_by_ident">Loading a specific entity and it&#8217;s subgraph (by ident)</a></h5>
<div class="paragraph">
<p>Once things are loaded from the server they are immediately growing stale (unless you&#8217;re pushing updates with
websockets). It is very common to want to re-load a particular thing in your database. Of course, you can trigger
a load just like we&#8217;ve been doing, but in that case we reloading a whole bunch of things. What if we just wanted to
refresh a particular person (e.g. in preparation for editing it).</p>
</div>
<div class="paragraph">
<p>The <code>load</code> function can be used for that as well. Just replace the keyword with an ident, and you&#8217;re there!</p>
</div>
<div class="paragraph">
<p>Load can take the <code>app</code> or any component&#8217;s <code>this</code> as the first argument, so from within the UI we can trigger a load
using <code>this</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(df/load this [<span class="symbol">:person/by-id</span> <span class="integer">3</span>] Person)</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_trigger_the_load_via_a_user_event"><a class="anchor" href="#_trigger_the_load_via_a_user_event"></a><a class="link" href="#_trigger_the_load_via_a_user_event">Trigger the Load via a User Event</a></h6>
<div class="paragraph">
<p>Let&#8217;s embed that into our UI at the root:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Root [this {<span class="symbol">:keys</span> [ui/react-key friends enemies current-user]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/react-key</span>
                   {<span class="symbol">:current-user</span> (prim/get-query Person)}
                   {<span class="symbol">:friends</span> (prim/get-query PersonList)}
                   {<span class="symbol">:enemies</span> (prim/get-query PersonList)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:friends</span> (prim/get-initial-state PersonList {<span class="symbol">:id</span> <span class="symbol">:friends</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>})
                                <span class="symbol">:enemies</span> (prim/get-initial-state PersonList {<span class="symbol">:id</span> <span class="symbol">:enemies</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Enemies</span><span class="delimiter">&quot;</span></span>})})}
  (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> react-key}
    (dom/h4 <span class="predefined-constant">nil</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Current User: </span><span class="delimiter">&quot;</span></span> (<span class="symbol">:person/name</span> current-user)))
    <span class="comment">; NEW BUTTON HERE:</span>
    (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [] (df/load this [<span class="symbol">:person/by-id</span> <span class="integer">3</span>] Person))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Refresh Person with ID 3</span><span class="delimiter">&quot;</span></span>)
    (ui-person-list friends)
    (ui-person-list enemies)))</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_handling_an_entity_query_on_the_server"><a class="anchor" href="#_handling_an_entity_query_on_the_server"></a><a class="link" href="#_handling_an_entity_query_on_the_server">Handling an Entity Query on the Server</a></h6>
<div class="paragraph">
<p>The incoming query will have a slightly different form, so there is an alternate macro for making a handler for entity
loading. Let&#8217;s add this in our server&#8217;s <code>read.clj</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defquery-entity <span class="symbol">:person/by-id</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Server query for allowing the client to pull an individual person from the database</span><span class="delimiter">&quot;</span></span>
  (value [env id params]
    <span class="comment">; the update is just so we can see it change in the UI</span>
    (update (<span class="keyword">get</span> @people-db id) <span class="symbol">:person/name</span> <span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content"> (refreshed)</span><span class="delimiter">&quot;</span></span>)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>defquery-entity</code> takes the "table name" as the dispatch key. The <code>value</code> method of the query handler will receive
the server environment, the ID of the entity to load, and any parameters passed with the query (see the <code>:params</code> option
of <code>load</code>).</p>
</div>
<div class="paragraph">
<p>In the implementation above we&#8217;re augmenting the person&#8217;s name with "(refreshed)" so that you can see it happen in the UI.</p>
</div>
<div class="paragraph">
<p>Remember to <code>(restart)</code> your server to load this code.</p>
</div>
<div class="paragraph">
<p>Your UI should now have a button, and when you press it you should see one person update!</p>
</div>
</div>
<div class="sect5">
<h6 id="_refreshing_this"><a class="anchor" href="#_refreshing_this"></a><a class="link" href="#_refreshing_this">Refreshing "This"</a></h6>
<div class="paragraph">
<p>There is a special case that is somewhat common: you want to trigger a refresh from an event on the item that needs
the refresh. The code for that is identical to what we&#8217;ve just presented (a load with an ident and component); however,
the <code>data-fetch</code> namespace includes a convenience function for it.</p>
</div>
<div class="paragraph">
<p>So, say we wanted a refresh button on each person. We could leverage <code>df/refresh</code> for that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Person [this {<span class="symbol">:keys</span> [db/id person/name person/age]} {<span class="symbol">:keys</span> [onDelete]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:db/id</span> <span class="symbol">:person/name</span> <span class="symbol">:person/age</span>]
   <span class="symbol">:ident</span>         [<span class="symbol">:person/by-id</span> <span class="symbol">:db/id</span>]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [id <span class="keyword">name</span> age]}] {<span class="symbol">:db/id</span> id <span class="symbol">:person/name</span> <span class="keyword">name</span> <span class="symbol">:person/age</span> age})}
  (dom/li <span class="predefined-constant">nil</span>
    (dom/h5 <span class="predefined-constant">nil</span> <span class="keyword">name</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">(age: </span><span class="delimiter">&quot;</span></span> age <span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span>)
      (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(onDelete id)} <span class="string"><span class="delimiter">&quot;</span><span class="content">X</span><span class="delimiter">&quot;</span></span>)
      (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(df/refresh! this)} <span class="string"><span class="delimiter">&quot;</span><span class="content">Refresh</span><span class="delimiter">&quot;</span></span>)))) <span class="comment">; ADD THIS</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This should already work with your server, so once the browser hot code reload has happened this button should just work!</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_additional_permutations"><a class="anchor" href="#_additional_permutations"></a><a class="link" href="#_additional_permutations">Additional Permutations</a></h5>
<div class="paragraph">
<p>Fulcro&#8217;s load system covers a number of additional bases that bring the story to completion. There are load markers
(so you can show network activity), UI refresh add-ons (when you modify data that isn&#8217;t auto-detected, e.g. through a post
mutation), server query parameters, and error handling. See the Developers Guide, doc strings, or source for more details.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_handling_mutations_on_the_server"><a class="anchor" href="#_handling_mutations_on_the_server"></a><a class="link" href="#_handling_mutations_on_the_server">2.10.4. Handling Mutations on The Server</a></h4>
<div class="paragraph">
<p>Mutations are handled on the server using the server&#8217;s <code>defmutation</code> macro (if you&#8217;re using Fulcro&#8217;s built-in request parser).</p>
</div>
<div class="paragraph">
<p>This has the identical syntax to the client version!</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You want to place your mutations in the same namespace on the client and server since the <code>defmutation</code>
macros namespace the symbol into the current namespace.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So, this is really why we have a duplicated namespace in Clojure called <code>mutations.clj</code> right
next to our <code>mutations.cljs</code>.</p>
</div>
<div class="paragraph">
<p>So, let&#8217;s add an implementation for our server-side <code>delete-person</code>. Your <code>mutations.clj</code> should end
up looking like this (don&#8217;t forget the require to get access to the people db):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.api.mutations</span>
  (<span class="symbol">:require</span>
    [taoensso.timbre <span class="symbol">:as</span> timbre]
    [app.api.read <span class="symbol">:refer</span> [people-db]]
    [fulcro.server <span class="symbol">:refer</span> [defmutation]]))

<span class="comment">;; Place your server mutations here</span>
(defmutation delete-person
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Server Mutation: Handles deleting a person on the server</span><span class="delimiter">&quot;</span></span>
  [{<span class="symbol">:keys</span> [person-id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (timbre/info <span class="string"><span class="delimiter">&quot;</span><span class="content">Server deleting person</span><span class="delimiter">&quot;</span></span> person-id)
    (<span class="keyword">swap!</span> people-db <span class="keyword">dissoc</span> person-id)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Refresh the code on your server with <code>(restart)</code> at the REPL. However, don&#8217;t expect it to work just yet. We have
to tell the client to send the remote request.</p>
</div>
<div class="sect4">
<h5 id="_triggering_the_remote_mutation_from_the_client"><a class="anchor" href="#_triggering_the_remote_mutation_from_the_client"></a><a class="link" href="#_triggering_the_remote_mutation_from_the_client">Triggering the Remote Mutation from the Client</a></h5>
<div class="paragraph">
<p>Mutations are simply optimistic local updates by default. To make them full-stack, you need to add a method-looking
section to your <code>defmutation</code> handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation delete-person
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Mutation: Delete the person with person-id from the list with list-id</span><span class="delimiter">&quot;</span></span>
  [{<span class="symbol">:keys</span> [list-id person-id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">let</span> [ident-to-remove [<span class="symbol">:person/by-id</span> person-id]
          strip-fk        (<span class="keyword">fn</span> [old-fks]
                            (<span class="keyword">vec</span> (<span class="keyword">filter</span> #(<span class="keyword">not</span><span class="keyword">=</span> ident-to-remove %) old-fks)))]
      (<span class="keyword">swap!</span> state <span class="keyword">update-in</span> [<span class="symbol">:person-list/by-id</span> list-id <span class="symbol">:person-list/people</span>] strip-fk)))
  (remote [env] <span class="predefined-constant">true</span>)) <span class="comment">; This one line is it!!!</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The syntax for the addition is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(remote-name [env] boolean-or-ast)</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>remote</code> is the name of a remote server (the default is <code>remote</code>). You can have any number of network remotes.
The default one talks to the
page origin at <code>/api</code>. What is this AST we speak of? It is the abstract syntax tree of the mutation itself (as data).
Using a boolean true means "send it just as the client specified". If you wish you can pull the AST from the <code>env</code>,
augment it (or completely change it) and return that instead. See the Developers Guide for more details.</p>
</div>
<div class="paragraph">
<p>Now that you&#8217;ve got the UI in place, try deleting a person. It should disappear from the UI as it did before; however,
now if you&#8217;re watching the network you&#8217;ll see a request to the server. If you server is working right, it will handle
the delete.</p>
</div>
<div class="paragraph">
<p>Try reloading your page from the server. That person should still be missing, indicating that it really was removed
from the server.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_a_legacy_rest_api"><a class="anchor" href="#_using_a_legacy_rest_api"></a><a class="link" href="#_using_a_legacy_rest_api">2.11. Using a legacy REST API</a></h3>
<div class="paragraph">
<p>Fulcro is really meant to be a full-stack solution. That said, it isn&#8217;t really that hard to make it talk to other kinds
of servers. As an example, this addendum talks you through what it takes to talk to a legacy REST service.</p>
</div>
<div class="paragraph">
<p>Working with legacy REST APIs is a simple, though tedious, task. Basically you need to add an additional remote to the Fulcro Client
that knows how to talk via JSON instead of EDN.</p>
</div>
<div class="paragraph">
<p>The basic steps are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Implement <code>FulcroNetwork</code>. See the <code>fulcro.client.network</code> namespace for the protocol and built-in implementation.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Your <code>send</code> method will be passed the query/mutations the client wants to do. You must translate them to a REST
call and translate the REST response into the desired tree of client data, which you then pass to the <code>ok</code> callback
that <code>send</code> is given.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Install your network handler on the client (using the <code>:networking</code> option)</p>
</li>
<li>
<p>Add the <code>:remote</code> option to your loads, or use your remote name as the remote side of a mutation</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_writing_the_networking_code"><a class="anchor" href="#_writing_the_networking_code"></a><a class="link" href="#_writing_the_networking_code">2.11.1. Writing the Networking Code</a></h4>
<div class="paragraph">
<p>For this example we&#8217;re going to use the following public REST API endpoint: <code>http://jsonplaceholder.typicode.com/posts</code>
which returns a list of posts (try it to make sure it is working).</p>
</div>
<div class="paragraph">
<p>It should return an array of JSON maps, with strings as keys.</p>
</div>
<div class="paragraph">
<p>Basically, when you run a transaction (read or
write) the raw transaction that is intended to go remote is passed into the <code>send</code> method of a networking protocol.
The networking can send that unchanged, or it can choose to modify it in some way. Since REST servers don&#8217;t understand
our Fulcro requests, we have to add a layer at the network to convert one to the other, and back (for the response).</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_ui_and_queries"><a class="anchor" href="#_the_ui_and_queries"></a><a class="link" href="#_the_ui_and_queries">2.11.2. The UI and Queries</a></h4>
<div class="paragraph">
<p>First, let&#8217;s talk about the UI code for dealing with these posts, since the UI defines the queries. Here is
a very simple UI we can add to our program:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Post [this {<span class="symbol">:keys</span> [post/title post/body]}]           <span class="comment">; </span><b class="conum">(1)</b>
  {<span class="symbol">:ident</span> [<span class="symbol">:posts/by-id</span> <span class="symbol">:db/id</span>]
   <span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:post/user-id</span> <span class="symbol">:post/body</span> <span class="symbol">:post/title</span>]}
  (dom/div <span class="predefined-constant">nil</span>
    (dom/h4 <span class="predefined-constant">nil</span> title)
    (dom/p <span class="predefined-constant">nil</span> body)))

(<span class="keyword">def</span> <span class="function">ui-post</span> (prim/factory Post {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defsc Posts [this {<span class="symbol">:keys</span> [posts]}]                         <span class="comment">; </span><b class="conum">(2)</b>
  {<span class="symbol">:initial-state</span> {<span class="symbol">:posts</span> []}
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:post-list/by-id</span> <span class="symbol">:the-one</span>])
   <span class="symbol">:query</span>         [{<span class="symbol">:posts</span> (prim/get-query Post)}]}
  (dom/ul <span class="predefined-constant">nil</span>
    (<span class="keyword">map</span> ui-post posts)))

(<span class="keyword">def</span> <span class="function">ui-posts</span> (prim/factory Posts))

<span class="comment">; ...</span>

(defsc Root [this {<span class="symbol">:keys</span> [ui/react-key blog-posts current-user friends enemies]}] <span class="comment">; </span><b class="conum">(5)</b>
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/react-key</span>
                   <span class="symbol">:ui/person-id</span>
                   {<span class="symbol">:current-user</span> (prim/get-query Person)}
                   {<span class="symbol">:blog-posts</span> (prim/get-query Posts)}     <span class="comment">; </span><b class="conum">(3)</b>
                   {<span class="symbol">:friends</span> (prim/get-query PersonList)}
                   {<span class="symbol">:enemies</span> (prim/get-query PersonList)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:blog-posts</span> (prim/get-initial-state Posts {}) <span class="comment">; </span><b class="conum">(4)</b>
                                <span class="symbol">:friends</span>    (prim/get-initial-state PersonList {<span class="symbol">:id</span> <span class="symbol">:friends</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Friends</span><span class="delimiter">&quot;</span></span>})
                                <span class="symbol">:enemies</span>    (prim/get-initial-state PersonList {<span class="symbol">:id</span> <span class="symbol">:enemies</span> <span class="symbol">:label</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Enemies</span><span class="delimiter">&quot;</span></span>})})}
  (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> react-key}
    (dom/h4 <span class="predefined-constant">nil</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Current User: </span><span class="delimiter">&quot;</span></span> (<span class="symbol">:person/name</span> current-user)))
    (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [] (df/load this [<span class="symbol">:person/by-id</span> <span class="integer">3</span>] Person))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Refresh User with ID 3</span><span class="delimiter">&quot;</span></span>)
    (ui-person-list friends)
    (ui-person-list enemies)
    (dom/h4 <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Blog Posts</span><span class="delimiter">&quot;</span></span>)                               <span class="comment">; </span><b class="conum">(6)</b>
    (ui-posts blog-posts)))</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A component to represent the post itself</p>
</li>
<li>
<p>A component to represent the list of the posts</p>
</li>
<li>
<p>Composing the Posts UI into root query</p>
</li>
<li>
<p>Composing the Posts UI into root initial data</p>
</li>
<li>
<p>Pull the resulting app db data from props</p>
</li>
<li>
<p>Render the list</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Of course, there are no posts yet, so all you&#8217;ll see is the heading. Notice that there is <strong>nothing new here</strong>. The UI
is completely network agnostic, as it should be.</p>
</div>
<div class="paragraph">
<p>Now for the networking code. This bit is a little longer, but most of it is the details around network communcation
itself, rather than the work you have to do. Create a new namespace <code>src/main/app/rest.cljs</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.rest</span>
  (<span class="symbol">:refer-clojure</span> <span class="symbol">:exclude</span> [<span class="keyword">send</span>])
  (<span class="symbol">:require</span> [fulcro.client.logging <span class="symbol">:as</span> log]
            [fulcro.client.network <span class="symbol">:as</span> net]
            [cognitect.transit <span class="symbol">:as</span> ct]
            [goog.events <span class="symbol">:as</span> events]
            [fulcro.transit <span class="symbol">:as</span> t]
            [clojure.string <span class="symbol">:as</span> <span class="keyword">str</span>]
            [clojure.set <span class="symbol">:as</span> <span class="keyword">set</span>]
            [fulcro.client.primitives <span class="symbol">:as</span> prim])
  (<span class="symbol">:import</span> [goog.net XhrIo EventType]))

(<span class="keyword">defn</span> <span class="function">make-xhrio</span> [] (XhrIo.))

(<span class="keyword">defrecord</span> <span class="class">Network</span> [url request-transform global-error-callback complete-app transit-handlers]
  net/NetworkBehavior
  (serialize-requests? [this] <span class="predefined-constant">true</span>)
  net/IXhrIOCallbacks
  (response-ok [this xhr-io valid-data-callback]
    <span class="comment">;; Implies:  everything went well and we have a good response</span>
    <span class="comment">;; (i.e., got a 200).</span>
    (<span class="keyword">try</span>
      (<span class="keyword">let</span> [read-handlers (<span class="symbol">:read</span> transit-handlers)
            <span class="comment">; STEP 3: Convert the JSON response into a proper tree structure to match the query</span>
            response      (<span class="keyword">.</span>getResponseJson xhr-io)
            edn           (js-&gt;clj response) <span class="comment">; convert it to clojure</span>
            <span class="comment">; Rename the keys from strings to the desired UI keywords</span>
            posts         (mapv #(set/rename-keys % {<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>     <span class="symbol">:db/id</span>
                                                     <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>  <span class="symbol">:post/title</span>
                                                     <span class="string"><span class="delimiter">&quot;</span><span class="content">userId</span><span class="delimiter">&quot;</span></span> <span class="symbol">:post/user-id</span>
                                                     <span class="string"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>   <span class="symbol">:post/body</span>})
                            edn)
            <span class="comment">; IMPORTANT: structure of the final data we send to the callback must match the nesting structure of the query</span>
            <span class="comment">; [{:posts [...]}] or it won't merge correctly:</span>
            fixed-response      {<span class="symbol">:posts</span> posts}]
        (js/console.log <span class="symbol">:converted-response</span> fixed-response)
        <span class="comment">; STEP 4; Send the fixed up response back to the client DB</span>
        (<span class="keyword">when</span> (<span class="keyword">and</span> response valid-data-callback) (valid-data-callback fixed-response)))
      (finally (<span class="keyword">.</span>dispose xhr-io))))
  (response-error [this xhr-io error-callback]
    <span class="comment">;; Implies:  request was sent.</span>
    <span class="comment">;; *Always* called if completed (even in the face of network errors).</span>
    <span class="comment">;; Used to detect errors.</span>
    (<span class="keyword">try</span>
      (<span class="keyword">let</span> [status                 (<span class="keyword">.</span>getStatus xhr-io)
            log-and-dispatch-error (<span class="keyword">fn</span> [<span class="keyword">str</span> error]
                                     <span class="comment">;; note that impl.application/initialize will partially apply the</span>
                                     <span class="comment">;; app-state as the first arg to global-error-callback</span>
                                     (log/error <span class="keyword">str</span>)
                                     (error-callback error)
                                     (<span class="keyword">when</span> @global-error-callback
                                       (@global-error-callback status error)))]
        (<span class="keyword">if</span> (<span class="keyword">zero?</span> status)
          (log-and-dispatch-error
            (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">UNTANGLED NETWORK ERROR: No connection established.</span><span class="delimiter">&quot;</span></span>)
            {<span class="symbol">:type</span> <span class="symbol">:network</span>})
          (log-and-dispatch-error (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">SERVER ERROR CODE: </span><span class="delimiter">&quot;</span></span> status) {})))
      (finally (<span class="keyword">.</span>dispose xhr-io))))
  net/FulcroNetwork
  (<span class="keyword">send</span> [this edn ok error]
    (<span class="keyword">let</span> [xhrio       (make-xhrio)
          <span class="comment">; STEP 1: Convert the request(s) from query notation to REST...</span>
          <span class="comment">; some logic to morph the incoming request into REST (assume you'd factor this out to handle numerous kinds)</span>
          request-ast (<span class="keyword">-&gt;</span> (prim/query-&gt;ast edn) <span class="symbol">:children</span> <span class="keyword">first</span>)
          uri         (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> (<span class="keyword">name</span> (<span class="symbol">:key</span> request-ast)))   <span class="comment">; in this case, posts</span>
          url         (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">http://jsonplaceholder.typicode.com</span><span class="delimiter">&quot;</span></span> uri)]
      (js/console.log <span class="symbol">:REQUEST</span> request-ast <span class="symbol">:URI</span> uri)
      <span class="comment">; STEP 2: Send the request</span>
      (<span class="keyword">.</span><span class="keyword">send</span> xhrio url <span class="string"><span class="delimiter">&quot;</span><span class="content">GET</span><span class="delimiter">&quot;</span></span>)
      <span class="comment">; STEP 3 (see response-ok above)</span>
      (events/listen xhrio (<span class="keyword">.</span>-SUCCESS EventType) #(net/response-ok this xhrio ok))
      (events/listen xhrio (<span class="keyword">.</span>-ERROR EventType) #(net/response-error this xhrio error))))
  (start [this] this))

(<span class="keyword">defn</span> <span class="function">make-rest-network</span> [] (map-&gt;Network {}))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The steps you need to customize are annotated in the comments of the code. There are just a few basic steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Fulcro comes with a handy function that can convert a query into an AST, which is easier to process. We don&#8217;t really
care too much about the whole query, we just want to detect what is being asked for (we&#8217;re going to ask for
<code>:posts</code>).</p>
</li>
<li>
<p>Once we&#8217;ve understood what is wanted, we create a REST URL and GET the data from the REST server.</p>
</li>
<li>
<p>When we get a successful response we need to convert the JSON into the proper EDN that the client expects. In
this case we&#8217;re looking for <code>{ :posts [ {:db/id 1 :post/body "..." :post/title "..." ] ... }</code>.</p>
</li>
<li>
<p>Once we have the properly structure tree of data to match the query, we simply pass it to the ok callback that
our send was given.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In a more complete program, you&#8217;d put hooks at steps (2) and (3) to handle all of the different REST requests, so that
the majority of this code would be a one-time thing.</p>
</div>
</div>
<div class="sect3">
<h4 id="_installing_our_networking_code"><a class="anchor" href="#_installing_our_networking_code"></a><a class="link" href="#_installing_our_networking_code">2.11.3. Installing our Networking Code</a></h4>
<div class="paragraph">
<p>Fulcro lets you set up networking yourself. We&#8217;d still like to talk to our server, but now we also want to be able
to talk to the REST server. The modification is done in our client options. For example, our devcard playground could
be changed to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.intro</span>
  (<span class="symbol">:require</span> [fulcro.client.cards <span class="symbol">:refer</span> [defcard-fulcro]]
            [app.ui.root <span class="symbol">:as</span> root]
            [fulcro.client.data-fetch <span class="symbol">:as</span> df]
            [app.rest <span class="symbol">:as</span> <span class="keyword">rest</span>]
            [app.api.mutations <span class="symbol">:as</span> api]
            [fulcro.client.network <span class="symbol">:as</span> net]))

(defcard-fulcro sample-app
  root/Root
  {}
  {<span class="symbol">:inspect-data</span> <span class="predefined-constant">true</span>
   <span class="symbol">:fulcro</span>       {
                  <span class="symbol">:networking</span> {<span class="symbol">:remote</span> (net/make-fulcro-network <span class="string"><span class="delimiter">&quot;</span><span class="content">/api</span><span class="delimiter">&quot;</span></span> <span class="symbol">:global-error-callback</span> (<span class="keyword">constantly</span> <span class="predefined-constant">nil</span>))
                               <span class="symbol">:rest</span>   (rest/make-rest-network)}
                  <span class="symbol">:started-callback</span>
                              (<span class="keyword">fn</span> [app] (df/load app <span class="symbol">:current-user</span> root/Person)
                                (df/load app <span class="symbol">:my-friends</span> root/Person {<span class="symbol">:target</span>        [<span class="symbol">:person-list/by-id</span> <span class="symbol">:friends</span> <span class="symbol">:person-list/people</span>]
                                                                      <span class="symbol">:post-mutation</span> `api/sort-friends})
                                (df/load app <span class="symbol">:my-enemies</span> root/Person {<span class="symbol">:target</span> [<span class="symbol">:person-list/by-id</span> <span class="symbol">:enemies</span> <span class="symbol">:person-list/people</span>]}))}})</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_requesting_data_from_the_alternate_remote"><a class="anchor" href="#_requesting_data_from_the_alternate_remote"></a><a class="link" href="#_requesting_data_from_the_alternate_remote">2.11.4. Requesting Data from the Alternate Remote</a></h4>
<div class="paragraph">
<p>IMPORTANT NOTE: If you&#8217;re using the dev cards, you might want to change <code>:inspect-data true</code> to <code>false</code>. Devcards get
a bit slow if you put a lot of data in the app and ask the card to format it all in the inspector. In those cases
it can be better to use Fulcro Inspect instead).</p>
</div>
<div class="paragraph">
<p>All the hard stuff is done. Loading is now triggered just like you would have before, except with a <code>:remote</code> option
to specify which network to talk over:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">                       <span class="symbol">:started-callback</span> (<span class="keyword">fn</span> [app]

                                           (df/load app <span class="symbol">:posts</span> Post {<span class="symbol">:remote</span> <span class="symbol">:rest</span> <span class="symbol">:target</span> [<span class="symbol">:post-list/by-id</span> <span class="symbol">:the-one</span> <span class="symbol">:posts</span>]})

                                           <span class="keyword">..</span><span class="keyword">.</span> as before <span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mutations_over_rest"><a class="anchor" href="#_mutations_over_rest"></a><a class="link" href="#_mutations_over_rest">2.11.5. Mutations over REST</a></h4>
<div class="paragraph">
<p>The same technique is used. Everything you&#8217;ve read is accurate for mutations as well (you&#8217;ll see the mutation come
into the <code>send</code> function). To trigger a mutation, just add another section to your client mutation (a mutation can
be sent to any number of remotes, in fact):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation delete-post
  [{<span class="symbol">:keys</span> [id]}]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>stuff to affect local db.<span class="keyword">..</span>)
  <span class="comment">; you could also include this: (remote [env] true)</span>
  (<span class="keyword">rest</span> [env] <span class="predefined-constant">true</span>)) <span class="comment">; tell the :rest networking to send this mutation</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So, <code>action</code> names the local (optimistic) effect. Each other method name <strong>must</strong> match a remote&#8217;s name as configured
in the <code>:networking</code> of the client. If you return true (or an AST) from one of these "remote" sections, it will trigger
the mutation to be sent to that network handler.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_complete_source"><a class="anchor" href="#_the_complete_source"></a><a class="link" href="#_the_complete_source">2.12. The Complete Source</a></h3>
<div class="paragraph">
<p>For your convenince this complete application is at <a href="https://github.com/fulcrologic/fulcro-getting-started" class="bare">https://github.com/fulcrologic/fulcro-getting-started</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_core_concepts"><a class="anchor" href="#_core_concepts"></a><a class="link" href="#_core_concepts">3. Core Concepts</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter covers some extra detail about core language features and theory that are important in the Fulcro ecosystem. You
need not read this chapter to use Fulcro, but it will aid in your understanding of it quite a bit.</p>
</div>
<div class="sect2">
<h3 id="_immutable_data_structures"><a class="anchor" href="#_immutable_data_structures"></a><a class="link" href="#_immutable_data_structures">3.1. Immutable Data Structures</a></h3>
<div class="paragraph">
<p>Many of the most interesting and compelling features of Fulcro are directly or
indirectly enabled (or made simpler) by the use of persistent data structures
that are a first-class citizen of the language.</p>
</div>
<div class="paragraph">
<p>In imperative programming languages like Java and Javascript you have no idea what
a function or method might do to your program state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Person p = <span class="keyword">new</span> Person();

doSomethingOnAnotherThread(p);

p.fumble();

<span class="comment">// did p just change??? Did I just cause a race condition???</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This leads to all sorts of subtle bugs and is arguably the source of many of
the hardest problems in keeping software sustainable today. What if <code>Person</code> couldn&#8217;t
change and you instead had to copy instead if you wanted to modify?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Person p = <span class="keyword">new</span> Person();

doSomethingOnAnotherThread(p);

Person q = p.fumble();

<span class="comment">// p is definitely unchanged, but q could be different</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can reason about what will happen. The other thread will see <code>p</code> exactly as
it was when you (locally) reasoned about it. Furthermore, <code>q</code> cannot be affected
because if <code>p</code> is truly "read-only" then I still know what it is when I use it to
derive <code>q</code> (the other thread can&#8217;t modify it either).</p>
</div>
<div class="paragraph">
<p>In order to derive these benefits you need to either write objects that enforce
this behavior (which is highly inconvenient and hard to make efficient
in imperative langauges), or use a programming language that supplies the ability
to do so as a first-class feature.</p>
</div>
<div class="paragraph">
<p>Another benefit is that persistent data structures can do <strong>structural sharing</strong>. Basically
the new version of a map, vector, list, or set can use references to point to any
parts of the old version that are still the same in the new version. This means,
for example, that adding an element to the head of a list that had 1,000,000 entries
(where only one is being changed) is still a constant time operation!</p>
</div>
<div class="paragraph">
<p>Here are some of the features in Fulcro that trivially result from using persistent data structures:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A Time-travel UI history viewer that consumes little space.</p>
</li>
<li>
<p>Extremely efficient detection of data changes that affect the UI (can be ref compare instead of data compare)</p>
</li>
<li>
<p>"Pure Rendering" is possible and convenient without having to resort to hidden variables in the UI.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_pure_rendering"><a class="anchor" href="#_pure_rendering"></a><a class="link" href="#_pure_rendering">3.2. Pure Rendering</a></h3>
<div class="paragraph">
<p>Fulcro uses Facebook&#8217;s React to accomplish updates to the browser DOM. React, in
concept, is really simple:</p>
</div>
<div class="paragraph">
<p>Render is a function you make that generates a data structure known as the
VDOM (a lightweight virtual DOM)</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On The first "frame", the real DOM is made to match this data structure.</p>
</li>
<li>
<p>On every subsequent frame, render is used to make a new VDOM. React
compares the prior VDOM (which is cached) to the new one, and then applies the
changes to the DOM.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The cool realization the creators of React had was that the DOM operations
that are slow and heavy, but there are efficient ways to figure out what
needs to be changed via the VDOM without you having to write a bunch of
controller logic.</p>
</div>
<div class="paragraph">
<p>Now, because React lives in a mutable space (Javascript), it allows all sorts of things
that can embed "rendering logic" within a component. This sounds like a good
idea to our OOP brains, but consider this:</p>
</div>
<div class="paragraph">
<p>What if you could have a complete snapshot of the state of your application, pass
that to a function, and have the screen just "look right". Like writing a 2D game: you
just redraw the screen based on the new "state of the world". All of the sudden your
mind shifts away from "bit twiddling" to thinking more about the representation
of your model with minimal data!</p>
</div>
<div class="paragraph">
<p>That is what we mean by "pure rendering".</p>
</div>
<div id="PureRenderingDiagram" class="imageblock">
<div class="content">
<img src="assets/img/rendering.png" alt="rendering" width="540" height="210">
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s an example to whet your appetite: Nested check-boxes.
In imperative programming each checkbox has it&#8217;s own state, and when we want a "check all"
we end up writing nightmares of logic to make sure the thing works right because we&#8217;re
having to <strong>store a mutable value</strong> into an object that then does the rendering.
Then we play with it and find out we
forgot to handle that event where some sub-box gets unchecked to
fire an event to ensure to uncheck the "select all"&#8230;&#8203;oh wait, but when I do that
it accidentally fires the event from "check all" which unchecks everything
and then goes into an infinite loop!</p>
</div>
<div class="paragraph">
<p>What a mess! Maybe you eventually figure out something that&#8217;s tractable, but
that extra bit of state in the "check all" is definitely the source of bugs.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what you do in pure rendering with immutable data:</p>
</div>
<div class="paragraph">
<p>Each sub-item checkbox is a simple data structure with a <code>:checked?</code> key that has a boolean
value. You use that to directly tell the checkbox what it&#8217;s state should be
(and React enforces that&#8230;&#8203;making it impossible for the UI to draw it any
differently)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">state</span> {<span class="symbol">:items</span> [{<span class="symbol">:id</span> <span class="symbol">:a</span> <span class="symbol">:checked?</span> <span class="predefined-constant">true</span>} {<span class="symbol">:id</span> <span class="symbol">:b</span> <span class="symbol">:checked?</span> <span class="predefined-constant">false</span>} <span class="keyword">..</span><span class="keyword">.</span>]})</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a "state of the world", these are read-only. (you have to make a "new
state of the world" to change one). When you render, the state of the
check-all is just the conjunction of it&#8217;s children&#8217;s <code>:checked?</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">let</span> [all-checked (<span class="keyword">every?</span> <span class="symbol">:checked?</span> (<span class="keyword">get</span> state <span class="symbol">:items</span>)]
   (dom/input <span class="error">#</span>js {<span class="symbol">:checked</span> all-checked}))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The check-all button would have <strong>no application state at all</strong>, and React will
force it to the correct state based on the calculated value.
When the sub-items change, a new "state of the world"
is generated with the altered item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">next-state</span> (<span class="keyword">assoc-in</span> state [<span class="symbol">:items</span> <span class="integer">0</span> <span class="symbol">:checked?</span>] <span class="predefined-constant">false</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the <strong>entire</strong> UI is re-rendered (React makes this fast
using the VDOM diff), the "check all" checkbox will just be
right!</p>
</div>
<div class="paragraph">
<p>If the "check all" button is pressed, then the logic is similarly very simple:
change the state for the subitems to checked if any were unchecked, or set them
all to unchecked if they were all checked:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">next-state-2</span>
  (<span class="keyword">let</span> [all-checked? (<span class="keyword">every?</span> <span class="symbol">:checked?</span> (<span class="keyword">get</span> state <span class="symbol">:items</span>))
        c            (<span class="keyword">not</span> all-checked?)
        old-items    (<span class="keyword">get</span> state <span class="symbol">:items</span>)
        new-items    (mapv #(<span class="keyword">assoc</span> % <span class="symbol">:checked?</span> c) old-items)]
    (<span class="keyword">assoc</span> state <span class="symbol">:items</span> new-items)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>and again you get to pretend you&#8217;re rendering an entire new frame on the screen!</p>
</div>
<div class="paragraph">
<p>You&#8217;ll be continually surprised at how simple your logic gets in the UI once you
adjust to this way of thinking about the problem.</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_driven"><a class="anchor" href="#_data_driven"></a><a class="link" href="#_data_driven">3.3. Data-Driven</a></h3>
<div class="paragraph">
<p>Data-driven concepts were pioneered in web development by Facebook&#8217;s GraphQL and
Netflix&#8217;s Falcor. The idea is quite powerful, and eliminates huge amounts of
complexity is your network communication and application development.</p>
</div>
<div class="paragraph">
<p>The basic idea is this: Your UI, which might have various versions (mobile, web, tablet)
all have different, but related, data needs. The prevalent way of talking to our
servers is to use REST, but REST itself isn&#8217;t a very good query <em>or</em> update
language. It creates a lot of complexity that we have to deal with in order
to do the simplest things. In the small, it is "easy". In the large, it isn&#8217;t
the best fit.</p>
</div>
<div class="paragraph">
<p>Data-driven applications basically use a more detailed protocol that allows the
client UIs to specify what they need, and also typically includes a "mutation
on the wire" notation that allows the client to abstractly say what it
needs the server to do.</p>
</div>
<div class="paragraph">
<p>So, instead of <code>/person/3</code> you can instead say "I need person 3, but only their
name, age, and billing info. But in the billing info, I only need to know their
billing zip code".</p>
</div>
<div class="paragraph">
<p>Notice that this abstract expression (which of course has a syntax we&#8217;re
not showing you yet) is "walking a graph". This is why Facebook calls their language
"GraphQL".</p>
</div>
<div class="paragraph">
<p>You can imagine that the person and billing info might be stored in two tables
of a database, with a to-one relationship, and our query is basically asking
to query this little sub-graph:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/graph-query-abstract.png" alt="graph query abstract" width="480" height="70">
</div>
</div>
<div class="paragraph">
<p>Modifications are done in a similar, abstract way. We model them as if
they were "function calls on the wire". Like RPC/RMI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">'(change-person {<span class="symbol">:id</span> <span class="integer">3</span> <span class="symbol">:age</span> <span class="integer">44</span>})</code></pre>
</div>
</div>
<div class="paragraph">
<p>but instead of actually <em>calling</em> the function, we encode this list as
a data structure (it is a list containing a symbol and a map: the power of Clojure!) and then process that
data locally (in the back-end of the UI) and optionally also
transmit it <em>as data</em> over the wire for server processing!</p>
</div>
</div>
<div class="sect2">
<h3 id="GraphDB"><a class="anchor" href="#GraphDB"></a><a class="link" href="#GraphDB">3.4. Graph Database</a></h3>
<div class="paragraph">
<p>The client-side of Fulcro keeps all relevant data in a simple graph database, which
is referenced by a single top-level atom. The database itself is a persistent map.</p>
</div>
<div class="paragraph">
<p>The database should be thought of as a root-level node (the top-level map itsef),
and tables that can hold data relevant to any
particular component or entity in your program (component or entity nodes).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/dbmodel.png" alt="dbmodel" width="270" height="182">
</div>
</div>
<div class="paragraph">
<p>The tables are also simple maps, with a naming convention and well-defined structure.
The name of the table is typically namespaced with the "kind" of thing you&#8217;re storing,
and has a name that indicates the way it is indexed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:person/by-id</span> { <span class="integer">4</span>    { <span class="symbol">:id</span> <span class="integer">4</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> }}}
<span class="comment">;   ^      ^      ^    ^</span>
<span class="comment">; kind   indexed  id   entity value itself</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_idents"><a class="anchor" href="#_idents"></a><a class="link" href="#_idents">3.4.1. Idents</a></h4>
<div class="paragraph">
<p>Items are joined together into a graph using a tuple of the table name and the key of
an entity. For example, the item above is known as <code>[:person/by-id 4]</code>. Notice that this
tuple is also exactly the vector you&#8217;d need in an operation that would pull data from that
entity or modify it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">update-in</span> state-db [<span class="symbol">:person/by-id</span> <span class="integer">4</span>] <span class="keyword">assoc</span> <span class="symbol">:person/age</span> <span class="integer">33</span>)
(<span class="keyword">get-in</span> state-db [<span class="symbol">:person/by-id</span> <span class="integer">4</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>These tuples are known as <em>idents</em>. Idents can be used anywhere one node
in the graph needs to point to another. If the idents (which are vectors)
<em>appear</em> in a vector, then you are creating a <em>to-many</em> relation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:person/by-id</span>
    {  <span class="integer">1</span>  {<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span>
           <span class="symbol">:person/spouse</span> [<span class="symbol">:person/by-id</span> <span class="integer">4</span>]         <b class="conum">(1)</b>
           <span class="symbol">:person/children</span> [ [<span class="symbol">:person/by-id</span> <span class="integer">2</span>]
                              [<span class="symbol">:person/by-id</span> <span class="integer">3</span>] ] } <b class="conum">(2)</b>
       <span class="integer">2</span>  { <span class="symbol">:id</span> <span class="integer">2</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Julie</span><span class="delimiter">&quot;</span></span> }
       <span class="integer">3</span>  { <span class="symbol">:id</span> <span class="integer">3</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Billy</span><span class="delimiter">&quot;</span></span> }
       <span class="integer">4</span>  { <span class="symbol">:id</span> <span class="integer">4</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Heather</span><span class="delimiter">&quot;</span></span>
            <span class="symbol">:person/spouse</span> [<span class="symbol">:person/by-id</span> <span class="integer">1</span>]}}      <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A to-one relation to Joe&#8217;s spouse (Heather)</p>
</li>
<li>
<p>A to-many relation to Joe&#8217;s kids</p>
</li>
<li>
<p>A to-relation back to Joe from Heather</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Notice in the example above that Joe and Heather point at each other. This creates
a <em>loop</em> in the graph. This is perfectly legal. Graphs can contain loops. The
table in the example contains 4 nodes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_complete_database"><a class="anchor" href="#_a_complete_database"></a><a class="link" href="#_a_complete_database">3.4.2. A Complete Database</a></h4>
<div class="paragraph">
<p>The client database treats the <em>root</em> node as a special set of non-table properties
in the top of the database map. Thus, an entire state database with <em>root node</em>
properties might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:people</span> [ [<span class="symbol">:person/by-id</span> <span class="integer">1</span>] [<span class="symbol">:person/by-id</span> <span class="integer">2</span>]                       <b class="conum">(1)</b>
            [<span class="symbol">:person/by-id</span> <span class="integer">3</span>] [<span class="symbol">:person/by-id</span> <span class="integer">4</span>] ]
  <span class="symbol">:person/by-id</span>                                                       <b class="conum">(2)</b>
    {  <span class="integer">1</span>  {<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span>
           <span class="symbol">:person/spouse</span> [<span class="symbol">:person/by-id</span> <span class="integer">4</span>]
           <span class="symbol">:person/children</span> [ [<span class="symbol">:person/by-id</span> <span class="integer">2</span>] [<span class="symbol">:person/by-id</span> <span class="integer">3</span>] ] }
       <span class="integer">2</span>  { <span class="symbol">:id</span> <span class="integer">2</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Julie</span><span class="delimiter">&quot;</span></span> }
       <span class="integer">3</span>  { <span class="symbol">:id</span> <span class="integer">3</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Billy</span><span class="delimiter">&quot;</span></span> }
       <span class="integer">4</span>  { <span class="symbol">:id</span> <span class="integer">4</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Heather</span><span class="delimiter">&quot;</span></span>
            <span class="symbol">:person/spouse</span> [<span class="symbol">:person/by-id</span> <span class="integer">1</span>]}}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A root property called <code>:people</code> that points to all of the people nodes</p>
</li>
<li>
<p>The people table that contains the people nodes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The above data structure can now be thought of as a graph database looking like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/dbgraph.png" alt="dbgraph" width="510" height="448">
</div>
</div>
<div class="paragraph">
<p>This makes for a very compact representation of a graph with an arbitrary number of nodes and edges.
All nodes but the special "root node" live in tables. The root node itself is special because
it is the storage location for both root properties <strong>and</strong> for the tables themselves.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Since the root node and the tables containing other nodes are merged
together into the same overall map it is important that you use
care when storing things so as not to accidentally collide on a name. Larger programs
should namespace all keywords.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_a_special_note_about_the_client_side_database"><a class="anchor" href="#_a_special_note_about_the_client_side_database"></a><a class="link" href="#_a_special_note_about_the_client_side_database">3.4.3. A Special Note about The Client-Side Database</a></h4>
<div class="paragraph">
<p>The graph database on the client is the most central and key concept to understand in Fulcro. Remember
that we are doing pure rendering. This means that the UI is simply a function transforming this
graph database into the the UI.</p>
</div>
<div class="paragraph">
<p>There are two primary things to write in Fulcro: the UI and the mutations. The UI pulls data from
this database and displays it. The mutations evolve this database to a new version.
Every interaction that changes the UI should be thought of as a <strong>data manipulation</strong>. You&#8217;re making
a new <strong>state of the world</strong> that your pure renderer turns into DOM.</p>
</div>
<div class="paragraph">
<p>The graph format of the database means that your data manipulation, the main dynamic thing in
the entire application, is simplified down to updating properties/nodes, which themselves
live at the top of the state atom or are only 2-3 levels deep:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">; change the root list of people, and modify the name and age of person 2</span>
(<span class="keyword">swap!</span> state (<span class="keyword">fn</span> [s]
               (<span class="keyword">-&gt;</span> s
                 (<span class="keyword">assoc</span> <span class="symbol">:people</span> [[<span class="symbol">:people/by-id</span> <span class="integer">1</span>] [<span class="symbol">:people/by-id</span> <span class="integer">2</span>]])
                 (<span class="keyword">assoc-in</span> [<span class="symbol">:people/by-id</span> <span class="integer">2</span> <span class="symbol">:person/name</span>] <span class="string"><span class="delimiter">&quot;</span><span class="content">George</span><span class="delimiter">&quot;</span></span>)
                 (<span class="keyword">assoc-in</span> [<span class="symbol">:people/by-id</span> <span class="integer">2</span> <span class="symbol">:person/age</span>] <span class="integer">33</span>))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the most part the UI takes care of itself. Clojure has very good functions for manipulating
maps and vectors, so even when your data structures get more complex the task is still about
as simple as it can be.</p>
</div>
</div>
<div class="sect3">
<h4 id="_client_database_naming_conventions"><a class="anchor" href="#_client_database_naming_conventions"></a><a class="link" href="#_client_database_naming_conventions">3.4.4. Client Database Naming Conventions</a></h4>
<div class="paragraph">
<p>To avoid collisions in your database, the following naming conventions are recommended for
use in the Fulcro client-side graph database:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>UI-only Properties</strong>
</td>
<td class="hdlist2">
<p><code>:ui/name</code>. These are special in that they never end up in server queries
derived from components. Can be used on any node to hold UI-only state. Not needed if the node itself
is not involved with server interaction.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Tables</strong>
</td>
<td class="hdlist2">
<p><code>:entity-type/index-indicator</code>. Examples: <code>:person/by-id</code> or <code>:graph/by-type</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Root properties</strong>
</td>
<td class="hdlist2">
<p><code>:root/prop-name</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Targeted Loads</strong>
</td>
<td class="hdlist2">
<p>Loads temporarily place their results in root. Targeting relocates them. If you&#8217;ve followed the
other naming conventions, then these can elide a namespace if that facilitates server interactions.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Node properties</strong>
</td>
<td class="hdlist2">
<p><code>:entity-type/property-name</code>. Examples: <code>:person/name</code> or <code>:graph/data</code></p>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_component_rendering"><a class="anchor" href="#_component_rendering"></a><a class="link" href="#_component_rendering">4. Component Rendering</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_html5_element_factories"><a class="anchor" href="#_html5_element_factories"></a><a class="link" href="#_html5_element_factories">4.1. HTML5 Element Factories</a></h3>
<div class="paragraph">
<p>The core of DOM rendering is taken care of by simple factory functions that
generate the core VDOM elements. These stand-ins are ultimately what React
uses to generate, diff, and update the real DOM.</p>
</div>
<div class="paragraph">
<p>So, there are functions for every possible HTML5 element. These are in the
<code>fulcro.client.dom</code> namespace, and take a Javascript map for attributes (this gives
optimal performance, since React wants to consume Javascript data):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(dom/div <span class="error">#</span>js { <span class="symbol">:className</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">some-class</span><span class="delimiter">&quot;</span></span> }
  (dom/ul <span class="predefined-constant">nil</span>
    (dom/li <span class="keyword">..</span><span class="keyword">.</span>)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that this (nested) call of functions results in a representation (VDOM) of
what you&#8217;d like to end up on the screen.</p>
</div>
<div class="paragraph">
<p>The next level of abstraction you can use is simply a function.
Combining more complex bits of UI into a function is a great way to group
re-usable nested DOM:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">my-header</span> []
  (dom/div <span class="error">#</span>js { <span class="symbol">:className</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">some-class</span><span class="delimiter">&quot;</span></span> }
    (dom/ul <span class="predefined-constant">nil</span>
      (dom/li <span class="keyword">..</span><span class="keyword">.</span>))))</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_fulcro_and_react_dom_notes"><a class="anchor" href="#_fulcro_and_react_dom_notes"></a><a class="link" href="#_fulcro_and_react_dom_notes">4.1.1. Fulcro and React DOM – Notes</a></h4>
<div class="paragraph">
<p>Here are some common things you&#8217;ll want to know how to do that are different when rendering with Fulcro:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inline styles are specified with JS maps <code>(dom/p #js { :style #js {:backgroundColor \"rgb(120,33,41)\"} } ...)</code>.</p>
<div class="ulist">
<ul>
<li>
<p><code>#js</code> is a reader tag. The reader is the thing that reads your source code, and it is configurable. This one
tells the reader how to turn the map into a js object.</p>
</li>
<li>
<p><code>dom/p</code> is a function for generating p tags for use in React componenets. There is one of these for every legal HTML tag.</p>
</li>
</ul>
</div>
</li>
<li>
<p>There are alternatives to this ([sablono](<a href="https://github.com/r0man/sablono" class="bare">https://github.com/r0man/sablono</a>) is popular). It adds some overhead, but many
people prefer how it reads.</p>
</li>
<li>
<p>Attributes follow the react naming conventions for [Tags and Attributes](<a href="https://facebook.github.io/react/docs/tags-and-attributes.html" class="bare">https://facebook.github.io/react/docs/tags-and-attributes.html</a>)</p>
<div class="ulist">
<ul>
<li>
<p>As an example - CSS class names are specified with <code>:className</code> instead of <code>:class</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Any time there are adjacent elements of the same type in the DOM, they should each have a unique <code>:key</code>
attribute. If the elements are in an array, React requires it.</p>
</li>
<li>
<p>You can convert cljs data structures (recursively) to js types with <code>(clj-&gt;js {:x {y 1}})</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_code_defsc_code_macro_2"><a class="anchor" href="#_the_code_defsc_code_macro_2"></a><a class="link" href="#_the_code_defsc_code_macro_2">4.2. The <code>defsc</code> Macro</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you&#8217;re new to Fulcro and started with version 2.0, you can safely ignore most comments about <code>defui</code>. The two
are rougly equivalent, with <code>defsc</code> being the newer.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Fulcro&#8217;s defsc is a front-end to the legacy defui macro. It is sanity-checked for the most common elements: ident (optional), query,
render, and initial state (optional). The sanity checking prevents a lot of the most common errors when writing a component,
and the concise syntax reduces boilerplate to the essential novelty. The name means "define stateful component" and is
intended to be used with components that have queries (though that is not a requirement).</p>
</div>
<div class="sect3">
<h4 id="_the_argument_list"><a class="anchor" href="#_the_argument_list"></a><a class="link" href="#_the_argument_list">4.2.1. The Argument List</a></h4>
<div class="paragraph">
<p>The primary argument list contains the common elements you might need to use in the body:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc [this props &lt;optional-computed&gt; &lt;optional-css-map-if-using-css&gt;]
 { <span class="keyword">..</span><span class="keyword">.</span>options.<span class="keyword">..</span> }
 (dom/div <span class="error">#</span>js {<span class="symbol">:onClick</span> (<span class="symbol">:onClick</span> computed)} (<span class="symbol">:db/id</span> props)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last parameter will let you destructure fulcro-css names, if and only if you&#8217;re using the Fulcro CSS library.</p>
</div>
<div class="paragraph">
<p>Only the first two parameters are required, so you can even write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc [this props]
 { <span class="keyword">..</span><span class="keyword">.</span>options.<span class="keyword">..</span> }
 (dom/div <span class="predefined-constant">nil</span> (<span class="symbol">:db/id</span> props)))</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_argument_destructuring"><a class="anchor" href="#_argument_destructuring"></a><a class="link" href="#_argument_destructuring">Argument Destructuring</a></h5>
<div class="paragraph">
<p>The parameter list fully supports Clojure destructuring on the props, computed, and css-name-map without having to write a
separate let:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc DestructuredExample [this
                            {<span class="symbol">:keys</span> [db/id] <span class="symbol">:as</span> props}
                            {<span class="symbol">:keys</span> [onClick] <span class="symbol">:as</span> computed <span class="symbol">:or</span> {onClick <span class="keyword">identity</span>}}
                            {<span class="symbol">:keys</span> [my-css-class] <span class="symbol">:as</span> css-name-map}]
  {<span class="symbol">:query</span>         [<span class="symbol">:db/id</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:db/id</span> <span class="integer">22</span>}
   <span class="symbol">:css</span>           [[<span class="symbol">:.</span>my-css-class {<span class="symbol">:color</span> <span class="symbol">:black</span>}]]}
  (dom/div <span class="error">#</span>js {<span class="symbol">:className</span> my-css-class}
    (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Component: </span><span class="delimiter">&quot;</span></span> id)))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_options_lambda_vs_template"><a class="anchor" href="#_options_lambda_vs_template"></a><a class="link" href="#_options_lambda_vs_template">4.2.2. Options – Lambda vs. Template</a></h4>
<div class="paragraph">
<p>The core options (:query, :ident, :initial-state, :css, and :css-include) of <code>defsc</code> support both a lambda and a template
form. The template form is shorter and enables some sanity checks; however, it is not expressive enough to cover all
possible cases. The lambda form is slightly more verbose, but enables full flexibility at the expense of the sanity checks.</p>
</div>
<div class="paragraph">
<p>IMPORTANT NOTE: In lambda mode use <code>this</code> and <code>props</code> from the <code>defsc</code> argument list. So, for example, <code>(fn [] [:x])</code> is
valid for query (this is added by the macro), and <code>(fn [] [:table/by-id id])</code> is valid for ident.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ident_generation"><a class="anchor" href="#_ident_generation"></a><a class="link" href="#_ident_generation">4.2.3. Ident Generation</a></h4>
<div class="paragraph">
<p>If you include <code>:ident</code>, it can take two forms: a template or lambda.</p>
</div>
<div class="sect4">
<h5 id="_template_idents"><a class="anchor" href="#_template_idents"></a><a class="link" href="#_template_idents">Template Idents</a></h5>
<div class="paragraph">
<p>A template ident is just a vector that patterns what goes in the ident. The first element is always literal, and the
second is the name of the property to pull from props to get the ID.</p>
</div>
<div class="paragraph">
<p>This is the most common case, and if you use the template mechanism you get some added sanity checks: it won&#8217;t compile
if your ID key isn&#8217;t in your query, eliminating some possible frustration.</p>
</div>
</div>
<div class="sect4">
<h5 id="_lambda_idents"><a class="anchor" href="#_lambda_idents"></a><a class="link" href="#_lambda_idents">Lambda Idents</a></h5>
<div class="paragraph">
<p>Template idents are great for the common case, but they don&#8217;t work if you have a single instance ever (i.e. you want
a literal second element), and they won&#8217;t work at all for union queries. They also do not support embedded code.
Therefore, if you want a more advanced ident, you&#8217;ll need to spell out the code.</p>
</div>
<div class="paragraph">
<p><code>defsc</code> at least eliminates some of the boilerplate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc UnionComponent [this {<span class="symbol">:keys</span> [db/id component/type]}]
  {<span class="symbol">:ident</span> (<span class="keyword">fn</span> [] (union-ident <span class="keyword">type</span> id))} <span class="comment">; id and type are destructured into the method for you.</span>
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_query"><a class="anchor" href="#_query"></a><a class="link" href="#_query">4.2.4. Query</a></h4>
<div class="paragraph">
<p><code>defsc</code> also allows you to specify the query as a template or lambda.</p>
</div>
<div class="sect4">
<h5 id="_template_query"><a class="anchor" href="#_template_query"></a><a class="link" href="#_template_query">Template Query</a></h5>
<div class="paragraph">
<p>The template form is strongly recommended for most cases, because without it many of the sanity checks won&#8217;t work.</p>
</div>
<div class="paragraph">
<p>In template mode, the following sanity checks are enabled:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The props destructuring</p>
</li>
<li>
<p>The ident&#8217;s id name is in the query (if ident is in template mode)</p>
</li>
<li>
<p>The initial app state only contains things that are queried for (if it is in template mode as well)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_lambda_query"><a class="anchor" href="#_lambda_query"></a><a class="link" href="#_lambda_query">Lambda Query</a></h5>
<div class="paragraph">
<p>This mode is necessary if you use more complex queries. The template mode currently does not support union queries.</p>
</div>
<div class="paragraph">
<p>To use this mode, specify your query as <code>(fn [] [:x])</code>. In lambda mode, <code>this</code> comes from the argument list of <code>defsc</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_initial_state"><a class="anchor" href="#_initial_state"></a><a class="link" href="#_initial_state">4.2.5. Initial State</a></h4>
<div class="paragraph">
<p>As with <code>:query</code> and <code>:ident</code>, <code>:initial-state</code> supports a template and lambda form.</p>
</div>
<div class="paragraph">
<p>The template form for initial state is a bit magical, because it tries to sanity check your initial state, but also has
to support relations through joins. Finally it tries to eliminate typing for you by auto-wrapping nested relation
initializations in get-initial-state for you by deriving the correct class to use from the query.
This further reduces the chances of error; however, you may find the terse result more difficult to read and
instead choose to write it yourself. Both ways are supported:</p>
</div>
<div class="sect4">
<h5 id="_lambda_mode"><a class="anchor" href="#_lambda_mode"></a><a class="link" href="#_lambda_mode">Lambda mode</a></h5>
<div class="paragraph">
<p>This is simple to understand, and all you need to see is a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Component [this props]
 {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] <span class="keyword">..</span><span class="keyword">.</span>exactly what you'd write in defui.<span class="keyword">..</span>)}
 <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_template_mode"><a class="anchor" href="#_template_mode"></a><a class="link" href="#_template_mode">Template Mode</a></h5>
<div class="paragraph">
<p>In template mode <code>:initial-state</code> converts incoming parameters (which must use simple keywords) into :param/X keys. So,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Person [this props]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:db/id</span> <span class="symbol">:param/id</span>}}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>means:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Person [this props]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:db/id</span> (<span class="symbol">:params</span> id)}})}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is even more powerful that that, because it analyzes your query and can deal with to-one and to-many join initialization as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Person [this props]
  {<span class="symbol">:query</span> [{<span class="symbol">:person/job</span> (prim/get-query Job)}]
  <span class="symbol">:initial-state</span> {<span class="symbol">:person/job</span> {<span class="symbol">:job/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Welder</span><span class="delimiter">&quot;</span></span>}}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>means (in simplified terms):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Person [this props]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:person/job</span> (prim/get-initial-state Job {<span class="symbol">:job/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Welder</span><span class="delimiter">&quot;</span></span>})})}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the magic there. <code>Job</code> was pulled from the query by looking for joins on the initialization keyword (<code>:person/job</code>).</p>
</div>
<div class="paragraph">
<p>To-many relations are also auto-derived:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Person [this props]
  {<span class="symbol">:query</span> [{<span class="symbol">:person/prior-jobs</span> (prim/get-query Job)}]
  <span class="symbol">:initial-state</span> {<span class="symbol">:person/prior-jobs</span> [{<span class="symbol">:job/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Welder</span><span class="delimiter">&quot;</span></span>} {<span class="symbol">:job/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Cashier</span><span class="delimiter">&quot;</span></span>]}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>means (in simplified terms):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Person [this props]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params]
    {<span class="symbol">:person/prior-jobs</span> [(prim/get-initial-state Job {<span class="symbol">:job/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Welder</span><span class="delimiter">&quot;</span></span>})
                         (prim/get-initial-state Job {<span class="symbol">:job/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Cashier</span><span class="delimiter">&quot;</span></span>})]})}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The internal steps for processing this template are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace all uses of :param/nm with (get params :nm)</p>
</li>
<li>
<p>The query is analyzed for joins on keywords (ident joins are not supported).</p>
<div class="ulist">
<ul>
<li>
<p>If a key in the initial state matches up with a join, then the value in initial state must be a map or a vector.
In that case (get-initial-state JoinClass p) will be called for each map (to-one) or mapped across the vector (to-many).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>REMEMBER: the value that you use in the initial-state for children is the parameter map to use against that child&#8217;s
initial state function. To-one and to-many relations are implied by what you pass (a map is to-one, a vector is to-many).</p>
</div>
<div class="paragraph">
<p>Step (1) means that nesting of param-namespaced keywords is supported, but realize that the params come from the
<strong>declaring component&#8217;s</strong> initial state parameters, they are substituted <strong>before</strong> being passed to the child.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_css_support"><a class="anchor" href="#_css_support"></a><a class="link" href="#_css_support">4.2.6. CSS Support</a></h4>
<div class="paragraph">
<p>Support for using <code>fulcrologic/fulcro-css</code> is built-in, but it is a dynamic dependency so to use it you must include
the <code>fulcrologic/fulcro-css</code> library in your project dependencies and require the <code>fulcro-css.css</code> namespace in any file
that uses this support.</p>
</div>
<div class="paragraph">
<p>The keys in the options map are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:css</code> - The items to put in protocol method css/local-rules. Can be pure garden data, or <code>(fn [] ...)</code></p>
</li>
<li>
<p><code>:css-include</code> - The items to put in protocol method css/include-children. Can be a vector of classes, or <code>(fn [] ...)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both are optional. If you use neither, then your code will not incur a dependency on the fulcro-css library.</p>
</div>
<div class="paragraph">
<p>See Fulcro CSS for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_react_lifecycle_methods"><a class="anchor" href="#_react_lifecycle_methods"></a><a class="link" href="#_react_lifecycle_methods">4.2.7. React Lifecycle Methods</a></h4>
<div class="paragraph">
<p>The options of defsc allow for React Lifecylcle methods to be defined (as lambdas). The <code>this</code> parameter of <code>defsc</code> is
in scope for all of them, but <strong>not</strong> <code>props</code> or <code>computed</code>. You can obtain computed using <code>prim/get-computed</code>. This is
because the lifecycle method may receive prior or next props, and using the top parameter list could be confusing.</p>
</div>
<div class="paragraph">
<p>The signatures are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Component [this props]
    <span class="comment">; remember that 'this' is in scope for lifecycle</span>
    <span class="symbol">:initLocalState</span>            (<span class="keyword">fn</span> [] <span class="keyword">..</span><span class="keyword">.</span>)
    <span class="symbol">:shouldComponentUpdate</span>     (<span class="keyword">fn</span> [next-props next-state] <span class="keyword">..</span><span class="keyword">.</span>)
    <span class="symbol">:componentWillReceiveProps</span> (<span class="keyword">fn</span> [next-props] <span class="keyword">..</span><span class="keyword">.</span>)
    <span class="symbol">:componentWillUpdate</span>       (<span class="keyword">fn</span> [next-props next-state] <span class="keyword">..</span><span class="keyword">.</span>)
    <span class="symbol">:componentDidUpdate</span>        (<span class="keyword">fn</span> [prev-props prev-state] <span class="keyword">..</span><span class="keyword">.</span>)
    <span class="symbol">:componentWillMount</span>        (<span class="keyword">fn</span> [] <span class="keyword">..</span><span class="keyword">.</span>)
    <span class="symbol">:componentDidMount</span>         (<span class="keyword">fn</span> [] <span class="keyword">..</span><span class="keyword">.</span>)
    <span class="symbol">:componentWillUnmount</span>      (<span class="keyword">fn</span> [] <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the React documentation for more details on how these work.</p>
</div>
<div class="sect4">
<h5 id="_additional_protocol_support"><a class="anchor" href="#_additional_protocol_support"></a><a class="link" href="#_additional_protocol_support">Additional Protocol Support</a></h5>
<div class="paragraph">
<p>If you need to include additional protocols (or lifecycle React methods) on the generated class then you can use the
<code>:protocols</code> option. It takes a list of forms that have the same shape as the body of a <code>defui</code>, and the <code>static</code> qualifier
is supported. If you supply <code>Object</code> methods then they will be properly combined with the generated render:</p>
</div>
<div class="paragraph">
<p>Here is an example of adding Fulcro CSS using protocols instead of options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc MyComponent [this props]
   {<span class="symbol">:protocols</span> (Object
                static css/CSS
                (local-rules [_] [])
                (include-children [_] []))
    <span class="keyword">..</span><span class="keyword">.</span>}
   (dom/div <span class="predefined-constant">nil</span> <span class="keyword">..</span><span class="keyword">.</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives you the full protocol capabilities of <code>defui</code>, but you only need the extra protocol additions when you
use methods and protocols beyond the central ones.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sanity_checking"><a class="anchor" href="#_sanity_checking"></a><a class="link" href="#_sanity_checking">4.2.8. Sanity Checking</a></h4>
<div class="paragraph">
<p>The sanity checking mentioned in the earlier sections causes compile errors. The errors are intended to be self-explanatory.
They will catch common mistakes (like forgetting to query for data that you&#8217;re pulling out of props, or misspelling a property).</p>
</div>
<div class="paragraph">
<p>Feel free to edit the components in this source file and try out the sanity checking. For example, try:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mismatching the name of a prop in options with a destructured name in props.</p>
</li>
<li>
<p>Destructuring a prop that isn&#8217;t in the query</p>
</li>
<li>
<p>Including initial state for a field that is not listed as a prop or child in options.</p>
</li>
<li>
<p>Using a scalar value for the initial value of a child (instead of a map or vector of maps)</p>
</li>
<li>
<p>Forget to query for the ID field of a component that is stored at an ident</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In some cases the sanity checking is more aggressive that you might desire. To get around it simply use the lambda style.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_factories"><a class="anchor" href="#_factories"></a><a class="link" href="#_factories">4.3. Factories</a></h3>
<div class="paragraph">
<p>Factories are how you generate React elements (the virtual DOM nodes) from your React classes defined with
<code>defsc</code>. You make a new factory using <code>fulcro.client.primitives/factory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">ui-component</span> (prim/factory MyComponent {<span class="symbol">:keyfn</span> f <span class="symbol">:validator</span> v <span class="symbol">:instrument?</span> <span class="predefined-constant">true</span>}))</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are 3 supported options to a factory:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:keyfn</code>
</td>
<td class="hdlist2">
<p>A function from <code>props</code> to a React key. Should generally be supplied to ensure React rendering can properly diff.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:validator</code>
</td>
<td class="hdlist2">
<p>A function from props to boolean. If it returns false then an assertion will be thrown at runtime.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:instrument?</code>
</td>
<td class="hdlist2">
<p>A boolean. If true, it indicates that instrumentation should be enabled on the component.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Instrumentation is a function you can install on the reconciler that wraps component <code>render</code> allowing you to add
measurement and debugging code to your component&#8217;s rendering.</p>
</div>
<div class="paragraph">
<p>In Fulcro documentation we generally adopt the naming convention for UI factories to be prefixed with <code>ui-</code>. This
is because you often want to name joins the same thing as a component: e.g. your query might be
<code>[{:child (prim/get-query Child)}]</code>, and then when you destructure in render: <code>(let [{:keys [child]} (prim/props this) ...</code>
you have local data in the symbol <code>child</code>. If your UI factory was also called <code>child</code> then it would cause annoying name
collisions. Prefixing the factories with <code>ui-</code> makes it very clear what is data and what is an element factory.</p>
</div>
</div>
<div class="sect2">
<h3 id="_render_and_props"><a class="anchor" href="#_render_and_props"></a><a class="link" href="#_render_and_props">4.4. Render and Props</a></h3>
<div class="paragraph">
<p>Properties are always passed to a component factory as the first argument. The properties can be accessed
from within <code>render</code> by calling <code>fulcro.client.primitives/props</code> on the parameter passed to <code>render</code> (typically named <code>this</code>
to remind you that it is a reference to the instance itself).</p>
</div>
<div class="paragraph">
<p>In components with queries there is a strong correlation between the query (which must join the child&#8217;s query),
props (from which you must extract the child&#8217;s props), and calling of the child&#8217;s factory
(to which you must pass the child&#8217;s data).</p>
</div>
<div class="paragraph">
<p>If you are using components that do not have queries, then you may pass whatever properties you deem useful.</p>
</div>
<div class="paragraph">
<p>Details about additional aspects of rendering are in the sections that follow.</p>
</div>
<div class="sect3">
<h4 id="_derived_values"><a class="anchor" href="#_derived_values"></a><a class="link" href="#_derived_values">4.4.1. Derived Values</a></h4>
<div class="paragraph">
<p>It is possible that your logic and state will be much simpler if your UI components derive some values at render time.
A prime example of this is the state of a "check all" button. The state of such a button is dependent on other components
in the UI, and it is <strong>not</strong> a separate value. Thus, your UI should compute it and not store it else it could
easily become out of sync and lead to more complex logic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">item-checked?</span> [item] (<span class="symbol">:checked?</span> item))

(defsc Checkboxes [this {<span class="symbol">:keys</span> [items]}]
  {<span class="symbol">:query</span> [{<span class="symbol">:items</span> (prim/get-query CheckboxItem)}]}
  (<span class="keyword">let</span> [all-checked? (every item-checked? items)]
    (dom/div <span class="predefined-constant">nil</span>
      <span class="string"><span class="delimiter">&quot;</span><span class="content">All: </span><span class="delimiter">&quot;</span></span> (dom/input <span class="error">#</span>js {<span class="symbol">:checked</span> all-checked? <span class="keyword">..</span><span class="keyword">.</span>})
    (dom/ul <span class="predefined-constant">nil</span> <span class="keyword">..</span><span class="keyword">.</span>))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>General Guidelines for Derived Values</p>
</div>
<div class="paragraph">
<p>You should consider computing a derived value when:
- The known data from the props already gives you sufficient information to calculate the value.
- The computation is relatively light.</p>
</div>
<div class="paragraph">
<p>Some examples where UI computation are effective, light, or even necessary:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Rendering an internationalized value. (e.g. <code>tr</code>)</p>
</li>
<li>
<p>Rendering a check-all button</p>
</li>
<li>
<p>Rendering "row numbering" or other decorations like row highlighting</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are some trade-offs, but most significantly you generally do <strong>not</strong> want to compute things like the order/pagination of a list of items.
The logic and overhead in sorting and pagination often needs caching, and there are
clear and easy "events" (user clicking on sort-by-name) that make it clear when to call the mutation to update
the database. You still have to store the selected sort order, and you have to have idents pointing to the list of
items. It is possible for your "selected sort order" and list to become out of sync, but the trade-offs of sorting
in the UI are typically high, particularly when pagination is involved and large amounts of data would have
to be fed to the UI.</p>
</div>
</div>
<div class="sect3">
<h4 id="_computed_props_and_callbacks"><a class="anchor" href="#_computed_props_and_callbacks"></a><a class="link" href="#_computed_props_and_callbacks">4.4.2. Computed Props and Callbacks</a></h4>
<div class="paragraph">
<p>Many reusable components will need to tell their parent about some event. For example, a list item generally wants
to tell the parent when the user has clicked on the "remote" button for that item. The item itself cannot
be truly composable if it has to know details of the parent. But a parent must always know the details of
a child (it rendered it, didn&#8217;t it?). As such, manipulations that affect the content of a parent should be
communicated to that parent for processing. The mechanism for this is identical to what you&#8217;d do in stock
React: callbacks from the child.</p>
</div>
<div class="paragraph">
<p>The one <strong>major</strong> difference is how you pass the callback <strong>to</strong> a component.</p>
</div>
<div class="paragraph">
<p>The query and data feed mechanisms that supply props to a component are capable of refreshing a child <strong>without</strong>
refreshing a parent. This UI optimization can pull the props directly from the database using the query, and
re-feed them to the child.</p>
</div>
<div class="paragraph">
<p>But this mechanism knows nothing about callbacks, because they are not (and should not be) stored in
the client database. Such a targeted refresh of a component cannot pass callbacks through the props
because the parent is where that is coded, but the parent may not be involved in the refresh!</p>
</div>
<div class="paragraph">
<p>So, any value (function or otherwise) that is generated on-the-fly by the parent must be passed via
<code>fulcro.client.primitives/computed</code>. This tells the data feed system how to reconstruct the complete data should it do a targeted update.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Child [this {<span class="symbol">:keys</span> [y]}]
  {<span class="symbol">:query</span> [<span class="symbol">:y</span>]}
  (<span class="keyword">let</span> [onDelete (prim/get-computed this <span class="symbol">:onDelete</span>)]
    <span class="keyword">..</span><span class="keyword">.</span>))

(defsc Parent [this {<span class="symbol">:keys</span> [x child]}]
  {<span class="symbol">:query</span>  [<span class="symbol">:x</span> {<span class="symbol">:child</span> (prim/get-query Child)}]}
  (<span class="keyword">let</span> [onDelete (<span class="keyword">fn</span> [id] (prim/transact! <span class="keyword">..</span><span class="keyword">.</span>))
        child-props-with-callbacks (prim/computed child {<span class="symbol">:onDelete</span> onDelete})]
    (ui-child child-props-with-callbacks)))</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Not understanding this can cause a lot of head scratching: The initial render will always work perfectly,
because the parent is involved. All events will be processed, and you&#8217;ll think everything is fine; however, if you
have passed a callback incorrectly it will mysteriously stop working after a (possibly unnoticeable) refresh. This
means you&#8217;ll "test it" and say it is OK, only to discover you have a bug that shows up during heavier use.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_children"><a class="anchor" href="#_children"></a><a class="link" href="#_children">4.4.3. Children</a></h4>
<div class="paragraph">
<p>A very common pattern in React is to define a number of custom components that are intended to work in a nested fashion. So,
instead of just passing <code>props</code> to a factory, you might also want to pass other React elements. This is fully supported
in Fulcro, but can cause confusion when you first try to mix it with the data-driven aspect of the system.</p>
</div>
<div class="sect4">
<h5 id="_working_with_children"><a class="anchor" href="#_working_with_children"></a><a class="link" href="#_working_with_children">Working with Children</a></h5>
<div class="paragraph">
<p>Fulcro includes a few functions that are helpful when designing React components that are intended to be nested as direct
children within a single render:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>(prim/children this)</code>
</td>
<td class="hdlist2">
<p>Returns the React children of <code>this</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>(cutil/react-instance? Component instance)</code>
</td>
<td class="hdlist2">
<p>Returns true if the given element is an instance of the given component class. Otherwise <code>nil</code>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>(cutil/first-node</code> Component child-seq)
</td>
<td class="hdlist2">
<p>Returns the first of a sequence of elements that has the given component class.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So, say you wanted to create the following kind of rendering scheme:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Panel <span class="keyword">..</span><span class="keyword">.</span>)
(<span class="keyword">def</span> <span class="function">ui-panel</span> (prim/factory Panel))
(defsc PanelHeader <span class="keyword">..</span><span class="keyword">.</span>)
(<span class="keyword">def</span> <span class="function">ui-panel-header</span> (prim/factory PanelHeader))
(defsc PanelBody <span class="keyword">..</span><span class="keyword">.</span>)
(<span class="keyword">def</span> <span class="function">ui-panel-body</span> (prim/factory PanelBody))

(ui-panel {}
  (ui-panel-header {} <span class="string"><span class="delimiter">&quot;</span><span class="content">Some Heading Text</span><span class="delimiter">&quot;</span></span>)
  (ui-panel-body {}
     (dom/div <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Some sub-DOM</span><span class="delimiter">&quot;</span></span>)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DOM generation for <code>Panel</code> will need to find the header and body children:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Panel [this props]
  (<span class="keyword">let</span> [children (prim/children this)
        header (util/first-node PanelHeader children)
        body (util/first-node PanelBody children)]
    (<span class="keyword">when</span> header
      (dom/h4 <span class="predefined-constant">nil</span> header))
    (<span class="keyword">when</span> body
      (dom/div <span class="predefined-constant">nil</span> body))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basically, the child or children can simply be dropped into the place where they should be rendered.</p>
</div>
</div>
<div class="sect4">
<h5 id="_mixing_data_driven_children_with_ui_only_concerns"><a class="anchor" href="#_mixing_data_driven_children_with_ui_only_concerns"></a><a class="link" href="#_mixing_data_driven_children_with_ui_only_concerns">Mixing Data-Driven Children with UI-Only Concerns</a></h5>
<div class="paragraph">
<p>At first this seems a little mind-bending, because you are in fact nesting components in the UI, but
the query nesting need only mimic the <strong>stateful</strong> portion of the UI tree. This means there is ample opportunity
to use React children in a way that looks incorrect from what you&#8217;ve learned so far. On deeper inspection
it turns out it is alignment with the rules, but it takes a minute on first exposure.</p>
</div>
<div class="paragraph">
<p>Take the Bootstrap collapse component: It needs state of its own in order to know when it is collapsed,
and we&#8217;d like that to be part of the application database so that the support history viewer can show the
correct thing. However, the children of the collapse cannot be known in advance when writing the collapse
reusable library component.</p>
</div>
<div class="paragraph">
<p>The solution is simple once you see it: Query for the collapse component&#8217;s state and the child state in
the common parent component, then do the UI nesting in that component. Technically the component that is "laying out" the
UI (the ultimate parent) is in charge of both obtaining and rendering the data.  The fact that the UI child ends
up nested in a query sibling is perfectly fine.</p>
</div>
<div class="paragraph">
<p>The collapse component itself is only concerned with the fact that it is open/closed, and that it has children that
should be shown/hidden. The actual DOM elements of those children are immaterial, and can be assembled by the parent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc CollapseExample [this {<span class="symbol">:keys</span> [collapse-1 child]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p] {<span class="symbol">:collapse-1</span> (prim/get-initial-state b/Collapse {<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:start-open</span> <span class="predefined-constant">false</span>})})
   <span class="symbol">:query</span> [{<span class="symbol">:collapse-1</span> (prim/get-query b/Collapse)}
           {<span class="symbol">:child</span> (prim/get-query SomeChild)}]}
  (dom/div <span class="predefined-constant">nil</span>
    (b/button {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> [] (prim/transact! this `[(b/toggle-collapse {<span class="symbol">:id</span> <span class="integer">1</span>})]))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Toggle</span><span class="delimiter">&quot;</span></span>)
    (b/ui-collapse collapse-1
      (ui-child child))))</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_controlled_inputs"><a class="anchor" href="#_controlled_inputs"></a><a class="link" href="#_controlled_inputs">4.5. Controlled Inputs</a></h3>
<div class="paragraph">
<p>Form inputs in React can take two possible approaches: controlled and uncontrolled. The browser normally maintains
the value state of inputs for you as mutable data; however, this breaks our overall model of pure rendering! The
advantage is UI interaction speed: If your UI gets rather large, it is possible that UI updates on keystrokes in
form inputs may be too slow. This is the same sort of trade-off that we talked about when covering component
local state for rendering speed with more graphical components.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re using UI routers to split up your UI, then you&#8217;re also getting the speed benefits of not running anything
but the current active screen&#8217;s query. This should, in fact, be fast enough to do on every keystroke (in fact, you&#8217;ll
see warnings in your browser console if this gets slower than 60 FPS).</p>
</div>
<div class="paragraph">
<p>So, in general it is recommended that you use controlled inputs and retain the benefits of pure rendering: no embedded
state, your UI exactly represents your data representation, concrete devcards support for UI prototyping, and full
support viewer support.</p>
</div>
<div class="paragraph">
<p>Most inputs become controlled when you set their <code>:value</code> property. The table below lists the mechanism whereby
a form input is completely controlled by React:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Input type</th>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">input</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">:value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(not checkboxes or radio)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkbox</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">:checked</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">radio</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">:checked</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(only one in a group should be checked)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">textarea</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">:value</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">select</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">:value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instead of marking an option selected. Match <code>select</code>'s <code>:value</code> to the <code>:value</code> of a nested <code>option</code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
React will consider <code>nil</code> to mean you want an uncontrolled component. This can result in
a warning about converting uncontrolled to controlled components. In order to prevent this warning you should make
sure that <code>:checked</code> is always a boolean, and that other inputs have a valid <code>:value</code> (e.g. an empty string). The
<code>select</code> input can be given an "extra" option that stands for "not selected yet" so that you can start its value
at something valid.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="https://facebook.github.io/react/docs/forms.html">React Forms</a> for more details.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Fulcro 2.0 and lower had wrapped inputs to fix some IE bugs. You can disable the wrapping in 2.0 with
the JVM option <code>-DrawInputs</code>. Future versions will drop this legacy wrapping by default.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ReactLifecycle"><a class="anchor" href="#ReactLifecycle"></a><a class="link" href="#ReactLifecycle">4.6. React Lifecycle Examples</a></h3>
<div class="paragraph">
<p>There are some common use-cases that can only be solved by working directly with the React Lifecycle methods.</p>
</div>
<div class="paragraph">
<p>Some topics you should be familiar with in React to accomplish many of these things are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Component references: A mechanism that allows you access to the <strong>real</strong> DOM of the component once it&#8217;s on-screen.</p>
</li>
<li>
<p>Component-local state: A stateful mechanism where mutable data is stored on the component instance.</p>
</li>
<li>
<p>General DOM manipulation. The Google Closure library has your JQuery equivalents, should you need them.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_focusing_an_input"><a class="anchor" href="#_focusing_an_input"></a><a class="link" href="#_focusing_an_input">4.6.1. Focusing an input</a></h4>
<div class="paragraph">
<p>Focus is a stateful browser mechanism, and React cannot force the rendering of "focus". As such, when you need
to deal with UI focus it generally involves some interpretation, and possibly component local state. One way
of dealing with deciding when to focus is to look at a component&#8217;s prior vs. next properties. This can be
done in <code>componentDidUpdate</code>. For example, say you have an item that renders as a string, but when clicked
turns into an input field. You&#8217;d certainly want to focus that, and place the cursor at the end of the
existing data (or highlight it all).</p>
</div>
<div class="paragraph">
<p>If your component had a property called <code>editing?</code> that you made true to indicate it should render as an input
instead of just a value, then you could write your focus logic based on the transition of your component&#8217;s props
from <code>:editing?</code> false to <code>:editing?</code> true.</p>
</div>
<div class="example" id="focus-example"> </div>
<a class="source-toggle" href="javascript:void(0)" onClick="$('.focus-example').toggle()">Show/Hide Source</a>
<div class="listingblock focus-example source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.ui.focus-example</span>
  (<span class="symbol">:require</span> [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defsc]]
            [fulcro.client.dom <span class="symbol">:as</span> dom]
            [fulcro.client.mutations <span class="symbol">:as</span> m]))

(defsc ClickToEditField [this {<span class="symbol">:keys</span> [value editing?]}]
  {<span class="symbol">:initial-state</span>      {<span class="symbol">:value</span>    <span class="string"><span class="delimiter">&quot;</span><span class="content">ABC</span><span class="delimiter">&quot;</span></span>
                        <span class="symbol">:db/id</span>    <span class="integer">1</span>
                        <span class="symbol">:editing?</span> <span class="predefined-constant">false</span>}
   <span class="symbol">:query</span>              [<span class="symbol">:db/id</span> <span class="symbol">:value</span> <span class="symbol">:editing?</span>]
   <span class="symbol">:ident</span>              [<span class="symbol">:field/by-id</span> <span class="symbol">:db/id</span>]
   <span class="symbol">:componentDidUpdate</span> (<span class="keyword">fn</span> [prev-props _]
                         (<span class="keyword">when</span> (<span class="keyword">and</span> (<span class="keyword">not</span> (<span class="symbol">:editing?</span> prev-props)) (<span class="symbol">:editing?</span> (prim/props this)))
                           (<span class="keyword">let</span> [input-field        (dom/node this <span class="string"><span class="delimiter">&quot;</span><span class="content">edit_field</span><span class="delimiter">&quot;</span></span>)
                                 input-field-length (<span class="keyword">..</span> input-field -value -length)]
                             (<span class="keyword">.</span>focus input-field)
                             (<span class="keyword">.</span>setSelectionRange input-field input-field-length input-field-length))))}
  (dom/div <span class="predefined-constant">nil</span>
    <span class="comment">; trigger a focus based on a state change (componentDidUpdate)</span>
    (dom/a <span class="error">#</span>js {<span class="symbol">:onClick</span> #(m/toggle! this <span class="symbol">:editing?</span>)}
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Click to focus (if not already editing): </span><span class="delimiter">&quot;</span></span>)
    (dom/input <span class="error">#</span>js {<span class="symbol">:value</span>    value
                    <span class="symbol">:onChange</span> #(m/set-string! this <span class="symbol">:event</span> %)
                    <span class="symbol">:ref</span>      <span class="string"><span class="delimiter">&quot;</span><span class="content">edit_field</span><span class="delimiter">&quot;</span></span>})
    <span class="comment">; do an explicit focus</span>
    (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> (<span class="keyword">fn</span> []
                                (<span class="keyword">let</span> [input-field        (dom/node this <span class="string"><span class="delimiter">&quot;</span><span class="content">edit_field</span><span class="delimiter">&quot;</span></span>)
                                      input-field-length (<span class="keyword">..</span> input-field -value -length)]
                                  (<span class="keyword">.</span>focus input-field)
                                  (<span class="keyword">.</span>setSelectionRange input-field <span class="integer">0</span> input-field-length)))}
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Highlight All</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">def</span> <span class="function">ui-click-to-edit</span> (prim/factory ClickToEditField))

(defsc Root [this {<span class="symbol">:keys</span> [field] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:field</span> (prim/get-query ClickToEditField)}]
   <span class="symbol">:initial-state</span> {<span class="symbol">:field</span> {}}}
  (ui-click-to-edit field))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
React documentation encourages a more functional form of <code>ref</code> (you supply a function instead of a string).
This example could also cache that in component local state like this:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc ClickToEditField [this {<span class="symbol">:keys</span> [value editing?]}]
  <span class="keyword">..</span><span class="keyword">.</span>
     (dom/input <span class="error">#</span>js {<span class="symbol">:ref</span> (<span class="keyword">fn</span> [r] (prim/set-state! this {<span class="symbol">:input</span> r}))})
  <span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The wrapped inputs of Fulcro 2.0 and earlier do not work with the functional ref technique.
The <code>ref</code> with a function only works on form elements in Fulcro 2.0.0 and older if you supply the
JVM with <code>-DrawInputs</code>. This will become the default in later versions of Fulcro.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_taking_control_of_the_sub_dom_d3_etc"><a class="anchor" href="#_taking_control_of_the_sub_dom_d3_etc"></a><a class="link" href="#_taking_control_of_the_sub_dom_d3_etc">4.6.2. Taking control of the sub-DOM (D3, etc)</a></h4>
<div class="paragraph">
<p>Libraries like D3 are great for dynamic visualizations, but they need full control
of the portion of the DOM that they create and manipulate.</p>
</div>
<div class="paragraph">
<p>In general this means that your <code>render</code> method should be called once
(and only once) to install the base DOM onto which the other library
will control.</p>
</div>
<div class="paragraph">
<p>For example, let&#8217;s say we wanted to use D3 to render things. We&#8217;d first
write a function that would take the <strong>real</strong> DOM node and the incoming
props:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">db-render</span> [DOM-NODE props] <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function should do everything necessary to render the sub-dom (and
update it if the props change). Then we&#8217;d wrap that under a component that
doesn&#8217;t allow React to refresh that sub-tree via <code>shouldComponentUpdate</code>.</p>
</div>
<div class="paragraph">
<p>Below is a demo of this:</p>
</div>
<div class="example" id="ui-d3"> </div>
<a class="source-toggle" href="javascript:void(0)" onClick="$('.ui-d3').toggle()">Show/Hide Source</a>
<div class="listingblock ui-d3 source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.ui.d3-example</span>
  (<span class="symbol">:require</span> [fulcro.client.dom <span class="symbol">:as</span> dom]
            cljsjs.d3
            [fulcro.client.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
            [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defsc]]))

(<span class="keyword">defn</span> <span class="function">render-squares</span> [component props]
  (<span class="keyword">let</span> [svg       (<span class="keyword">-&gt;</span> js/d3 (<span class="keyword">.</span>select (dom/node component)))
        data      (clj-&gt;js (<span class="symbol">:squares</span> props))
        selection (<span class="keyword">-&gt;</span> svg
                    (<span class="keyword">.</span>selectAll <span class="string"><span class="delimiter">&quot;</span><span class="content">rect</span><span class="delimiter">&quot;</span></span>)
                    (<span class="keyword">.</span>data data (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>-id d))))]
    (<span class="keyword">-&gt;</span> selection
      <span class="keyword">.</span>enter
      (<span class="keyword">.</span>append <span class="string"><span class="delimiter">&quot;</span><span class="content">rect</span><span class="delimiter">&quot;</span></span>)
      (<span class="keyword">.</span>style <span class="string"><span class="delimiter">&quot;</span><span class="content">fill</span><span class="delimiter">&quot;</span></span> (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>-color d)))
      (<span class="keyword">.</span>attr <span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>)
      (<span class="keyword">.</span>attr <span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>)
      <span class="keyword">.</span>transition
      (<span class="keyword">.</span>attr <span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span> (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>-x d)))
      (<span class="keyword">.</span>attr <span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span> (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>-y d)))
      (<span class="keyword">.</span>attr <span class="string"><span class="delimiter">&quot;</span><span class="content">width</span><span class="delimiter">&quot;</span></span> (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>-size d)))
      (<span class="keyword">.</span>attr <span class="string"><span class="delimiter">&quot;</span><span class="content">height</span><span class="delimiter">&quot;</span></span> (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>-size d))))
    (<span class="keyword">-&gt;</span> selection
      <span class="keyword">.</span>exit
      <span class="keyword">.</span>transition
      (<span class="keyword">.</span>style <span class="string"><span class="delimiter">&quot;</span><span class="content">opacity</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>)
      <span class="keyword">.</span><span class="keyword">remove</span>)
    <span class="predefined-constant">false</span>))

(defsc D3Thing [this props]
  {<span class="symbol">:componentDidMount</span>         (<span class="keyword">fn</span> [] (render-squares this (prim/props this)))
   <span class="symbol">:shouldComponentUpdate</span>     (<span class="keyword">fn</span> [next-props next-state] <span class="predefined-constant">false</span>)
   <span class="symbol">:componentWillReceiveProps</span> (<span class="keyword">fn</span> [props] (render-squares this props))}
  (dom/svg <span class="error">#</span>js {<span class="symbol">:style</span>   <span class="error">#</span>js {<span class="symbol">:backgroundColor</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">rgb(240,240,240)</span><span class="delimiter">&quot;</span></span>}
                <span class="symbol">:width</span>   <span class="integer">200</span> <span class="symbol">:height</span> <span class="integer">200</span>
                <span class="symbol">:viewBox</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">0 0 1000 1000</span><span class="delimiter">&quot;</span></span>}))

(<span class="keyword">def</span> <span class="function">d3-thing</span> (prim/factory D3Thing))

(<span class="keyword">defn</span> <span class="function">random-square</span> []
  {
   <span class="symbol">:id</span>    (<span class="keyword">rand-int</span> <span class="integer">10000000</span>)
   <span class="symbol">:x</span>     (<span class="keyword">rand-int</span> <span class="integer">900</span>)
   <span class="symbol">:y</span>     (<span class="keyword">rand-int</span> <span class="integer">900</span>)
   <span class="symbol">:size</span>  (<span class="keyword">+</span> <span class="integer">50</span> (<span class="keyword">rand-int</span> <span class="integer">300</span>))
   <span class="symbol">:color</span> (<span class="keyword">case</span> (<span class="keyword">rand-int</span> <span class="integer">5</span>)
            <span class="integer">0</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">yellow</span><span class="delimiter">&quot;</span></span>
            <span class="integer">1</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">green</span><span class="delimiter">&quot;</span></span>
            <span class="integer">2</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">orange</span><span class="delimiter">&quot;</span></span>
            <span class="integer">3</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">blue</span><span class="delimiter">&quot;</span></span>
            <span class="integer">4</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">black</span><span class="delimiter">&quot;</span></span>)})

(defmutation add-square [params]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state update <span class="symbol">:squares</span> <span class="keyword">conj</span> (random-square))))

(defmutation clear-squares [params]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state <span class="keyword">assoc</span> <span class="symbol">:squares</span> [])))

(defsc Root [this props]
  {<span class="symbol">:query</span>         [<span class="symbol">:squares</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:squares</span> []}}
  (dom/div <span class="predefined-constant">nil</span>
    (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(prim/transact! this
                                 `[(add-square {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Add Random Square</span><span class="delimiter">&quot;</span></span>)
    (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(prim/transact! this
                                 `[(clear-squares {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Clear</span><span class="delimiter">&quot;</span></span>)
    (dom/br <span class="predefined-constant">nil</span>)
    (dom/br <span class="predefined-constant">nil</span>)
    (d3-thing props)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The things to note for this example are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We override the React lifecycle method <code>shouldComponentUpdate</code> to return false. This tells React to never ever call
render once the component is mounted. D3 is in control of the underlying stuff.</p>
</li>
<li>
<p>We override <code>componentWillReceiveProps</code> and <code>componentDidMount</code> to do the actual D3 render/update. The former will
get incoming data changes, and the latter is called on initial mount. Our render method
delegates all of the hard work to D3.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_dynamically_rendering_into_a_canvas"><a class="anchor" href="#_dynamically_rendering_into_a_canvas"></a><a class="link" href="#_dynamically_rendering_into_a_canvas">4.6.3. Dynamically rendering into a canvas</a></h4>
<div class="paragraph">
<p>Sometimes you need to use component-local state to avoid the overhead in running a query to feed props. An example
of this is when handing mouse interactions like drag. You&#8217;ll typically use React refs to grab the actual low-level canvas.</p>
</div>
<div class="paragraph">
<p>There are actually two ways to change component-local state. One of them defers rendering to the next animation frame,
but it <strong>also</strong> reconciles the database with the stateful components. This one will not give you as much of a speed boost
(though it may be enough, since you&#8217;re not changing the database or recording more UI history).</p>
</div>
<div class="paragraph">
<p>The other mechanism completely avoids this, and just asks React for an immediate forced update.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>(set-state! this data)</code> and <code>(update-state! this data)</code> - trigger a reconcile against the database at the next animation frame. Limits frame rate to 60 fps.</p>
</li>
<li>
<p><code>(react-set-state! this data)</code> - trigger a React forceUpdate immediately</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this example we&#8217;re using <code>set-state!</code>, and you can see it is still plenty fast!</p>
</div>
<div class="example" id="hover-example"> </div>
<a class="source-toggle" href="javascript:void(0)" onClick="$('.hover-example').toggle()">Show/Hide Source</a>
<div class="listingblock hover-example source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.ui.hover-example</span>
  (<span class="symbol">:require</span>
    [fulcro.client.cards <span class="symbol">:refer</span> [defcard-fulcro]]
    [fulcro.i18n <span class="symbol">:refer</span> [tr trf]]
    [fulcro.client.mutations <span class="symbol">:refer</span> [defmutation]]
    [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defsc InitialAppState initial-state]]
    [fulcro.client.dom <span class="symbol">:as</span> dom]
    yahoo.intl-messageformat-with-locales))

(<span class="keyword">defn</span> <span class="function">change-size*</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Change the size of the canvas by some (pos or neg) amount..</span><span class="delimiter">&quot;</span></span>
  [state-map amount]
  (<span class="keyword">let</span> [current-size (<span class="keyword">get-in</span> state-map [<span class="symbol">:child/by-id</span> <span class="integer">0</span> <span class="symbol">:size</span>])
        new-size     (<span class="keyword">+</span> amount current-size)]
    (<span class="keyword">assoc-in</span> state-map [<span class="symbol">:child/by-id</span> <span class="integer">0</span> <span class="symbol">:size</span>] new-size)))

<span class="comment">; Make the canvas smaller. This will cause</span>
(defmutation ^<span class="symbol">:intern</span> make-smaller [p]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state change-size* <span class="integer">-20</span>)))

(defmutation ^<span class="symbol">:intern</span> make-bigger [p]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state change-size* <span class="integer">20</span>)))

(defmutation ^<span class="symbol">:intern</span> update-marker [{<span class="symbol">:keys</span> [coords]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state <span class="keyword">assoc-in</span> [<span class="symbol">:child/by-id</span> <span class="integer">0</span> <span class="symbol">:marker</span>] coords)))


(<span class="keyword">defn</span> <span class="function">event-&gt;dom-coords</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Translate a javascript evt to a clj [x y] within the given dom element.</span><span class="delimiter">&quot;</span></span>
  [evt dom-ele]
  (<span class="keyword">let</span> [cx (<span class="keyword">.</span>-clientX evt)
        cy (<span class="keyword">.</span>-clientY evt)
        BB (<span class="keyword">.</span>getBoundingClientRect dom-ele)
        x  (<span class="keyword">-</span> cx (<span class="keyword">.</span>-left BB))
        y  (<span class="keyword">-</span> cy (<span class="keyword">.</span>-top BB))]
    [x y]))

(<span class="keyword">defn</span> <span class="function">event-&gt;normalized-coords</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Translate a javascript evt to a clj [x y] within the given dom element as normalized (0 to 1) coordinates.</span><span class="delimiter">&quot;</span></span>
  [evt dom-ele]
  (<span class="keyword">let</span> [cx (<span class="keyword">.</span>-clientX evt)
        cy (<span class="keyword">.</span>-clientY evt)
        BB (<span class="keyword">.</span>getBoundingClientRect dom-ele)
        w  (<span class="keyword">-</span> (<span class="keyword">.</span>-right BB) (<span class="keyword">.</span>-left BB))
        h  (<span class="keyword">-</span> (<span class="keyword">.</span>-bottom BB) (<span class="keyword">.</span>-top BB))
        x  (<span class="keyword">/</span> (<span class="keyword">-</span> cx (<span class="keyword">.</span>-left BB))
             w)
        y  (<span class="keyword">/</span> (<span class="keyword">-</span> cy (<span class="keyword">.</span>-top BB))
             h)]
    [x y]))

(<span class="keyword">defn</span> <span class="function">render-hover-and-marker</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Render the graphics in the canvas. Pass the component props and state. </span><span class="delimiter">&quot;</span></span>
  [props state]
  (<span class="keyword">let</span> [canvas             (<span class="symbol">:canvas</span> state)
        hover              (<span class="symbol">:coords</span> state)
        marker             (<span class="symbol">:marker</span> props)
        size               (<span class="symbol">:size</span> props)
        real-marker-coords (mapv (<span class="keyword">partial</span> <span class="keyword">*</span> size) marker)
        <span class="comment">; See HTML5 canvas docs</span>
        ctx                (<span class="keyword">.</span>getContext canvas <span class="string"><span class="delimiter">&quot;</span><span class="content">2d</span><span class="delimiter">&quot;</span></span>)
        clear              (<span class="keyword">fn</span> []
                             (set! (<span class="keyword">.</span>-fillStyle ctx) <span class="string"><span class="delimiter">&quot;</span><span class="content">white</span><span class="delimiter">&quot;</span></span>)
                             (<span class="keyword">.</span>fillRect ctx <span class="integer">0</span> <span class="integer">0</span> size size))
        drawHover          (<span class="keyword">fn</span> []
                             (set! (<span class="keyword">.</span>-strokeStyle ctx) <span class="string"><span class="delimiter">&quot;</span><span class="content">gray</span><span class="delimiter">&quot;</span></span>)
                             (<span class="keyword">.</span>strokeRect ctx (<span class="keyword">-</span> (<span class="keyword">first</span> hover) <span class="integer">5</span>) (<span class="keyword">-</span> (<span class="keyword">second</span> hover) <span class="integer">5</span>) <span class="integer">10</span> <span class="integer">10</span>))
        drawMarker         (<span class="keyword">fn</span> []
                             (set! (<span class="keyword">.</span>-strokeStyle ctx) <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
                             (<span class="keyword">.</span>strokeRect ctx (<span class="keyword">-</span> (<span class="keyword">first</span> real-marker-coords) <span class="integer">5</span>) (<span class="keyword">-</span> (<span class="keyword">second</span> real-marker-coords) <span class="integer">5</span>) <span class="integer">10</span> <span class="integer">10</span>))]
    (<span class="keyword">.</span>save ctx)
    (clear)
    (drawHover)
    (drawMarker)
    (<span class="keyword">.</span>restore ctx)))

(<span class="keyword">defn</span> <span class="function">place-marker</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Update the marker in app state. Derives normalized coordinates, and updates the marker in application state.</span><span class="delimiter">&quot;</span></span>
  [child evt]
  (prim/transact! child `[(update-marker
                            {<span class="symbol">:coords</span> ~(event-&gt;normalized-coords evt (prim/get-state child <span class="symbol">:canvas</span>))})]))

(<span class="keyword">defn</span> <span class="function">hover-marker</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Updates the hover location of a proposed marker using canvas coordinates. Hover location
   is stored in component local state (meaning that a low-level app database query will not
   run to do the render that responds to this change)</span><span class="delimiter">&quot;</span></span>
  [child evt]
  (<span class="keyword">let</span> [current-state  (prim/get-state child)
        updated-coords (event-&gt;dom-coords evt (<span class="symbol">:canvas</span> current-state))
        new-state      (<span class="keyword">assoc</span> current-state <span class="symbol">:coords</span> updated-coords)]
    (prim/set-state! child new-state)
    (render-hover-and-marker (prim/props child) new-state)))

(defsc Child [this {<span class="symbol">:keys</span> [id size]}]
  {<span class="symbol">:query</span>          [<span class="symbol">:id</span> <span class="symbol">:size</span> <span class="symbol">:marker</span>]
   <span class="symbol">:initial-state</span>  (<span class="keyword">fn</span> [_] {<span class="symbol">:id</span> <span class="integer">0</span> <span class="symbol">:size</span> <span class="integer">50</span> <span class="symbol">:marker</span> [<span class="float">0.5</span> <span class="float">0.5</span>]})
   <span class="symbol">:ident</span>          (<span class="keyword">fn</span> [] [<span class="symbol">:child/by-id</span> id])
   <span class="symbol">:initLocalState</span> (<span class="keyword">fn</span> [] {<span class="symbol">:coords</span> [<span class="integer">-50</span> <span class="integer">-50</span>]})}
  <span class="comment">; Remember that this &quot;render&quot; just renders the DOM (e.g. the canvas DOM element). The graphical</span>
  <span class="comment">; rendering within the canvas is done during event handling.</span>
  <span class="comment">; size comes from props. Transactions on size will cause the canvas to resize in the DOM</span>
  (dom/canvas <span class="error">#</span>js {<span class="symbol">:width</span>       (<span class="keyword">str</span> size <span class="string"><span class="delimiter">&quot;</span><span class="content">px</span><span class="delimiter">&quot;</span></span>)
                   <span class="symbol">:height</span>      (<span class="keyword">str</span> size <span class="string"><span class="delimiter">&quot;</span><span class="content">px</span><span class="delimiter">&quot;</span></span>)
                   <span class="symbol">:onMouseDown</span> (<span class="keyword">fn</span> [evt] (place-marker this evt))
                   <span class="symbol">:onMouseMove</span> (<span class="keyword">fn</span> [evt] (hover-marker this evt))
                   <span class="comment">; This is a pure React mechanism for getting the underlying DOM element.</span>
                   <span class="comment">; Note: when the DOM element changes this fn gets called with nil</span>
                   <span class="comment">; (to help you manage memory leaks), then the new element</span>
                   <span class="symbol">:ref</span>         (<span class="keyword">fn</span> [r]
                                  (<span class="keyword">when</span> r
                                    (prim/update-state! this <span class="keyword">assoc</span> <span class="symbol">:canvas</span> r)
                                    (render-hover-and-marker (prim/props this) (prim/get-state this))))
                   <span class="symbol">:style</span>       <span class="error">#</span>js {<span class="symbol">:border</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">1px solid black</span><span class="delimiter">&quot;</span></span>}}))

(<span class="keyword">def</span> <span class="function">ui-child</span> (prim/factory Child))

(defsc Root [this {<span class="symbol">:keys</span> [ui/react-key child]}]
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/react-key</span> {<span class="symbol">:child</span> (prim/get-query Child)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:ui/react-key</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">K</span><span class="delimiter">&quot;</span></span> <span class="symbol">:child</span> (initial-state Child <span class="predefined-constant">nil</span>)})}
  (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> react-key}
    (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(prim/transact! this `[(make-bigger {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Bigger!</span><span class="delimiter">&quot;</span></span>)
    (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(prim/transact! this `[(make-smaller {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Smaller!</span><span class="delimiter">&quot;</span></span>)
    (dom/br <span class="predefined-constant">nil</span>)
    (dom/br <span class="predefined-constant">nil</span>)
    (ui-child child)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The component receives mouse move events to show a hover box. To make this move in real-time we use component
local state. Clicking to set the box, or resize the container are real transactions, and will actually cause
a refresh from application state to update the rendering.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_javascript_react_components"><a class="anchor" href="#_using_javascript_react_components"></a><a class="link" href="#_using_javascript_react_components">4.7. Using Javascript React Components</a></h3>
<div class="paragraph">
<p>One of the great parts about React is the ecosystem. There are some great libraries out there.
However, the interop story isn&#8217;t always straight forward. The goal of this section is to make that story a little clearer.</p>
</div>
<div class="sect3">
<h4 id="_factory_functions_for_js_react_components"><a class="anchor" href="#_factory_functions_for_js_react_components"></a><a class="link" href="#_factory_functions_for_js_react_components">4.7.1. Factory Functions for JS React Components</a></h4>
<div class="paragraph">
<p>Integrating React components is fairly straightforward if you have used React from JS before. The curve comes having
spent time with libraries or abstractions like Om and friends. JSX will also abstract some of this away, so it&#8217;s not
just the cljs wrappers. For a good article explaining some of the concepts read, React Elements The take-aways here are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you are importing third party components, you should be importing the class, not a factory.</p>
</li>
<li>
<p>You need to explicitly create the react elements with factories. The relevent js functions are React.createElement, and React.createFactory.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It is very important to consider when using any of these functions - the children. JS does not have a built in notion
of lazy sequences. Clojurescript does. This can create suttle bugs when evaluating the children of a component.</p>
</div>
<div class="paragraph">
<p><code>fulcro.util/force-children</code> helps us in this regard by taking a seq and returning a vector. We can use this to
create our own factory function, much like React.createFactory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">factory-force-children</span>
  [<span class="keyword">class</span>]
  (<span class="keyword">fn</span> [props &amp; children]
    (js/React.createElement <span class="keyword">class</span>
      props
      (util/force-children children))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is fine, but you will notice that children in our factory may be missing keys. Because we passed a vector in,
React won&#8217;t attach the key attribute. We can solve this problem by using the apply function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">factory-apply</span>
  [<span class="keyword">class</span>]
  (<span class="keyword">fn</span> [props &amp; children]
    (<span class="keyword">apply</span> js/React.createElement
      <span class="keyword">class</span>
      props
      children)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the apply function will pass the children in as args to <code>React.createElement</code>, thus avoiding the key problem
as well as the issue with lazy sequences.</p>
</div>
<div class="paragraph">
<p>Now that we have some background on creating React Elements it&#8217;s pretty simple to implement something.
Let' look at making a chart using Victory. We are going to make a simple line chart, with an X axis that contains
years, and a Y axis that contains dollar amounts. Really the data is irrelavent, it&#8217;s the implementation we care about.</p>
</div>
<div class="paragraph">
<p>The running code and source are below:</p>
</div>
<div class="example" id="victory-example"> </div>
<a class="source-toggle" href="javascript:void(0)" onClick="$('.victory-example').toggle()">Show/Hide Source</a>
<div class="listingblock victory-example source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.ui.victory-example</span>
  (<span class="symbol">:require-macros</span> [cljs.test <span class="symbol">:refer</span> [is]])
  (<span class="symbol">:require</span> [cljs.pprint <span class="symbol">:refer</span> [cl-format]]
            cljsjs.victory
            [devcards.core <span class="symbol">:as</span> dc <span class="symbol">:refer-macros</span> [defcard defcard-doc]]
            [fulcro.ui.elements <span class="symbol">:as</span> ele]
            [fulcro.client.cards <span class="symbol">:refer</span> [defcard-fulcro]]
            [fulcro.client.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
            [fulcro.client.dom <span class="symbol">:as</span> dom]
            [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defsc]]
            [fulcro.util <span class="symbol">:as</span> util]
            [fulcro.client <span class="symbol">:as</span> fc]))

(<span class="keyword">defn</span> <span class="function">us-dollars</span> [n]
  (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">$</span><span class="delimiter">&quot;</span></span> (cl-format <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">~:d</span><span class="delimiter">&quot;</span></span> n)))

(<span class="keyword">defn</span> <span class="function">factory-force-children</span>
  [<span class="keyword">class</span>]
  (<span class="keyword">fn</span> [props &amp; children]
    (js/React.createElement <span class="keyword">class</span>
      props
      (util/force-children children))))

(<span class="keyword">defn</span> <span class="function">factory-apply</span>
  [<span class="keyword">class</span>]
  (<span class="keyword">fn</span> [props &amp; children]
    (<span class="keyword">apply</span> js/React.createElement
      <span class="keyword">class</span>
      props
      children)))

(<span class="keyword">def</span> <span class="function">vchart</span> (factory-apply js/Victory.VictoryChart))
(<span class="keyword">def</span> <span class="function">vaxis</span> (factory-apply js/Victory.VictoryAxis))
(<span class="keyword">def</span> <span class="function">vline</span> (factory-apply js/Victory.VictoryLine))

<span class="comment">;; &quot; [ {:year 1991 :value 2345 } ...] &quot;</span>
(defsc YearlyValueChart [this {<span class="symbol">:keys</span> [label plot-data x-step]}]
  (<span class="keyword">let</span> [start-year (<span class="keyword">apply</span> <span class="keyword">min</span> (<span class="keyword">map</span> <span class="symbol">:year</span> plot-data))
        end-year   (<span class="keyword">apply</span> <span class="keyword">max</span> (<span class="keyword">map</span> <span class="symbol">:year</span> plot-data))
        years      (<span class="keyword">range</span> start-year (<span class="keyword">inc</span> end-year) x-step)
        dates      (clj-&gt;js (mapv #(<span class="keyword">new</span> js/Date % <span class="integer">1</span> <span class="integer">2</span>) years))
        {<span class="symbol">:keys</span> [min-value
                max-value]} (<span class="keyword">reduce</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [min-value max-value] <span class="symbol">:as</span> acc}
                                         {<span class="symbol">:keys</span> [value] <span class="symbol">:as</span> n}]
                                      (<span class="keyword">assoc</span> acc
                                        <span class="symbol">:min-value</span> (<span class="keyword">min</span> min-value value)
                                        <span class="symbol">:max-value</span> (<span class="keyword">max</span> max-value value)))
                              {}
                              plot-data)
        min-value  (<span class="keyword">int</span> (<span class="keyword">*</span> <span class="float">0.8</span> min-value))
        max-value  (<span class="keyword">int</span> (<span class="keyword">*</span> <span class="float">1.2</span> max-value))
        points     (clj-&gt;js (mapv (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [year value]}]
                                    {<span class="symbol">:x</span> (<span class="keyword">new</span> js/Date year <span class="integer">1</span> <span class="integer">2</span>)
                                     <span class="symbol">:y</span> value})
                              plot-data))]
    (vchart <span class="predefined-constant">nil</span>
      (vaxis <span class="error">#</span>js {<span class="symbol">:label</span>      label
                  <span class="symbol">:standalone</span> <span class="predefined-constant">false</span>
                  <span class="symbol">:scale</span>      <span class="string"><span class="delimiter">&quot;</span><span class="content">time</span><span class="delimiter">&quot;</span></span>
                  <span class="symbol">:tickFormat</span> (<span class="keyword">fn</span> [d] (<span class="keyword">.</span>getFullYear d))
                  <span class="symbol">:tickValues</span> dates})
      (vaxis <span class="error">#</span>js {<span class="symbol">:dependentAxis</span> <span class="predefined-constant">true</span>
                  <span class="symbol">:standalone</span>    <span class="predefined-constant">false</span>
                  <span class="symbol">:tickFormat</span>    (<span class="keyword">fn</span> [y] (us-dollars y))
                  <span class="symbol">:domain</span>        <span class="error">#</span>js [min-value max-value]})
      (vline <span class="error">#</span>js {<span class="symbol">:data</span> points}))))

(<span class="keyword">def</span> <span class="function">yearly-value-chart</span> (prim/factory YearlyValueChart))

(defsc Root [this props]
  {<span class="symbol">:initial-state</span> {<span class="symbol">:label</span>     <span class="string"><span class="delimiter">&quot;</span><span class="content">Yearly Value</span><span class="delimiter">&quot;</span></span>
                   <span class="symbol">:x-step</span>    <span class="integer">2</span>
                   <span class="symbol">:plot-data</span> [{<span class="symbol">:year</span> <span class="integer">1983</span> <span class="symbol">:value</span> <span class="integer">100</span>}
                               {<span class="symbol">:year</span> <span class="integer">1984</span> <span class="symbol">:value</span> <span class="integer">100</span>}
                               {<span class="symbol">:year</span> <span class="integer">1985</span> <span class="symbol">:value</span> <span class="integer">90</span>}
                               {<span class="symbol">:year</span> <span class="integer">1986</span> <span class="symbol">:value</span> <span class="integer">89</span>}
                               {<span class="symbol">:year</span> <span class="integer">1987</span> <span class="symbol">:value</span> <span class="integer">88</span>}
                               {<span class="symbol">:year</span> <span class="integer">1988</span> <span class="symbol">:value</span> <span class="integer">85</span>}
                               {<span class="symbol">:year</span> <span class="integer">1989</span> <span class="symbol">:value</span> <span class="integer">83</span>}
                               {<span class="symbol">:year</span> <span class="integer">1990</span> <span class="symbol">:value</span> <span class="integer">80</span>}
                               {<span class="symbol">:year</span> <span class="integer">1991</span> <span class="symbol">:value</span> <span class="integer">70</span>}
                               {<span class="symbol">:year</span> <span class="integer">1992</span> <span class="symbol">:value</span> <span class="integer">80</span>}
                               {<span class="symbol">:year</span> <span class="integer">1993</span> <span class="symbol">:value</span> <span class="integer">90</span>}
                               {<span class="symbol">:year</span> <span class="integer">1994</span> <span class="symbol">:value</span> <span class="integer">95</span>}
                               {<span class="symbol">:year</span> <span class="integer">1995</span> <span class="symbol">:value</span> <span class="integer">110</span>}
                               {<span class="symbol">:year</span> <span class="integer">1996</span> <span class="symbol">:value</span> <span class="integer">120</span>}
                               {<span class="symbol">:year</span> <span class="integer">1997</span> <span class="symbol">:value</span> <span class="integer">160</span>}
                               {<span class="symbol">:year</span> <span class="integer">1998</span> <span class="symbol">:value</span> <span class="integer">170</span>}
                               {<span class="symbol">:year</span> <span class="integer">1999</span> <span class="symbol">:value</span> <span class="integer">180</span>}
                               {<span class="symbol">:year</span> <span class="integer">2000</span> <span class="symbol">:value</span> <span class="integer">180</span>}
                               {<span class="symbol">:year</span> <span class="integer">2001</span> <span class="symbol">:value</span> <span class="integer">200</span>}
                               ]}}
  (dom/div <span class="predefined-constant">nil</span>
    (yearly-value-chart props)))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_demo_an_image_clip_tool"><a class="anchor" href="#_demo_an_image_clip_tool"></a><a class="link" href="#_demo_an_image_clip_tool">4.8. Demo: An Image Clip Tool</a></h3>
<div class="paragraph">
<p>Fulcro has the start of an image clip tool. Right now it is mainly for demonstration purposes, but it is in the main
library and is a good example of a complex UI component where two components have to talk to each other and share
image data.</p>
</div>
<div class="paragraph">
<p>You should study the source code (<code>src/main/fulcro/ui/clip_tool.cljs</code>) to get the full details,
but here is an overview of the critical facets:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ClipTool creates a canvas on which to draw</p>
<div class="ulist">
<ul>
<li>
<p>It uses initial state and a query to track the setup (e.g. size, aspect ratio, image to clip)</p>
</li>
<li>
<p>For speed (and because some data is not serializable), it uses component-local state to track current clip region,
a javascript Image object and the DOM canvas (via React ref) for rendering, and the current active operation (e.g. dragging a handle).</p>
</li>
<li>
<p>The mouse events are essentially handled as updates to the component local state, which causes a local component
render update.</p>
</li>
</ul>
</div>
</li>
<li>
<p>PreviewClip is a React component, but not data-driven (no query). Everything is just passed through props.</p>
<div class="ulist">
<ul>
<li>
<p>It technically knows nothing of the clip tool.</p>
</li>
<li>
<p>It expects an :image-object and clip data to be passed in&#8230;&#8203;it just renders it on a canvas.</p>
</li>
<li>
<p>It uses React refs to get the reference to the real DOM canvas for rendering</p>
</li>
<li>
<p>It renders whenever props change</p>
</li>
</ul>
</div>
</li>
<li>
<p>A callback on the ClipTool communicates <strong>through</strong> the common parent&#8217;s component local state. The parent
will re-render when its state changes, which will in turn force a new set of props to be passed to the preview).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As you can see, the interaction performance is quite good.</p>
</div>
<div class="example" id="clip-tool-example"> </div>
<a class="source-toggle" href="javascript:void(0)" onClick="$('.clip-tool-example').toggle()">Show/Hide Source</a>
<div class="listingblock clip-tool-example source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.ui.clip-tool-example</span>
  (<span class="symbol">:require</span> [cljs.pprint <span class="symbol">:refer</span> [cl-format]]
            cljsjs.victory
            [fulcro.ui.clip-tool <span class="symbol">:as</span> ct]
            [fulcro.ui.elements <span class="symbol">:as</span> ele]
            [fulcro.client.cards <span class="symbol">:refer</span> [defcard-fulcro]]
            [fulcro.client.mutations <span class="symbol">:as</span> m <span class="symbol">:refer</span> [defmutation]]
            [fulcro.client.dom <span class="symbol">:as</span> dom]
            [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defsc]]
            [fulcro.util <span class="symbol">:as</span> util]
            [fulcro.client <span class="symbol">:as</span> fc]))

(<span class="keyword">def</span> <span class="function">minion-image</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://s-media-cache-ak0.pinimg.com/736x/34/c2/f5/34c2f59284fcdff709217e14df2250a0--film-minions-minions-images.jpg</span><span class="delimiter">&quot;</span></span>)

(defsc Root [this {<span class="symbol">:keys</span> [ui/react-key ctool]}]
  {<span class="symbol">:initial-state</span>
          (<span class="keyword">fn</span> [p] {<span class="symbol">:ctool</span> (prim/get-initial-state ct/ClipTool {<span class="symbol">:id</span>        <span class="symbol">:clipper</span> <span class="symbol">:aspect-ratio</span> <span class="float">0.5</span>
                                                               <span class="symbol">:image-url</span> minion-image})})
   <span class="symbol">:query</span> [<span class="symbol">:ui/react-key</span> <span class="symbol">:ctool</span>]}
  (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> react-key}
    (ct/ui-clip-tool (prim/computed ctool {<span class="symbol">:onChange</span> (<span class="keyword">fn</span> [props] (prim/set-state! this props))}))
    (ct/ui-preview-clip (<span class="keyword">merge</span> (prim/get-state this) {<span class="symbol">:filename</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">minions.jpg</span><span class="delimiter">&quot;</span></span>
                                                      <span class="symbol">:width</span>    <span class="integer">100</span> <span class="symbol">:height</span> <span class="integer">200</span>}))))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_code_defui_code_macro_fulcro_1_x_legacy_support_in_2_x"><a class="anchor" href="#_the_code_defui_code_macro_fulcro_1_x_legacy_support_in_2_x"></a><a class="link" href="#_the_code_defui_code_macro_fulcro_1_x_legacy_support_in_2_x">4.9. The <code>defui</code> Macro (Fulcro 1.x. Legacy support in 2.x)</a></h3>
<div class="paragraph">
<p>The <code>defui</code> macro generates a React component. It does the same thing as the
<code>defsc</code> macro, but looks more like a <code>defrecord</code> and is a bit more OO in style. It
does not error-check your work, nor does it allow you to destructure incoming data
over the body or options; however, it is syntax-comptible with Om Next, so it you&#8217;re
porting from that library, it can be useful to have access to it.</p>
</div>
<div class="paragraph">
<p>It is 100% compatible with the React ecosystem. The macro is intended
to look a bit like a class declaration, and borrows generation notation style from <code>defrecord</code>. There is no
minimum required list of methods (e.g. you don&#8217;t even have to define <code>render</code>). This latter fact is useful
for cases where you want a component for server queries and database normalization, but not for rendering.</p>
</div>
<div class="sect3">
<h4 id="_react_object_methods"><a class="anchor" href="#_react_object_methods"></a><a class="link" href="#_react_object_methods">4.9.1. React (Object) methods</a></h4>
<div class="paragraph">
<p><code>defui</code> is aware of the following React-centric methods, which you can override:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defui MyComponent
  Object
  (initLocalState [this] <span class="keyword">..</span><span class="keyword">.</span>)
  (shouldComponentUpdate [this next-props next-state] <span class="keyword">..</span><span class="keyword">.</span>)
  (componentWillReceiveProps [this next-props] <span class="keyword">..</span><span class="keyword">.</span>)
  (componentWillUpdate [this next-props next-state] <span class="keyword">..</span><span class="keyword">.</span>)
  (componentDidUpdate [this prev-props prev-state] <span class="keyword">..</span><span class="keyword">.</span>)
  (componentWillMount [this] <span class="keyword">..</span><span class="keyword">.</span>)
  (componentDidMount [this] <span class="keyword">..</span><span class="keyword">.</span>)
  (componentWillUnmount [this] <span class="keyword">..</span><span class="keyword">.</span>)
  (render [this] <span class="keyword">..</span><span class="keyword">.</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#ReactLifecycle">React Lifecycle Examples</a> for some specific examples, and the React documentation for a complete description of each of these.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Fulcro does override <code>shouldComponentUpdate</code> to short-circuit renders of a component whose props have not changed. You
generally do <strong>not</strong> want to change this to make it render more frequently; however, when using Fulcro with
libraries like D3 that want to "own" the portion of the DOM they render you may need to make it so that
React never updates the component once mounted (by returning <code>false</code> always). The Developer&#8217;s Guide shows an example
of this in the UI section.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_code_static_code_protocol_qualifier"><a class="anchor" href="#_the_code_static_code_protocol_qualifier"></a><a class="link" href="#_the_code_static_code_protocol_qualifier">4.9.2. The <code>static</code> Protocol Qualifier</a></h4>
<div class="paragraph">
<p><code>defui</code> supports implementations of protocols in a <code>static</code> context. It basically
means that you&#8217;d like the methods you&#8217;re defining to go on the class (instead of instance), but conform to the
given protocol. There is no Java analogue for this, but in Javascript the classes themselves are open.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Since there is no JVM equivalent of implementing <code>static</code> methods, a hack is used internally where the
protocol methods are placed in metadata on the resulting symbol. This is the reason functions like
<code>get-initial-state</code> exist. Calling the protocol (e.g. <code>initial-state</code>) in Javascript will work, but if you
try that when doing server-side rendering on the JVM, it will blow up.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_iquery_and_ident"><a class="anchor" href="#_iquery_and_ident"></a><a class="link" href="#_iquery_and_ident">4.9.3. IQuery and Ident</a></h4>
<div class="paragraph">
<p>There are two core protocols for supporting a component&#8217;s data in the graph database. They work in tandem to
find data in the database for the component, and also to take data (e.g. from a server response or initial state) and
normalize it into the database.</p>
</div>
<div class="paragraph">
<p>Both of these protocols <strong>must</strong> be declared <strong>static</strong>. The reason for this is initial normalization and query: The
system has to be able to ask components about their ident and query generation in order to turn a tree of data
into a normalized database.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/queryidentoperation.png" alt="queryidentoperation" width="680" height="126">
</div>
</div>
<div class="paragraph">
<p>Queries <strong>must</strong> be composed towards the root component (so you end up with a UI query that can pull the entire
tree of data for the UI).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defui ListItem
  static prim/IQuery
  (query [this] [<span class="symbol">:db/id</span> <span class="symbol">:item/label</span>])
  static prim/Ident
  (ident [this props] [<span class="symbol">:list-item/by-id</span> (<span class="symbol">:db/id</span> props)])
  <span class="keyword">..</span><span class="keyword">.</span>)

(defui List
  static prim/IQuery
  (query [this] [<span class="symbol">:db/id</span> {<span class="symbol">:list/items</span> (prim/get-query ListItem)}])
  static prim/Ident
  (ident [this props] [<span class="symbol">:list/by-id</span> (<span class="symbol">:db/id</span> props)])
  <span class="keyword">..</span><span class="keyword">.</span>)

<span class="comment">;; queries compose up to root</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_notes_on_the_iquery_protocol"><a class="anchor" href="#_notes_on_the_iquery_protocol"></a><a class="link" href="#_notes_on_the_iquery_protocol">Notes on the IQuery Protocol</a></h5>
<div class="paragraph">
<p>Even though the method itself is declared statically, there are some interesting things about the <code>query</code> method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Once mounted, a component can have a dynamic query. This means calling <code>(prim/get-query this)</code> will return either
the static query, or whatever has been set on that component via <code>(prim/set-query! ...)</code>.</p>
</li>
<li>
<p>The <code>get-query</code> accessor method not only helps with server-side invocation, it annotates the query with
metadata that includes the component info. This is what makes normalization work.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some rules about the query itself:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A query <strong>must not</strong> be stolen from another component (<strong>even</strong> if it seems more DRY):</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defui PersonView1
  static prim/IQuery
  (query [this] (prim/get-query PersonView2)) <span class="comment">;; WRONG!!!!</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is wrong because the query will end up annotated with <code>PersonView2</code>'s metadata. Never use the return
value of <code>get-query</code> as the return value for your own <code>query</code>.</p>
</div>
</li>
<li>
<p>The query will be structured with joins to follow the UI tree. In this manner the render and query
follow form. If you query for some subcomponent&#8217;s data, then you should pass that data to that
component&#8217;s factory function for rendering.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_notes_on_the_ident_protocol"><a class="anchor" href="#_notes_on_the_ident_protocol"></a><a class="link" href="#_notes_on_the_ident_protocol">Notes on the Ident Protocol</a></h5>
<div class="paragraph">
<p>The ident of a component is often needed in mutations, since you&#8217;re always manipulating the graph. To avoid
typos, it is generally recommended that you write a function like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">person-ident</span> [id-or-props]
  (<span class="keyword">if</span> (<span class="keyword">map?</span> id-or-props)
    [<span class="symbol">:person/by-id</span> (<span class="symbol">:db/id</span> id-or-props)]
    [<span class="symbol">:person/by-id</span> id-or-props]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>and use that in both your component&#8217;s ident implementation and all of your mutations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defui Person
  static prim/Ident
  (ident [this props] (person-ident props)))

<span class="keyword">..</span><span class="keyword">.</span>

(defmutation change-name [{<span class="symbol">:keys</span> [id <span class="keyword">name</span>]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">let</span> [name-path (<span class="keyword">conj</span> (person-ident id) <span class="symbol">:person/name</span>)]
      (<span class="keyword">swap!</span> state <span class="keyword">assoc-in</span> name-path <span class="keyword">name</span>))))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_om_next_compatibility"><a class="anchor" href="#_om_next_compatibility"></a><a class="link" href="#_om_next_compatibility">4.9.4. Om Next Compatibility</a></h4>
<div class="paragraph">
<p>Fulcro&#8217;s <code>defui</code> is identical in syntax to Om Next&#8217;s <code>defui</code>. Porting
Om Next UI code to Fulcro is a simple matter of changing namespaces.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_query_and_mutation_language"><a class="anchor" href="#_the_query_and_mutation_language"></a><a class="link" href="#_the_query_and_mutation_language">5. The Query and Mutation Language</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before reading this chapter you should make sure you&#8217;ve read <a href="#GraphDB">The Graph Database Section</a>. It details
the low-level format of the application state, and talks about general details that
are referenced in this chapter.</p>
</div>
<div class="paragraph">
<p>In Fulcro all data is pulled from the database using a notation that is a subset of Datomic&#8217;s pull query syntax. Since
the query is a graph walk it is a relative notation: it must start at some specific spot, but that spot is not
always named in the query itself. On the client side the starting point is usually the root node of your database. Thus,
a complete query from the Root UI component will be a graph query that can start at the root node of the database.</p>
</div>
<div class="paragraph">
<p>However, you&#8217;ll note that any query <strong>fragment</strong> is implied to be relative to where we are in the walk of the graph
database. This is important to understand: no component&#8217;s query can just be grabbed and run against the database
as-is. Then again, if you know the <code>ident</code> of a component, then you can <strong>start</strong> at that table entry in the database
and go from there.</p>
</div>
<div class="paragraph">
<p>The mutation language is a data representation of the abstract actions you&#8217;d like to take on the data model. It is
intended to be network agnostic: The UI need not be aware that a given mutation does local-only modifications and/or
remote operations against any number of remote servers. As such, the mutations, like queries, are simply data. Data
that can be interpreted by local logic, or data that can be sent over the wire to be interpreted by a server.</p>
</div>
<div class="paragraph">
<p>Queries can either be a vector or a map of vectors. The former is a regular component query, and the latter is
known as a <strong>union</strong> query. Union queries are useful when you&#8217;re walking a graph edge and the target could be
one of many different kinds of nodes, so you&#8217;re not sure which query to use until you actually are walking
the graph.</p>
</div>
<div class="sect2">
<h3 id="_properties"><a class="anchor" href="#_properties"></a><a class="link" href="#_properties">5.1. Properties</a></h3>
<div class="paragraph">
<p>The simplest thing to query are properties "right here" in the relative node of the graph. Properties are queried
by a simple keyword. Their values can be any scalar data value that is serializable in EDN.</p>
</div>
<div class="paragraph">
<p>The query</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[<span class="symbol">:a</span> <span class="symbol">:b</span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>is asking for the properties known as <code>:a</code> and <code>:b</code> at the "current node" in the graph traversal.</p>
</div>
</div>
<div class="sect2">
<h3 id="_joins"><a class="anchor" href="#_joins"></a><a class="link" href="#_joins">5.2. Joins</a></h3>
<div class="paragraph">
<p>A join is similar to a property query, in that the linkage is stored at the given keyword, but the linkage
walks to another node in the graph. The notation is a map with a single key (the local property at
the current node) whose single value is the query for the remainder of the graph walk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[{<span class="symbol">:children</span> (prim/get-query Child)}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query itself cannot specify that this is a to-one or to-many join. The data in the database graph itself
determines this when the query is being run. Basically, if walking the join property leads to a vector of
links, it is to-many. If it leads to a single link, then it is to-one. Of course, rendering the data is going
to have the same concern, so the arity of the relation more strongly affects the rendering code.</p>
</div>
<div class="paragraph">
<p>Joins should always use <code>get-query</code> to get the next component in the graph. This annotates (with metadata) the sub-query
so that normalization can work correctly.</p>
</div>
</div>
<div class="sect2">
<h3 id="Unions"><a class="anchor" href="#Unions"></a><a class="link" href="#Unions">5.3. Unions</a></h3>
<div class="paragraph">
<p>Unions represent a map of queries, only one of which applies at a given graph edge. This is a form of
dynamic query that adjusts based on the actual linkage of data. Unions cannot stand alone.
They are meant to select one of many possible alternate queries when a link (to-one or to-many join) in the
graph is reached. Unions are always used in tandem with a join, and can therefore not be used on root-level
components. The union query itself is a map of the possible queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc PersonPlaceOrThingUnion [this props]
  <span class="comment">; lambda form required for unions</span>
  {<span class="symbol">:query</span> (<span class="keyword">fn</span> [] {<span class="symbol">:person</span> (prim/get-query Person)
                  <span class="symbol">:place</span> (prim/get-query Place)
                  <span class="symbol">:thing</span> (prim/get-query Thing)})}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>and such a query must be joined by a parent component. Therefore, you&#8217;ll always end up with something
like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Parent [this props]
  {<span class="symbol">:query</span> [{<span class="symbol">:person-place-or-thing</span> (prim/get-query PersonPlaceOrThingUnion)}]})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Union queries take a little getting used to because there are a number of rules to follow when
using them in order for everything to work correctly (normalization, queries, and rendering).</p>
</div>
<div class="paragraph">
<p>Here is what a graph database might look like for the above query assuming we started at <code>Parent</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:peron-place-or-thing</span> [<span class="symbol">:place</span> <span class="integer">3</span>]
  <span class="symbol">:place</span> { <span class="integer">3</span> { <span class="symbol">:id</span> <span class="integer">3</span> <span class="symbol">:location</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">New York</span><span class="delimiter">&quot;</span></span> }}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query would start at the root. When it saw the join it would detect a union. The union would be resolved
by looking at the <strong>first</strong> element of the <strong>ident in the database</strong> (in this case <code>:place</code> from <code>[:place 3]</code>). That keyword
would then be used to select the <strong>query</strong> from the subcomponent union (in this example, <code>(prim/get-query Place)</code>).</p>
</div>
<div class="paragraph">
<p>Processing of the query then continues as normal as if the join was just on <code>Place</code>.</p>
</div>
<div class="paragraph">
<p>A to-many linkage works just as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:peron-place-or-thing</span> [[<span class="symbol">:person</span> <span class="integer">1</span>] [<span class="symbol">:place</span> <span class="integer">3</span>]]
  <span class="symbol">:person</span> { <span class="integer">1</span> { <span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Julie</span><span class="delimiter">&quot;</span></span> }}
  <span class="symbol">:place</span> { <span class="integer">3</span> { <span class="symbol">:id</span> <span class="integer">3</span> <span class="symbol">:location</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">New York</span><span class="delimiter">&quot;</span></span> }}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and now you have a mixed to-many relationship where the correct sub-query will be used for each item in turn.</p>
</div>
<div class="paragraph">
<p>Normalization of unions requires that the union component <strong>itself</strong> have an ident function that can properly
generate idents for <strong>all of the possible kinds of things that could be found</strong>. Often this means that you&#8217;ll need
to encode some kind of type indicator in the data itself.</p>
</div>
<div class="paragraph">
<p>Say you had this incoming tree of data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:person-place-or-thing</span> [ {<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span>} {<span class="symbol">:id</span> <span class="integer">3</span> <span class="symbol">:location</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">New York</span><span class="delimiter">&quot;</span></span>} ]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to normalize this correctly we need to end up with the correct <code>person</code> and <code>place</code> idents. The resulting
ident function might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc PersonPlaceOrThingUnion [this props]
  {<span class="symbol">:ident</span> (<span class="keyword">fn</span> []
    (<span class="keyword">cond</span>
      (<span class="keyword">contains?</span> props <span class="symbol">:name</span>) [<span class="symbol">:person</span> (<span class="symbol">:id</span> props)]
      (<span class="keyword">contains?</span> props <span class="symbol">:location</span>) [<span class="symbol">:place</span> (<span class="symbol">:id</span> props)]
      <span class="symbol">:else</span> [<span class="symbol">:thing</span> (<span class="symbol">:id</span> props)]))}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Often it is easier to just include a <code>:type</code> field so that <code>ident</code> can look up both the type and id.</p>
</div>
<div class="paragraph">
<p>Rendering the correct thing in the UI of the union component has the same concern: you must detect what
kind of data (among the options) that you actually receive, and pass that on to the correct child factory (e.g.
<code>ui-person</code>, <code>ui-place</code>, or <code>ui-thing</code>. This is most commmonly done with a simple <code>case</code> statement.</p>
</div>
<div class="sect3">
<h4 id="_demo_using_unions_as_a_ui_type_selector"><a class="anchor" href="#_demo_using_unions_as_a_ui_type_selector"></a><a class="link" href="#_demo_using_unions_as_a_ui_type_selector">5.3.1. Demo – Using Unions as a UI Type Selector</a></h4>
<div class="paragraph">
<p>The <code>fulcro.client.routing/defrouter</code> macro emits a union component that can be switched to point at any kind
of component that it knows about. The support for parameterized routers in the routing tree makes it possible
to very easily reuse the UI router as a component that can show one of many screens in the same location.</p>
</div>
<div class="paragraph">
<p>This is particularly useful when you have a list of items that have varying types, and you&#8217;d like to, for example,
show the list on one side of the screen and the detail on the other.</p>
</div>
<div class="paragraph">
<p>To write such a thing one would follow these steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create one component for each item type that represents how it will look in the list.</p>
</li>
<li>
<p>Create one component for each item type that represents the fine detail view for that item.</p>
</li>
<li>
<p>Join (1) together into a union component and use it in a component that shows them as a list. In other words
the union will represent a to-many edge in your graph. Remember that unions cannot stand alone, so there
will be a union component (to switch the UI) and a list component to iterate through the items.</p>
</li>
<li>
<p>Combine the detail components from (2) into a <code>defrouter</code> (e.g. named :detail-router).</p>
</li>
<li>
<p>Create a routing tree that includes the :detail-router, and parameterize both elements of the target ident (kind and id)</p>
</li>
<li>
<p>Hook a click event from the items to a <code>route-to</code> mutation, and send route parameters for the kind and id.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The output of this defrouter (macro):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defrouter ItemDetail <span class="symbol">:detail-router</span>
  (ident [this props] (item-ident props))
  <span class="symbol">:person</span> PersonDetail
  <span class="symbol">:place</span> PlaceDetail
  <span class="symbol">:thing</span> ThingDetail)</code></pre>
</div>
</div>
<div class="paragraph">
<p>is roughly this (cleaned up from macro output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc ItemDetail-Union [this props]
  {<span class="symbol">:initial-state</span> [clz params] (prim/get-initial-state PersonDetail params)) <span class="comment">;; defaults to the first one listed</span>
   <span class="symbol">:ident</span> [this props] (item-ident props))
   <span class="symbol">:query</span> (<span class="keyword">fn</span> [] {<span class="symbol">:person</span> (prim/get-query PersonDetail),
                  <span class="symbol">:place</span> (prim/get-query PlaceDetail),
                  <span class="symbol">:thing</span> (prim/get-query ThingDetail)}}
   (<span class="keyword">let</span> [page (<span class="keyword">first</span> (prim/get-ident this))]
    (<span class="keyword">case</span> page
     <span class="symbol">:person</span> ((prim/factory PersonDetail) (prim/props this))
     <span class="symbol">:place</span> ((prim/factory PlaceDetail) (prim/props this))
     <span class="symbol">:thing</span> ((prim/factory ThingDetail) (prim/props this))
     (dom/div <span class="predefined-constant">nil</span> (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Cannot route: Unknown Screen </span><span class="delimiter">&quot;</span></span> page))))

(defsc ItemDetail [this props]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [params] {<span class="symbol">:fulcro.client.routing/id</span> <span class="symbol">:detail-router</span>
                                <span class="symbol">:fulcro.client.routing/current-route</span> (prim/get-initial-state ItemDetail-Union params)})
   <span class="symbol">:ident</span> (<span class="keyword">fn</span> [] [<span class="symbol">:fulcro.client.routing.routers/by-id</span> <span class="symbol">:detail-router</span>])
   <span class="symbol">:query</span> [this] [<span class="symbol">:fulcro.client.routing/id</span> {<span class="symbol">:fulcro.client.routing/current-route</span> (prim/get-query ItemDetail-Union)}]}
  (<span class="keyword">let</span> [computed (prim/get-computed this)
        props (<span class="symbol">:fulcro.client.routing/current-route</span> (prim/props this))
        props-with-computed (prim/computed props computed)]
   ((prim/factory ItemDetail-Union) props-with-computed)))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that this just defines a union whose "selection" is controlled by the <code>:current-route</code> property!</p>
</div>
<div class="paragraph">
<p>Here is a compelte working example that uses this to make a UI around displaying things of various types:</p>
</div>
<div class="example" id="union-example-1"> </div>
<a class="source-toggle" href="javascript:void(0)" onClick="$('.union-example-1').toggle()">Show/Hide Source</a>
<div class="listingblock union-example-1 source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.queries.union-example-1</span>
(<span class="symbol">:require</span> [fulcro.client.dom <span class="symbol">:as</span> dom]
  [fulcro.client.routing <span class="symbol">:as</span> r <span class="symbol">:refer</span> [defrouter]]
  [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defsc]]
  [fulcro.client <span class="symbol">:as</span> fc]
  [fulcro.ui.bootstrap3 <span class="symbol">:as</span> b]
  [fulcro.ui.elements <span class="symbol">:as</span> ele]
  [fulcro.client.cards <span class="symbol">:refer</span> [defcard-fulcro]]))

(<span class="keyword">defn</span> <span class="function">item-ident</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Generate an ident from a person, place, or thing.</span><span class="delimiter">&quot;</span></span>
  [props] [(<span class="symbol">:kind</span> props) (<span class="symbol">:db/id</span> props)])

(<span class="keyword">defn</span> <span class="function">item-key</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Generate a distinct react key for a person, place, or thing</span><span class="delimiter">&quot;</span></span>
  [props] (<span class="keyword">str</span> (<span class="symbol">:kind</span> props) <span class="string"><span class="delimiter">&quot;</span><span class="content">-</span><span class="delimiter">&quot;</span></span> (<span class="symbol">:db/id</span> props)))

(<span class="keyword">defn</span> <span class="function">make-person</span> [id n] {<span class="symbol">:db/id</span> id <span class="symbol">:kind</span> <span class="symbol">:person</span> <span class="symbol">:person/name</span> n})
(<span class="keyword">defn</span> <span class="function">make-place</span> [id n] {<span class="symbol">:db/id</span> id <span class="symbol">:kind</span> <span class="symbol">:place</span> <span class="symbol">:place/name</span> n})
(<span class="keyword">defn</span> <span class="function">make-thing</span> [id n] {<span class="symbol">:db/id</span> id <span class="symbol">:kind</span> <span class="symbol">:thing</span> <span class="symbol">:thing/label</span> n})

(defsc PersonDetail [this {<span class="symbol">:keys</span> [db/id person/name] <span class="symbol">:as</span> props}]
  <span class="comment">; defrouter expects there to be an initial state for each possible target. We'll cause this to be a &quot;no selection&quot;</span>
  <span class="comment">; state so that the detail screen that starts out will show &quot;Nothing selected&quot;. We initialize all three in case</span>
  <span class="comment">; we later re-order them in the defrouter.</span>
  {<span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span>         [<span class="symbol">:kind</span> <span class="symbol">:db/id</span> <span class="symbol">:person/name</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:db/id</span> <span class="symbol">:no-selection</span> <span class="symbol">:kind</span> <span class="symbol">:person</span>}}
  (dom/div <span class="predefined-constant">nil</span>
    (<span class="keyword">if</span> (<span class="keyword">=</span> id <span class="symbol">:no-selection</span>)
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Nothing selected</span><span class="delimiter">&quot;</span></span>
      (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Details about person </span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>))))

(defsc PlaceDetail [this {<span class="symbol">:keys</span> [db/id place/name] <span class="symbol">:as</span> props}]
  {<span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span>         [<span class="symbol">:kind</span> <span class="symbol">:db/id</span> <span class="symbol">:place/name</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:db/id</span> <span class="symbol">:no-selection</span> <span class="symbol">:kind</span> <span class="symbol">:place</span>}}
  (dom/div <span class="predefined-constant">nil</span>
    (<span class="keyword">if</span> (<span class="keyword">=</span> id <span class="symbol">:no-selection</span>)
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Nothing selected</span><span class="delimiter">&quot;</span></span>
      (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Details about place </span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>))))

(defsc ThingDetail [this {<span class="symbol">:keys</span> [db/id thing/label] <span class="symbol">:as</span> props}]
  {<span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span>         [<span class="symbol">:kind</span> <span class="symbol">:db/id</span> <span class="symbol">:thing/label</span>]
   <span class="symbol">:initial-state</span> {<span class="symbol">:db/id</span> <span class="symbol">:no-selection</span> <span class="symbol">:kind</span> <span class="symbol">:thing</span>}}
  (dom/div <span class="predefined-constant">nil</span>
    (<span class="keyword">if</span> (<span class="keyword">=</span> id <span class="symbol">:no-selection</span>)
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Nothing selected</span><span class="delimiter">&quot;</span></span>
      (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Details about thing </span><span class="delimiter">&quot;</span></span> label))))

(defsc PersonListItem [this
                       {<span class="symbol">:keys</span> [db/id person/name] <span class="symbol">:as</span> props}
                       {<span class="symbol">:keys</span> [onSelect] <span class="symbol">:as</span> computed}]
  {<span class="symbol">:ident</span> (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span> [<span class="symbol">:kind</span> <span class="symbol">:db/id</span> <span class="symbol">:person/name</span>]}
  (dom/li <span class="error">#</span>js {<span class="symbol">:onClick</span> #(onSelect (item-ident props))}
    (dom/a <span class="error">#</span>js {<span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">javascript:void(0)</span><span class="delimiter">&quot;</span></span>} (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Person </span><span class="delimiter">&quot;</span></span> id <span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>))))

(<span class="keyword">def</span> <span class="function">ui-person</span> (prim/factory PersonListItem {<span class="symbol">:keyfn</span> item-key}))

(defsc PlaceListItem [this {<span class="symbol">:keys</span> [db/id place/name] <span class="symbol">:as</span> props} {<span class="symbol">:keys</span> [onSelect] <span class="symbol">:as</span> computed}]
  {<span class="symbol">:ident</span> (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span> [<span class="symbol">:kind</span> <span class="symbol">:db/id</span> <span class="symbol">:place/name</span>]}
  (dom/li <span class="error">#</span>js {<span class="symbol">:onClick</span> #(onSelect (item-ident props))}
    (dom/a <span class="error">#</span>js {<span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">javascript:void(0)</span><span class="delimiter">&quot;</span></span>} (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Place </span><span class="delimiter">&quot;</span></span> id <span class="string"><span class="delimiter">&quot;</span><span class="content"> : </span><span class="delimiter">&quot;</span></span> <span class="keyword">name</span>))))

(<span class="keyword">def</span> <span class="function">ui-place</span> (prim/factory PlaceListItem {<span class="symbol">:keyfn</span> item-key}))

(defsc ThingListItem [this {<span class="symbol">:keys</span> [db/id thing/label] <span class="symbol">:as</span> props} {<span class="symbol">:keys</span> [onSelect] <span class="symbol">:as</span> computed}]
  {<span class="symbol">:ident</span> (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span> [<span class="symbol">:kind</span> <span class="symbol">:db/id</span> <span class="symbol">:thing/label</span>]}
  (dom/li <span class="error">#</span>js {<span class="symbol">:onClick</span> #(onSelect (item-ident props))}
    (dom/a <span class="error">#</span>js {<span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">javascript:void(0)</span><span class="delimiter">&quot;</span></span>} (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Thing </span><span class="delimiter">&quot;</span></span> id <span class="string"><span class="delimiter">&quot;</span><span class="content"> : </span><span class="delimiter">&quot;</span></span> label))))

(<span class="keyword">def</span> <span class="function">ui-thing</span> (prim/factory ThingListItem item-key))

(defrouter ItemDetail <span class="symbol">:detail-router</span>
  (ident [this props] (item-ident props))
  <span class="symbol">:person</span> PersonDetail
  <span class="symbol">:place</span> PlaceDetail
  <span class="symbol">:thing</span> ThingDetail)

(<span class="keyword">def</span> <span class="function">ui-item-detail</span> (prim/factory ItemDetail))

(defsc ItemUnion [this {<span class="symbol">:keys</span> [kind] <span class="symbol">:as</span> props}]
  {<span class="symbol">:ident</span> (<span class="keyword">fn</span> [] (item-ident props))
   <span class="symbol">:query</span> (<span class="keyword">fn</span> [] {<span class="symbol">:person</span> (prim/get-query PersonListItem)
                  <span class="symbol">:place</span>  (prim/get-query PlaceListItem)
                  <span class="symbol">:thing</span>  (prim/get-query ThingListItem)})}
  (<span class="keyword">case</span> kind
    <span class="symbol">:person</span> (ui-person props)
    <span class="symbol">:place</span> (ui-place props)
    <span class="symbol">:thing</span> (ui-thing props)))

(<span class="keyword">def</span> <span class="function">ui-item-union</span> (prim/factory ItemUnion {<span class="symbol">:keyfn</span> item-key}))

(defsc ItemList [this {<span class="symbol">:keys</span> [items]} {<span class="symbol">:keys</span> [onSelect]}]
  {
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p]
                    <span class="comment">; These would normally be loaded...but for demo purposes we just hand code a few</span>
                    {<span class="symbol">:items</span> [(make-person <span class="integer">1</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Tony</span><span class="delimiter">&quot;</span></span>)
                             (make-thing <span class="integer">2</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Toaster</span><span class="delimiter">&quot;</span></span>)
                             (make-place <span class="integer">3</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">New York</span><span class="delimiter">&quot;</span></span>)
                             (make-person <span class="integer">4</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span>)
                             (make-thing <span class="integer">5</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Pillow</span><span class="delimiter">&quot;</span></span>)
                             (make-place <span class="integer">6</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Canada</span><span class="delimiter">&quot;</span></span>)]})
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] [<span class="symbol">:lists/by-id</span> <span class="symbol">:singleton</span>])
   <span class="symbol">:query</span>         [{<span class="symbol">:items</span> (prim/get-query ItemUnion)}]}
  (dom/ul <span class="predefined-constant">nil</span>
    (<span class="keyword">map</span> (<span class="keyword">fn</span> [i] (ui-item-union (prim/computed i {<span class="symbol">:onSelect</span> onSelect}))) items)))

(<span class="keyword">def</span> <span class="function">ui-item-list</span> (prim/factory ItemList))

(defsc Root [this {<span class="symbol">:keys</span> [item-list item-detail]}]
  {<span class="symbol">:query</span>         [{<span class="symbol">:item-list</span> (prim/get-query ItemList)}
                   {<span class="symbol">:item-detail</span> (prim/get-query ItemDetail)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p] (<span class="keyword">merge</span>
                            (r/routing-tree
                              (r/make-route <span class="symbol">:detail</span> [(r/router-instruction <span class="symbol">:detail-router</span> [<span class="symbol">:param/kind</span> <span class="symbol">:param/id</span>])]))
                            {<span class="symbol">:item-list</span>   (prim/get-initial-state ItemList <span class="predefined-constant">nil</span>)
                             <span class="symbol">:item-detail</span> (prim/get-initial-state ItemDetail <span class="predefined-constant">nil</span>)}))}
  (<span class="keyword">let</span> [<span class="comment">; This is the only thing to do: Route the to the detail screen with the given route params!</span>
        showDetail (<span class="keyword">fn</span> [[kind id]]
                     (prim/transact! this `[(r/route-to {<span class="symbol">:handler</span> <span class="symbol">:detail</span> <span class="symbol">:route-params</span> {<span class="symbol">:kind</span> ~kind <span class="symbol">:id</span> ~id}})]))]
    <span class="comment">; devcards, embed in iframe so we can use bootstrap css easily</span>
    (ele/ui-iframe {<span class="symbol">:frameBorder</span> <span class="integer">0</span> <span class="symbol">:height</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">300px</span><span class="delimiter">&quot;</span></span> <span class="symbol">:width</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">100%</span><span class="delimiter">&quot;</span></span>}
      (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">example-frame-key</span><span class="delimiter">&quot;</span></span>}
        (dom/style <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">.boxed {border: 1px solid black}</span><span class="delimiter">&quot;</span></span>)
        (dom/link <span class="error">#</span>js {<span class="symbol">:rel</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">bootstrap-3.3.7/css/bootstrap.min.css</span><span class="delimiter">&quot;</span></span>})
        (b/container-fluid {}
          (b/row {}
            (b/col {<span class="symbol">:xs</span> <span class="integer">6</span>} <span class="string"><span class="delimiter">&quot;</span><span class="content">Items</span><span class="delimiter">&quot;</span></span>)
            (b/col {<span class="symbol">:xs</span> <span class="integer">6</span>} <span class="string"><span class="delimiter">&quot;</span><span class="content">Detail</span><span class="delimiter">&quot;</span></span>))
          (b/row {}
            (b/col {<span class="symbol">:xs</span> <span class="integer">6</span>} (ui-item-list (prim/computed item-list {<span class="symbol">:onSelect</span> showDetail})))
            (b/col {<span class="symbol">:xs</span> <span class="integer">6</span>} (ui-item-detail item-detail))))))))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_demo_using_unions_to_switch_out_ui_elements"><a class="anchor" href="#_demo_using_unions_to_switch_out_ui_elements"></a><a class="link" href="#_demo_using_unions_to_switch_out_ui_elements">5.3.2. Demo – Using Unions to Switch out UI Elements</a></h4>
<div class="paragraph">
<p>This demo is similar to the prior example. In fact, the two could be combined to make
this one polymorphic as well, but the primary interest in this demo is to show swapping between an editor
and a list (or table).</p>
</div>
<div class="paragraph">
<p>This example uses the forms support, with a custom submit and cancel mutation.
It is instructive to see how entities could be loaded
(simulated in the started-callback) as pristine entities and augmented with form support through mutations
that have a nice clear meaning (to both front and back-end).</p>
</div>
<div class="paragraph">
<p>See the comments on the source for more details.</p>
</div>
<div class="example" id="union-example-2"></div>
<a class="source-toggle" href="javascript:void(0)" onClick="$('.union-example-2').toggle()">Show/Hide Source</a>
<div class="listingblock union-example-2 source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.queries.union-example-2</span>
  (<span class="symbol">:require</span> [fulcro.client.dom <span class="symbol">:as</span> dom]
            [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defsc]]
            [fulcro.client.cards <span class="symbol">:refer</span> [defcard-fulcro]]
            [fulcro.client <span class="symbol">:as</span> fc]
            [fulcro.client.routing <span class="symbol">:as</span> r <span class="symbol">:refer</span> [defrouter]]
            [fulcro.client.mutations <span class="symbol">:refer</span> [defmutation]]
            [book.macros <span class="symbol">:refer</span> [defexample]]
            [fulcro.ui.bootstrap3 <span class="symbol">:as</span> b]
            [fulcro.ui.elements <span class="symbol">:as</span> ele]
            [fulcro.ui.forms <span class="symbol">:as</span> f]
            [fulcro.client.logging <span class="symbol">:as</span> log]))

(<span class="keyword">defn</span> <span class="function">person-ident</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Generate an ident from a person.</span><span class="delimiter">&quot;</span></span>
  [id-or-props]
  (<span class="keyword">if</span> (<span class="keyword">map?</span> id-or-props)
    [<span class="symbol">:person/by-id</span> (<span class="symbol">:db/id</span> id-or-props)]
    [<span class="symbol">:person/by-id</span> id-or-props]))

(<span class="keyword">declare</span> <span class="function">PersonForm</span>)

(defmutation edit-person
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Fulcro mutation: Edit the person with the given ID.</span><span class="delimiter">&quot;</span></span>
  [{<span class="symbol">:keys</span> [id]}]
  (action [{<span class="symbol">:keys</span> [state] <span class="symbol">:as</span> env}]
    (<span class="keyword">swap!</span> state (<span class="keyword">fn</span> [s]
                   (<span class="keyword">-&gt;</span> s
                     <span class="comment">; change the route. This just points the routers via ident changes</span>
                     (r/update-routing-links {<span class="symbol">:handler</span> <span class="symbol">:editor</span> <span class="symbol">:route-params</span> {<span class="symbol">:id</span> id}})
                     <span class="comment">; make sure the form has form support installed</span>
                     (f/init-form PersonForm (person-ident id)))))))

(defmutation cancel-edit
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Fulcro mutation: Cancel an edit.</span><span class="delimiter">&quot;</span></span>
  [no-args-needed]
  (action [{<span class="symbol">:keys</span> [state] <span class="symbol">:as</span> env}]
    (<span class="keyword">let</span> [ident-of-person-being-edited (r/current-route @state <span class="symbol">:listform-router</span>)]
      (<span class="keyword">swap!</span> state (<span class="keyword">fn</span> [s]
                     (<span class="keyword">-&gt;</span> s
                       <span class="comment">; change the route</span>
                       (r/update-routing-links {<span class="symbol">:handler</span> <span class="symbol">:people</span>})
                       <span class="comment">; clear any edits on the person (this is non-recursive)</span>
                       (<span class="keyword">update-in</span> ident-of-person-being-edited f/reset-entity)))))))

(defmutation submit-person
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Fulcro mutation: An example of a custom form submit, composing other operations into the submit.</span><span class="delimiter">&quot;</span></span>
  [{<span class="symbol">:keys</span> [form]}]                                          <span class="comment">; form is passed in from UI to close over it. See dev guide for why.</span>
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">let</span> [ident-of-person-being-edited (r/current-route @state <span class="symbol">:listform-router</span>)]
      (<span class="keyword">swap!</span> state (<span class="keyword">fn</span> [s]
                     (<span class="keyword">-&gt;</span> s
                       <span class="comment">; non-recursive. if using subforms see dev guide</span>
                       (<span class="keyword">update-in</span> ident-of-person-being-edited f/commit-state)
                       (r/update-routing-links {<span class="symbol">:handler</span> <span class="symbol">:people</span>})))))))


(<span class="keyword">defn</span> <span class="function">make-person</span> [id n] {<span class="symbol">:db/id</span> id <span class="symbol">:person/name</span> n})

(defsc PersonForm [this {<span class="symbol">:keys</span> [db/id person/name] <span class="symbol">:as</span> form-props}]
  {<span class="symbol">:ident</span>     (<span class="keyword">fn</span> [] (person-ident form-props))
   <span class="symbol">:query</span>     [<span class="symbol">:db/id</span> <span class="symbol">:person/name</span> f/form-key f/form-root-key]
   <span class="symbol">:protocols</span> [static f/IForm
               (form-spec [this] [(f/id-field <span class="symbol">:db/id</span>)
                                  (f/text-input <span class="symbol">:person/name</span>)])]}
  (b/form-horizontal <span class="predefined-constant">nil</span>
    (b/labeled-input {<span class="symbol">:split</span>           <span class="integer">4</span>
                      <span class="symbol">:input-generator</span> (<span class="keyword">fn</span> [_] (f/form-field this form-props <span class="symbol">:person/name</span>))} <span class="string"><span class="delimiter">&quot;</span><span class="content">Name:</span><span class="delimiter">&quot;</span></span>)
    (b/labeled-input {<span class="symbol">:split</span>           <span class="integer">4</span>
                      <span class="symbol">:input-generator</span> (<span class="keyword">fn</span> [_]
                                         (dom/div <span class="predefined-constant">nil</span>
                                           <span class="comment">; the follow-on read of :root/router ensures re-render from the router level</span>
                                           (b/button {<span class="symbol">:onClick</span> #(prim/transact! this `[(cancel-edit {}) <span class="symbol">:root/router</span>])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Cancel</span><span class="delimiter">&quot;</span></span>)
                                           (b/button {<span class="symbol">:onClick</span> #(prim/transact! this `[(submit-person {<span class="symbol">:form</span> form-props}) <span class="symbol">:root/router</span>])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Save</span><span class="delimiter">&quot;</span></span>)))} <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)))

(defsc PersonListItem [this {<span class="symbol">:keys</span> [db/id person/name] <span class="symbol">:as</span> props}]
  {<span class="symbol">:ident</span> (<span class="keyword">fn</span> [] (person-ident props))
   <span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:person/name</span>]}
  <span class="comment">; the follow-on read of :root/router ensures re-render from the router level</span>
  (dom/li <span class="error">#</span>js {<span class="symbol">:onClick</span> #(prim/transact! this `[(edit-person {<span class="symbol">:id</span> ~id}) <span class="symbol">:root/router</span>])}
    (dom/a <span class="error">#</span>js {<span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">javascript:void(0)</span><span class="delimiter">&quot;</span></span>} <span class="keyword">name</span>)))

(<span class="keyword">def</span> <span class="function">ui-person</span> (prim/factory PersonListItem {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(<span class="keyword">def</span> <span class="function">person-list-ident</span> [<span class="symbol">:person-list/table</span> <span class="symbol">:singleton</span>])

(defsc PersonList [this {<span class="symbol">:keys</span> [people]}]
  {<span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p] {<span class="symbol">:people</span> []})
   <span class="symbol">:query</span>         [{<span class="symbol">:people</span> (prim/get-query PersonListItem)}]
   <span class="symbol">:ident</span>         (<span class="keyword">fn</span> [] person-list-ident)}
  (dom/div <span class="predefined-constant">nil</span>
    (dom/h4 <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">People</span><span class="delimiter">&quot;</span></span>)
    (dom/ul <span class="predefined-constant">nil</span>
      (<span class="keyword">map</span> (<span class="keyword">fn</span> [i] (ui-person i)) people))))

(defrouter PersonListOrForm <span class="symbol">:listform-router</span>
  (ident [this props]
    (<span class="keyword">if</span> (<span class="keyword">contains?</span> props <span class="symbol">:people</span>)
      person-list-ident
      (person-ident props)))
  <span class="comment">; if the router points to a person list entity, render with a PersonList. This is the default route.</span>
  <span class="symbol">:person-list/table</span> PersonList
  <span class="comment">; if the router points to a person entity, render with PersonForm</span>
  <span class="symbol">:person/by-id</span> PersonForm)

(<span class="keyword">def</span> <span class="function">ui-person-list-or-form</span> (prim/factory PersonListOrForm))

(defsc Root [this {<span class="symbol">:keys</span> [ui/react-key root/router] <span class="symbol">:as</span> props}]
  {<span class="symbol">:query</span>         [<span class="symbol">:ui/react-key</span> {<span class="symbol">:root/router</span> (prim/get-query PersonListOrForm)}]
   <span class="symbol">:initial-state</span> (<span class="keyword">fn</span> [p] (<span class="keyword">merge</span>
                            <span class="comment">; This data is used by the `update-routing-links` functions to switch routes (union idents on the router's current route)</span>
                            (r/routing-tree
                              <span class="comment">; switch to the person list</span>
                              (r/make-route <span class="symbol">:people</span> [(r/router-instruction <span class="symbol">:listform-router</span> person-list-ident)])
                              <span class="comment">; switch to the given person (id is passed to update-routing-links and become :param/id)</span>
                              (r/make-route <span class="symbol">:editor</span> [(r/router-instruction <span class="symbol">:listform-router</span> (person-ident <span class="symbol">:param/id</span>))]))
                            {<span class="symbol">:root/router</span> (prim/get-initial-state PersonListOrForm <span class="predefined-constant">nil</span>)}))}
  <span class="comment">; embed in iframe so we can use bootstrap css easily</span>
  (ele/ui-iframe {<span class="symbol">:frameBorder</span> <span class="integer">0</span> <span class="symbol">:height</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">300px</span><span class="delimiter">&quot;</span></span> <span class="symbol">:width</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">100%</span><span class="delimiter">&quot;</span></span>}
    (dom/div <span class="error">#</span>js {<span class="symbol">:key</span> react-key}
      (dom/style <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">.boxed {border: 1px solid black}</span><span class="delimiter">&quot;</span></span>)
      (dom/link <span class="error">#</span>js {<span class="symbol">:rel</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">bootstrap-3.3.7/css/bootstrap.min.css</span><span class="delimiter">&quot;</span></span>})
      (b/container-fluid {}
        (ui-person-list-or-form router)))))

(defexample <span class="string"><span class="delimiter">&quot;</span><span class="content">Unions as View/Edit Routers</span><span class="delimiter">&quot;</span></span> Root <span class="string"><span class="delimiter">&quot;</span><span class="content">union-example-2</span><span class="delimiter">&quot;</span></span>
  <span class="symbol">:started-callback</span> (<span class="keyword">fn</span> [{<span class="symbol">:keys</span> [reconciler]}]
                      <span class="comment">; simulate a load of people via a simple integration of some tree data</span>
                      (prim/merge-component! reconciler PersonList {<span class="symbol">:people</span> [(make-person <span class="integer">1</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Tony</span><span class="delimiter">&quot;</span></span>)
                                                                             (make-person <span class="integer">2</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Sally</span><span class="delimiter">&quot;</span></span>)
                                                                             (make-person <span class="integer">3</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Allen</span><span class="delimiter">&quot;</span></span>)
                                                                             (make-person <span class="integer">4</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Luna</span><span class="delimiter">&quot;</span></span>)]})))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Mutations"><a class="anchor" href="#Mutations"></a><a class="link" href="#Mutations">5.4. Mutations</a></h3>
<div class="paragraph">
<p>Mutations are also just data, as we mentioned earlier. However, they are intended to <strong>look like</strong> single-
argument function calls where the single argument is a map of parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[(do-something)]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The main concern is that this expression, in normal Clojure, will be evaluated because it contains a raw list.
In order to keep it data, one must quote expressions with mutations. Of course you may use syntax quoting
or literal quoting. Usually we recommend namespacing your mutations (with <code>defmutation</code>) and then using
syntax quoting to get reasonably short expressions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.mutations</span>)

(defmutation do-something [params] <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.ui</span>
  (<span class="symbol">:require</span> [app.mutations <span class="symbol">:as</span> am]))

<span class="keyword">..</span><span class="keyword">.</span>
   (prim/transact! this `[(am/do-something {})])</code></pre>
</div>
</div>
<div class="paragraph">
<p>The syntax quoting always ensures everything is fully-qualified, so this results in the raw symbol within
the <code>transact!</code>: <code>app.mutations/do-something</code>. When using IDEs like Cursive this allows you to enable support
for code navigation to the definition of mutations.</p>
</div>
<div class="paragraph">
<p>The parameter map on mutations is optional.</p>
</div>
</div>
<div class="sect2">
<h3 id="_parameters"><a class="anchor" href="#_parameters"></a><a class="link" href="#_parameters">5.5. Parameters</a></h3>
<div class="paragraph">
<p>Most of the query elements also support a parameter map. In Fulcro these are mainly useful when sending a query
to the server, and it is rare you will write such a query "by hand". However, for completeness you should know
what these look like. Basically, you just surround the property or join with parentheses, and add a map as
parameters. This is just like mutations, except instead of a symbol as the first element of the list it is either
a keyword (prop) or a map (join).</p>
</div>
<div class="paragraph">
<p>Thus a property can be parameterized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[(<span class="symbol">:prop</span> {<span class="symbol">:x</span> <span class="integer">1</span>})]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would cause, for example, a server&#8217;s query processing to see <code>{:x 1}</code> in the <code>params</code> when handling the read
for <code>:prop</code>.</p>
</div>
<div class="paragraph">
<p>A join is similarly parameterized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[({<span class="symbol">:child</span> (prim/get-query Child)} {<span class="symbol">:x</span> <span class="integer">1</span>})]</code></pre>
</div>
</div>
<div class="paragraph">
<p>with the same kind of effect.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The plain list has the same requirement as for mutations: quoting. Generally syntax quoting is again the best
choice, since you&#8217;ll often need unquoting. For example, the join example above would actually be written in code as:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">  <span class="keyword">..</span><span class="keyword">.</span>
  (query [this] `[({<span class="symbol">:child</span> ~(prim/get-query Child)} {<span class="symbol">:x</span> <span class="integer">1</span>})])
  <span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to avoid trying to use the map as a function for execution, yet allowing the nested <code>get-query</code> to run and embed
the proper subquery.</p>
</div>
</div>
<div class="sect2">
<h3 id="_queries_on_idents"><a class="anchor" href="#_queries_on_idents"></a><a class="link" href="#_queries_on_idents">5.6. Queries on Idents</a></h3>
<div class="paragraph">
<p>Idents are valid in queries as a plain prop or a join. When used as a plain prop you will end up with the ident
as a key in the <code>props</code>, and the complete (still-normalized) table entry as a value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[ [<span class="symbol">:person/by-id</span> <span class="integer">1</span>] ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>results in something like this in props:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ [<span class="symbol">:person/by-id</span> <span class="integer">1</span>] {<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:person/spouse</span> [<span class="symbol">:person/by-id</span> <span class="integer">1</span>]} }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is not typically what you want because you&#8217;d typically want it to follow the graph links.
Instead, <code>idents</code> are normally queried with a join:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[{[<span class="symbol">:person/by-id</span> <span class="integer">1</span>] (prim/get-query Person)}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>which has the effect of "re-rooting" the graph walk at that node, and continuing from there. You still get
the ident in the props, but now spouse would resolve to a map of real properties.</p>
</div>
</div>
<div class="sect2">
<h3 id="_link_queries"><a class="anchor" href="#_link_queries"></a><a class="link" href="#_link_queries">5.7. Link Queries</a></h3>
<div class="paragraph">
<p>There are times when you want to start "back at the root" node. This is useful for pulling data that has
a singleton representation in the root node itself. For example, the current UI locale or currently logged-in
user. There is a special notation for this the looks like an ident without an ID:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[ [<span class="symbol">:ui/locale</span> '_] ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This component query would result in <code>:ui/locale</code> in your props (not an ident) with a value that came from the
overall root node of the database. Of course, denormalization just requires you use a join:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[ {[<span class="symbol">:current-user</span> '_] (prim/get-query Person)} ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>would pull <code>:current-user</code> into the component&#8217;s props with a continued walk of the graph (e.g. person&#8217;s spouse would
be populated).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Link queries require that the component doing the query have a database node, even if empty. The database
query engine will not try to run the query of a component that has no data presence in the graph. Remember: the
query and database are walked together. If it runs out of data, it stops. So, if you had a component
asking for only <code>:current-user</code> via a link, but that component itself did not exist in the database then you
will never get to the link query at all. The fix is simple: include an empty map where that component&#8217;s state
should be.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_the_ast"><a class="anchor" href="#_the_ast"></a><a class="link" href="#_the_ast">5.8. The AST</a></h3>
<div class="paragraph">
<p>You can convert any expression in the query/mutation language into an AST (abstract syntax tree) and vice
versa. This lends itself to doing complex parsing of the query (typically on the server). The functions
of interest are <code>fulcro.client.primitives/query-&gt;ast</code> and <code>ast-&gt;query</code>.</p>
</div>
<div class="paragraph">
<p>There are many uses for this. One such use might be to convert the graph expression into another form. For
example, say you wanted to run a query against and SQL database. You could write an algorithm that translates
the AST into a series of SQL queries to build the desired result. The AST is always available as one
of the parameters in the mutation/query <code>env</code> on the client and server.</p>
</div>
<div class="paragraph">
<p>Another use for the AST is in mutations targeted at a remote: it turns out you can morph a mutation before
sending it to the server.</p>
</div>
<div class="sect3">
<h4 id="_morphing_mutations"><a class="anchor" href="#_morphing_mutations"></a><a class="link" href="#_morphing_mutations">5.8.1. Morphing Mutations</a></h4>
<div class="paragraph">
<p>The most common use of the AST is probably adding parameters that the UI is unaware need to be sent to
a remote. When processing a mutation with <code>defmutation</code> (or just the raw defmethod) you will receive
the AST of the mutation in the <code>env</code>. It is legal to return <strong>any</strong> valid AST from the remote side of a
mutation. This has the effect of changing what will be sent to the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation do-thing [params]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>)
  (remote [{<span class="symbol">:keys</span> [ast]}] ast)) <span class="comment">; same effect as `true`</span>

(defmutation do-thing [params]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>)
  (remote [{<span class="symbol">:keys</span> [ast]}] (prim/query-&gt;ast `[(do-other-thing)])) <span class="comment">; completely change what gets sent to `remote`</span>

(defmutation do-thing [params]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>)
  (remote [{<span class="symbol">:keys</span> [ast]}] (<span class="keyword">assoc</span> ast <span class="symbol">:params</span> {<span class="symbol">:y</span> <span class="integer">3</span>}))) <span class="comment">; change the parameters</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more on mutations see the chapter on <a href="#MutationsChapter">Handling Mutations</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initial_application_state"><a class="anchor" href="#_initial_application_state"></a><a class="link" href="#_initial_application_state">6. Initial Application State</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>When starting any application one thing has to be done before just about anything else: Establish a starting state. In Fulcro
this just means generating a client-side application database (normalized). Other parts of this guide have talked about
the <a href="#GraphDB">Graph Database</a>. You can well imagine that hand-coding one of these for a large application&#8217;s starting
state could be kind of a pain. Actually, coding it would turn out to be less of a pain than maintaining such
a hand-coded thing it as you refactor and evolve your UI!</p>
</div>
<div class="paragraph">
<p>However, Fulcro already knows how to normalize a tree of data, and your UI is the tree you&#8217;re interested in. So, Fulcro
encourages you to co-locate initial application state with the components that need the state and compose it towards
the root, just like you do for queries. This gives some nice results:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Your initial application state is reasoned about local to each component, just like the queries.</p>
</li>
<li>
<p>Refactoring the UI just means modifying the <strong>local</strong> composition of queries and initial state from one place
to another in the UI.</p>
</li>
<li>
<p>Fulcro understands unions (you can only initialize one branch of a to-one relation), and can scan for and initialize alternate branches.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_adding_initial_state_to_components"><a class="anchor" href="#_adding_initial_state_to_components"></a><a class="link" href="#_adding_initial_state_to_components">6.1. Adding Initial State to Components</a></h3>
<div class="paragraph">
<p>To add initial state, follow these steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For each component that should appear initially: add the <code>:initial-state</code> option.</p>
</li>
<li>
<p>Compose the components in (1) all the way to your root.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>That&#8217;s it! Fulcro will automatically detect initial state on the root, and use it for the application!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Pulling the initial state from a component should be done with <code>fulcro.core/get-initial-state</code>. Calling a static
protocol cannot work on the server, so this helper method makes server-side rendering possible for your components.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defui Child
  static fulcro.core/InitialAppState
  (initial-state [cls params] { <span class="symbol">:x</span> <span class="integer">1</span> }) <span class="comment">; set :x to 1 for this component's state</span>
  static prim/IQuery
  (query [this] [<span class="symbol">:x</span>]) <span class="comment">; query for :x</span>
  static prim/Ident
  (ident [this props] <span class="keyword">..</span><span class="keyword">.</span>) <span class="comment">; how to normalize</span>
  Object
  (render [this]
    (<span class="keyword">let</span> [{<span class="symbol">:keys</span> [x]} (prim/props this)] <span class="comment">; pull x from props</span>
      <span class="keyword">..</span><span class="keyword">.</span>)))

(defui Parent
  static fulcro.core/InitialAppState
  (initial-state [cls params] { <span class="symbol">:y</span> <span class="integer">2</span> <span class="symbol">:child</span> (prim/get-initial-state Child {}) }) <span class="comment">; set y, and compose in child's state</span>
  static prim/IQuery
  (query [this] [<span class="symbol">:y</span> {<span class="symbol">:child</span> (prim/get-query Child)}]) <span class="comment">; query for :y and compose child's query</span>
  static prim/Ident
  (ident [this props] <span class="keyword">..</span><span class="keyword">.</span>) <span class="comment">; how to normalize</span>
  Object
  (render [this]
    (<span class="keyword">let</span> [{<span class="symbol">:keys</span> [y child]} (prim/props this)] <span class="comment">; pull y and child from props</span>
      <span class="keyword">..</span><span class="keyword">.</span>)))

<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the nice symmetry here. The initial state is (usually) a map that represents (recursively) the entity and
it&#8217;s children. The query is a vector that lists the "scalar" props, and joins as maps.  So, in <code>Child</code> we have
initial state for <code>:x</code> and a query for <code>:x</code>. In the parent we have a query for the property <code>:y</code> and a join to
the child, and initial state for the scalar value of <code>:y</code> and the composed initial state of the <code>Child</code>. Render has
the same thing: the things you pull out of props will be the things for which you queried. Thus, all three essentially
list the same things, but in slightly different forms.</p>
</div>
<div class="sect3">
<h4 id="_initial_state_and_alternate_branches_of_unions"><a class="anchor" href="#_initial_state_and_alternate_branches_of_unions"></a><a class="link" href="#_initial_state_and_alternate_branches_of_unions">6.1.1. Initial State and Alternate Branches of Unions</a></h4>
<div class="paragraph">
<p>The one "extra" feature that initial state support does for you is to initialize <strong>alternate branches</strong> of components that
have to-one <a href="#Unions">union query</a>. Remember that a to-one relation from a union could be to any number of alternates.</p>
</div>
<div class="paragraph">
<p>Take this union query: <code>{:person (prim/get-query Person) :place (prim/get-query Place)}</code></p>
</div>
<div class="paragraph">
<p>It means "if you find an ident in the graph pointing to a <code>:person</code>, then query for the person. If you find one
for <code>:place</code>, then query for a place. The problem is: if it is a to-one relation then only <strong>one</strong> can be in the
initial state tree at startup!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:person-or-place</span> [<span class="symbol">:person</span> <span class="integer">2</span>]
  <span class="symbol">:person</span> {<span class="integer">2</span> {<span class="symbol">:id</span> <span class="integer">2</span> <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you look at a proposed initial state, it will make the problem more clear:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defui Person
  static prim/InitialAppState
  (initial-state [c {<span class="symbol">:keys</span> [id <span class="keyword">name</span>]}] {<span class="symbol">:id</span> id <span class="symbol">:name</span> <span class="keyword">name</span> <span class="symbol">:type</span> <span class="symbol">:person</span>})
  <span class="keyword">..</span><span class="keyword">.</span>)

(defui PersonPlaceUnion
  static prim/InitialAppState
  (initial-state [c p] (prim/get-initial-state Person {<span class="symbol">:id</span> <span class="integer">1</span> <span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span>})) <span class="comment">; I can only put in one of them!</span>
  static prim/IQuery
  (query [this] {<span class="symbol">:person</span> (prim/get-query Person) <span class="symbol">:place</span> (prim/get-query Place)})
  <span class="keyword">..</span><span class="keyword">.</span>)

(defui Parent
  static prim/InitialAppState
  (initial-state [c p] {<span class="symbol">:person-or-place</span> (prim/get-initial-state PersonPlaceUnion)})
  static prim/IQuery
  (query [this] [{<span class="symbol">:person-or-place</span> (prim/get-query PersonPlaceUnion)}]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would result in a person in the initial state, but not a place.</p>
</div>
<div class="paragraph">
<p>Fulcro solves this at startup in the following manner: It pulls the query from root and walks it. If it finds
a union component, then <strong>for each branch</strong> it sees if that component (via the query metadata) has initial state. If
it does, it places it in the correct table in app state. This does <strong>not</strong>, of course, join it to anything in the graph
since it isn&#8217;t the "default branch" that was explicitly listed (in <code>PersonPlaceUnion</code>'s <code>InitialAppState</code>).</p>
</div>
<div class="paragraph">
<p>This behavior is critical when using unions to handle UI routing, which is in turn essential for good application
performance.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_initial_state_and_state_progressions"><a class="anchor" href="#_initial_state_and_state_progressions"></a><a class="link" href="#_initial_state_and_state_progressions">6.2. Initial State and State Progressions</a></h3>
<div class="paragraph">
<p>If you remember from the <a href="#PureRenderingDiagram">diagram</a> about pure rendering, then you&#8217;ll also note that this step
generates the <strong>first state</strong> in that progression. Rendering any state results in the UI for that state.</p>
</div>
<div class="paragraph">
<p>An interesting note is that this model also results in a really useful property: You can take the initial state,
run it though the implementation of one or more mutations, and end up with any other state. This means you can
easily reason about initializing your application into <strong>any</strong> state, which is useful for things like testing and server-side rendering.</p>
</div>
<div class="paragraph">
<p>There are all sorts of very useful features that fall out of this. For example, it is also possible to record a series
of "user interactions" (which can be recorded as a list of the mutations that ran) and replay those. This could be used
to send a tester a sequence of steps to show recent development work, run automated demos/tests, teleport your development
environment to a specific page, etc.</p>
</div>
<div class="paragraph">
<p>Writing tests against the state model and mutation implementations is a great way to <strong>unit test</strong> your application
without needing to involve the UI itself at all! You can read more about that in the section on
<a href="#VisualRegression">Visual Regression Testing</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_normalization_2"><a class="anchor" href="#_normalization_2"></a><a class="link" href="#_normalization_2">7. Normalization</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Normalization is a central mechanism in Fulcro. It is the means by which your data
trees (which you receive from component queries against servers) can be placed into
your normalized graph database.</p>
</div>
<div class="sect2">
<h3 id="_internals"><a class="anchor" href="#_internals"></a><a class="link" href="#_internals">7.1. Internals</a></h3>
<div class="paragraph">
<p>The function <code>prim/tree-&gt;db</code> is the workhorse that turns an incoming tree of data into normalized data (which can then
be merged into the overall database).</p>
</div>
<div class="paragraph">
<p>Imagine an incoming tree of data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:people</span> [ {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:person/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> <span class="keyword">..</span><span class="keyword">.</span>} {<span class="symbol">:db/id</span> <span class="integer">2</span> <span class="keyword">..</span><span class="keyword">.</span>} <span class="keyword">..</span><span class="keyword">.</span> ] }</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[{<span class="symbol">:people</span> (prim/get-query Person)}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>which expands to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[{<span class="symbol">:people</span> [<span class="symbol">:db/id</span> <span class="symbol">:person/name</span>]}]
          ^ metadata {<span class="symbol">:component</span> Person}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>tree-&gt;db</code> recursively walks the data structure and query:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At the root, it sees <code>:people</code> as a root key and property. It remembers it will be writing <code>:people</code> to the root.</p>
</li>
<li>
<p>It examines the value of <code>:people</code> and finds it to be a vector of maps. This indicates a to-one relationship.</p>
</li>
<li>
<p>It examines the metadata on the subquery of <code>:people</code> and discovers that the entries are represented by
the component <code>Person</code></p>
</li>
<li>
<p>For each map in the vector, it calls the <code>ident</code> function of <code>Person</code> (which it found in the metadata) to get a
database location. It then places the "person" values into the result via <code>assoc-in</code> on the ident.</p>
</li>
<li>
<p>It replaces the entries in the vector with the idents.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the metadata was missing then it would assume the person data did not need normalization. This is why it is
critical to compose queries correctly. The query and tree of data must have a parallel structure, as should the
UI. In template mode <code>defsc</code> will try to check some things for you, but you must ensure that you
compose the queries correctly.</p>
</div>
</div>
<div class="sect2">
<h3 id="Normalization"><a class="anchor" href="#Normalization"></a><a class="link" href="#Normalization">7.2. Normalization: Initial State, Server Interations, and Mutations</a></h3>
<div class="paragraph">
<p>The process described above is how most data interactions occur. At startup the <code>InitialAppState</code> supplies data that
exactly matches the tree of the UI. This gives your UI some initial state to render. The normalization mechanism
described above is exaclty what happens to that initial tree when it is detected by Fulcro at startup.</p>
</div>
<div class="paragraph">
<p>Network interactions send a UI-based query (which remember is annotated with the components). The query is
remembered and when a response tree of data is received (which must match the tree structure of the query), the
normalization process is applied and the resulting normalized data is merged with the database.</p>
</div>
<div class="paragraph">
<p>If using websockets, it is the same thing: A server push gives you a tree of data. You could hand-normalize that data,
but actually if you know the structure of the incoming data you can easily generate a client-side query (using
<code>defsc</code> or <code>defui</code>) that can be used in conjunction with <code>prim/tree-&gt;db</code> to normalize that incoming data.</p>
</div>
<div class="paragraph">
<p>Mutations can do the same thing. If a new instance of some entity is being generated by the UI as a tree of data, then
the query for that UI component can be used to turn it into normalized data that can be merged into the state
within the mutation.</p>
</div>
<div class="paragraph">
<p>Some useful functions to know about:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>prim/merge-component</code> - A utility function for merging new instances of a (possibly recursive) entity state into
the normalized database. Usable from within mutations.</p>
</li>
<li>
<p><code>prim/merge-state!</code> - A utility function for merging out-of-band (e.g. push notification) data into your application.
Includes ident integration options, and honors the Fulcro merge clobbering algorithm (if the query doesn&#8217;t ask for it,
then merge doesn&#8217;t affect it). Also queues rendering for affected components (derived from integration of idents). Generally
<strong>not</strong> used within mutations (use <code>merge-component</code> and <code>integrate-ident!</code> instead).</p>
</li>
<li>
<p><code>prim/tree-&gt;db</code> - General utility for normalizing data via a query and chunk of data.</p>
</li>
<li>
<p><code>prim/integrate-ident!</code> - A utility for adding an ident into existing to-one and to-many relations in your database.
Can be used within mutations.</p>
</li>
<li>
<p><code>fulcro.client.util/deep-merge</code> - An implementation of merge that is recursive</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="MutationsChapter"><a class="anchor" href="#MutationsChapter"></a><a class="link" href="#MutationsChapter">8. Handling Mutations</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#Mutations">Mutations</a> are triggered using <code>fulcro.client.primitives/transact!</code>. The meaning of this function is to
"run a sequence of operations that can have both local and remote side-effects". The
mutation expression itself is just data, and must be quoted since it uses plain
lists.</p>
</div>
<div class="paragraph">
<p>Mutations are known by their symbol and are dispatched to the internal multimethod
<code>fulcro.client.mutations/mutate</code>. To handle a mutation you can do two basic things: use <code>defmethod</code>
to add a mutation support, or use the macro <code>defmutation</code>. The macro is recommended for most cases
because it namespaces the mutation, prevents some common errors, and works better with IDEs.</p>
</div>
<div class="sect2">
<h3 id="_stages_of_mutation"><a class="anchor" href="#_stages_of_mutation"></a><a class="link" href="#_stages_of_mutation">8.1. Stages of Mutation</a></h3>
<div class="paragraph">
<p>There are multiple passes on a mutation: one local, and one for each possible remote. It is
technically the job of the mutation handler to return a lambda for the local pass, and a boolean (or AST)
for each remote. Returning <code>nil</code> from any pass means to not do anything for that concern.</p>
</div>
<div class="paragraph">
<p>For example, say you have three remotes: one for normal API, one that hits a REST API, and one for
file uploads. Each would have a name, and each pass of the mutation handling would be interested
in knowing what you&#8217;d like to do for the local or remote.</p>
</div>
<div class="paragraph">
<p>The mutation environment (<code>env</code> in the examples) contains a target that is set to a remote&#8217;s name when
the mutation is being asked for details about how to handle the mutation with respect to that remote.</p>
</div>
<div class="paragraph">
<p>For each pass the mutation is supposed to return a map whose key is <code>:action</code> or the name of the remote, and
whose value is the thing to do (a lambda for <code>:action</code>, and AST or true/false for remotes).</p>
</div>
<div class="paragraph">
<p>Summary:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You <code>transact!</code> somewhere in the UI</p>
</li>
<li>
<p>The internals call your mutation with <code>:target</code> set to nil in <code>env</code>. You return a map with an <code>:action</code> key
whose value is the function to run.</p>
</li>
<li>
<p>The internals call your mutation once for each remote, with <code>:target</code> set. You return a map with
that remote&#8217;s keyword as the key, and either a boolean or AST as the remote action. (true means send the
AST for the expression sent in (1) to the remote)</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_multimethod_directly"><a class="anchor" href="#_using_the_multimethod_directly"></a><a class="link" href="#_using_the_multimethod_directly">8.2. Using the Multimethod Directly</a></h3>
<div class="paragraph">
<p>Typically the multipass nature is ignored by the mutation itself, and it just returns a map
containing all of the possible things that should be done. This looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defmethod</span> <span class="function">fulcro.client.mutations/mutate</span> `mutation-symbol [{<span class="symbol">:keys</span> [state ast target] <span class="symbol">:as</span> env} k params]
   {<span class="symbol">:action</span> (<span class="keyword">fn</span> [] <span class="keyword">..</span><span class="keyword">.</span>)
    <span class="symbol">:rest-api</span> <span class="predefined-constant">true</span> <span class="comment">; trigger this remotely on the rest API AND the normal one.</span>
    <span class="symbol">:remote</span> <span class="predefined-constant">true</span> })</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the action is just data, it doesn&#8217;t matter that we "generate" it for the multiple passes. Same for
the remotes. Note that the example above uses syntax quoting on the symbol, which will add the current
namespace to it. In any case, the symbol is just that: a symbol (data) that acts as the dispatch
key for the multimethod. If you use a plain quote (<code>'</code>) then you should still namespace the symbol.</p>
</div>
<div class="paragraph">
<p>Some common possible mistakes are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You side-effect. Since your mutation will be called at least two times, this is a bad idea.</p>
</li>
<li>
<p>You assume that the remote expression "sees" the old state (e.g. you might build an AST based on
what is in app state). The local action is usually run before the remote passes, meaning that state has already changed.</p>
</li>
<li>
<p>You could forget to return a map with the correct keys (usually if you made mistake 1).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There is no guaranteed order to evaluation. Therefore if you need a value from state as it was seen
when the mutation was triggered: send it as a parameter to the mutation. That way the call has closed
over the old value.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_code_defmutation_code"><a class="anchor" href="#_using_code_defmutation_code"></a><a class="link" href="#_using_code_defmutation_code">8.3. Using <code>defmutation</code></a></h3>
<div class="paragraph">
<p><code>defmutation</code> is a macro that writes the multimethod for you. It looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation mutation-symbol
  <span class="string"><span class="delimiter">&quot;</span><span class="content">docstring</span><span class="delimiter">&quot;</span></span>
  [params]
  (action [{<span class="symbol">:keys</span> [state] <span class="symbol">:as</span> env}]
    (<span class="keyword">swap!</span> state <span class="keyword">..</span><span class="keyword">.</span>))
  (rest-api [env] <span class="predefined-constant">true</span>)
  (remote [env] <span class="predefined-constant">true</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Thus it ends up looking more like a function definition. IDE&#8217;s like Cursive can be told how to resolve
the macro (as <code>defn</code> in this case) and will then let you read the docstrings and navigate from the
use in transact. This makes development a lot easier.</p>
</div>
<div class="paragraph">
<p>Another advantage is that the symbol is placed into the namespace in which it is declared (not interned,
just given the namespace&#8230;&#8203;it is still just symbol data). Syntax quoting can expand these, which means
you get a very nice tool experience at usage site:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app</span>
  (<span class="symbol">:require</span> [app.mutations <span class="symbol">:as</span> am]))

<span class="keyword">..</span><span class="keyword">.</span>
   (prim/transact! this `[(am/mutation-symbol {})]) <span class="comment">; am gets expanded to app.mutations</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The final advantage is it is harder to accidentally side-effect. The <code>action</code> section of <code>defmutation</code>
will wrap the logic in a lambda, meaning that it can read as-if you&#8217;re side-effecting, but in fact
will do the right thing.</p>
</div>
<div class="paragraph">
<p>In general these advantages mean you should generally use the macro to define mutations, but it is good
to be aware that underneath is just a multimethod.</p>
</div>
</div>
<div class="sect2">
<h3 id="_recommendations_about_writing_mutations"><a class="anchor" href="#_recommendations_about_writing_mutations"></a><a class="link" href="#_recommendations_about_writing_mutations">8.4. Recommendations About Writing Mutations</a></h3>
<div class="paragraph">
<p>Mutations really are aimed at being functions on your application state. Components have nice clean abstractions,
and you will often benefit from writing low-level functions that represent the general operations on a component. As
you move towards higher-level abstractions you&#8217;ll want to compose those lower-level functions. As such, it pays
to think a little about how this will look over time.</p>
</div>
<div class="paragraph">
<p>If you write the <strong>actual logic</strong> of a mutation into a <code>defmutation</code>, then composition is difficult because the
model does not encourage recursive calls to <code>transact!</code>. This will either lead to code duplication or other bad
practices.</p>
</div>
<div class="paragraph">
<p>To maximize code reuse, local reasoning, and general readability it pays to think about your mutations in the following manner:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A mutation is a function that changes the state of the application: <code>state -&gt; mutation -&gt; state'</code></p>
</li>
<li>
<p>Within a mutation, you are essentially doing operations to a graph, which means you have operations that
work on some node in the graph: <code>node -&gt; op -&gt; node'</code>. These operations may modifiy a scalar or an edge to another node.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_node_specific_mutation"><a class="anchor" href="#_node_specific_mutation"></a><a class="link" href="#_node_specific_mutation">8.4.1. Node-Specific Mutation</a></h4>
<div class="paragraph">
<p>You can run a node-specific operation with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">swap!</span> state <span class="keyword">update-in</span> node-ident op args)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, say you want to implement a mutation that adds a person to another person&#8217;s friend list. The data
representation of a person is: <code>{:db/id 1 :person/name "Nancy" :person/friends []}</code>.</p>
</div>
<div class="paragraph">
<p>The <code>ident</code> function can be coded into a top-level function and used by the <code>defui</code> and a person-centric function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">person-ident</span> [id-or-props]
  (<span class="keyword">if</span> (<span class="keyword">map?</span> id-or-props)
    (person-ident (<span class="symbol">:db/id</span> id-or-props))
    [<span class="symbol">:person/by-id</span> id-or-props]))

(defui Person
  static prim/Ident
  (ident [this props] (person-ident props))
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>and our desired operation on the general state of a person can also be written as a simple function (add an ident
to the :person/friends field):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">add-friend-impl</span>
   [person target-person-id]
   (update person <span class="symbol">:person/friends</span> (fnil <span class="keyword">conj</span> []) (person-ident target-person-id)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note, in particular, that we always choose to put the item to be updated as the first argument so that functions
like <code>update</code> are easier to use with it.</p>
</div>
<div class="paragraph">
<p>Now <code>(add-friend-impl {:db/id 1 :person/name "Nancy"} 33)</code> results in
<code>{:db/id 1, :person/name "Nancy", :person/friends [[:person/by-id 33]]}</code>.</p>
</div>
<div class="paragraph">
<p>You can write a mutation to support this operation within Fulcro:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation add-friend [{<span class="symbol">:keys</span> [source-person-id target-id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state <span class="keyword">update-in</span> (person-ident source-person-id)
      add-friend-impl target-id)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>You could even take it a step further with a little more sugar by defining a helper that can turn a node-specific
op into a db-level operation (again note that the thing being updated is the first argument):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">update-person</span> [state-map person-id person-fn &amp; args]
  (<span class="keyword">apply</span> <span class="keyword">update-in</span> state-map (person-ident person-id) person-fn args))

(defmutation add-friend [{<span class="symbol">:keys</span> [source-person-id target-id]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state update-person source-person-id add-friend-impl target-id)))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_composition_in_mutations"><a class="anchor" href="#_composition_in_mutations"></a><a class="link" href="#_composition_in_mutations">8.4.2. Composition in Mutations</a></h4>
<div class="paragraph">
<p>Once you have your general operations written as basic functions on either the entire state (like <code>update-person</code>) or
targeted to nodes (like <code>add-friend-impl</code>), then it becomes much easier to create mutations that compose together the
necessary graph database operations to accomplish any higher-level task.</p>
</div>
<div class="paragraph">
<p>For example, the <code>fulcro.client.routing/update-routing-links</code> function takes a state map, and changes all of the routers
in the application state to show that particular screen. So, say you wanted add-friend to also
take you to the screen that shows the details of that particular person. The top-level abstract mutation in the UI
might still be called <code>add-friend</code>, but the internals now two things to do.</p>
</div>
<div class="paragraph">
<p>Having all of these functions on the graph database allows you to write this in a very nice form as
a sequence of operations on the state map itself through threading:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation add-friend
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Locally add a friend, and show them. Full stack operation.
  [{:keys [source-id target-id]}]
  (action [{:keys [state]}]
    (swap! state
      (fn [s]
        (-&gt; s
          (r/update-routing-links {:handler :show-friend :route-params {:person-id target-id}})
          (update-person source-id add-friend-impl target-id)))))
  (remote [env] true)</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and your mutations become a thing of beauty!</p>
</div>
<div class="paragraph">
<p>Of course, this can also be overkill. It is true that it is often handy to be able to compose many db operations together
into one abstract mutation, but don&#8217;t forget that more that one mutation can be triggered by a single call
to <code>transact!</code>. You&#8217;ll want to balance your mutations just like you do any other library of code: so that
reuse and clarity are maximized.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(prim/transact! this `[(route-to {<span class="symbol">:handler</span> <span class="symbol">:show-friend</span> <span class="symbol">:route-params</span> {<span class="symbol">:person-id</span> ~target-id}})
                     (add-friend {<span class="symbol">:source-person-id</span> ~my-id <span class="symbol">:target-id</span> ~target-id})])</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mutation_helpers"><a class="anchor" href="#_mutation_helpers"></a><a class="link" href="#_mutation_helpers">8.4.3. Mutation Helpers</a></h4>
<div class="paragraph">
<p>As a reminder: the section on <a href="#Normalization">normalization</a> mentioned a number of helper functions that are useful
when working on the graph database. Some of these can be very handy within mutation implementations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_remote_mutations"><a class="anchor" href="#_remote_mutations"></a><a class="link" href="#_remote_mutations">8.5. Remote Mutations</a></h3>
<div class="paragraph">
<p>Fulcro comes with a default remote, named <code>:remote</code>, that by default talks to the origin server at <code>/api</code>. All of this
is configurable when you create your fulcro client application. In fact, any number of remotes can be created and
installed on your client, each with a unique name. See the section on <a href="#Networking">networking</a> for more details on
adding remotes to your client.</p>
</div>
<div class="paragraph">
<p>Mutations are already plain data, so Fulcro can pass them over the network as-is when the client invokes them. All you
need to do to indicate that a given mutation should affect a given remote is add that remote to the mutation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation add-friend [params]
  (action <span class="keyword">..</span><span class="keyword">.</span>) <span class="comment">; optimistic update of client state</span>
  (remote [env] <span class="predefined-constant">true</span>)) <span class="comment">; send the mutation to the remote known as :remote</span>

<span class="comment">; or using the multimethod directly:</span>
(<span class="keyword">defmethod</span> <span class="function">m/mutate</span> `add-friend [env k params]
  {<span class="symbol">:action</span> (<span class="keyword">fn</span> [] <span class="keyword">..</span><span class="keyword">.</span>)
   <span class="symbol">:remote</span> <span class="predefined-constant">true</span>})</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_altering_the_mutation"><a class="anchor" href="#_altering_the_mutation"></a><a class="link" href="#_altering_the_mutation">8.5.1. Altering the Mutation</a></h4>
<div class="paragraph">
<p>It is sometimes desirable to alter the mutation that came from the UI before sending it to the remote. For example,
you might want to add a parameter like a global security token so that you don&#8217;t have to worry about security at the
UI <code>transact!</code>.</p>
</div>
<div class="paragraph">
<p>The <code>env</code> passed to the mutation contains an <code>ast</code>. This is the abstract syntax tree of the mutation (e.g. the symbol
name and params). You may return this instead of <code>true</code> from the remote side of the mutation, and Fulcro will
send the specific representation of that AST on the network. This means if you change the AST, you&#8217;ll change
what the remote sees.</p>
</div>
<div class="paragraph">
<p>So, for example, to add an api-token to the parameters, you would do something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation add-friend [params]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>)
  (remote [{<span class="symbol">:keys</span> [ast]}]
    (update ast <span class="symbol">:params</span> <span class="keyword">assoc</span> <span class="symbol">:api-token</span> @global-api-token)))</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The <code>state</code> is available in <code>remote</code>, but the <code>action</code> will run first. This means that you should not
expect the "old" values in state when computing anything for the remote because the optimistic
update of the <code>action</code> will have already been applied! If you need to rely on data as it existed at the time of
<code>transact!</code> then you <strong>must</strong> pass it as a <strong>parameter</strong> to the mutation so that the original data is closed over for the
duration of the mutation processing.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_mutations_that_trigger_one_or_more_loads"><a class="anchor" href="#_mutations_that_trigger_one_or_more_loads"></a><a class="link" href="#_mutations_that_trigger_one_or_more_loads">8.5.2. Mutations that Trigger one or more Loads</a></h4>
<div class="paragraph">
<p>Mutations generally need not expose their full-stack nature to the UI. For
example a <code>next-page</code> mutation might trigger a load for the next page of
data or simply swap in some already cached data. The UI need not be
aware of the logic of this distinction (though typically the UI will
want to include loading markers, so it is common for there to be some
kind of knowledge about lazy loading).</p>
</div>
<div class="paragraph">
<p>Instead of coding complex "do I need to load that?" logic in the UI
(where it most certainly does <strong>not</strong> belong) one should instead write
mutations that abstract it into a nice concept.</p>
</div>
<div class="paragraph">
<p>Fulcro handles loads by placing load markers into a special place in the
application database. Whenever a remote operation is triggered, the
networking layer will check this queue and process it.</p>
</div>
<div class="paragraph">
<p>The <code>fulcro.client.data-detch/load</code> function simply runs a <code>transact!</code>
that does both (adds the load to the queue and triggers remote processing).</p>
</div>
<div class="paragraph">
<p>If you&#8217;d like to compose one or more loads into a mutation, there are helper
functions that will help you do just that: <code>df/load-action</code> and <code>df/remote-load</code>.</p>
</div>
<div class="paragraph">
<p>The basic pattern is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation next-page [params]
  (action [{<span class="symbol">:keys</span> [state] <span class="symbol">:as</span> env}]
    (<span class="keyword">swap!</span> state <span class="keyword">..</span><span class="keyword">.</span>) <span class="comment">; local optimistic db updates</span>
    (df/load-action env <span class="symbol">:prop</span> Component {<span class="symbol">:remote</span> <span class="symbol">:remote</span>}) <span class="comment">; same basic args as `load`, except state atom instead of `this`</span>
    (df/load-action env <span class="symbol">:other</span> Other) {<span class="symbol">:remote</span> <span class="symbol">:other-remote</span>}) <span class="comment">; as many as you need...</span>
  (remote [env]
    (df/remote-load env))) <span class="comment">; notifies back-end that there is some loading to do</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The <code>remote-load</code> call need only be done for <strong>any one</strong> of the remotes you&#8217;re talking to. It merely tells the
back-end code to process remote requests (which will hit all remote queues). Thus, the parameters to the <code>load-action</code>
calls are where you actually specify which remote a given load should actually talk to.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_full_stack_operation"><a class="anchor" href="#_full_stack_operation"></a><a class="link" href="#_full_stack_operation">9. Full Stack Operation</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_server_interaction_general_operation"><a class="anchor" href="#_server_interaction_general_operation"></a><a class="link" href="#_server_interaction_general_operation">9.1. Server interaction - General Operation</a></h3>
<div class="paragraph">
<p>One of the most interesting and powerful things about Fulcro is that the model for server interaction is unified into
a clean data-driven structure. At first the new concepts can be challenging, but once you&#8217;ve seen the core primitive
(component-based queries/idents for normalization) we think you&#8217;ll find that it dramatically simplifies everything!</p>
</div>
<div class="paragraph">
<p>In fact, now that you&#8217;ve completed the materials of this guide on the graph database, queries, idents, and
normalization, it turns out that the server interactions become nearly trivial!</p>
</div>
<div class="paragraph">
<p>Not only is the <strong>structure</strong> of server interaction well-defined, Fulcro come with two pre-written server-side code bases
that handle all of the Fulcro plumbing for you. You can choose to provide as little or as much as you like. The easy
server code provides everything in a Ring-based stack, and the modular style of server code provides something you can
plug into just about anything (though it assumes it can behave a bit like Ring).</p>
</div>
<div class="paragraph">
<p>Even then, there are a lot of possible pitfalls when writing distributed applications. People often underestimate just how hard
it is to get web applications right because they forget that.</p>
</div>
<div class="paragraph">
<p>So, while the <strong>API and mechanics</strong> of how you write Fulcro server interactions are as simple as possible there is no getting
around that there are some hairy things to navigate in distributed apps independent of your choice of tools.
Fulcro tries to make these things apparent, and it also tries hard to make sure you&#8217;re able to get it right without
pulling out your hair.</p>
</div>
<div class="paragraph">
<p>Here are some of the basics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Networking is provided.</p>
<div class="ulist">
<ul>
<li>
<p>The protocol is EDN on the wire (via transit), which means you just speak clojure data on the wire, and can
easily extend it to encode/decode new types.</p>
</li>
</ul>
</div>
</li>
<li>
<p>All network requests (queries and mutations) are processed sequentially unless you specify otherwise. This allows you
to reason about optimistic updates (Starting more than one at a time via async calls could
lead to out-of-order execution, and impossible-to-reason-about recovery from errors).</p>
</li>
<li>
<p>You may provide fallbacks that indicate error-handling mutations to run on failures.</p>
</li>
<li>
<p>Writes and reads that are enqueued together will always be performed in write-first order. This ensures that remote reads are
as current as possible.</p>
</li>
<li>
<p>Any <code>:ui/</code> namespaced query elements are automatically elided when generating a query from the UI to a server, allowing you
to easily mix UI concerns with server concerns in your component queries.</p>
</li>
<li>
<p>Normalization of a remote query result is automatic.</p>
</li>
<li>
<p>Deep merge of query results uses intelligent overwrite for properties that are already present in the client database
(described in a section on Deep Merge).</p>
</li>
<li>
<p>Any number of remotes can be defined (allowing you to easily integrate with microservices)</p>
</li>
<li>
<p>Protocol and communication is strictly constrained to the networking layer and away from your application&#8217;s core structure,
meaning you can actually speak whatever and however you want to a remote. In fact
the concept of a remote is just \"something you can talk to via queries and mutations\".
You can easily define a \"remote\" that reads and writes browser
local storage or a Datascript database in the browser. This is an extremely powerful generalization for isolating
side-effect code from your UI.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_general_theory_of_operation"><a class="anchor" href="#_general_theory_of_operation"></a><a class="link" href="#_general_theory_of_operation">9.2. General Theory of Operation</a></h3>
<div class="paragraph">
<p>There are only a few general kinds of interactions with a server:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Initial loads when the application starts</p>
</li>
<li>
<p>Incremental loads of sub-graphs of something that was previously loaded.</p>
</li>
<li>
<p>Event-based loads (e.g. user or timed events)</p>
</li>
<li>
<p>Integrating data from other external sources (e.g. server push)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In standard Fulcro networking, <strong>all</strong> of the above have the following similarities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A component-based graph query needs to be involved (to enable auto-normalization). Even the server push (though in that case the client needs to know what <strong>implied</strong> question the server is sending data about.</p>
</li>
<li>
<p>The data from the server will be a tree that has the same shape as the query.</p>
</li>
<li>
<p>The data needs to be normalized into the client database.</p>
</li>
<li>
<p>Optionally: after integrating new data there may be some need to transform the result to a form the UI needs
(e.g. perhaps you need to sort or paginate some list of items that came in).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>IMPORTANT</strong>: Remember what you learned about the graph database, queries, and idents. This section cannot possibly be understood
properly if you do not understand those topics!</p>
</div>
<div class="sect3">
<h4 id="_integration_of_strong_all_strong_new_external_data_is_just_a_query_based_merge"><a class="anchor" href="#_integration_of_strong_all_strong_new_external_data_is_just_a_query_based_merge"></a><a class="link" href="#_integration_of_strong_all_strong_new_external_data_is_just_a_query_based_merge">9.2.1. Integration of <strong>ALL</strong> new external data is just a Query-Based Merge</a></h4>
<div class="paragraph">
<p>So, here is the secret: When external data needs to go into your database, it all uses the exact same mechanism: a
query-based merge. So, for a simple load, you send a UI-based query to the server, the server responds with a tree
of data that matches that graph query, and then the query itself (which is annotated with the components and ident functions)
can be used to normalize the result. Finally, the normalized result can be merged into your existing client database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Query --&gt; Server --&gt; Response + Original Query w/Idents --&gt; Normalized Data --&gt; Database Merge --&gt; New Database</pre>
</div>
</div>
<div class="paragraph">
<p>Any other kind of extern data integration just starts at the \"Response\" step by manually providing the query that
is annotated with components/idents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>New External Data + Query w/Idents --&gt; Normalized Data --&gt; Database Merge --&gt; New Database</pre>
</div>
</div>
<div class="paragraph">
<p>There is a primitive function <code>merge!</code> function that implements this, so that you can simplify the picture to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Tree of Data + Query --&gt; merge! --&gt; New Database</pre>
</div>
</div>
<div class="paragraph">
<p>When you interact with a server through the data fetch API, remember that it is essentially doing a server interaction
(send the query to get the response), but everything that happens after that is pretty much just <code>merge!</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_central_functions_code_transact_code_and_code_merge_code"><a class="anchor" href="#_the_central_functions_code_transact_code_and_code_merge_code"></a><a class="link" href="#_the_central_functions_code_transact_code_and_code_merge_code">9.3. The Central Functions : <code>transact!</code> and <code>merge!</code></a></h3>
<div class="paragraph">
<p>When you start a Fulcro application your start-callback will get the completed <code>app</code> as a parameter.</p>
</div>
<div class="paragraph">
<p>Inside of this app is a <code>reconciler</code>. The <code>reconciler</code> is a central component in the system, particularly with
respect to remote interaction. It is the component that is responsible for managing the query engine, the remote
networking, data merge, etc.</p>
</div>
<div class="paragraph">
<p>There are some core central functions you should be well aware of, because they can be used from anywhere if used
with the <code>reconciler</code>. It is therefore often also useful to make sure your <code>app</code> or <code>reconciler</code> are stored in
a more global location where you can access them from outside of the application if you should need to.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>prim/transact!</code> : The central function for running abstract changes in the application. Can be run with a component
or reconciler. If run with the reconciler, will typically cause a root re-render.</p>
</li>
<li>
<p><code>prim/merge!</code> : A function that can be run against the reconciler to merge a tree of data via a UI query. This is
the primary function that is used to integrate data in response to things like websocket server push.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_augmenting_the_ring_response"><a class="anchor" href="#_augmenting_the_ring_response"></a><a class="link" href="#_augmenting_the_ring_response">9.4. Augmenting the Ring Response</a></h3>
<div class="paragraph">
<p>In the following sections we&#8217;ll be showing you how to respond to queries and mutations. The Ring stack is supplied for
you in the server, but there are times when you need to modify something about the low-level response itself (such
as adding a cookie).</p>
</div>
<div class="paragraph">
<p>Any of the techniques you read about in the coming sections all allow you to wrap your response as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(fulcro.server/augment-response your-response (<span class="keyword">fn</span> [ring-response] ring-response'))</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, if you were using Ring and Ring Session, you could cause a session cookie to be generated, and user
information to be stored in a server session store simply by returning this from a query on user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(server/augment-response user (<span class="keyword">fn</span> [resp] (<span class="keyword">assoc-in</span> resp [<span class="symbol">:session</span> <span class="symbol">:uid</span>] real-uid)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll mention this again when you need to be reminded in an upcoming section.</p>
</div>
<div class="paragraph">
<p>The easy server is a fairly minimal server implementation that includes a simple Ring stack, component support,
API query/mutation injections of server components, and resource and alternate route handling. It allows you to
get going quickly, and is extensible; however, it is not as flexible as the modular server construction.</p>
</div>
<div class="paragraph">
<p>In general if all you&#8217;re using is a few components and the API, then the easy server is a great choice for getting
started.</p>
</div>
<div class="paragraph">
<p>If you have more interesting requirements, then you may want to explore composing Fulcro&#8217;s back-end into your server
with the modular components.</p>
</div>
</div>
<div class="sect2">
<h3 id="_easy_server"><a class="anchor" href="#_easy_server"></a><a class="link" href="#_easy_server">9.5. Easy Server</a></h3>
<div class="paragraph">
<p>The pre-built easy server component for Fulcro uses Stuart Sierra&#8217;s Component library. The server has no
global state except for a debugging atom that holds the entire system, and can therefore be easily restarted
with a code refresh to avoid costly restarts of the JVM. It actually takes very little code to get one going:
A couple of config files, and a couple of short clj files.</p>
</div>
<div class="paragraph">
<p>You should have a firm understanding of [Stuart&#8217;s component library](<a href="https://github.com/stuartsierra/component" class="bare">https://github.com/stuartsierra/component</a>), since
we won&#8217;t be covering that in detail here.</p>
</div>
<div class="sect3">
<h4 id="_constructing_a_base_server"><a class="anchor" href="#_constructing_a_base_server"></a><a class="link" href="#_constructing_a_base_server">9.5.1. Constructing a base server</a></h4>
<div class="paragraph">
<p>The base server is trivial to create:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">app.system</span>
  (<span class="symbol">:require</span>
    [fulcro.easy-server <span class="symbol">:as</span> server]
    [app.api <span class="symbol">:as</span> api]
    [fulcro.server <span class="symbol">:as</span> prim]))

(<span class="keyword">defn</span> <span class="function">make-system</span> []
  (server/make-fulcro-server
    <span class="comment">; where you want to store your override config file</span>
    <span class="symbol">:config-path</span> <span class="char">\&quot;</span>/usr/local/etc/app.edn<span class="char">\&quot;</span>

    <span class="comment">; The keyword names of any components you want auto-injected into the query/mutation processing parser env (e.g. databases)</span>
    <span class="symbol">:parser-injections</span> #{}

    <span class="comment">; Additional components you want added to the server</span>
    <span class="symbol">:components</span> {}))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_the_server"><a class="anchor" href="#_configuring_the_server"></a><a class="link" href="#_configuring_the_server">9.5.2. Configuring the server</a></h4>
<div class="paragraph">
<p>Server configuration requires two EDN files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>resources/config/defaults.edn</code>: This file should contain a single EDN map that contains
defaults for everything that the application wants to configure.</p>
</li>
<li>
<p><code>/abs/path/of/choice</code>: This file can be named what you want (you supply the name when
making the server). It can also contain an empty map, but is meant to be machine-local
overrides of the configuration in the defaults. This file is required. We chose to do this because
it keeps people from starting the app in an unconfigured production environment.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">make-system</span> []
  (server/make-fulcro-server
    <span class="symbol">:config-path</span> <span class="char">\&quot;</span>/usr/local/etc/app.edn<span class="char">\&quot;</span>
    <span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The only parameter that the default server looks for is the network port to listen on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:port</span> <span class="integer">3000</span> }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_reloading_server_code"><a class="anchor" href="#_reloading_server_code"></a><a class="link" href="#_reloading_server_code">9.5.3. Reloading Server Code</a></h4>
<div class="paragraph">
<p>When working with server code you&#8217;d like to be able to start and stop/reload/start the server to make changes to
your code available. We typically put these together in the <code>user</code> namespace under a <code>dev</code> source folder. Something
like this works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">user</span>
  (<span class="symbol">:require</span>
    [clojure.tools.namespace.repl <span class="symbol">:as</span> tools-ns <span class="symbol">:refer</span> [disable-reload! refresh clear set-refresh-dirs]]
    [my-server <span class="symbol">:as</span> svr]
    [com.stuartsierra.component <span class="symbol">:as</span> component]))

<span class="comment">; Make sure the cljs output folder is NOT on the refresh dirs list, or you'll get screwy results</span>
(set-refresh-dirs <span class="char">\&quot;</span>src/main<span class="char">\&quot;</span> <span class="char">\&quot;</span>src/test<span class="char">\&quot;</span> <span class="char">\&quot;</span>src/dev<span class="char">\&quot;</span>)

<span class="comment">; An atom to hold onto the running server component</span>
(<span class="keyword">defonce</span> <span class="function">server</span> (<span class="keyword">atom</span> <span class="predefined-constant">nil</span>))

(<span class="keyword">defn</span> <span class="function">stop</span> <span class="char">\&quot;</span>Stop the running web server.<span class="char">\&quot;</span> []
  (<span class="keyword">when</span> @server
    (<span class="keyword">swap!</span> server component/stop)
    (<span class="keyword">reset!</span> server <span class="predefined-constant">nil</span>)))

(<span class="keyword">defn</span> <span class="function">go</span> <span class="char">\&quot;</span>Load the overall web server system <span class="keyword">and</span> start it.<span class="char">\&quot;</span> []
  (<span class="keyword">reset!</span> server (svr/make-system))
  (<span class="keyword">swap!</span> server component/start))

(<span class="keyword">defn</span> <span class="function">restart</span>
  <span class="char">\&quot;</span>Stop the web server, refresh all <span class="keyword">namespace</span> source code from disk, then restart the web server.<span class="char">\&quot;</span>
  []
  (stop)
  (refresh <span class="symbol">:after</span> 'user/run-demo-server))</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should now be able to start a Clojure REPL, and within the user namespace run things like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>user=&gt; (go) ; start from stopped state
user=&gt; (restart) ; should reload code and restart web server
user=&gt; (tools-ns/refresh) ; IFF restart fails to start, followed by (go) again</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_data_fetch_api_code_load_code"><a class="anchor" href="#_the_data_fetch_api_code_load_code"></a><a class="link" href="#_the_data_fetch_api_code_load_code">9.6. The Data Fetch API: <code>load</code></a></h3>
<div class="paragraph">
<p>Let&#8217;s say we want to load all of our friends from the server. A query has to be rooted somewhere, so we&#8217;ll invent
a root-level keyword, <code>:all-friends</code>, and join it to the UI query for a <code>Person</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[{<span class="symbol">:all-friends</span> (prim/get-query Person)}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>What we&#8217;d like to see then from the server is a return value with the shape of the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:all-frields</span> [ {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="keyword">..</span><span class="keyword">.</span>} {<span class="symbol">:db/id</span> <span class="integer">2</span> <span class="keyword">..</span><span class="keyword">.</span>} <span class="keyword">..</span><span class="keyword">.</span>] }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we combine that query with that tree result and were to manually call <code>merge!</code> we&#8217;d end up with this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:all-frields</span> [ [<span class="symbol">:person/by-id</span> <span class="integer">1</span>] [<span class="symbol">:person/by-id</span> <span class="integer">2</span>] <span class="keyword">..</span><span class="keyword">.</span>]
  <span class="symbol">:person/by-id</span> { <span class="integer">1</span> { <span class="symbol">:db/id</span> <span class="integer">1</span> <span class="keyword">..</span><span class="keyword">.</span>}
                  <span class="integer">2</span> { <span class="symbol">:db/id</span> <span class="integer">2</span> <span class="keyword">..</span><span class="keyword">.</span>}
                  <span class="keyword">..</span><span class="keyword">.</span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The data fetch API has a simple function for this that will do all of these together (query derivation, server
interaction, and merge):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my-thing</span>
  (<span class="symbol">:require</span> [fulcro.client.data-fetch <span class="symbol">:as</span> df]))

<span class="keyword">..</span><span class="keyword">.</span>

  (df/load comp-reconciler-or-app <span class="symbol">:all-friends</span> Person)</code></pre>
</div>
</div>
<div class="paragraph">
<p>An important thing to notice is that <code>load</code> can be thought of as a function that loads normalized data into the
root node of your graph (<code>:all-friends</code> appears in your root node).</p>
</div>
<div class="paragraph">
<p>This is sometimes what you want, but more often you really want data loaded at some other spot in your graph. We&#8217;ll
talk about this more in a moment, first, let&#8217;s see how to handle that on the server.</p>
</div>
<div class="sect3">
<h4 id="_handling_a_root_query"><a class="anchor" href="#_handling_a_root_query"></a><a class="link" href="#_handling_a_root_query">9.6.1. Handling a Root Query</a></h4>
<div class="paragraph">
<p>If you&#8217;re using the standard server support of Fulcro, then the API hooks are already predefined for you, and you
can use helper macros to generate handlers for queries. If your <code>load</code> specified a keyword, then this is seen by
the server as a load targeted to your root node. Thus, the server macro is called <code>defquery-root</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">api</span>
(<span class="symbol">:require</span> [fulcro.server <span class="symbol">:refer</span> [defquery-root defquery-entity defmutation]]))

(defquery-root <span class="symbol">:all-friends</span>
   <span class="char">\&quot;</span>optional docstring<span class="char">\&quot;</span>
   (value [env params]
      [{<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:person/name</span> <span class="keyword">..</span><span class="keyword">..</span>} {<span class="symbol">:db/id</span> <span class="integer">2</span> <span class="keyword">..</span><span class="keyword">.</span>} <span class="keyword">..</span><span class="keyword">.</span>]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s as simple as that! Write a function that returns the correct value for the query. The query itself will be available
in the <code>env</code>, and you can use libraries like <code>pathom</code>, <code>Datomic</code>, and <code>fulcro-sql</code> to parse those queries into the proper tree
result from various data sources.</p>
</div>
</div>
<div class="sect3">
<h4 id="_entity_queries"><a class="anchor" href="#_entity_queries"></a><a class="link" href="#_entity_queries">9.6.2. Entity Queries</a></h4>
<div class="paragraph">
<p>You can also ask to load a specific entity. You do this simply by telling load the ident of the thing you&#8217;d like to
load:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">load</span> this [<span class="symbol">:person/by-id</span> <span class="integer">22</span>] Person)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Such a load will send a query to the server that is a join on that ident. The helper macro to handle those
is <code>defquery-entity</code>, and is dispatched by the table name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defquery-entity <span class="symbol">:person/by-id</span>
   <span class="char">\&quot;</span>optional docstring<span class="char">\&quot;</span>
   (value [env id params]
      {<span class="symbol">:db/id</span> id <span class="keyword">..</span><span class="keyword">.</span>}))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this call gets an <code>id</code> in addition to parameters (in the above call, <code>id</code> would be 22). Again, the full query
is in <code>env</code> so you can process the data driven response properly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_targeting_loads"><a class="anchor" href="#_targeting_loads"></a><a class="link" href="#_targeting_loads">9.6.3. Targeting Loads</a></h4>
<div class="paragraph">
<p>A short while ago we noted that loads are targeted at the root of your graph, and that this wasn&#8217;t always what you
wanted. After all, your graph database will always have other UI stuff. For example there might be a current screen, which
might point to a friends screen, which in turn is where you want to load that list of friends:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:current-screen</span> [<span class="symbol">:screens/by-type</span> <span class="symbol">:friends</span>]
  <span class="keyword">..</span><span class="keyword">.</span>
  <span class="symbol">:screens/by-type</span> { <span class="symbol">:friends</span> { <span class="symbol">:friends/list</span> [] <span class="keyword">..</span><span class="keyword">.</span> }}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;ve followed our earlier recommendations, then your applications UI is normalized as well, and any given
spot in your graph is really just an entry in a top-level table. Thus, the path to the desired location
of our friends is usually just 3 deep. In this case: <code>[:screens/by-type :friends :friends/list]</code>.</p>
</div>
<div class="paragraph">
<p>If we were to merge the earlier load into that database we could get what we want by just moving graph edges (where
a to-one edge is an ident, and a to-many edge is a vector of idents):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{ <span class="symbol">:all-frields</span> [ [<span class="symbol">:person/by-id</span> <span class="integer">1</span>] [<span class="symbol">:person/by-id</span> <span class="integer">2</span>] <span class="keyword">..</span><span class="keyword">.</span>]  <span class="comment">; (1) MOVE this to (2)</span>
  <span class="symbol">:person/by-id</span> { <span class="integer">1</span> { <span class="symbol">:db/id</span> <span class="integer">1</span> <span class="keyword">..</span><span class="keyword">.</span>}
                  <span class="integer">2</span> { <span class="symbol">:db/id</span> <span class="integer">2</span> <span class="keyword">..</span><span class="keyword">.</span>}
  <span class="symbol">:current-screen</span> [<span class="symbol">:screens/by-type</span> <span class="symbol">:friends</span>]
  <span class="symbol">:screens/by-type</span> { <span class="symbol">:friends</span> { <span class="symbol">:friends/list</span> [] <span class="keyword">..</span><span class="keyword">.</span> }}} <span class="comment">; (2) where friends *should* be</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the graph database is just nodes and edges, there really aren&#8217;t many more operations to worry about!
You&#8217;ve essentially got to <strong>normalize a tree</strong>, <strong>merge normalized data</strong>, and <strong>move graph edges</strong>.</p>
</div>
<div class="paragraph">
<p>The load API supports several kinds of graph edge targeting to allow you to put data where you want it in your
graph. NOTE: Technically data is always loaded into the root, then relocated. So, be careful not to name your top-level
edge after something that already exists there!</p>
</div>
<div class="sect4">
<h5 id="_simple_targeting"><a class="anchor" href="#_simple_targeting"></a><a class="link" href="#_simple_targeting">Simple Targeting</a></h5>
<div class="paragraph">
<p>The simplest targeting is to just relocate an edge from the root to somewhere else. The <code>load</code> function can do
that with a simple additional parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(df/load <span class="keyword">comp</span> <span class="symbol">:all-friends</span> Person {<span class="symbol">:target</span> [<span class="symbol">:screens/by-type</span> <span class="symbol">:friends</span> <span class="symbol">:friends/list</span>]})</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, the server will still see the well-known query for <code>:all-friends</code>, but your local UI graph will end up seeing the
results in the list on the friends screen.</p>
</div>
</div>
<div class="sect4">
<h5 id="_advanced_targets"><a class="anchor" href="#_advanced_targets"></a><a class="link" href="#_advanced_targets">Advanced Targets</a></h5>
<div class="paragraph">
<p>You can also ask the target parameter to modify to-many edges instead of replacing them. For example, say you
were loading one new person, and wanted to append it to the current list of friends:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(df/load <span class="keyword">comp</span> <span class="symbol">:best-friend</span> Person {<span class="symbol">:target</span> (df/append-to [<span class="symbol">:screens/by-type</span> <span class="symbol">:friends</span> <span class="symbol">:friends/list</span>])})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>append-to</code> function in the <code>data-fetch</code> namespace augments the target to indicate that the incoming items
(which will be normalized) should have their idents appended onto the to-many edge found at the given location.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<code>append-to</code> will not create duplicates.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The other available helper is <code>prepend-to</code>. Using a plain target is equivalent to full replacement.</p>
</div>
<div class="paragraph">
<p>You may also ask the targeting system to place the result(s) at more than one place in your graph. You do this
with the <code>multiple-targets</code> wrapper:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(df/load <span class="keyword">comp</span> <span class="symbol">:best-friend</span> Person {<span class="symbol">:target</span> (df/multiple-targets
                                              (df/append-to [<span class="symbol">:screens/by-type</span> <span class="symbol">:friends</span> <span class="symbol">:friends/list</span>])})
                                              [<span class="symbol">:other-spot</span>]
                                              (df/prepend-to [<span class="symbol">:screens/by-type</span> <span class="symbol">:summary</span> <span class="symbol">:friends</span>]))})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>multiple-targets</code> can use plain target vectors (replacement) or any of the special wrappers.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_refreshing_the_ui_after_load"><a class="anchor" href="#_refreshing_the_ui_after_load"></a><a class="link" href="#_refreshing_the_ui_after_load">9.6.4. Refreshing the UI After Load</a></h4>
<div class="paragraph">
<p>The component that issued the load will automatically be refreshed when the load completes. You may use the data-driven
nature of the app to request other components refresh as well. The <code>:refresh</code> option tells the system what data has
changed due to the load. It causes all live components that have queried those things to refresh.
You can supply keywords and/or idents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">; load my best friend, and re-render every live component that queried for the name of a person</span>
(df/load <span class="keyword">comp</span> <span class="symbol">:best-friend</span> Person {<span class="symbol">:refresh</span> [<span class="symbol">:person/name</span>]})</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_other_load_options"><a class="anchor" href="#_other_load_options"></a><a class="link" href="#_other_load_options">9.6.5. Other Load Options</a></h4>
<div class="paragraph">
<p>Loads allow a number of additional arguments. Many of these are discussed in more detail in later sections:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:post-mutation</code> and <code>:post-mutation-params</code>
</td>
<td class="hdlist2">
<p>A mutation to run once the load is complete (local data transform only).</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:remote</code>
</td>
<td class="hdlist2">
<p>The name of the remote you want to load from.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:refresh</code>
</td>
<td class="hdlist2">
<p>A vector of keywords and idents. Any component that queries these will be re-rendered once the load completes.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:marker</code>
</td>
<td class="hdlist2">
<p>Boolean or keyword. Indicates how (of if) load should indicate progress in your app state.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:parallel</code>
</td>
<td class="hdlist2">
<p>Boolean. Defaults to false. When true, bypasses the sequential network queue. Allows multiple loads to run at once, but causes you to lose any guarantees about ordering since the server might complete them out-of-order.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:fallback</code>
</td>
<td class="hdlist2">
<p>A mutation to run if the server throws an error during the load.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:without</code>
</td>
<td class="hdlist2">
<p>A set of keywords to elide from the query. Covered in Incremental Loading.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:params</code>
</td>
<td class="hdlist2">
<p>A map. If supplied the params will appear as the params of the query on the server.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:initialize bool|map</code>
</td>
<td class="hdlist2">
<p>If true, uses component&#8217;s initial state as a basis for incoming merge. If a map, uses the map as the basis for incoming merge.</p>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_initializing_loaded_items"><a class="anchor" href="#_initializing_loaded_items"></a><a class="link" href="#_initializing_loaded_items">9.6.6. Initializing Loaded Items</a></h4>
<div class="paragraph">
<p>On occasion you may find that your entities have <code>:ui/???</code> attributes that you would like to
default to something on a loaded entity. This is the purpose of the <code>:initialize</code> option to load.
If it is set to <code>true</code>, then <code>load</code> will call <code>get-initial-state</code> on the component of the
load, and merge the return value from the server into that before merging it to app state.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can pass <code>:initialize</code> a map, and that will be used as the target for
the server response merge before normalizing the result into app state.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The value of <code>:initialize</code> must either be <code>true</code> or a map <strong>that matches the correct
shape of the component&#8217;s sub-tree of data</strong>. It must <strong>not</strong> be a normalized database fragment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The steps are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Send the request</p>
</li>
<li>
<p>Merge the response into the basis defined by <code>:initialize</code>.</p>
</li>
<li>
<p>Merge the result of (2) into the database using the component&#8217;s query (auto-normalize)</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_post_mutations_morphing_loaded_data"><a class="anchor" href="#_post_mutations_morphing_loaded_data"></a><a class="link" href="#_post_mutations_morphing_loaded_data">9.6.7. Post Mutations – Morphing Loaded Data</a></h4>
<div class="paragraph">
<p>The targeting system that we discussed in the prior section is great for cases where your data-driven query gets you
exactly what you need for the UI. In fact, since you can process the query on the server it is entirely possible that
load with targeting is all you&#8217;ll ever need; however, from a practical perspective it may turn out that you&#8217;ve got a
server that can easily understand certain shapes of data-driven queries, but not others.</p>
</div>
<div class="paragraph">
<p>For example, say you were pulling a list of items from a database. It might be trivial to pull that graph of data
from the server from the perspective of a list of items, but let&#8217;s say that each item had a category. Perhaps you&#8217;d like to
group the items by category in the UI.</p>
</div>
<div class="paragraph">
<p>The data-driven way to handle that is to make the server understand the UI query that has them grouped by category; however,
that implies that you might end up embedding code on your server to handle a way of looking at data that is really
specific to one kind of UI. That tends to push us back toward a proliferation of code on the server that was a nightmare
in REST.</p>
</div>
<div class="paragraph">
<p>Another way of handling this is to accept the fact that our data-driven queries have some natural limits: If the
database on the server can easily produce the graph, then we should let it do so from the data-driven query; however,
in some cases it may make more sense to let the UI morph the incoming data into a shape that makes more sense to that
UI.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/server-interactions.png" alt="server interactions" width="350" height="378">
</div>
</div>
<div class="paragraph">
<p>We all understand doing these kinds of transforms. It&#8217;s just data manipulation. So, you may find this has some
distinct advantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Simple query to the server (only have to write one query handler) that is a natural fit for the database there.</p>
</li>
<li>
<p>Simple layout in resulting UI database (normalized into tables and a graph)</p>
</li>
<li>
<p>Straightforward data transform into what we want to show</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_post_mutations"><a class="anchor" href="#_post_mutations"></a><a class="link" href="#_post_mutations">Post Mutations</a></h5>
<div class="paragraph">
<p>Fulcro calls these kinds of post-load transforms <strong>Post Mutations</strong>. The reason for this name is that it requires
you define the transform as a mutation, and then allows you to ask for that transform to trigger when the load is
complete. The API is trivial:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(df/load this <span class="symbol">:items</span> Item {<span class="symbol">:post-mutation</span> `group-items})</code></pre>
</div>
</div>
<div class="paragraph">
<p>and you can include parameters with <code>:post-mutation-params</code>.</p>
</div>
<div class="paragraph">
<p>The example below simulates post mutations. You can interact with it and view the database to A/B compare
the before/after state.</p>
</div>
<div class="example" id="morphing-example"></div>
<a class="source-toggle" href="javascript:void(0)" onClick="$('.morphing-example').toggle()">Show/Hide Source</a>
<div class="listingblock morphing-example source">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">book.server.morphing-example</span>
  (<span class="symbol">:require</span> [fulcro.client.primitives <span class="symbol">:as</span> prim <span class="symbol">:refer</span> [defsc]]
            [fulcro.client.dom <span class="symbol">:as</span> dom]
            [book.macros <span class="symbol">:refer</span> [defexample]]
            [fulcro.client.cards <span class="symbol">:refer</span> [defcard-fulcro]]
            [fulcro.client.mutations <span class="symbol">:refer</span> [defmutation]]
            [fulcro.client <span class="symbol">:as</span> fc]))

(defsc CategoryQuery [this props]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:category/name</span>]
   <span class="symbol">:ident</span> [<span class="symbol">:categories/by-id</span> <span class="symbol">:db/id</span>]})

(defsc ItemQuery [this props]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:item/name</span> {<span class="symbol">:item/category</span> (prim/get-query CategoryQuery)}]
   <span class="symbol">:ident</span> [<span class="symbol">:items/by-id</span> <span class="symbol">:db/id</span>]})

(<span class="keyword">def</span> <span class="function">sample-server-response</span>
  {<span class="symbol">:all-items</span> [{<span class="symbol">:db/id</span> <span class="integer">5</span> <span class="symbol">:item/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">item-42</span><span class="delimiter">&quot;</span></span> <span class="symbol">:item/category</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:category/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}}
               {<span class="symbol">:db/id</span> <span class="integer">6</span> <span class="symbol">:item/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">item-92</span><span class="delimiter">&quot;</span></span> <span class="symbol">:item/category</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:category/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}}
               {<span class="symbol">:db/id</span> <span class="integer">7</span> <span class="symbol">:item/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">item-32</span><span class="delimiter">&quot;</span></span> <span class="symbol">:item/category</span> {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:category/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">A</span><span class="delimiter">&quot;</span></span>}}
               {<span class="symbol">:db/id</span> <span class="integer">8</span> <span class="symbol">:item/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">item-52</span><span class="delimiter">&quot;</span></span> <span class="symbol">:item/category</span> {<span class="symbol">:db/id</span> <span class="integer">2</span> <span class="symbol">:category/name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">B</span><span class="delimiter">&quot;</span></span>}}]})

(<span class="keyword">def</span> <span class="function">component-query</span> [{<span class="symbol">:all-items</span> (prim/get-query ItemQuery)}])

(<span class="keyword">def</span> <span class="function">hand-written-query</span> [{<span class="symbol">:all-items</span> [<span class="symbol">:db/id</span> <span class="symbol">:item/name</span>
                                      {<span class="symbol">:item/category</span> [<span class="symbol">:db/id</span> <span class="symbol">:category/name</span>]}]}])

(defsc ToolbarItem [this {<span class="symbol">:keys</span> [item/name]}]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:item/name</span>]
   <span class="symbol">:ident</span> [<span class="symbol">:items/by-id</span> <span class="symbol">:db/id</span>]}
  (dom/li <span class="predefined-constant">nil</span> <span class="keyword">name</span>))

(<span class="keyword">def</span> <span class="function">ui-toolbar-item</span> (prim/factory ToolbarItem {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defsc ToolbarCategory [this {<span class="symbol">:keys</span> [category/name category/items]}]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:category/name</span> {<span class="symbol">:category/items</span> (prim/get-query ToolbarItem)}]
   <span class="symbol">:ident</span> [<span class="symbol">:categories/by-id</span> <span class="symbol">:db/id</span>]}
  (dom/li <span class="predefined-constant">nil</span>
    <span class="keyword">name</span>
    (dom/ul <span class="predefined-constant">nil</span>
      (<span class="keyword">map</span> ui-toolbar-item items))))

(<span class="keyword">def</span> <span class="function">ui-toolbar-category</span> (prim/factory ToolbarCategory {<span class="symbol">:keyfn</span> <span class="symbol">:db/id</span>}))

(defmutation group-items-reset [params]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">reset!</span> state (prim/tree-&gt;db component-query sample-server-response <span class="predefined-constant">true</span>))))

(<span class="keyword">defn</span> <span class="function">add-to-category</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns a new db with the given item added into that item's category.</span><span class="delimiter">&quot;</span></span>
  [db item]
  (<span class="keyword">let</span> [category-ident (<span class="symbol">:item/category</span> item)
        item-location  (<span class="keyword">conj</span> category-ident <span class="symbol">:category/items</span>)]
    (<span class="keyword">update-in</span> db item-location (fnil <span class="keyword">conj</span> []) (prim/ident ItemQuery item))))

(<span class="keyword">defn</span> <span class="function">group-items*</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns a new db with all of the items sorted by name and grouped into their categories.</span><span class="delimiter">&quot;</span></span>
  [db]
  (<span class="keyword">let</span> [sorted-items   (<span class="keyword">-&gt;&gt;</span> db <span class="symbol">:items/by-id</span> <span class="keyword">vals</span> (<span class="keyword">sort-by</span> <span class="symbol">:item/name</span>))
        category-ids   (<span class="keyword">-&gt;</span> db (<span class="symbol">:categories/by-id</span>) <span class="keyword">keys</span>)
        clear-items    (<span class="keyword">fn</span> [db id] (<span class="keyword">assoc-in</span> db [<span class="symbol">:categories/by-id</span> id <span class="symbol">:category/items</span>] []))
        db             (<span class="keyword">reduce</span> clear-items db category-ids)
        db             (<span class="keyword">reduce</span> add-to-category db sorted-items)
        all-categories (<span class="keyword">-&gt;&gt;</span> db <span class="symbol">:categories/by-id</span> <span class="keyword">vals</span> (mapv #(prim/ident CategoryQuery %)))]
    (<span class="keyword">assoc</span> db <span class="symbol">:toolbar/categories</span> all-categories)))

(defmutation ^<span class="symbol">:intern</span> group-items [params]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state group-items*)))

(defsc Toolbar [this {<span class="symbol">:keys</span> [toolbar/categories]}]
  {<span class="symbol">:query</span> [{<span class="symbol">:toolbar/categories</span> (prim/get-query ToolbarCategory)}]}
  (dom/div <span class="predefined-constant">nil</span>
    (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(prim/transact! this `[(group-items {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Trigger Post Mutation</span><span class="delimiter">&quot;</span></span>)
    (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(prim/transact! this `[(group-items-reset {})])} <span class="string"><span class="delimiter">&quot;</span><span class="content">Reset</span><span class="delimiter">&quot;</span></span>)
    (dom/ul <span class="predefined-constant">nil</span>
      (<span class="keyword">map</span> ui-toolbar-category categories))))

(defexample <span class="string"><span class="delimiter">&quot;</span><span class="content">Morphing Data</span><span class="delimiter">&quot;</span></span> Toolbar <span class="string"><span class="delimiter">&quot;</span><span class="content">morphing-example</span><span class="delimiter">&quot;</span></span> <span class="symbol">:initial-state</span> (<span class="keyword">atom</span> (prim/tree-&gt;db component-query sample-server-response <span class="predefined-constant">true</span>)))</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_using_code_defsc_code_for_server_queries"><a class="anchor" href="#_using_code_defsc_code_for_server_queries"></a><a class="link" href="#_using_code_defsc_code_for_server_queries">Using <code>defsc</code> For Server Queries</a></h5>
<div class="paragraph">
<p>It is perfectly legal to use <code>defsc</code> to define an graph query (and normalization) for something like this that doesn&#8217;t exactly
exist on your UI. This can be quite useful in the presence of post mutations that can re-shape the data.</p>
</div>
<div class="paragraph">
<p>Simply code your (nested) queries using <code>defsc</code>, and skip writing the body:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc ItemQuery [this props]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:item/name</span> {<span class="symbol">:item/category</span> (prim/get-query CategoryQuery)}]
   <span class="symbol">:ident</span> [<span class="symbol">:items/by-id</span> <span class="symbol">:db/id</span>]})</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(df/load this <span class="symbol">:all-items</span> ItemQuery {<span class="symbol">:post-mutation</span> `group-items})</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
We know that the name <code>defsc</code> seems a bit of a misnomer for this, so feel free to create an alias for it.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_full_stack_mutations"><a class="anchor" href="#_full_stack_mutations"></a><a class="link" href="#_full_stack_mutations">9.7. Full-Stack Mutations</a></h3>
<div class="paragraph">
<p>You&#8217;ve already seen how to define local mutations on the client. That portion of a mutation is run immediately on the
client, and when there is also a server interaction that client-side of the operation is an optimistic update (because
you&#8217;re assuming that the server will succeed in replicating the action).</p>
</div>
<div class="paragraph">
<p>We&#8217;ll talk more about handling errors in a bit, but first let&#8217;s clear up how you go about telling the server it has
something to do.</p>
</div>
<div class="sect3">
<h4 id="_mutations_revisited"><a class="anchor" href="#_mutations_revisited"></a><a class="link" href="#_mutations_revisited">9.7.1. Mutations Revisited</a></h4>
<div class="paragraph">
<p>A multi-method in Fulcro client (which is manipualted with <code>defmutation</code>) can indicate that a given mutation
should be sent to any number of remotes. The default remote is named <code>:remote</code>, but you can define new ones or even
rename the default one.</p>
</div>
<div class="paragraph">
<p>The technical structure of this looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">require</span> [fulcro.client.mutations <span class="symbol">:refer</span> [mutate]])

(<span class="keyword">defmethod</span> <span class="function">mutate</span> 'some/mutation [env k params]
  <span class="comment">;; sends this mutation with the same `env`, `k`, and `params` arguments to the server</span>
  {<span class="symbol">:remote</span> <span class="predefined-constant">true</span>
   <span class="symbol">:action</span> (<span class="keyword">fn</span>[] <span class="keyword">..</span><span class="keyword">.</span> )})</code></pre>
</div>
</div>
<div class="paragraph">
<p>or preferably using the <code>defmutation</code> macro:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation do-thing [params]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>)
  (remote [env] <span class="predefined-constant">true</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basically, you use the <strong>name</strong> of the remote as an indicator of which remote you want to replicate the mutation to. From
there you either return <code>true</code> (which means send the mutation as-is), or you may return an expression AST that represents
the mutation you&#8217;d like to send instead. The <code>fulcro.client.primitives</code> namespace includes <code>ast-&gt;query</code> and <code>query-ast</code>
for arbitrary generation of ASTs, but the original AST of the mutation is also available in the mutation&#8217;s environment.</p>
</div>
<div class="paragraph">
<p>Therefore, you can alter a mutation simply by altering and returning the <code>ast</code> given in <code>env</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation do-thing [params]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>)
  <span class="comment">; send (do-thing {:x 1}) even if params are different than that on the client</span>
  (remote [{<span class="symbol">:keys</span> [ast]}] (<span class="keyword">assoc</span> ast <span class="symbol">:params</span> {<span class="symbol">:x</span> <span class="integer">1</span>})) <span class="comment">; change the param list for the remote</span>

<span class="comment">; or using the with-params helper</span>
(defmutation do-thing [params]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>)
  <span class="comment">; send (do-thing {:x 1}) even if params are different than that on the client</span>
  (remote [{<span class="symbol">:keys</span> [ast]}] (m/with-params ast {<span class="symbol">:x</span> <span class="integer">1</span>})) <span class="comment">; change the param list for the remote</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or even change which mutation the server sees:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation some-mutation [ params]
  <span class="comment">;; Changes the mutation from the incoming client-side some-mutation to server-mutation</span>
  (remote [{<span class="symbol">:keys</span> [ast] <span class="symbol">:as</span> env}] (<span class="keyword">assoc</span> ast <span class="symbol">:key</span> 'server-mutation <span class="symbol">:dispatch-key</span> 'server-mutation)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: The action is executed <strong>before</strong> the remote, and the processing is done in multiple passes (your mutation
handler is invoked for each pass).
So if you want to delete data from the client, but will need the data to compute the remote expression, then you will
typically pass the needed data as a <strong>parameter</strong> to the mutation so that the mutation invocation closes over it and you
don&#8217;t have to rely on state (which might have changed in an earlier pass).</p>
</div>
</div>
<div class="sect3">
<h4 id="_writing_the_server_mutations"><a class="anchor" href="#_writing_the_server_mutations"></a><a class="link" href="#_writing_the_server_mutations">9.7.2. Writing The Server Mutations</a></h4>
<div class="paragraph">
<p>Server-side mutations in Fulcro are written the same way as on the client: A mutation returns a map with a key <code>:action</code>
and a function of no variables as a value. The mutation then does whatever server-side operation is indicated. The <code>env</code>
parameter on the server can contain anything you like (for example database access interfaces), and you&#8217;ll see how
to configure that when you study the <code>I_Building_A_Server</code> section.</p>
</div>
<div class="paragraph">
<p>The recommended approach to writing a server mutation is to use the pre-written server-side parser and multimethods, which allow you
to mimic the same code structure of the client (there is a <code>defmutation</code> in <code>fulcro.server</code> for this).</p>
</div>
<div class="paragraph">
<p>If you&#8217;re using this approach (which is the default in the easy server), then here are the client-side and server-side
implementations of the same mutation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; client</span>
<span class="comment">;; src/my_app/mutations.cljs</span>
(<span class="keyword">ns</span> <span class="namespace">my-app.mutations</span>
  (<span class="symbol">:require</span> [fulcro.client.mutations <span class="symbol">:refer</span> [defmutation]]))

(defmutation do-something [{<span class="symbol">:keys</span> [p]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state <span class="keyword">assoc</span> <span class="symbol">:value</span> p))
  (remote [env] <span class="predefined-constant">true</span>))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; server</span>
<span class="comment">;; src/my_app/mutations.clj</span>
(<span class="keyword">ns</span> <span class="namespace">my-app.mutations</span>
  (<span class="symbol">:require</span> [fulcro.server <span class="symbol">:refer</span> [defmutation]]))

(defmutation do-something [{<span class="symbol">:keys</span> [p]}]
  (action [{<span class="symbol">:keys</span> [some-server-database]}]
     <span class="keyword">..</span><span class="keyword">.</span> server code to make change <span class="keyword">..</span><span class="keyword">.</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is recommended that you use the same namespace on the client and server for mutations so it is easy to find them,
but the macro allows you to namespace the symbol if you choose to use a different namespace on the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my-app.server</span>
  (<span class="symbol">:require</span> [fulcro.server <span class="symbol">:refer</span> [defmutation]]))

(defmutation my-app.mutations/do-something [{<span class="symbol">:keys</span> [p]}]
  (action [{<span class="symbol">:keys</span> [some-server-database]}]
     <span class="keyword">..</span><span class="keyword">.</span> server code to make change <span class="keyword">..</span><span class="keyword">.</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The ideal structure for many people is to use a CLJC file, where they can co-locate the mutations in the same
source file. The only trick is that you have to make sure you use the correct <code>defmutation</code>!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my-app.api</span>
  (<span class="symbol">:require</span>
    <span class="error">#</span>?(<span class="symbol">:clj</span> [fulcro.server <span class="symbol">:as</span> server]
       <span class="symbol">:cljs</span> [fulcro.client.mutations <span class="symbol">:refer</span> [defmutation]])))

  <span class="error">#</span>?(<span class="symbol">:clj</span> (server/defmutation do-thing [params]
          (action [server-env] <span class="keyword">..</span><span class="keyword">.</span>))
    <span class="symbol">:cljs</span> (defmutation do-thing [params]
            (remote [env] <span class="predefined-constant">true</span>)))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The server namespace includes support for defining a server mutation in the browser. This allows you to simulate a server
in the browser instead of having to have a real server.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please see I_Building_A_Server for more information about setting up a server with injected components in the mutation
environment.</p>
</div>
</div>
<div class="sect3">
<h4 id="_new_item_creation_temporary_ids"><a class="anchor" href="#_new_item_creation_temporary_ids"></a><a class="link" href="#_new_item_creation_temporary_ids">9.7.3. New item creation – Temporary IDs</a></h4>
<div class="paragraph">
<p>Fulcro has a built in function <code>prim/tempid</code> that will generate a unique temporary ID. This allows the normalization
and denormalization of the client side database to continue working while the server processes the new data and returns
the permanent identifier(s).</p>
</div>
<div class="paragraph">
<p>The idea is that these temporary IDs can be safely placed in your client database (and network queues), and will be
automatically rewritten to their real ID when the server has managed to create the real persistent entity. Of course, since
you have optimistic updates on the client it is important that things go in the correct sequence, and that queued operations
for the server don&#8217;t get confused about what ID is correct!</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Because mutation code can be called multiple times (at least once + once per each remote),
you should take care to not call <code>fulcro.client.primitives/tempid</code> inside your mutation.
Instead call it from your UI code that builds the mutation params.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Fulcro&#8217;s implementation works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Mutations always run in the order specified in the call to <code>transact!</code></p>
</li>
<li>
<p>Transmission of separate calls to <code>transact!</code> run in the order they were called.</p>
</li>
<li>
<p>If remote mutations are separated in time, then they go through a sequential networking queue, and are processed in order.</p>
</li>
<li>
<p>As mutations complete on the server, they return tempid remappings. Those are applied to the application state <strong>and</strong> network
queue before the next network operation (load or mutation) is sent.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This set of rules helps ensure that you can reason about your program, even in the presence of optimistic updates that
could theoretically be somewhat ahead of the server.</p>
</div>
<div class="paragraph">
<p>For example, you could create an item, edit it, then delete it. The UI responds immediately, but the initial create might
still be running on the server. This means the server has not even given it a real ID before you&#8217;re queuing up a request
to delete it! With the above rules, it will just work! The network queue will have two backlogged operations (the edit
and the delete), each with the same tempid that you currently know. When the create finally returns
it will automatically rewrite all of the tempids in state and the network queues, then send the next operation. Thus,
the edit will apply to the current server entity, as will the delete.</p>
</div>
<div class="paragraph">
<p>All the server code has to do is return a map with the special key <code>:fulcro.client.primitives/tempids</code>
(or the legacy <code>:tempids</code>) whose value is a map of <code>tempid-&gt;realid</code> whenever it sees an ID during persistence operations.
Here are the client-side and server-side implementations of the same mutation that create a new item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; client</span>
<span class="comment">;; src/my_app/mutations.cljs</span>
(<span class="keyword">ns</span> <span class="namespace">my-app.mutations</span>
  (<span class="symbol">:require</span> [fulcro.client.mutations <span class="symbol">:refer</span> [defmutation]]))

(defmutation new-item [{<span class="symbol">:keys</span> [tempid text]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">swap!</span> state <span class="keyword">assoc-in</span> [<span class="symbol">:item/by-id</span> tempid] {<span class="symbol">:db/id</span> tempid <span class="symbol">:item/text</span> text}))
  (remote [env] <span class="predefined-constant">true</span>))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; server</span>
<span class="comment">;; src/my_app/mutations.clj</span>
(<span class="keyword">ns</span> <span class="namespace">my-app.mutations</span>
  (<span class="symbol">:require</span> [fulcro.client.primitives <span class="symbol">:as</span> prim]
            [fulcro.server <span class="symbol">:refer</span> [defmutation]]))

(defmutation new-item [{<span class="symbol">:keys</span> [tempid text]}]
  (action [{<span class="symbol">:keys</span> [state]}]
    (<span class="keyword">let</span> [database-tempid (make-database-tempid)
          database-id (add-item-to-database database {<span class="symbol">:db/id</span> database-tempid <span class="symbol">:item/text</span> text})]
      {<span class="symbol">::prim/tempids</span> {tempid database-id}})))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Other mutation return values are covered in Mutation Return Values.</p>
</div>
</div>
<div class="sect3">
<h4 id="_remote_reads_after_a_mutation"><a class="anchor" href="#_remote_reads_after_a_mutation"></a><a class="link" href="#_remote_reads_after_a_mutation">9.7.4. Remote Reads After a Mutation</a></h4>
<div class="paragraph">
<p>In earlier sections you learned that you can list properties with your mutation to indicate re-renders.
These follow-on read keywords are always local re-render reads, and nothing more:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(prim/transact! this '[(app/f) <span class="symbol">:thing</span>])
<span class="comment">; Does mutation, and re-renders anything that has :thing in a query</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Fulcro will automatically queue remote reads <strong>after</strong> writes when they are submitted in the same thread interaction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(prim/transact! this `[(f)])
(df/load this <span class="symbol">:thing</span> Thing)
(prim/transact! this `[(g)])</code></pre>
</div>
</div>
<div class="paragraph">
<p>will result in two network interactions. The first will run <code>[(f) (g)]</code>, and the second will be a load of <code>:thing</code>. This
is a defined and official behavior.</p>
</div>
<div class="paragraph">
<p>Thus, one way you can implement a sequence of mutation followed by learning a result is to run a mutation and a load.</p>
</div>
</div>
<div class="sect3">
<h4 id="PTransact"><a class="anchor" href="#PTransact"></a><a class="link" href="#PTransact">9.7.5. Pessimistic Transactions</a></h4>
<div class="paragraph">
<p>There are scenarios where the above behavior is not what you want. In particular are cases like form submission where
you might want to wait until the server completes, so that the user can be kept in the form until you&#8217;ve confirmed
the server isn&#8217;t down or something.</p>
</div>
<div class="paragraph">
<p>Fulcro 2.0+ has support for pessimistic transactions that enable exactly this sort of behavior:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(prim/ptransact! this `[(a) (b)])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Will run <code>a</code>'s action, <code>a</code>'s remote, <strong>then</strong> <code>b</code>'s action and <code>b</code>'s remote.
This can be combined with analysis of <a href="#ReturnValues">mutation return values</a> to allow you to follow a remote operation with a UI one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">; assume submit-my-form blocks the UI, and leave-form-if-ok checks app state and moves on.</span>
(prim/ptransact! this `[(submit-my-form) (leave-form-if-ok)])</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_pessimistic_transaction_fallbacks"><a class="anchor" href="#_pessimistic_transaction_fallbacks"></a><a class="link" href="#_pessimistic_transaction_fallbacks">Pessimistic Transaction Fallbacks</a></h5>
<div class="paragraph">
<p>The fallback mechanism described for error handling works in <code>ptransact!</code>. Fallbacks are clustered to the remote they follow
up until the next remote mutation (with one exception: fallbacks at the beginning of the entire tx are clustered to the first remote mutation):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(ptransact! this `[(L) (df/fallback {<span class="keyword">..</span><span class="keyword">.</span>}) (L) (R) (df/fallback {<span class="keyword">..</span><span class="keyword">.</span>}) (L2) (R2) (L3) (df/fallback {<span class="keyword">..</span><span class="keyword">.</span>}) ])</code></pre>
</div>
</div>
<div class="paragraph">
<p>will associate the first two fallbacks with remote call <code>R</code>, and the last one with <code>R2</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_loads_as_mutations"><a class="anchor" href="#_using_loads_as_mutations"></a><a class="link" href="#_using_loads_as_mutations">9.7.6. Using Loads as Mutations</a></h4>
<div class="paragraph">
<p>There is technically nothing wrong with issuing a load that has side-effects on the server (though one could argue that
this is a bit sketchy from a design perspective). For example, one way to
implement login is to issue a load with the user&#8217;s credentials:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(df/load <span class="symbol">:current-user</span> User {<span class="symbol">:params</span> {<span class="symbol">:username</span> u <span class="symbol">:password</span> p}})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The server query response can validate the credentials, set a cookie, and return the user info all at once! Your UI can
simply base rendering on the values in <code>:current-user</code>. If they&#8217;re valid, you&#8217;re logged in.</p>
</div>
<div class="paragraph">
<p>If you remember from the General Operations section, you can modify the low-level Ring response by associating a lambda
with your return value. If you were using Ring Session, then this might be how the query would be implemented on the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my-api</span>
  (<span class="symbol">:require</span> [fulcro.server <span class="symbol">:as</span> server <span class="symbol">:refer</span> [defmutation defquery-root]]))

(<span class="keyword">def</span> <span class="function">bad-user</span> {<span class="symbol">:db/id</span> <span class="integer">0</span>})

(defquery-root <span class="symbol">:current-user</span>
  (value [env params]
    (<span class="keyword">if-let</span> [{<span class="symbol">:keys</span> [db/id] <span class="symbol">:as</span> user} (authenticate params)] <span class="comment">; look up the user, return nil if bad</span>
      (server/augment-response user (<span class="keyword">fn</span> [resp] (<span class="keyword">assoc-in</span> resp [<span class="symbol">:session</span> <span class="symbol">:uid</span>] id)))
      bad-user)))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_mutations_in_the_context_of_an_entity"><a class="anchor" href="#_running_mutations_in_the_context_of_an_entity"></a><a class="link" href="#_running_mutations_in_the_context_of_an_entity">9.7.7. Running Mutations in the Context of an Entity</a></h4>
<div class="paragraph">
<p>If you submit a transaction and include an ident:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(transact! reconciler [<span class="symbol">:person/by-id</span> <span class="integer">4</span>] `[(f)])</code></pre>
</div>
</div>
<div class="paragraph">
<p>then the transaction will run as-if it were executed in the context of any live component on the screen that currently has
that ident. This will make the ident available in the mutation&#8217;s environment as <code>:ref</code>, and will focus refresh at that
component sub-tree(s). This can be useful when you have out-of-band data that causes you to want to run a
transaction outside of the UI using the reconciler.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_network_activity_indicators"><a class="anchor" href="#_network_activity_indicators"></a><a class="link" href="#_network_activity_indicators">9.8. Network Activity Indicators</a></h3>
<div class="paragraph">
<p>Rendering is completely up to you, but Fulcro handles the networking (technically this is pluggable, but Fulcro still initiates
the interactions). That means that you&#8217;re going to need some help when it comes to showing the user that something is happening on the network.</p>
</div>
<div class="paragraph">
<p>The first and easiest thing to use is a global activity marker that is automatically maintained at the root node of
your client database.</p>
</div>
<div class="sect3">
<h4 id="_global_network_activity_marker"><a class="anchor" href="#_global_network_activity_marker"></a><a class="link" href="#_global_network_activity_marker">9.8.1. Global network activity marker</a></h4>
<div class="paragraph">
<p>Fulcro will automatically maintain a global network activity marker at the top level of the app state under the
keyword <code>:ui/loading-data</code>. This key will have a <code>true</code> value when there are network requests awaiting a response from
the server, and will have a <code>false</code> value when there are no network requests in process.</p>
</div>
<div class="paragraph">
<p>You can access this marker from any component that composes to root by including a link in your component&#8217;s query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Item <span class="keyword">..</span><span class="keyword">.</span> )
(<span class="keyword">def</span> <span class="function">ui-item</span> (prim/factory Item {<span class="symbol">:keyfn</span> <span class="symbol">:id</span>}))

(defsc List [this {<span class="symbol">:keys</span> [title items ui/loading-data]}]
  {<span class="symbol">:query</span> [<span class="symbol">:id</span> <span class="symbol">:title</span> {<span class="symbol">:items</span> (prim/get-query Item)} [<span class="symbol">:ui/loading-data</span> '_]]}
  <span class="keyword">..</span><span class="keyword">.</span>
  (<span class="keyword">if</span> (<span class="keyword">and</span> loading-data (<span class="keyword">empty?</span> items))
    (dom/div <span class="predefined-constant">nil</span> <span class="char">\&quot;</span>Loading.<span class="keyword">..</span><span class="char">\&quot;</span>)
    (dom/div <span class="predefined-constant">nil</span>
      (dom/h1 <span class="predefined-constant">nil</span> title)
      (<span class="keyword">map</span> ui-item items))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the global loading marker is at the top level of the application state, do not use the keyword as a follow-on
read to mutations because it may unnecessarily trigger a re-render of the entire application.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mutation_activity"><a class="anchor" href="#_mutation_activity"></a><a class="link" href="#_mutation_activity">9.8.2. Mutation Activity</a></h4>
<div class="paragraph">
<p>Mutations can be passed off silently to the server. You may choose to block the UI if you have reason to believe there
will be a problem, but there is usually no other reason to prevent the user from just continuing to use your application
while the server processes the mutation. Thus, only the global activity marker is available for mutations. See
<a href="#PTransact">Pessimistic Transactions</a> for a method of controlling UI around the network activity of remote mutations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tracking_specific_loads"><a class="anchor" href="#_tracking_specific_loads"></a><a class="link" href="#_tracking_specific_loads">9.8.3. Tracking Specific Loads</a></h4>
<div class="paragraph">
<p>Loads are a different story. It is very often the case that you might have a number of loads running to populate different
parts of your UI all at once. In this case it is quite useful to have some kind of load-specific marker that you
can use to show that activity.</p>
</div>
<div class="paragraph">
<p>In Fulcro 1.0 this was done as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The target of each load was replaced by a <strong>load marker</strong> until the load completed</p>
</li>
<li>
<p>You can detect these load markers and show an alternate UI while they are loading</p>
</li>
<li>
<p>When the data arrived the load marker was replaced by it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is still supported (and is still currently the default); however, it is deprecated because it was found to be less than ideal:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It caused the old data to disappear. There was noplace else to put the targeted load marker except <strong>over</strong> the old data.
This caused flicker and workarounds (such as mis-targeting the data and using post-mutations to put it in place at the end)</p>
</li>
<li>
<p>The load markers are rather large. Looking at your component&#8217;s app state during a load is kind of ugly.</p>
</li>
<li>
<p>The load markers could not be queried from elsewhere, meaning activity indicators had to be local to the loaded data.</p>
</li>
<li>
<p>Worst: you had to add a special query property to the component representing the thing being loaded, or the load marker
wasn&#8217;t even available. This bit of magic was hard to understand.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In Fulcro 2.0, it is recommended that you use a keyword (of your own invention) for the <code>:marker</code> option instead. This
has the following behavior:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Load markers are placed in a top-level table (the var fulcro.client.data-fetch/marker-table holds the table name),
using your keyword as their ID. They are normalized!</p>
</li>
<li>
<p>You can therefore explicitly query for them using an ident join</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This solves all of the prior system&#8217;s weaknesses.</p>
</div>
<div class="sect4">
<h5 id="_working_with_load_markers"><a class="anchor" href="#_working_with_load_markers"></a><a class="link" href="#_working_with_load_markers">Working with Load Markers</a></h5>
<div class="paragraph">
<p>The steps are rather simple: Include the <code>:marker</code> parameter with load, and issue a query for the load marker on
the marker table. The table name for markers is stored in the data-fetch namespace as <code>df/marker-table</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc SomeComponent [this props]
  {<span class="symbol">:query</span> [<span class="symbol">:data</span> <span class="symbol">:prop2</span> <span class="symbol">:other</span> [df/marker-table <span class="symbol">:marker-id</span>]]} <span class="comment">; an ident in queries pulls in an entire entity</span>
  (<span class="keyword">let</span> [marker (<span class="keyword">get</span> props [df/marker-table <span class="symbol">:marker-id</span>])]
    <span class="keyword">..</span><span class="keyword">.</span>)))

<span class="keyword">..</span><span class="keyword">.</span>

(df/load this <span class="symbol">:key</span> Item {<span class="symbol">:marker</span> <span class="symbol">:marker-id</span>})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The data fetch load marker will be missing if no loading is in progress. You can use the following functions
to detect what state the load is in:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>(df/ready? m)</code> - Returns true if the item is queued, but not yet active on the network</p>
</li>
<li>
<p><code>(df/loading? m)</code> - Returns true if the item is active on the network</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The marker will disappear from the table when network activity completes.</p>
</div>
<div class="paragraph">
<p>The rendering is up to you, but that is really all there is to it.</p>
</div>
<div class="sect5">
<h6 id="_marker_ids_for_items_that_have_many_instances"><a class="anchor" href="#_marker_ids_for_items_that_have_many_instances"></a><a class="link" href="#_marker_ids_for_items_that_have_many_instances">Marker IDs for Items That Have Many Instances</a></h6>
<div class="paragraph">
<p>The most confusing part of normalized load markers is that the IDs are keywords, but you may need a marker for a specific
entity. Say you have a list of people, and you&#8217;d like to show an activity marker on the one you&#8217;re refreshing. You
have many on the screen, so you can&#8217;t just use a simple keyword as the marker ID or they might all show a loading
indicator when only one is updating.</p>
</div>
<div class="paragraph">
<p>In this case you will need to generate a marker ID based on the entity ID, and then use a link query to pull the
entire load marker table to see what is loading.</p>
</div>
<div class="paragraph">
<p>For example, you might define the marker IDs as <code>(keyword \"person-load-marker\" (str person-id))</code>. Your person
component could then find its load marker like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">person-markerid</span> [id] (<span class="keyword">keyword</span> <span class="char">\&quot;</span>person-load-marker<span class="char">\&quot;</span> (<span class="keyword">str</span> id)))

(defsc Person [this {<span class="symbol">:keys</span> [db/id person/name]}]
  {<span class="symbol">:query</span> [<span class="symbol">:db/id</span> <span class="symbol">:person/name</span> [df/marker-table '_]]
   <span class="symbol">:ident</span> [<span class="symbol">:person/by-id</span> <span class="symbol">:db/id</span>]}
  (<span class="keyword">let</span> [marker-id   (person-markerid id)
        all-markers (<span class="keyword">get</span> props df/marker-table)
        marker      (<span class="keyword">get</span> all-markers marker-id)]
      <span class="keyword">..</span><span class="keyword">.</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>the load might look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(df/load this [<span class="symbol">:person/by-id</span> <span class="integer">42</span>] Person {<span class="symbol">:marker</span> (person-markerid <span class="integer">42</span>)})</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: Demo HERE!</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ReturnValues"><a class="anchor" href="#ReturnValues"></a><a class="link" href="#ReturnValues">9.9. Server Mutation Return Values</a></h3>
<div class="paragraph">
<p>The server mutation is always allowed to return a value. Normally the only value that makes sense is the temporary ID
remapping as previoiusly discussed in the main section of full-stack mutations. It is automatically processed by the client
and causes the tempid to be rewritten everywhere in your state and network backlog:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">; server-side</span>
(defmutation new-thing [params]
  (action [env]
    <span class="keyword">..</span><span class="keyword">.</span>
    {<span class="symbol">::prim/tempids</span> {old-id new-id}}))</code></pre>
</div>
</div>
<div class="paragraph">
<p>In some cases you&#8217;d like to return other details. However, remember that
any data merge needs a tree of data <strong>and</strong> a query. With a mutation <strong>there is no query</strong>!
As such, return values from mutations are <strong>ignored by default</strong> because there is no way to understand how to
merge the result into your database. Remember we&#8217;re trying to eliminate the vast majority of callback hell and keep
asynchrony out of the UI. The processing pipeline is always: update the database state, re-render the UI.</p>
</div>
<div class="paragraph">
<p>If you want to make use of the returned values from the server then you need to add something to remedy the
lack of a query.</p>
</div>
<div class="sect3">
<h4 id="_using_mutation_joins"><a class="anchor" href="#_using_mutation_joins"></a><a class="link" href="#_using_mutation_joins">9.9.1. Using Mutation Joins</a></h4>
<div class="paragraph">
<p>The solution might be obvious to you: include the query with the mutation! This is called a <strong>mutation join</strong>.
The explicit syntax for a mutation join looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">`[{(f) [<span class="symbol">:x</span>]}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>but you never write them this way because a manual query doesn&#8217;t have ident information and cannot aid normalization. Instead,
you write them just like you do when grabbing queries for anything else:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">`[{(f) ~(om/get-query Item)}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running a mutation with this notation allows you to return a value from the server&#8217;s mutation that exactly matches the graph
of the item, and it will be automatically normalized and merged into your database. So, if the <code>Item</code> query ended up being
<code>[:db/id :item/value]</code> then the server mutation could just return a simple map like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">; server-side</span>
(defmutation f [params]
  (action [env]
     {<span class="symbol">:db/id</span> <span class="integer">1</span> <span class="symbol">:item/value</span> <span class="integer">42</span>})) <span class="comment">; ok to return one (a map) OR many (as a vector of maps)</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
At the time of this writing the query must come from a UI component that <strong>has an ident</strong>. Thus, mutations joins
essentially normalize things into a specific table in your database (determined by the ID(s) of the return
value and the ident on the query&#8217;s component). Newer versions may relax this restriction.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ASTMutationJoins"><a class="anchor" href="#ASTMutationJoins"></a><a class="link" href="#ASTMutationJoins">9.9.2. Mutation Joins: Simpler Notation</a></h4>
<div class="paragraph">
<p>Writing <code>transact!</code> using mutation joins is a bit visually noisy. It turns out there is a better way.
If you remember: the remote section of client mutations can return a boolean <strong>or an AST</strong>. Fulcro comes with helper functions that can
rewrite the AST of the mutation to modify the parameters or convert it to a mutation join! This can simplify how the
mutations look in the UI.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the difference. With the manual syntactic technique we just described your UI and client mutation would look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">; in the UI</span>
(transact! this `[{(f) ~(om/get-query Item)}])

<span class="comment">; in your mutation definition (client-side)</span>
(defmutation f [params]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>)
  (remote [env] <span class="predefined-constant">true</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, using the helpers you can instead write it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">api</span>
  (<span class="symbol">:require</span> [fulcro.client.mutations <span class="symbol">:refer</span> [returning]]))

<span class="comment">; in the UI</span>
(transact! this `[(f)])

<span class="comment">; in your mutation definition (client-side)</span>
(defmutation f [params]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>)
  (remote [{<span class="symbol">:keys</span> [ast state]}] (returning ast state Item))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This makes the mutation join an artifact of the <strong>network interaction</strong>, and less for you to manually code (and read) in the UI.</p>
</div>
<div class="paragraph">
<p>The server-side code is the same for both: just return a proper graph value!</p>
</div>
</div>
<div class="sect3">
<h4 id="_targeting_return_values_from_mutation_joins"><a class="anchor" href="#_targeting_return_values_from_mutation_joins"></a><a class="link" href="#_targeting_return_values_from_mutation_joins">9.9.3. Targeting Return Values From Mutation Joins</a></h4>
<div class="paragraph">
<p>If you use the <a href="#ASTMutationJoins">AST with mutation joins</a>, then Fulcro gives you an additional bonus:
A helper you can use with your mutation to indicate that the given mutation return value
should be <strong>further integrated</strong> into your app state. By default, you&#8217;re just returning an entity. The data gets
normalized, but there is no further linkage into your app state.</p>
</div>
<div class="paragraph">
<p>You will sometimes want to pepper idents around your app state as a result of the return. You can add this
kind of targeting through the AST in the remote (not available at the UI layer):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation f [params]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>)
  (remote [{<span class="symbol">:keys</span> [ast state]}]
    (<span class="keyword">-&gt;</span> ast
      (m/returning state Item)
      (m/with-target [<span class="symbol">:path</span> <span class="symbol">:to</span> <span class="symbol">:field</span>])))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Special targets are also supported:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation f [params]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>)
  (remote [{<span class="symbol">:keys</span> [ast state]}]
    (<span class="keyword">-&gt;</span> ast
      (m/returning state Item) <span class="comment">; Returns something of type Item, will merge/normalize</span>
      (m/with-target           <span class="comment">; Place the ident pointing to the loaded item in app state at additional locations</span>
        (df/multiple-targets
          (df/append-to [<span class="symbol">:table</span> <span class="integer">3</span> <span class="symbol">:field</span>])
          (df/prepend-to [<span class="symbol">:table-2</span> <span class="integer">4</span> <span class="symbol">:field</span>]))))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: DEMO</p>
</div>
</div>
<div class="sect3">
<h4 id="_augmenting_the_merge"><a class="anchor" href="#_augmenting_the_merge"></a><a class="link" href="#_augmenting_the_merge">9.9.4. Augmenting the Merge</a></h4>
<div class="paragraph">
<p>There is also a sledge-hammer approach to return values: plug into Fulcro&#8217;s merge routines. This is an advanced technique
and is not recommended for most applications.</p>
</div>
<div class="paragraph">
<p>Fulcro gives a hook for a <code>mutation-merge</code> function that you can install when you&#8217;re creating the application. If you
use a multi-method, then it will make it easier to co-locate your return value logic near the client-local mutation itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defmulti</span> <span class="function">return-merge</span> (<span class="keyword">fn</span> [state mutation-sym return-value] mutation-sym))
(<span class="keyword">defmethod</span> <span class="function">return-merge</span> <span class="symbol">:default</span> [s m r] s)

(new-fulcro-client <span class="symbol">:mutation-merge</span> return-merge <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you should be able to write your return merging logic next to the mutation that it goes with. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defmethod</span> <span class="function">m/mutate</span> 'some-mutation [env k p] {<span class="symbol">:remote</span> <span class="predefined-constant">true</span> })
(<span class="keyword">defmethod</span> <span class="function">app/return-merge</span> 'some-mutation [state k returnval] <span class="keyword">..</span><span class="keyword">.</span>new-state.<span class="keyword">..</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the API is a bit different between the two: mutations get the app state <strong>atom</strong> in an environment, and you
<code>swap!</code> on that atom to change state. The return merge function is <strong>in an already running</strong> <code>swap!</code> during the state merge
of the networking layer. So, it is a function that takes the application state as a <strong>map</strong> and must
return a new state as a <strong>map</strong>.</p>
</div>
<div class="paragraph">
<p>This technique is fully general in terms of handling arbitrary return values, but is limited in that your only recourse
is to merge the data into you app state. Of course, since your rendering is a pure function of app state this means you
can, at the very least, visualize the result.</p>
</div>
<div class="paragraph">
<p>This works, but is not the recommended approach because it is very easy to make mistakes that affect your entire
application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Mutation merge happens after server return values have been merged; however, it does happen <strong>before</strong> tempid remapping.
Just work with the tempids, and they will be rewritten once your merge is complete.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</dt>
<dt class="hdlist1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</dt>
<dd>
<p>OLD CONTENT STARTS BELOW</p>
</dd>
<dt class="hdlist1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</dt>
<dt class="hdlist1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</dt>
<dt class="hdlist1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</dt>
<dt class="hdlist1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</dt>
<dd>
<p>=== API Modules (OLD)</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The <code>fulcro.server</code> namespace&#8217;s server&#8217;s primary contribution to your server is the API handling. Everything else is
pretty much up to you to construct. The general structure of your server will end up as shown in the following
diagram.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/svg/modular-server.svg" alt="modular server">
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll write (or find as a library) each Module (API Handler). You&#8217;ll also construct whatever sort of network
pipeline (Web Server) and join that all together using the <code>com.stuartsierra/component</code> library. The primary thing
the Fulcro code does for you in this diagram is composes the Modules together into a <strong>single</strong> middleware component
that you can inject and use in your own network stack (e.g. Ring).</p>
</div>
<div class="paragraph">
<p>The primary requirement is that the <code>server/wrap-transit-params</code> and <code>server/wrap-transit-response</code> be in front
of this compose API to ensure that the EDN can be encoded/decoded across the network.</p>
</div>
<div class="paragraph">
<p>See Developer&#8217;s Guide for more details.</p>
</div>
<div class="sect4">
<h5 id="_accessing_server_components_old"><a class="anchor" href="#_accessing_server_components_old"></a><a class="link" href="#_accessing_server_components_old">Accessing Server Components (OLD)</a></h5>
<div class="paragraph">
<p>The modular server uses the Stuart Sierra component library. This allows you to inject any component into any other.
The one place where there needs to be a bit of special support is in the API modules themselves. The modular server
support of API Modules will automatically merge the Module&#8217;s state with the parser environment. This means that
any components that are injected into the API module component will appear in the <code>env</code> of the read/mutate methods
for that module.</p>
</div>
</div>
<div class="sect4">
<h5 id="_library_modules_composition_old"><a class="anchor" href="#_library_modules_composition_old"></a><a class="link" href="#_library_modules_composition_old">Library Modules (composition) (OLD)</a></h5>
<div class="paragraph">
<p>The modular server allows you to install more than one API handler. Remember that the expression parser will invoke
the API once for each "top-level" expression (root query key or mutation). The modular server composes modules together
leveraging these facts in the following manner:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For each expression:</p>
</li>
<li>
<p>Try the modules in declared order</p>
</li>
<li>
<p>Use the first non-nil result</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thus, to ensure that your modules are composable you should ensure that your API&#8217;s "default" handler returns nil when
it doesn&#8217;t recognize something.</p>
</div>
<div class="paragraph">
<p>This is <strong>not</strong> the default behavior for the built-in server mutation handling. If you plan to compose API handlers and
you&#8217;re using the built-in server-read and server-mutation, you should install default handlers that return nil instead
of throwing an error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defmethod</span> <span class="function">server/server-mutate</span> <span class="symbol">:default</span> [env k p] <span class="predefined-constant">nil</span>)
(<span class="keyword">defmethod</span> <span class="function">server/read-root</span> <span class="symbol">:default</span> [env k p] <span class="predefined-constant">nil</span>)
(<span class="keyword">defmethod</span> <span class="function">server/read-entity</span> <span class="symbol">:default</span> [env <span class="keyword">type</span> id p] <span class="predefined-constant">nil</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Libraries that provide full-stack operations can simple provide an API module that has the same attributes. For example,
say you wanted to create a Fulcro Image Library plug-in that came with server and client components. You could write
the server-side as a module that handles just your reads and mutations, and allow your users to install it into
the module chain.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_full_stack_operations_needs_combined_with_earlier_chapter"><a class="anchor" href="#_full_stack_operations_needs_combined_with_earlier_chapter"></a><a class="link" href="#_full_stack_operations_needs_combined_with_earlier_chapter">10. Full-Stack Operations (NEEDS COMBINED WITH EARLIER CHAPTER)</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Full stack operation is where Fulcro really shines. All of the primitives you&#8217;ve learned for the client application
not only solve some real client-side issues, they also form the basis for the data-driven story of server interactions.
You&#8217;ll see that full-stack operations very much mirror client local ones in a way that makes full-stack development a breeze.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To those of you with REST APIs. Fulcro can be made to work with REST, but you&#8217;re in for some work. The full
stack data-driven architecture is often completely at odds with REST. You will end up writing a network layer on your
client that translates graph queries to one or more REST calls, and then combines those results into a tree of response
data that you can pass back up the chain. The UI is wonderfully protected from this nastiness, but when possible you
will find the most leverage by writing the server to support the graph queries directly (consider your REST API a legacy
thing that your new UI doesn&#8217;t want/need). If you have to access 3rd-party REST APIs, then you&#8217;re kind of stuck
with making the interface layer.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_theory_of_operation"><a class="anchor" href="#_theory_of_operation"></a><a class="link" href="#_theory_of_operation">10.1. Theory of Operation</a></h3>
<div class="sect3">
<h4 id="_think_in_graphs"><a class="anchor" href="#_think_in_graphs"></a><a class="link" href="#_think_in_graphs">10.1.1. Think In Graphs</a></h4>
<div class="paragraph">
<p>The first thing you should continue getting used to is the fact that everything works on your graph database concept
of the client database. The connections within this graph have two possible realities: the graph that corresponds to your
UI, and the graph that corresponds to the schema of your actual persistence engine (database).</p>
</div>
<div class="paragraph">
<p>Sub-portions of these graphs (the persistent parts) will very often match perfectly. For example, "a person has a phone
number" is almost certainly modelled in the same sort of relational way in the UI and the database.</p>
</div>
<div class="paragraph">
<p>But we have all sorts of ways we&#8217;d like to view data. Perhaps we&#8217;d like to view "all the people who&#8217;ve ever had this
phone number". That is something we can very simply represent with a UI graph, but may not be trivial to pull from
our database.</p>
</div>
<div class="paragraph">
<p>In general, there are a few approaches to resolving our graph differences:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the query parser on the server to piece together data based on the graph of the query.</p>
</li>
<li>
<p>Ask the server for exactly what you want, using an invented well-known "root" keyword, and hand-code the database
code to create the UI-centric view.</p>
</li>
<li>
<p>Ask the server for something it can easily provide with the persistence graph, and morph it on the client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The first two have the advantage of making the client blissfully unaware of the server schema. It just asks for what
it needs, and someone on the server programming team is stuck with satisfying the query. This is the down-side: the number
of possible UI-centric queries could become quite large. Theoretically a parser solution makes this <strong>more</strong> tractable
than a hand-coded variant, but in practice the parser is hard to make general in a way that allows UI developers to just
run willy-nilly queries and get what they want.</p>
</div>
<div class="paragraph">
<p>In the example of "people who&#8217;ve had this phone number", the graph would be phone-number centric. Maybe
<code>[:db/id :phone/number {:phone/historical-owners (prim/get-query Person)}]</code>. There probably isn&#8217;t a graph edge in the
real database called <code>:phone/historical-owners</code>.  One could write parser code that understood this particular edge,
and did the logic. In this case, that really isn&#8217;t even that hard and may be a good choice.</p>
</div>
<div class="paragraph">
<p>Fulcro gives you an easy-to-access additional option: morph something the server can easily provide (on the
real graph without custom code). Issuing
<code>(load this :people Person {:params {:with-phone-number n} :post-mutation 'generate-historical-phone-view})</code> would allow
you to simply support an additional parameter on the graph walk of your normal schema to filter it down to people that have
had a specific phone number. Then the post-mutation is used to create the UI graph you&#8217;re looking for.</p>
</div>
</div>
<div class="sect3">
<h4 id="_targeting_the_root_of_your_graph"><a class="anchor" href="#_targeting_the_root_of_your_graph"></a><a class="link" href="#_targeting_the_root_of_your_graph">10.1.2. Targeting the Root of Your Graph</a></h4>
<div class="paragraph">
<p>The main way of obtaining data from the server is a call to <code>load</code>. By default, <code>load</code> targets the loaded data to
the root of your graph, though it does normalize the result (so you typically just end up with an ident or list of
idents at the root key).</p>
</div>
<div class="paragraph">
<p><code>(load this :root-keyword Component)</code> is the most basic form of load. This will issue the server query
<code>[{:root-keyword (prim/get-query Component)}]</code>. It generates the query for you so that things are guaranteed to be
well-structured. In particular, <code>post-mutations</code> are typically interested in just one sub-graph, and targeting loads
to alternate places in your graph is also made easier.</p>
</div>
<div class="paragraph">
<p>If you issue more than one <code>load</code> in the same thread of execution (event handler, for example), then the loads
<strong>will</strong> be combined, when possible, into a single network interaction. In other words, network processing does not proceed
until you release the UI thread.</p>
</div>
</div>
<div class="sect3">
<h4 id="_targeting_an_alternate_node"><a class="anchor" href="#_targeting_an_alternate_node"></a><a class="link" href="#_targeting_an_alternate_node">10.1.3. Targeting an Alternate Node</a></h4>
<div class="paragraph">
<p>The vast majority of your loads will not belong at the root of your graph. Fortunatly, your database is normalized, so
all of your UI components are in top-level tables (at some ident path). The <code>load</code> function includes an option that
allows you to take advantage of this convenient fact to place the resulting (normalized) graph result in some
field of some component. It&#8217;s as simple as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">load</span> this <span class="symbol">:root-keyword</span> Component {<span class="symbol">:target</span> [<span class="symbol">:table</span> id <span class="symbol">:field</span>]})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actual operation of this load is to run the query, place the (normalized) result on the root node (temporarily at :root-keyword)
and then move the resulting ident (or vector of idents) at that root-level key to the desired location.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Because the value does briefly appear on the root node, we recommend that you namespace the root keyword to
avoid collisions with real root-node data.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_ui_only_query_elements"><a class="anchor" href="#_ui_only_query_elements"></a><a class="link" href="#_ui_only_query_elements">10.1.4. UI-Only Query Elements</a></h4>
<div class="paragraph">
<p>The general pure rendering model encourages you to put as much state as possible into your client database, including
data that is of concern only to the UI. Server interactions pose a problem here: you don&#8217;t want to have to worry about
UI-specific parts of the UI query being sent to the server on data-driver interactions.</p>
</div>
<div class="paragraph">
<p>Fulcro has you covered. If you have query elements that have nothing to do with server interaction, just use keywords
in the <code>ui</code> namespace. Such keywords will be automatically omitted from the network query.</p>
</div>
</div>
<div class="sect3">
<h4 id="_server_interaction_order"><a class="anchor" href="#_server_interaction_order"></a><a class="link" href="#_server_interaction_order">10.1.5. Server Interaction Order</a></h4>
<div class="paragraph">
<p>Unless you mark queries as parallel (an option to <code>load</code>), Fulcro will serialize requests. Two different <strong>events</strong> that
queue mutations or loads will be processed in order. For example The user clicks on something and you trigger two loads. Those
two loads are combined and sent. The user clicks on something else and that handler queues two more loads. The latter two
loads will not start over the network until the first load sequence completes. This ensures that you don&#8217;t get out-of-order
server execution. This is a distributed system, so it is possible for a second request to hit a less congested server than
the first and get processed out of order. This kills your ability to reason about your program, so the default behavior in
Fulcro is to ensure that server interactions happen in the same order as on the client.</p>
</div>
<div class="paragraph">
<p>If you combine mutations and reads in the same event processing (before giving up the thread), then Fulcro also ensures
that remote <strong>mutations</strong> go over the wire and complete <strong>before</strong> reads. The idea being that you don&#8217;t want to fetch data
and then immediately make it stale through mutations. This additional detail is also aimed at preventing subtle classes
of application bugs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_server_result_query_merging"><a class="anchor" href="#_server_result_query_merging"></a><a class="link" href="#_server_result_query_merging">10.1.6. Server Result Query Merging</a></h4>
<div class="paragraph">
<p>There is a potential for a data-driven app to create a new class of problem related to merging data. The normalization
guarantees that the data for any number of <strong>views</strong> of the same thing are normalized to the same <strong>node</strong> in the graph.</p>
</div>
<div class="paragraph">
<p>Thus, your <code>PersonListRow</code> view and <code>PersonDetail</code> view might both normalize their data to <code>[:person/by-id id]</code>. Let&#8217;s say
you have a quick list of people on the screen that is paginated and demand-loaded, where each row is a <code>PersonListRow</code>
with query <code>[:db/id :person/name {:person/image (prim/get-query Image)}]</code>. Now say that you can click on one of these
rows and a side-by-side view of that person&#8217;s <code>PersonDetail</code> is shown, but the query for that is a whole bunch of
stuff: name, age, address, phone numbers, etc. A <strong>much</strong> larger query.</p>
</div>
<div class="paragraph">
<p>A naive merge could cause you all sorts of nightmares. For example, Refreshing the list rows would load only name and image,
but if merge overwrote the entire table entry then the current detail view might suddenly empty out!</p>
</div>
<div class="paragraph">
<p>Fulcro provides you with an advanced merging algorithm that ensures these kinds of cases don&#8217;t easily occur. It does an
intelligent merge with the following algorithm:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is a detailed deep merge. Thus, the target table entry is not overwritten, but updated</p>
</li>
<li>
<p>If the query asks for a value but the result does not contain it, then that value <strong>is removed</strong>.</p>
</li>
<li>
<p>If the query didn&#8217;t ask for a value, then the existing value is untouched.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This reduces the problem to one of potential staleness. It is technically possible for an entity in the resulting
database to be in a state that has never existed on the server because of such a partial update. This is considered
to be a better result than the arbitrary UI madness that generalized data-driven overwrite would cause.</p>
</div>
<div class="paragraph">
<p>For example, in the example above, a query for a list row will update the name and image. All of the other details (if already
loaded) would remain the same; however, it is possible that the server has run a mutation that also updated this person&#8217;s
phone number. The detail part of the UI will be showing an updated name and image, but the old phone number. Technically
this "state of Person" has never existed in the server&#8217;s timeline.</p>
</div>
<div class="paragraph">
<p>In practice this isn&#8217;t that big of a deal; however, if switching the UI to an edit mode it is generally a good practice to
bring the entity being edited up-to-date with respect to the server to help prevent problems with your reasoning model.</p>
</div>
</div>
<div class="sect3">
<h4 id="_react_lifecycle_and_load"><a class="anchor" href="#_react_lifecycle_and_load"></a><a class="link" href="#_react_lifecycle_and_load">10.1.7. React Lifecycle and Load</a></h4>
<div class="paragraph">
<p>React lifecycle and Load may not mix well. The UI lifecycle should really not be heavily tied to the
data lifecycle, other than to perhaps trigger a mutation that checks state and conditionally triggers loads. Different
scenarios in React can cause a subtree to unmount and remount, meaning that calls like <code>componentDidMount</code> may fire when
you don&#8217;t expect them to.</p>
</div>
</div>
<div class="sect3">
<h4 id="_incremental_loading"><a class="anchor" href="#_incremental_loading"></a><a class="link" href="#_incremental_loading">10.1.8. Incremental Loading</a></h4>
<div class="paragraph">
<p>Incremental loading is a first-class feature of Fulcro&#8217;s data-driven model. The <code>load</code> primitive allows you to
prune parts of the query to prevent loading those bits. For example, say you have a <code>Blog</code> with <code>Comments</code>. You
probably want to load the blog by itself, and then load the comments later, but the comments are almost
certainly in the UI&#8217;s graph query. So <code>(load app :blog Blog)</code> would ask the server for the blog, comments, etc.</p>
</div>
<div class="paragraph">
<p>The <code>:without</code> option allows you to have the query trimmed so that certain branches are not sent to the server. So,
a call like <code>(load app :blog Blob {:without #{:comments}})</code> will send the same query to the server, but any property
or join (anywhere in the query tree) that is named <code>:comments</code> will not be included.</p>
</div>
<div class="paragraph">
<p>The elided data can later be loaded <strong>in the context</strong> of the component where it appears. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defui Blog
  static prim/IQuery
  (query [this] [<span class="symbol">:db/id</span> <span class="symbol">:blog/content</span> {<span class="symbol">:comments</span> (prim/get-query Comment)}])
  <span class="keyword">..</span><span class="keyword">.</span>
  Object
  (render [this]
    <span class="keyword">..</span><span class="keyword">.</span>
    (dom/button <span class="error">#</span>js {<span class="symbol">:onClick</span> #(df/load-field this <span class="symbol">:comments</span>)} <span class="string"><span class="delimiter">&quot;</span><span class="content">Comments</span><span class="delimiter">&quot;</span></span>)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>does the exact opposite: it finds the ident of the invoking component, and joins it to a query from Blog that contains
nothing <strong>but</strong> <code>:comments</code> (e.g. <code>[{[:blog/by-id 3] [{:comments (prim/get-query Comment)}]}]</code>). This allows the server
to understand exactly which entity to start at (blog 3) and what sub-graph is needed.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_processing_remote_queries"><a class="anchor" href="#_processing_remote_queries"></a><a class="link" href="#_processing_remote_queries">10.2. Processing Remote Queries</a></h3>
<div class="paragraph">
<p>The server-side processing defines two internal multimethods, and joins them together in a parser via a call
to <code>fulcro-parser</code>. You can also write your own custom parser and use that instead. The latter is covered in some detail in the
Developer&#8217;s Guide.</p>
</div>
<div class="paragraph">
<p>All of the techniques you&#8217;d use in a parser can be easily applied using the <code>fulcro-parser</code>, but the entry points are
slightly more well-defined.</p>
</div>
<div class="paragraph">
<p>Fulcro&#8217;s parser hooks queries that join on a simple keyword up to the <code>fulcro.server/read-root</code> multimethod, and those
that join on idents (e.g. <code>load-field</code> and <code>refresh</code>) to <code>fulcro.server/read-entity</code>. For convenience, two
macros give you a slightly easier way to write handlers for these.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Once you&#8217;re in a handler, the <code>env</code> <strong>will</strong> contain the parser (which dispatches ident-based joins to read-entity, and
keyword-based things to <code>read-root</code>). You could also use an alternative hand-constructed parser to continue processing the graph if you
so desire.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_using_code_defquery_root_code_and_code_defquery_entity_code"><a class="anchor" href="#_using_code_defquery_root_code_and_code_defquery_entity_code"></a><a class="link" href="#_using_code_defquery_root_code_and_code_defquery_entity_code">10.2.1. Using <code>defquery-root</code> and <code>defquery-entity</code></a></h4>
<div class="paragraph">
<p>Any load of the form <code>(load this :keyword Component)</code> can be handled with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defquery-root <span class="symbol">:keyword</span>
  (value [env params]
     value-to-send-to-client))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any load of the form <code>(load this [:table/by-id 4] Component)</code> or <code>(load-field this :field)</code> will trigger:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defquery-entity <span class="symbol">:table/by-id</span>
  (value [env id params]
     value-to-send-to-client))</code></pre>
</div>
</div>
<div class="paragraph">
<p>In both cases the <code>env</code> will include things like an AST and parser for processing the remainder of the graph query.</p>
</div>
</div>
<div class="sect3">
<h4 id="_datomic_tips"><a class="anchor" href="#_datomic_tips"></a><a class="link" href="#_datomic_tips">10.2.2. Datomic Tips</a></h4>
<div class="paragraph">
<p>The query syntax is a subset of Datomic Pull syntax. Typically your code on the server can simply find the root set of
entities in question (using the ident or implied entities of the keyword), and then run a <code>pull</code> to get the result.
See the Fulcro Demos for an example of security-checking graph queries to prevent arbitrary graph walks of your database.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sql_tips"><a class="anchor" href="#_sql_tips"></a><a class="link" href="#_sql_tips">10.2.3. SQL Tips</a></h4>
<div class="paragraph">
<p>The <code>fulcro-sql</code> library includes a function that mimics the Datomic <code>pull</code> method against SQL databases. This allows you
to run real data-driven graph queries against your SQL database with a minimal description of the schema. This library
is young and may not support certain complex SQL schemas, but demonstrates the power of the model. The actual algorithm
to run the graph query against an SQL database takes about 250 lines of Clojure.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_remote_mutations_2"><a class="anchor" href="#_remote_mutations_2"></a><a class="link" href="#_remote_mutations_2">10.3. Remote Mutations</a></h3>
<div class="paragraph">
<p>Server-side mutations, when using the <code>fulcro-parser</code> look identical to the client-side ones. You can either
use <code>defmethod</code> on <code>fulcro.server/server-mutate</code> OR you can use a <code>fulcro.server/defmutation</code> that looks
identical to the client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(server/defmutation sample [params]
  (action [env] <span class="keyword">..</span><span class="keyword">.</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The biggest difference is that the <code>env</code> in this case is a server environment that you create through dependency injection
to include things like databases.</p>
</div>
<div class="sect3">
<h4 id="_creating_things_tempid_remapping"><a class="anchor" href="#_creating_things_tempid_remapping"></a><a class="link" href="#_creating_things_tempid_remapping">10.3.1. Creating Things: Tempid Remapping</a></h4>
<div class="paragraph">
<p>Creating things on the client involves the resolution of identity. A new thing on the client will turn into
a persistent thing on the server, and you cannot know in advance what ID(s) to give to those things. Temporary IDs
are the solution. The <code>prim/tempid</code> function generates a specially typed UUID that is transit-compatible, and can be
used in place of a real ID.</p>
</div>
<div class="paragraph">
<p>Server-side mutations that create things can simply return a map with a <code>:tempids</code> key whose value is a map from
<code>tempid</code> to <code>realid</code>. Fulcro will take it from there:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All appearances of the tempid in application state will automatically be rewritten to the real ID</p>
</li>
<li>
<p>Any pending network requests that contain the tempid will be rewritten to use the new real ID</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The only danger is using parallel network requests. If you use the (default) sequential processing of network interactions, then
the fact that pending network requests are tempid remapped means that you don&#8217;t have to do anything special to keep track
of the fact that a temporary ID appears in your client application state. Simply keep evolving your graph optimistically
in response to user events, and let the full-stack interaction (however slow it may be) take care of the rest!</p>
</div>
</div>
<div class="sect3">
<h4 id="_dealing_with_errors"><a class="anchor" href="#_dealing_with_errors"></a><a class="link" href="#_dealing_with_errors">10.3.2. Dealing with Errors</a></h4>
<div class="paragraph">
<p>A distributed system with optimistic updates assumes a relatively robust network where unrecoverable errors are rare. The default
networking of Fulcro assumes LAN quality. This isn&#8217;t always a true assumption, but let&#8217;s first talk about
the kinds of errors we&#8217;ll see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Communication (the operation would succeed, if we could just make the request)</p>
</li>
<li>
<p>Outage</p>
</li>
<li>
<p>Security</p>
</li>
<li>
<p>Bug</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you&#8217;re seeing a security problem that isn&#8217;t a bug, then someone is attacking your servers. There is nothing to do in the UI.
Hard fail at the server and move on with your life. Why write UI code for a case that should never be triggered by the UI.</p>
</div>
<div class="paragraph">
<p>If it is a true bug, then there isn&#8217;t much you can do about it either. It is a bug. It is random and affects things in
ways you cannot possibly imagine. You didn&#8217;t even detect it (or you would have fixed it). So again: nothing you can
reasonably code to help.</p>
</div>
<div class="paragraph">
<p>The final two, outage and communication, are technically something you can recover from. In both cases your biggest problem
is figuring out how your client and server state might differ. Again, you&#8217;re in a distributed system. Did that mutation
partially complete?</p>
</div>
<div class="paragraph">
<p>If your application can assume reasonably reliable networking, then your error handling can be a relatively small amount of
code. Outages and network problems will be rare, and at worst you throw up a dialog that says you&#8217;ve had an unrecoverable
error and the user hits reload on their browser. If this happens to users once or twice a year, it isn&#8217;t going to hurt you.</p>
</div>
<div class="paragraph">
<p>If your users are likely using your software from a phone on a subway, then you have a completely different issue.</p>
</div>
<div class="paragraph">
<p>Fortunately, Fulcro actually makes handling this case relatively easy as well. Here is what you can do:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Write a custom networking implementation for the client that detects the <strong>kind</strong> of error, and retries recoverable ones
until they succeed. Possibly with exponential backoff. (If an infinite loop happens, the user will eventually hit reload.)</p>
</li>
<li>
<p>Make your server mutations idempotent, so that a client can safely re-apply one that fails.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The default fulcro networking does not do retries because without the idempotent guarantee it isn&#8217;t safe.</p>
</div>
<div class="paragraph">
<p>The optimistic updates of Fulcro and the in-order server execution means that "offline" operation is actually quite
tractable. If programmed this way, your error handling becomes isolated almost entirely to the networking layer. Of course,
if the user navigates to a screen that needs server data, they will just have to wait. Writing UI code that possibly has
lifecycle timers to show progress updates will improve the overall feel, but the correctness will be there with a fairly
small number of additions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_returning_a_value"><a class="anchor" href="#_returning_a_value"></a><a class="link" href="#_returning_a_value">10.3.3. Returning a Value</a></h4>
<div class="paragraph">
<p>The optimistic update nature of Fulcro means that return values from mutations are rare. The client generates everything
about a mutation, including the (temporary) ID of new entities. However, there are cases where a return value is
desirable.</p>
</div>
<div class="paragraph">
<p>The problem is the fact that a return value doesn&#8217;t have a query! Remember, you need to normalize any data that comes
from the server into the proper place in the app state. That is the model. A return value has "noplace to go" by default.</p>
</div>
<div class="paragraph">
<p>There are two ways of dealing with this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If there is a server-based session: place the data in the session, and query for it after the mutation. Remember that mutations
are always ordered before reads. So a mutation/load combo can server as a "call a function" and then "read the result".</p>
</li>
<li>
<p>Register a mutation merge function.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Option (1) should be pretty obvious by now, but option (2) is new. There is an option when creating a fulcro client
called <code>mutation-merge</code>. You give it a function (typically a multimethod) of the form <code>(fn [state-map mutation-symbol return-value-from-server] state-map')</code>.
Note that this is a state-map, not an atom. You must return the new state of the entire app (if you return nil, you&#8217;ll wipe out your
entire UI database). This allows you to use functions like <code>merge</code>, <code>tree-&gt;db</code>, and such to do whatever is necessary with the
return value with respect to application state.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_parsing"><a class="anchor" href="#_advanced_parsing"></a><a class="link" href="#_advanced_parsing">11. Advanced Parsing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>See the Developer&#8217;s Guide for details on advanced parsing.</p>
</div>
<div class="sect2">
<h3 id="_using_advanced_parsing_on_the_client"><a class="anchor" href="#_using_advanced_parsing_on_the_client"></a><a class="link" href="#_using_advanced_parsing_on_the_client">11.1. Using Advanced Parsing on the Client</a></h3>
<div class="paragraph">
<p>Fulcro allows you to augment the built-in query parser. It uses the exact same techniques discussed in the Developer&#8217;s
Guide on advanced server query processing; and it is similar in that you must start at the root of the query
(even though you may only want to augment something rather deep in the query tree).</p>
</div>
<div class="paragraph">
<p>This is a limitation of how queries are processed. Fulcro normally runs the query through <code>db-&gt;tree</code>, which attempts to
fill the entire result. If you supply a <code>:read-local</code> function during client construction, then your <code>:read-local</code> will
get first shot at each element of the query that was submitted. Note that the query <strong>can start</strong> at an ident.
If your <code>read-local</code> function returns <code>nil</code> for an element, then the normal Fulcro
processing takes place on that sub-query. If your <code>read-local</code> returns a value, then that is all the processing that
is done for that sub-tree. Thus, custom client parsing always requires you to process sub-trees of the query, not just
individual elements.  Of course, you can use <code>db-&gt;tree</code> at any time to "finish out" some subquery against real data.</p>
</div>
<div class="paragraph">
<p>This has the advantage of letting you dynamically fill queries without having to have a concrete representation of the
graph in your database. This can be helpful if you have some rapidly changing data (e.g. updated by a web worker) and
some views of that data that would otherwise be hard to keep up-to-date.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ui_routing"><a class="anchor" href="#_ui_routing"></a><a class="link" href="#_ui_routing">12. UI Routing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>See the Developer&#8217;s Guide and the Fulcro Template.</p>
</div>
<div class="sect2">
<h3 id="_see_the_developer_s_guide"><a class="anchor" href="#_see_the_developer_s_guide"></a><a class="link" href="#_see_the_developer_s_guide">12.1. See the Developer&#8217;s Guide.</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_forms"><a class="anchor" href="#_forms"></a><a class="link" href="#_forms">13. Forms</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_see_the_developer_s_guide_2"><a class="anchor" href="#_see_the_developer_s_guide_2"></a><a class="link" href="#_see_the_developer_s_guide_2">13.1. See the Developer&#8217;s Guide.</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_server_side_rendering"><a class="anchor" href="#_server_side_rendering"></a><a class="link" href="#_server_side_rendering">14. Server-side Rendering</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>See the Developer&#8217;s Guide and the Fulcro Template.</p>
</div>
<div class="sect2">
<h3 id="_generating_initial_state"><a class="anchor" href="#_generating_initial_state"></a><a class="link" href="#_generating_initial_state">14.1. Generating Initial State</a></h3>
<div class="paragraph">
<p>When your application is starting you will need data in the app database for the UI to query. There are three ways
to do this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Hand-code a normalized graph database</p>
</li>
<li>
<p>Hand-code a tree of data that matches the initial UI query, and let it be auto-normalized on start</p>
</li>
<li>
<p>(recommended) co-locate initial state with components.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The first two are legal options when creating the client application. You can use the <code>:initial-state</code> option. If
you pass a map in an atom, then it will be treated as an already-normalized database. If you pass a plain
map it will be considered a UI tree of data and will be auto-normalized. The first two exist mainly for legacy
reasons, although they are handy when using devcards (the devcard&#8217;s atom is used to hold state so you can see it
with data inspection).</p>
</div>
<div class="paragraph">
<p>The third option is <strong>definitely</strong> the option you should use. It enable easy UI refactoring, and it by far the
easiest and most reliable way to generate your application&#8217;s initial state database.</p>
</div>
<div class="paragraph">
<p>Simply statically implement the fulcro.client.primitives/InitialAppState protocol and compose that to the root
component of your UI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defui Component
  static prim/InitialAppState
  (initial-state [cls params] {<span class="symbol">:x</span> <span class="integer">1</span>})
  static prim/IQuery
  (query [this] [<span class="symbol">:x</span>])
  Object
  (render [this] <span class="keyword">..</span><span class="keyword">.</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Composing that into it&#8217;s parent (repeated up until root) will result in the construction of the correct initial tree of data at root:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defui Parent
  static prim/InitialAppState
  (initial-state [cls params] {<span class="symbol">:comp</span> (prim/get-initial-state Component {}})
  static prim/IQuery
  (query [this] [{<span class="symbol">:comp</span> (prim/get-query Component)}])
  Object
  (render [this] <span class="keyword">..</span><span class="keyword">.</span>))</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_alternate_union_branches"><a class="anchor" href="#_alternate_union_branches"></a><a class="link" href="#_alternate_union_branches">14.1.1. Alternate Union Branches</a></h4>
<div class="paragraph">
<p>If your Initial UI uses union queries on a to-one relation (e.g. for UI routing), then you may want initial
state for all of the branches, but only one branch will be the <strong>current</strong> branch, meaning that the initial
tree will only be able to list the default one in state.</p>
</div>
<div class="paragraph">
<p>Fulcro will auto-detect <code>InitialAppState</code> on the alternate branches and place those in the database. This ensures
that your initial application state will be complete, even in the presence of this complication.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Networking"><a class="anchor" href="#Networking"></a><a class="link" href="#Networking">15. Networking</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_adding_additional_remotes"><a class="anchor" href="#_adding_additional_remotes"></a><a class="link" href="#_adding_additional_remotes">15.1. Adding Additional Remotes</a></h3>
<div class="paragraph">
<p>Give a single FulcroNetworking object to <code>:networking</code> (which will be known as <code>:remote</code>), or a map of keyword
remote names whose values are objects the implement FulcroNetworking. Each remote that you add will be usable
through the <code>:remote</code> parameter of loads, and that remote&#8217;s name in mutations.</p>
</div>
<div class="paragraph">
<p>For example, if you add a remote named <code>:microservice-one</code>, then you could query it with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">load</span> this <span class="symbol">:thing</span> Things {<span class="symbol">:remote</span> <span class="symbol">:microservice-one</span>})</code></pre>
</div>
</div>
<div class="paragraph">
<p>and send it a mutation with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defmutation something [params]
  (microservice-one [env] <span class="predefined-constant">true</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Loads must be directed at a single remote, but mutations can technically be sent to as many as you&#8217;d like (though there
is no built-in coordination of them).</p>
</div>
</div>
<div class="sect2">
<h3 id="_creating_custom_remote_handlers"><a class="anchor" href="#_creating_custom_remote_handlers"></a><a class="link" href="#_creating_custom_remote_handlers">15.2. Creating Custom Remote Handlers</a></h3>
<div class="paragraph">
<p>You can create custom "remote" handlers for Fulcro. Usually this is to talk to remote systems, but you can
also leverage them to talk to side-effecting subsystems of the client app, simulate server interactions
(for prototyping), and more.</p>
</div>
<div class="paragraph">
<p>The basic task for doing this is to implement the <code>FulcroNetwork</code> protocol and pass an instance of that
object as a <code>:remote</code> when creating your client.</p>
</div>
<div class="paragraph">
<p>There are only two methods in the protocol: <code>send</code> and <code>start</code>. The latter is called when the application is starting
on the client. The latter is called whenever there is work for the remote to do.</p>
</div>
<div class="sect3">
<h4 id="_optional_sequential_operation"><a class="anchor" href="#_optional_sequential_operation"></a><a class="link" href="#_optional_sequential_operation">15.2.1. Optional Sequential Operation</a></h4>
<div class="paragraph">
<p>When you create a client component to provide networking you can optionally implement the <code>NetworkBehavior</code> protocol,
which has a single method <code>(serialize-requests? [this])</code>. The default is to serialize them, but if you implement this
protocol and return false, then Fulcro&#8217;s plumbing will not manage request queuing, and will just call <code>send</code> any time
there is anything in the queue.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementing_send"><a class="anchor" href="#_implementing_send"></a><a class="link" href="#_implementing_send">15.2.2. Implementing Send</a></h4>
<div class="paragraph">
<p>The send method of the <code>FulcroNetwork</code> protocol is given <code>[this edn done-callback error-callback]</code>. <code>this</code> is just
the instance of your implementation. The <code>edn</code> is the raw Fulcro query/mutation that was issued. The two callback
functions are what you call when the request is complete. You must call one (and only one) of them exactly once
with the response (or error).</p>
</div>
<div class="paragraph">
<p>The error callback, if called, will trigger and fallbacks, will update the (optional) load markers for the
request with an error state.</p>
</div>
<div class="paragraph">
<p>The done callback, if called, expects to be given a response that matches the shape of the request. This is always
a map that contains the top-level keys that were in the query/mutation. Mutations are keyed by the symbol of the mutation.</p>
</div>
<div class="paragraph">
<p>So, a query like this <code>[:a]</code> should call done with a map like <code>{:a 1}</code>. A mutation like <code>[(f)]</code> should call
the done callback with something like <code>{'f 42}</code>. The only automatically-handled return value from mutations
are tempid remappings.</p>
</div>
</div>
<div class="sect3">
<h4 id="_merging_state"><a class="anchor" href="#_merging_state"></a><a class="link" href="#_merging_state">15.2.3. Merging State</a></h4>
<div class="paragraph">
<p>Fulcro remembers the query that was used when calling <code>send</code>. Therefore it can auto-normalize the server&#8217;s tree-like
response to a graph query. It is perfectly legal to alter this by passing a UI query to the <code>done-callback</code> as
an additional argument. Doing so will cause the back-end to use the specified query for normalization instead of
the original outgoing query.</p>
</div>
</div>
<div class="sect3">
<h4 id="_error_handling"><a class="anchor" href="#_error_handling"></a><a class="link" href="#_error_handling">15.2.4. Error Handling</a></h4>
<div class="paragraph">
<p>The general philosophy of a Fulcro application is that optimistic updates are not even triggered on the client
unless they expect to succeed on the server. In other words, you write the application in such a way that operations cannot be triggered
from the UI unless you&#8217;re certain that a <strong>functioning server</strong> will execute them. A server should not throw an exception
and trigger a need for network error handling unless there is a real, non-recoverable situation.</p>
</div>
<div class="paragraph">
<p>If this is true, then a functioning server <strong>does</strong> need to do sanity checking for security reasons, but in general you
don&#8217;t need to give friendly errors when those checks fail: you should assume they are attempted hacks. Other serious
problems are similar: there is usually nothing you can do but throw an exception and let the user contact support.
Exceptions to this rule certainly exist, but they are few and far between.</p>
</div>
<div class="paragraph">
<p>There are some cases where the server has to be involved in a validation interaction non-optimistically. Login is a great
example of this. However, invalid credentials on login <strong>should not be treated as an error</strong>! It should be treated as
a response to a question. "Can I log in with these credentials?". Yes or no. This is a <strong>query</strong> and <strong>response</strong>, <strong>not</strong> an
error handling interaction. Thus, something like login can be handled with a query (to get the answer) and post-mutation
(to update the screen with an error or change the route on response).</p>
</div>
<div class="paragraph">
<p>This philosophy eases the overhead in general application programming. You need not write a bunch of code in the UI
that gives a nice friendly message for every kind of error that occurs. If an error occurs, you can pretty much assume
it is either a bug, or a real outage. In both cases, there isn&#8217;t a lot you can do that will work "well" for the user. If
it is a bug, then you really have no chance of predicting what will fix it, otherwise you would have already fixed the
bug. If it&#8217;s an outage, again you have no way of knowing what has gone wrong. Is the user&#8217;s WiFi out of range? Did your
database take a dump?</p>
</div>
<div class="paragraph">
<p>So, most error conditions can be treated as a problem that needs fairly radical recovery. Since you&#8217;re working with
a distributed application the recovery from errors is a difficult task. There is no sugar-coating it. What in your
client database is now corrupt or out-of-sync?</p>
</div>
<div class="paragraph">
<p>In general, it is recommended that full-stack error handling use the global error handler that is configured during
the setup of your client application (you have to explicitly configure networking). This function can update application
state to show some kind of top-level modal dialog that describes the problem, possibly allows the user to submit
application history (for support viewer) to your servers, and then re-initializes the application in some way.</p>
</div>
<div class="paragraph">
<p>You can, of course, get pretty creative with the re-initialization. For example, say you write screens so that they will
refresh their persistent data whenever it is older than some amount of time, and write it so all entities have a timestamp.
You could walk the state and "expire" all of the timestamps, and then close the dialog. Your lifecycle methods on the
components could be set up to check for the expiration, which in turn would trigger loads. If the server is really having
problems then the worst case is that the dialog pops back up telling them there is still a problem.</p>
</div>
</div>
<div class="sect3">
<h4 id="_supporting_progress_updates"><a class="anchor" href="#_supporting_progress_updates"></a><a class="link" href="#_supporting_progress_updates">15.2.5. Supporting Progress Updates</a></h4>
<div class="paragraph">
<p>The networking layer of Fulcro will, by default, place load markers at the target location for any data that is
scheduled to be loaded or is currently loading. It also updates a global loading marker. This gives you ample
opportunities to give the user feedback about network activity.</p>
</div>
<div class="paragraph">
<p>However, many applications have custom desires beyond showing a busy indicator in place of the data being loaded.</p>
</div>
<div class="sect4">
<h5 id="_alternative_busy_indicator"><a class="anchor" href="#_alternative_busy_indicator"></a><a class="link" href="#_alternative_busy_indicator">Alternative Busy Indicator</a></h5>
<div class="paragraph">
<p>One common pattern is for the current data to stay in-place while the new data is loading, and for a busy
marker (for <strong>that</strong> data, not for global network activity) to show in the UI. In this case what you want is a load
marker for the data, but you don&#8217;t want it to appear at the target.</p>
</div>
<div class="paragraph">
<p>The best way to support this use-case is to target the data to a temporary location in the UI, where you want to show
the load marker. Then use a post-mutation to re-target it when loading is done.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(df/load <span class="symbol">:person</span> Person {<span class="symbol">:params</span> {<span class="symbol">:id</span> <span class="integer">1</span>} <span class="symbol">:target</span> [<span class="symbol">:panel</span> <span class="symbol">:person-editor</span> <span class="symbol">:temp/person</span>]
                         <span class="symbol">:post-mutation</span> `move-temp-to-editor})</code></pre>
</div>
</div>
<div class="paragraph">
<p>where the <code>PersonEditor</code> would need to query for <code>:temp/person</code> (the load target) as well as <code>:person-to-edit</code>
(the field that represents the actual thing being edited). When <code>:temp/person</code> has a load marker, show the busy indicator.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_interfacing_with_rest_servers"><a class="anchor" href="#_interfacing_with_rest_servers"></a><a class="link" href="#_interfacing_with_rest_servers">15.2.6. Interfacing with REST Servers</a></h4>
<div class="paragraph">
<p>See the final sections of the GettingStarted guide in the Fulcro repository on Git Hub.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_websockets"><a class="anchor" href="#_websockets"></a><a class="link" href="#_websockets">16. Websockets</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Fulcro comes with support for websockets.</p>
</div>
<div class="sect2">
<h3 id="_client_side_setup"><a class="anchor" href="#_client_side_setup"></a><a class="link" href="#_client_side_setup">16.1. Client-side Setup</a></h3>

</div>
<div class="sect2">
<h3 id="_server_side_setup"><a class="anchor" href="#_server_side_setup"></a><a class="link" href="#_server_side_setup">16.2. Server-side Setup</a></h3>

</div>
<div class="sect2">
<h3 id="_server_push"><a class="anchor" href="#_server_push"></a><a class="link" href="#_server_push">16.3. Server Push</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_internationalization"><a class="anchor" href="#_internationalization"></a><a class="link" href="#_internationalization">17. Internationalization</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_basic_strings"><a class="anchor" href="#_basic_strings"></a><a class="link" href="#_basic_strings">17.1. Basic Strings</a></h3>

</div>
<div class="sect2">
<h3 id="_formatted_strings"><a class="anchor" href="#_formatted_strings"></a><a class="link" href="#_formatted_strings">17.2. Formatted Strings</a></h3>

</div>
<div class="sect2">
<h3 id="_strings_in_variables"><a class="anchor" href="#_strings_in_variables"></a><a class="link" href="#_strings_in_variables">17.3. Strings in Variables</a></h3>

</div>
<div class="sect2">
<h3 id="_extracting_strings"><a class="anchor" href="#_extracting_strings"></a><a class="link" href="#_extracting_strings">17.4. Extracting Strings</a></h3>

</div>
<div class="sect2">
<h3 id="_generating_translations"><a class="anchor" href="#_generating_translations"></a><a class="link" href="#_generating_translations">17.5. Generating Translations</a></h3>

</div>
<div class="sect2">
<h3 id="_modular_locale_loading"><a class="anchor" href="#_modular_locale_loading"></a><a class="link" href="#_modular_locale_loading">17.6. Modular Locale Loading</a></h3>

</div>
<div class="sect2">
<h3 id="_polyfills"><a class="anchor" href="#_polyfills"></a><a class="link" href="#_polyfills">17.7. Polyfills</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_devcards_2"><a class="anchor" href="#_devcards_2"></a><a class="link" href="#_devcards_2">18. Devcards</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_developing_component_ui"><a class="anchor" href="#_developing_component_ui"></a><a class="link" href="#_developing_component_ui">18.1. Developing Component UI</a></h3>

</div>
<div class="sect2">
<h3 id="_developing_active_screens"><a class="anchor" href="#_developing_active_screens"></a><a class="link" href="#_developing_active_screens">18.2. Developing Active Screens</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_support_viewer"><a class="anchor" href="#_support_viewer"></a><a class="link" href="#_support_viewer">19. Support Viewer</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_submitting_support_requests"><a class="anchor" href="#_submitting_support_requests"></a><a class="link" href="#_submitting_support_requests">19.1. Submitting Support Requests</a></h3>

</div>
<div class="sect2">
<h3 id="_supplying_state_to_the_support_viewer"><a class="anchor" href="#_supplying_state_to_the_support_viewer"></a><a class="link" href="#_supplying_state_to_the_support_viewer">19.2. Supplying State to the Support Viewer</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_code_splitting_modules"><a class="anchor" href="#_code_splitting_modules"></a><a class="link" href="#_code_splitting_modules">20. Code Splitting (modules)</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clojurescript 1.9.854+ has expanded support for code splitting (older versions do too, but require a bit more code). The
main things you need to do to accomplish code splitting are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure your main app doesn&#8217;t don&#8217;t accidentally refer to things in the module. Hard dependencies make it
impossible to split the code.</p>
</li>
<li>
<p>Define a mechanism whereby your loaded code can find and install itself into the application.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Since you&#8217;re working with a data-driven application with components that have queries, this typically means that you&#8217;re
going to have to have the newly loaded components somehow modify the main application&#8217;s query to tie them in. Also,
since parents technically render children, you&#8217;re going to have to have an extensible mechanism for that as well.</p>
</div>
<div class="paragraph">
<p>To demonstrate one technique we&#8217;ll assume that what you load is a "section" of the application that can be routed to. The
main application knows to provide the link, but it does not yet have the rendering factory, class, or query.</p>
</div>
<div class="sect2">
<h3 id="_the_source_structure"><a class="anchor" href="#_the_source_structure"></a><a class="link" href="#_the_source_structure">20.1. The Source Structure</a></h3>
<div class="paragraph">
<p>TODO: Add a dynamic query routing component to <code>routing.cljc</code></p>
</div>
<div class="paragraph">
<p>TODO: multimethods for getting class by well-known name. Use keyword (which parent can know) as dispatch. Use dynamic query for that router.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_compiler_config"><a class="anchor" href="#_the_compiler_config"></a><a class="link" href="#_the_compiler_config">20.2. The Compiler Config</a></h3>
<div class="ulist">
<ul>
<li>
<p>Add modules</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_the_extension_point"><a class="anchor" href="#_the_extension_point"></a><a class="link" href="#_the_extension_point">20.3. The Extension Point</a></h3>

</div>
<div class="sect2">
<h3 id="_server_side_rendering_2"><a class="anchor" href="#_server_side_rendering_2"></a><a class="link" href="#_server_side_rendering_2">20.4. Server-Side Rendering</a></h3>
<div class="paragraph">
<p>Of course this affects server-side rendering as well. If you want to pre-render a page that is normally loaded as a
module then you must make sure it is loaded properly on the server. This is typically relatively simple, since you won&#8217;t
need the module splitting or the loading code to do anything. Instead, you just need to make sure the namespace is required so
that the multimethod has been installed. There is also the problem of the dynamic query: you don&#8217;t have component instances
or a reconciler, so there is no place to set the query. Instead, you&#8217;ll have to use reader conditionals so that the query
is statically complete when used on the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defui RouterUnion
  static prim/IQuery
  (query [this]
    <span class="error">#</span>?(<span class="symbol">:cljs</span> {<span class="symbol">:main-screen</span> (prim/get-query Main)}
       <span class="symbol">:clj</span> {<span class="symbol">:main-screen</span> (prim/get-query Main) <span class="symbol">:other</span> (prim/get-query Other) <span class="keyword">..</span><span class="keyword">.</span>}))</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dynamic_queries"><a class="anchor" href="#_dynamic_queries"></a><a class="link" href="#_dynamic_queries">21. Dynamic Queries</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Fulcro fully support dynamic queries: the ability the change the query of a component at runtime. This feature is fully
serializable (works with the support viewer and other time-travel features), and is critical for features like code splitting
where you may need to compose in a query of an as-yet unloaded component tree of your application.</p>
</div>
<div class="sect2">
<h3 id="_query_ids"><a class="anchor" href="#_query_ids"></a><a class="link" href="#_query_ids">21.1. Query IDs</a></h3>
<div class="paragraph">
<p>For dynamic queries to work right they have to be stored in your application database and every aspect of them must
be serializable. Additionally, the UI must be able to look them up at the component level in order to do optimal refresh.
The solution to this is query IDs. A query ID is a simple combination of the the component&#8217;s fully-qualified class name
combined with a user-defined qualifier (which defaults to the empty string).</p>
</div>
<div class="paragraph">
<p>Since this qualifier is needed both in the code that obtains queries (<code>get-query</code>) and in the UI rendering (the factory
that draws that component), it is easiest to locate the qualifier in the UI factory itself. This allows you
to have instances of a class that can have different queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defsc Thing <span class="keyword">..</span><span class="keyword">.</span>)
(<span class="keyword">def</span> <span class="function">ui-thing</span> (prim/factory Thing)) <span class="comment">; query ID is derived from Thing + :a</span>
(<span class="keyword">def</span> <span class="function">ui-thing-1</span> (prim/factory Thing {<span class="symbol">:qualifier</span> <span class="symbol">:a</span>})) <span class="comment">; query ID is derived from Thing + :a</span>

(defsc Parent [this props]
  {<span class="symbol">:query</span> (<span class="keyword">fn</span> [] [{<span class="symbol">:child</span> (prim/get-query ui-thing-1)}])}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example one can now set the query for <code>Thing</code>, or <code>Thing</code> with qualifier <code>:a</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_query_parameters"><a class="anchor" href="#_query_parameters"></a><a class="link" href="#_query_parameters">21.2. Query Parameters</a></h3>
<div class="paragraph">
<p>The dynamic query support allows you to use variables in your query to facilitate more easy modification of a component&#8217;s query.
Setting the entire query can be tedious when the query has a lot of elements, only one or a few of which need modifications.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hacking_the_client_query_engine"><a class="anchor" href="#_hacking_the_client_query_engine"></a><a class="link" href="#_hacking_the_client_query_engine">22. Hacking the Client Query Engine</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Om Next pioneered the data-driven space, and Fulcro is based upon many of the original concepts defined there. One of those
was the client parser. Fulcro is implemeted interally with a client query parser that is identical to Om Next&#8217;s. Fulcro
provides a default implementation of this parser, but allows you to hook into it to add your own code for interpreting
queries! Doing so allows you to interpret the
query of a component instead of pulling it from your database. This gives you an extreme amount of power, but at the
cost of some added complexity that is disconnected from your graph reasoning about the data graph itself.</p>
</div>
<div class="paragraph">
<p>This feature also allows you to leverage parameters on props and joins which are legal parts of the query syntax that
cannot be encoded in the database itself.</p>
</div>
<div class="paragraph">
<p>The mechansim is exactly as described for parsing on the server. The client-side notes are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The read is always called starting at root. If you want to handle something, you have to handle the path from root to
that item.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_adding_to_code_read_local_code"><a class="anchor" href="#_adding_to_code_read_local_code"></a><a class="link" href="#_adding_to_code_read_local_code">22.1. Adding to <code>read-local</code></a></h3>

</div>
<div class="sect2">
<h3 id="_demo_writing_a_pagination_and_sort_routine"><a class="anchor" href="#_demo_writing_a_pagination_and_sort_routine"></a><a class="link" href="#_demo_writing_a_pagination_and_sort_routine">22.2. Demo – Writing a Pagination and Sort Routine</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_performance"><a class="anchor" href="#_performance"></a><a class="link" href="#_performance">23. Performance</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Fuclro and React behave in a very performant manner for most data-driven applications. There are ways, however,
in which you can negatively affect performance.</p>
</div>
<div class="sect2">
<h3 id="_poor_query_performance"><a class="anchor" href="#_poor_query_performance"></a><a class="link" href="#_poor_query_performance">23.1. Poor Query Performance</a></h3>
<div class="paragraph">
<p>This is by far the most common source of performance issues. Evaluating the UI query is relatively fast, but <strong>relative</strong> is
the key word. The larger the query, the more work that has to be done to get the data for it. Remember that you compose all
component queries to the root. If you do this with <strong>only</strong> joins and props, then your root query will ask for <strong>everything</strong> that
your UI could ever show, on every frame! This will perform very badly as your application gets large.</p>
</div>
<div class="paragraph">
<p>The solution to this is to ensure that your query contains only the currently relevant things.
There are a number of possible solutions for this, but the two most common are to use union or dynamic queries.</p>
</div>
<div class="paragraph">
<p>The <code>fulcro.client.routing</code> namespace includes primitives for building UI routes using unions (the unions are written
for you). It has a number of features, including the ability to nicely integrate with HTML5 history events for full HTML5
routing in your application.</p>
</div>
<div class="paragraph">
<p>In the dynamic query approach you use <code>prim/set-query!</code> to actually change the query of a component at runtime in
response to user events.</p>
</div>
<div class="paragraph">
<p>It is also important to note that you need not normalize things that are really just big blobs of data that you don&#8217;t
intend to mutate. An example of this is large reports where the data is read-only. You could write a big
nested bunch of components, normalize all of the parts, and write a query that joins it all back together; however,
that incurs a lot of overhead both in loading the data, and every time you render.</p>
</div>
<div class="paragraph">
<p>Instead, realize that a property query like <code>[:report-data]</code> can pull <strong>any</strong> kind of (serializable, if you want
support viewer support) value from the
application state. You can put a js/Date there. You can put a map there. Anything. Furthermore, this query is super-fast
since it just pulls that big blob of data from app state and adds it to the result tree. Structural sharing makes that
fast.</p>
</div>
</div>
<div class="sect2">
<h3 id="_poor_react_performance"><a class="anchor" href="#_poor_react_performance"></a><a class="link" href="#_poor_react_performance">23.2. Poor React Performance</a></h3>
<div class="paragraph">
<p>In general Fulcro should be able to handle a pretty high frame-rate. In fact, the design is meant to facilitate
60FPS rendering. Remember, however, that there are a number of stages in rendering, and each of them has an overhead. Large
UIs can have negative performance impacts at both the query and DOM layers.</p>
</div>
<div class="paragraph">
<p>Since React does your rendering it is best to understand how to best optimize it using their suggestions and documentation. Note
that Fulcro already ensures that <code>shouldComponentUpdate</code> is defined to an optimal value that should prevent even a regen/diff of VDOM
when data hasn&#8217;t changed.</p>
</div>
<div class="paragraph">
<p>Some general tips to start with in React are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure your components have a <strong>stable</strong> react key. If the key changes, React will ignore the diff and redo the DOM. This is <strong>very</strong> slow. So,
if you&#8217;ve generated keys using something like random numbers just to get warnings to go away, then you&#8217;re asking for trouble.</p>
</li>
<li>
<p>You&#8217;re generally better off changing classes than DOM structure. For example, having a <code>(when render? (dom/div ...))</code> will cause entire
sections to be inserted and removed from the DOM. Using a class is much more efficient: <code>(dom/div #js {:className (str "" (when-not render? " hidden"))} ...)</code>.</p>
</li>
<li>
<p>Large DOM. React is pretty good with eliminating unnecessary changes, but that is still no reason to try to render a table with 1000&#8217;s of rows. Paginate.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing"><a class="anchor" href="#_testing"></a><a class="link" href="#_testing">24. Testing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Fulcro has a companion library called Fulcro Spec. It is a BDD DSL that wraps Clojure(script) test, and provides you
with a number of helpful features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A browser-based UI that can</p>
<div class="ulist">
<ul>
<li>
<p>Auto-refresh on code changes</p>
</li>
<li>
<p>Focus in on the tests of concern (you can define what that means)</p>
</li>
<li>
<p>Run client tests in any number of simultaneous browsers to detect browser differences</p>
</li>
<li>
<p>Run server-side tests through the same browser-based UI</p>
</li>
</ul>
</div>
</li>
<li>
<p>A Mocking/expectation system</p>
</li>
<li>
<p>Outline-based specifications</p>
</li>
<li>
<p>All of the functions from <code>clojure.test</code> work inside of specifications (e.g. <code>is</code>, <code>are</code>, etc).</p>
</li>
<li>
<p>It is easy to run specifications from CI systems. See the templates for examples.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_specifications"><a class="anchor" href="#_specifications"></a><a class="link" href="#_specifications">24.1. Specifications</a></h3>
<div class="paragraph">
<p>A specification is just a helpful wrapper around <code>clojure.test/deftest</code>. It looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(specification <span class="string"><span class="delimiter">&quot;</span><span class="content">The thing you're testing</span><span class="delimiter">&quot;</span></span>
   <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_behaviors_components_and_assertions"><a class="anchor" href="#_behaviors_components_and_assertions"></a><a class="link" href="#_behaviors_components_and_assertions">24.2. Behaviors, Components, and Assertions</a></h3>
<div class="paragraph">
<p>These macros assist you in organizing your specification. Behavior and component just add an outline
entry and increase nesting. The <code>assertions</code> macro can add descriptions for each assertion, and gives a nice
human-readable notation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(specification <span class="string"><span class="delimiter">&quot;</span><span class="content">Math</span><span class="delimiter">&quot;</span></span>
  (component <span class="string"><span class="delimiter">&quot;</span><span class="content">Addition</span><span class="delimiter">&quot;</span></span>
    (assertions
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Works with positive integers</span><span class="delimiter">&quot;</span></span>
      (<span class="keyword">+</span> <span class="integer">1</span> <span class="integer">1</span>) =&gt; <span class="integer">2</span>
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Works with negative integers</span><span class="delimiter">&quot;</span></span>
      (<span class="keyword">+</span> <span class="integer">-2</span> <span class="integer">-2</span>) =&gt; <span class="integer">-4</span>)))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exceptions"><a class="anchor" href="#_exceptions"></a><a class="link" href="#_exceptions">24.3. Exceptions</a></h3>
<div class="paragraph">
<p>It is common to want to test error handling code. The <code>assertions</code> macro supports checking for, and pattern-matching
against, exceptions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="keyword">..</span><span class="keyword">.</span>
   (assertions
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Throws when arg is nil</span><span class="delimiter">&quot;</span></span>
      (f <span class="predefined-constant">nil</span>) =throws=&gt; (ExceptionInfo <span class="regexp"><span class="delimiter">#&quot;</span><span class="content">Regex match on message</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_functional_assertions"><a class="anchor" href="#_functional_assertions"></a><a class="link" href="#_functional_assertions">24.4. Functional Assertions</a></h3>
<div class="paragraph">
<p>Often you don&#8217;t need a data comparison as much as you need to run a predicate on the result of a function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="keyword">..</span><span class="keyword">.</span>
   (assertions
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Returns odd numbers</span><span class="delimiter">&quot;</span></span>
      (f) =fn=&gt; <span class="keyword">odd?</span>)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mocking_and_spies"><a class="anchor" href="#_mocking_and_spies"></a><a class="link" href="#_mocking_and_spies">24.5. Mocking and Spies</a></h3>
<div class="paragraph">
<p>One of the most important features of sustainable testing is the ability to test things in isolation. Any kind of coupling
can result in cascading failures that make tests difficult to write/maintain/understand. Fulcro Spec has a mocking
system that is concise and allows you to do a number of advanced things. The basic syntax looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">f</span> [v] <span class="keyword">..</span><span class="keyword">.</span>)
(<span class="keyword">defn</span> <span class="function">g</span> [] (f <span class="integer">1</span>) <span class="integer">33</span>)

(specification <span class="string"><span class="delimiter">&quot;</span><span class="content">g</span><span class="delimiter">&quot;</span></span>
  (<span class="keyword">let</span> [real-f f] <span class="comment">; save f into a temporary binding</span>
    (when-mocking
      (f arg) =&gt; (<span class="keyword">do</span> <span class="comment">; rebinds `f` to this code</span>
                   (real-f arg) <span class="comment">; spy! Call the real original f</span>
                   (assertions
                     <span class="string"><span class="delimiter">&quot;</span><span class="content">calls f with 1</span><span class="delimiter">&quot;</span></span>
                     arg =&gt; <span class="integer">1</span>))

      (g))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s a lot going on here. The <code>when-mocking</code> macro looks for any number of arrow-separated triples (like <code>(f v) =&gt; 1</code>)
and re-binds the real function to an internally scripted one that captures the arguments and makes them available to the
code on the right-hand side of the triple (see <code>arg</code> above).</p>
</div>
<div class="paragraph">
<p>The form to the right of the <code>=&gt;</code> is run instead of the original function, and it can make assertions on the args
or even invoke the original.</p>
</div>
<div class="paragraph">
<p>If you specify a mock and it isn&#8217;t called, then the specification will fail. Thus, a check that <code>f</code> is actually called
is also implied by this test!</p>
</div>
<div class="sect3">
<h4 id="_specifying_call_count"><a class="anchor" href="#_specifying_call_count"></a><a class="link" href="#_specifying_call_count">24.5.1. Specifying Call Count</a></h4>
<div class="paragraph">
<p>It may be useful (or even necessary) to specify the number of times a function is called when mocking. The default is
"at least once". You can write a more complex scenario simply by adding a multiplier into the arrow!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">f</span> [] <span class="integer">99</span>)
(<span class="keyword">defn</span> <span class="function">g</span> [] (<span class="keyword">+</span> (f) (f))

(specification <span class="string"><span class="delimiter">&quot;</span><span class="content">g</span><span class="delimiter">&quot;</span></span>
  (assertions
    <span class="string"><span class="delimiter">&quot;</span><span class="content">produces the sum of two calls to f (coupled to the real definition of f)</span><span class="delimiter">&quot;</span></span>
    (g) =&gt; <span class="integer">198</span>))
  (when-mocking
    (f arg) =&gt; <span class="integer">2</span>

    (assertions
      <span class="string"><span class="delimiter">&quot;</span><span class="content">produces the sum of two calls to f (mocking returns same thing over and over)</span><span class="delimiter">&quot;</span></span>
      (g) =&gt; <span class="integer">4</span>))
  (when-mocking
    (f arg) =1x=&gt; <span class="integer">2</span>
    (f arg) =1x=&gt; <span class="integer">4</span>

    (assertions
      <span class="string"><span class="delimiter">&quot;</span><span class="content">produces the sum of two calls to f (called exactly twice is enforced, and different values returned)</span><span class="delimiter">&quot;</span></span>
      (g) =&gt; <span class="integer">6</span>)))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_checking_order"><a class="anchor" href="#_checking_order"></a><a class="link" href="#_checking_order">24.5.2. Checking Order</a></h4>
<div class="paragraph">
<p>When call counts are specified they imply order, and that order is checked as well by the internals of mocking. For
example a <code>1x</code> mock of <code>f</code>, <code>g</code>, <code>f</code> will fail if <code>f</code> is called twice before <code>g</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_limitations"><a class="anchor" href="#_limitations"></a><a class="link" href="#_limitations">24.5.3. Limitations</a></h4>
<div class="paragraph">
<p>Fulcro spec has some limitations that are inherent to the underlying programming language/VM.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It cannot mock inline, protocols, or macros.</p>
</li>
<li>
<p>You&#8217;re always creating "partial mocks". Expanding a function will often invalidate the mocking around it.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="VisualRegression"><a class="anchor" href="#VisualRegression"></a><a class="link" href="#VisualRegression">24.6. Visual Regression Testing</a></h3>
<div class="paragraph">
<p>When you have immutable data, pure rendering, and devcards it isn&#8217;t too hard to create an automated testing suite
that verifies your UI, without having to have ugly and hard-to-maintain browser drivers. The scheme is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Treat your UI components as animations that have a specific list of valid "key frames"</p>
<div class="ulist">
<ul>
<li>
<p>Each possible combination of input values results in a specific look</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create a devcard that statically renders the component with that state</p>
</li>
<li>
<p>Write a script that can drive a browser to jump from card to card, and screen shot the output</p>
</li>
<li>
<p>Have a human look at them and approve their look</p>
</li>
<li>
<p>Add the script to CI, and have it compare the "approved" images to the newly generated ones. If the image
comparison fails, your UI changed. Have a human check that specific item and approve the change.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below you&#8217;ll find the source for a Clojure program that can drive this CI testing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TODO: Include code</pre>
</div>
</div>
<style>
@media screen {
  .source-toggle {padding-bottom: 1em;}
  .source {display: none;
  margin-left: 2em;}
}
@media print {
  .source-toggle {display:none;}
  .source {display: block;
           margin-left: 2em;
          }
}
.example {width: "100vw";
          height: "100vh";
          background-color: lightgray;
          border: 3px groove white;
          border-radius: 10px;
          padding: 0;
          margin: 0;}
.example-title {
}
.com-rigsomelight-rendered-edn .keyval > .keyword {
 color: rgb(196,33,0);
 padding-right: 10px;
}

.com-rigsomelight-rendered-edn .collection {
  position: relative;
}

.com-rigsomelight-rendered-edn .vector,
.com-rigsomelight-rendered-edn .set,
.com-rigsomelight-rendered-edn .seq  {
  padding-left: 0.9em;
  padding-right: 0.9em;
}

.com-rigsomelight-rendered-edn .set {
  padding-left: 1.2em;
}


.com-rigsomelight-rendered-edn .collection.map {
  padding-left: 0.8em;
  display: inline-block;
  vertical-align: top;
}

.com-rigsomelight-rendered-edn .vector,
.com-rigsomelight-rendered-edn .set,
.com-rigsomelight-rendered-edn .seq {
  display: inline-block;
  vertical-align: top;
}

.com-rigsomelight-rendered-edn .vector > .contents {
  background-color: rgba(0,0,0,0.01);
}

.com-rigsomelight-rendered-edn .keyval {
  display: inline-block;
}

.com-rigsomelight-rendered-edn .collection.map > .contents > .separator  {
padding-right: 10px;
}

.com-rigsomelight-rendered-edn .collection .collection > .contents {
/*  background-color: rgba(0,0,0,0.02); */
}

.com-rigsomelight-rendered-edn .collection .contents > .collection:nth-child(even) {
background-color: rgba(0,0,0,0.04);
}

.com-rigsomelight-rendered-edn .contents {
  display: inline-block;
}

.com-rigsomelight-rendered-edn .opener,
.com-rigsomelight-rendered-edn .closer {
 color: #999;
}

.com-rigsomelight-rendered-edn .collection.map > .opener,
.com-rigsomelight-rendered-edn .collection.vector > .opener,
.com-rigsomelight-rendered-edn .collection.seq > .opener,
.com-rigsomelight-rendered-edn .collection.set > .opener {
 position: absolute;
 top: 0px;
 left: 3px;
}
.com-rigsomelight-rendered-edn .collection.map > .closer {
 bottom: 0px;
 right: 0px;
 display: block;
}

.com-rigsomelight-rendered-edn .collection.vector > .closer,
.com-rigsomelight-rendered-edn .collection.seq > .closer,
.com-rigsomelight-rendered-edn .collection.set > .closer {
 position: absolute;
 bottom: 0px;
 right: 0px;
 display: block;
}
</style>
<script src="/js/book.js"></script>
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2017-12-23 13:25:15 PST
</div>
</div>
</body>
</html>